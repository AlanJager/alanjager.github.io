<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>JVM metaspace memory leak analysis | 花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="BackgroundOut system became unavailable due to java.lang.OutOfMemoryError: Metaspace and according to a stackoverflow answer: https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;36051813&#x2F;java8-java-lang-outofmemoryer">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM metaspace memory leak analysis">
<meta property="og:url" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:description" content="BackgroundOut system became unavailable due to java.lang.OutOfMemoryError: Metaspace and according to a stackoverflow answer: https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;36051813&#x2F;java8-java-lang-outofmemoryer">
<meta property="og:locale">
<meta property="og:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1000.00.54.png">
<meta property="og:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.07.29.png">
<meta property="og:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.40.png">
<meta property="og:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.44.png">
<meta property="og:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.49.png">
<meta property="og:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.58.png">
<meta property="article:published_time" content="2022-10-11T09:13:39.000Z">
<meta property="article:modified_time" content="2022-10-11T09:24:50.221Z">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1000.00.54.png">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-jvm-metaspace-memory-leak-analysis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/11/jvm-metaspace-memory-leak-analysis/" class="article-date">
  <time class="dt-published" datetime="2022-10-11T09:13:39.000Z" itemprop="datePublished">2022-10-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      JVM metaspace memory leak analysis
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Out system became unavailable due to <code>java.lang.OutOfMemoryError: Metaspace</code> and according to a stackoverflow answer: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36051813/java8-java-lang-outofmemoryerror-metaspace">https://stackoverflow.com/questions/36051813/java8-java-lang-outofmemoryerror-metaspace</a>, I started to figure out what wrong with the system.</p>
<p>Before finding start analysis jvm memory dump, we need to known what means memory leak. In this case, we found thread failed to execution because create task failed due to OOM. But there are two typical reason.</p>
<ul>
<li>Too many classes need to be loaded</li>
<li>Memory leak causes some classes not unloaded</li>
</ul>
<p>Everytime you new a object, metaspace will be allocated to store metadata of the object. </p>
<p>Following code could reproduce this issue:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ; i++) &#123;</span><br><span class="line">            Class c = cp.makeClass(<span class="string">&quot;eu.plumbr.demo.Generated&quot;</span> + i).toClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.27.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>so dynamic created class will add new class information into metaspace but if there is no class loader reference to the class, the class will be cleared after GC.</p>
<p>So it’s clear that if memory leak happened to your metaspace, you can find your application no problem when just started and oom happens after it runs for a period of time.</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>A couple of tools are available for memory leak analysis and only refer to what I have used when I figure out this issue.</p>
<h3 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h3><blockquote>
<p> <strong>JConsole</strong> is a graphical monitoring tool to monitor <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Virtual_Machine">Java Virtual Machine</a> (JVM) and Java applications both on a local or remote machine.</p>
<p> JConsole uses underlying features of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Virtual_Machine">Java Virtual Machine</a> to provide information on performance and resource consumption of applications running on the Java platform using <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Management_Extensions">Java Management Extensions</a> (JMX) technology. JConsole comes as part of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Development_Kit">Java Development Kit</a> (JDK) and the graphical console can be started using “jconsole” command. </p>
</blockquote>
<p>As JConsole is a part of JDK, you can easily find it. On macOS, you can use commandline directly</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jconsole</span><br></pre></td></tr></table></figure>

<p>or find your java_home by </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/libexec/java_home -V</span><br></pre></td></tr></table></figure>

<p>the jconsole is under</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/bin/jconsole</span><br></pre></td></tr></table></figure>

<p>and then connect to local or remote application.</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1000.00.54.png" class="">

<p>Note: </p>
<p>In order to use JConsole, jmx need to be enabled for your application’s jvm options</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=10000 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.local.only=false -Djava.rmi.server.hostname=your_ip_address</span><br></pre></td></tr></table></figure>

<p>make sure your ip adress and port is available for remote access.</p>
<p>From JConsole we can monitor loaded class number, unloaded class number, perform gc and check if metaspace is continuously increasing.</p>
<h3 id="VisualVM"><a href="#VisualVM" class="headerlink" title=" VisualVM"></a> VisualVM</h3><p>A replacement for JConsole except jvm monitor, heap dump, application snapshot is available which is quite efficient for memory leak analysis.</p>
<h3 id="Memory-Analyzer-MAT"><a href="#Memory-Analyzer-MAT" class="headerlink" title="Memory Analyzer (MAT)"></a>Memory Analyzer (MAT)</h3><p>The Eclipse Memory Analyzer is a fast and feature-rich <strong>Java heap analyzer</strong> that helps you find memory leaks and reduce memory consumption.Use the Memory Analyzer to analyze productive heap dumps with hundreds of millions of objects, quickly calculate the retained sizes of objects, see who is preventing the Garbage Collector from collecting objects, run a report to automatically extract leak suspects.</p>
<p>My application use openjdk-1.8, so only MemoryAnalyzer-1.11.0.20201202-macosx.cocoa.x86_64.dmg</p>
<p>could be used. After that MAT only support java11.</p>
<h2 id="Start-debug"><a href="#Start-debug" class="headerlink" title="Start debug"></a>Start debug</h2><p>Combining background and tools, finding continuously increasing memory is easy but how to get to the code seems more diffcult.</p>
<p>But we could seperate debug procedure to several steps</p>
<ul>
<li>Do heap dump during a period to known always in memory classes and dynamic classes</li>
<li>Compare heap dump to figure out what increase metaspace</li>
<li>Find a operation that causes the leak</li>
</ul>
<p>Use visualVM connect to java application and monitor for a time</p>
<p>Metaspace leak can be monitored because after manually perforce GC, it still not decrease.</p>
<p>GC performed we have 72246 loaded classes.</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.07.29.png" class="">

<p>after aboubt 1minutes, GC performed but loaded class increased to 72262</p>
<p>![截屏2022-10-11 16.08.23](/Users/kayo/Desktop/blog/JVM metaspace memory leak analysis/截屏2022-10-11 16.08.23.png)</p>
<p>Aboviously there are some leak problems, so still use 1 minute as period and collect two heap dump for next step analysis.</p>
<p>Open the heap dumps with MAT to do compare, from heap dump’s dominator tree</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.40.png" class="">

<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.44.png" class="">

<p>Luckily, we found the increased class at first glance. The SessionFactoryImpl seems to blame.</p>
<p>Except this we found another issue with Groovy’s GStringTemplateEngine which causes groovy.reflection.ClassInfo increases and we will tell the details in next section.</p>
<p>Expand the suspects to get more details about it. By list all objects, query plan cache increased, so just google for this value</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.49.png" class="">

<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.58.png" class="">

<p>from <a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.0/javadocs/org/hibernate/engine/query/spi/QueryPlanCache.html">https://docs.jboss.org/hibernate/orm/5.0/javadocs/org/hibernate/engine/query/spi/QueryPlanCache.html</a>:  Acts as a cache for compiled query plans, as well as query-parameter metadata.</p>
<p>And check its source code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the cache of the actual plans...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BoundedConcurrentHashMap queryPlanCache;</span><br></pre></td></tr></table></figure>

<p>it seems a bounded hashmap and created like below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryPlanCache = <span class="keyword">new</span> BoundedConcurrentHashMap( maxQueryPlanCount, <span class="number">20</span>, BoundedConcurrentHashMap.Eviction.LIRS );</span><br></pre></td></tr></table></figure>

<p>and hibernate use default 2048 as maxQueryPlanCount and LIRS as eviction strategy. So no need to solve a cache increasing.</p>
<h2 id="GStringTemplateEngine"><a href="#GStringTemplateEngine" class="headerlink" title="GStringTemplateEngine"></a>GStringTemplateEngine</h2><p>By debug steps, we find GStringTemplateScript occupied metaspace and thousands of classes are created.</p>
<p>Check its implements, </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groovyClass = loader.parseClass(<span class="keyword">new</span> GroovyCodeSource(templateExpressions.toString(), <span class="string">&quot;GStringTemplateScript&quot;</span> + GStringTemplateEngine.counter.incrementAndGet() + <span class="string">&quot;.groovy&quot;</span>, <span class="string">&quot;x&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>GStringTemplateScript will be created every GStringTemplate created. So for template creation, will cause dynamic class creation and finally let jvm run out of memory.</p>
<p>According to some related fix, <a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/GROOVY-7017">https://issues.apache.org/jira/browse/GROOVY-7017</a> this fix use a seperate class loader to make sure gstring template could be gced from heap but metaspace is still occupied.</p>
<p>And another article talk about: <a target="_blank" rel="noopener" href="https://tigase.net/how-aws-helped-us-optimize-memory-usage-tigase-http-api/">https://tigase.net/how-aws-helped-us-optimize-memory-usage-tigase-http-api/</a> AWS improve Tigase HTTP API Memory usage, following fix is suggested: </p>
<ul>
<li>We load all templates at once using single <code>GStringTemplateEngine</code> and cache generate templates. <strong>No more automatic reloading of templates.</strong></li>
<li>When manual reload of templates is initiated we release old instance of <code>GStringTemplateEngine</code> and parse templates using the new one.</li>
</ul>
<p>So do some test before change our code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.text.GStringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyMetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String EVENT_CHINESE_TEMPLATE = <span class="string">&quot;事件 发生了 事件详情: 名称:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        GStringTemplateEngine engine = <span class="keyword">new</span> GStringTemplateEngine();</span><br><span class="line">        HashMap&lt;Integer, groovy.text.Template&gt; templateHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            groovy.text.Template template = templateHashMap.get(EVENT_CHINESE_TEMPLATE.hashCode());</span><br><span class="line">            <span class="keyword">if</span> (template == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    template = (groovy.text.Template) engine.createTemplate(<span class="keyword">new</span> StringReader(EVENT_CHINESE_TEMPLATE));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                templateHashMap.put(EVENT_CHINESE_TEMPLATE.hashCode(), template);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(template.make().toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MemoryPoolMXBean memoryMXBean : (ManagementFactory.getMemoryPoolMXBeans())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Metaspace&quot;</span>.equals(memoryMXBean.getName())) &#123;</span><br><span class="line">                    System.out.println(memoryMXBean.getUsage().getUsed()/<span class="number">1024</span>/<span class="number">1024</span> + <span class="string">&quot; mb&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>by use templateHashMap as cache to avoid duplicate template creation, we can see Metaspace memory usage not changed</p>
<p>but if change the code without templateHashMap:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.text.GStringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyMetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String EVENT_CHINESE_TEMPLATE = <span class="string">&quot;事件 发生了 事件详情: 名称:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        GStringTemplateEngine engine = <span class="keyword">new</span> GStringTemplateEngine();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            groovy.text.Template template;</span><br><span class="line">            <span class="comment">//= templateHashMap.get(EVENT_CHINESE_TEMPLATE.hashCode());</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                template = (groovy.text.Template) engine.createTemplate(<span class="keyword">new</span> StringReader(EVENT_CHINESE_TEMPLATE));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(template.make().toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MemoryPoolMXBean memoryMXBean : (ManagementFactory.getMemoryPoolMXBeans())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Metaspace&quot;</span>.equals(memoryMXBean.getName())) &#123;</span><br><span class="line">                    System.out.println(memoryMXBean.getUsage().getUsed()/<span class="number">1024</span>/<span class="number">1024</span> + <span class="string">&quot; mb&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>the metaspace will increase until oom.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/" data-id="cld1mhead000kyuwb98bvg0mn" data-title="JVM metaspace memory leak analysis" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/11/jvm-metaspace-memory-leak-analysis/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/11/jvm-metaspace-memory-leak-analysis/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Plugable module architecture design and thoughts about its implementation
        
      </div>
    </a>
  
  
    <a href="/2022/10/06/iommu/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Input–output memory management unit</div>
    </a>
  
</nav>

  
</article>



  <section id="comments" class="vcomment">

  </section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/DPDK/" style="font-size: 13.33px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/TDP/" style="font-size: 11.67px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 16.67px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 10px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 13.33px;">java</a> <a href="/tags/kernel/" style="font-size: 11.67px;">kernel</a> <a href="/tags/kvm/" style="font-size: 16.67px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 10px;">libvirt</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 13.33px;">software-arch</a> <a href="/tags/system-design/" style="font-size: 13.33px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 18.33px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 15px;">virt</a> <a href="/tags/virtio/" style="font-size: 10px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 18.33px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 18.33px;">virtio-networking</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/">Live migration failed due to libvirt keepalive timeout</a>
          </li>
        
          <li>
            <a href="/2022/12/15/nessus-on-centos-7/">Nessus on centos 7</a>
          </li>
        
          <li>
            <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/">UEFI Windows guest hang after live migration</a>
          </li>
        
          <li>
            <a href="/2022/11/09/plugable-system-in-practice-00/">Plugable system in practice 00</a>
          </li>
        
          <li>
            <a href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/">JVM loaded classes rapidly increased issue</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>