<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>The disk in the guest OS is unmounted during the kernel startup process. | 花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Phenomenon: When creating a new virtual machine, after the virtual machine enters the “running” state (libvirt reports running, and the qemu process starts), a disk is loaded. During the kernel startu">
<meta property="og:type" content="article">
<meta property="og:title" content="The disk in the guest OS is unmounted during the kernel startup process.">
<meta property="og:url" content="http://hanayo.cn/2023/12/06/2023-12-06/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:description" content="Phenomenon: When creating a new virtual machine, after the virtual machine enters the “running” state (libvirt reports running, and the qemu process starts), a disk is loaded. During the kernel startu">
<meta property="og:locale">
<meta property="article:published_time" content="2023-12-06T06:14:17.000Z">
<meta property="article:modified_time" content="2023-12-06T06:35:28.031Z">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="ブログ">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2023-12-06" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/12/06/2023-12-06/" class="article-date">
  <time class="dt-published" datetime="2023-12-06T06:14:17.000Z" itemprop="datePublished">2023-12-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      The disk in the guest OS is unmounted during the kernel startup process.
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Phenomenon: When creating a new virtual machine, after the virtual machine enters the “running” state (libvirt reports running, and the qemu process starts), a disk is loaded. During the kernel startup process, the disk (vdb) is recognized, and then qemu receives a device removal event, which is fed back to libvirt. Libvirt updates the XML, causing inconsistency between the disk state recorded in the zstack database and the XML on the host.</p>
<p>The main issue here is that the libvirt loading device interface returns success, and the XML corresponding to the device is also added. However, this device is deleted according to the event feedback from qemu.</p>
<p>Important log information: Here, let’s first analyze the system logs in the guest OS:</p>
<p>Here, we notice the logs related to pciehp because this virtual machine is UEFI-booted, leading to numerous pcie-related logs (due to UEFI boot requiring the q35 machine type, which defaults to pcie devices).</p>
<p>The initially observed logs include an error log from pcieport:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pci 0000:00:02.7: BAR 13: failed to assign [io size 0x1000]</span><br></pre></td></tr></table></figure>

<p>Followed by the recognition of the vdb device:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_virtio_blk virtio6: [vdb] 104857600 512-byte logical blocks (537 GB&#x2F;500 GiB)</span><br></pre></td></tr></table></figure>

<p>An external interrupt is sent to the virtual machine:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pciehp 0000:00:02.7:pcie004: Slot(0-7): Attention button pressed</span><br></pre></td></tr></table></figure>

<p>Subsequently, through ausearch, it is identified that libvirt received a device deletion event, leading to the removal of the mentioned device:</p>
<p>libvirt received device deleted event, removing the device</p>
<p>Based on these scenarios, we have summarized the steps to reproduce the issue:</p>
<ol>
<li>During the kernel startup process</li>
<li>Load the data disk.</li>
<li>Check for inconsistencies between the XML and the database.</li>
<li>Through repeated testing of VM boot and data disk loading, the issue can be reproduced.</li>
</ol>
<p>Regarding the error logs mentioned above, the explanation is as follows:</p>
<ol>
<li><p><code>pci 0000:00:02.7: BAR 13: failed to assign [io size 0x1000]</code>:</p>
<ul>
<li>According to <a target="_blank" rel="noopener" href="https://access.redhat.com/solutions/3144711">https://access.redhat.com/solutions/3144711</a>, this error may occur because in virtualized environments, there might be more PCIe ports than in a real physical environment, leading to this error. However, it does not have any actual impact.</li>
</ul>
</li>
<li><p><code>_virtio_blk virtio6: [vdb] 104857600 512-byte logical blocks (537 GB/500 GiB)</code>:</p>
<ul>
<li>This indicates that the virtio-blk disk has indeed been successfully loaded, as it has been recognized within the virtual machine.</li>
</ul>
</li>
<li><p><code>pciehp 0000:00:02.7:pcie004: Slot(0-7): Attention button pressed</code>:</p>
<ul>
<li>“Attention button pressed” indicates that when resetting the PCIe slot, QEMU sends the corresponding interrupt. When the host receives this interrupt, the corresponding processing logic prints this log.</li>
</ul>
</li>
</ol>
<p>As for the key QEMU code, by searching the codebase, it has been confirmed that QEMU sends the corresponding interrupt when resetting the PCIe slot, and the host prints the log as part of the corresponding processing logic.</p>
<p>code from <code>pcie.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pci_word_test_and_clear_mask(exp_cap + PCI_EXP_SLTSTA,</span><br><span class="line">                             PCI_EXP_SLTSTA_EIS |&#x2F;* on reset,</span><br><span class="line">                                                    the lock is released *&#x2F;</span><br><span class="line">                             PCI_EXP_SLTSTA_CC |</span><br><span class="line">                             PCI_EXP_SLTSTA_PDC |</span><br><span class="line">                             PCI_EXP_SLTSTA_ABP);</span><br></pre></td></tr></table></figure>

<p>which is used in <code>qdev.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">QLIST_FOREACH(bus, &amp;dev-&gt;child_bus, sibling) &#123;</span><br><span class="line">     object_property_set_bool(OBJECT(bus), true, &quot;realized&quot;,</span><br><span class="line">                                  &amp;local_err);</span><br><span class="line">     if (local_err !&#x3D; NULL) &#123;</span><br><span class="line">         goto child_realize_fail;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> if (dev-&gt;hotplugged) &#123;</span><br><span class="line">     device_reset(dev);</span><br><span class="line"> &#125;</span><br><span class="line"> dev-&gt;pending_deleted_event &#x3D; false;</span><br><span class="line"> </span><br><span class="line"> if (hotplug_ctrl) &#123;</span><br><span class="line">     hotplug_handler_plug(hotplug_ctrl, dev, &amp;local_err);</span><br><span class="line">     if (local_err !&#x3D; NULL) &#123;</span><br><span class="line">         goto child_realize_fail;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>During the device hotplug process, there will be a reset action.</p>
<p>Kernel-related code:</p>
<p>from <code>pciehp_hpc.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">static int pciehp_poll(void *data)</span><br><span class="line">&#123;</span><br><span class="line">    struct controller *ctrl &#x3D; data;</span><br><span class="line"> </span><br><span class="line">    schedule_timeout_idle(10 * HZ); &#x2F;* start with 10 sec delay *&#x2F;</span><br><span class="line"> </span><br><span class="line">    while (!kthread_should_stop()) &#123;</span><br><span class="line">        &#x2F;* poll for interrupt events or user requests *&#x2F;</span><br><span class="line">        while (pciehp_isr(IRQ_NOTCONNECTED, ctrl) &#x3D;&#x3D; IRQ_WAKE_THREAD ||</span><br><span class="line">               atomic_read(&amp;ctrl-&gt;pending_events))</span><br><span class="line">            pciehp_ist(IRQ_NOTCONNECTED, ctrl);</span><br><span class="line"> </span><br><span class="line">        if (pciehp_poll_time &lt;&#x3D; 0 || pciehp_poll_time &gt; 60)</span><br><span class="line">            pciehp_poll_time &#x3D; 2; &#x2F;* clamp to sane value *&#x2F;</span><br><span class="line"> </span><br><span class="line">        schedule_timeout_idle(pciehp_poll_time * HZ);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;* Check Attention Button Pressed *&#x2F;</span><br><span class="line">    if (events &amp; PCI_EXP_SLTSTA_ABP) &#123;</span><br><span class="line">        ctrl_info(ctrl, &quot;Slot(%s): Attention button pressed\n&quot;,</span><br><span class="line">              slot_name(ctrl));</span><br><span class="line">        pciehp_handle_button_press(ctrl);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>This code represents a kernel function for polling PCIe Hot Plug events. It uses a kernel thread (kthread) to continuously poll for interrupt events or user requests related to PCIe Hot Plug. The function includes a timeout mechanism with an initial delay of 10 seconds and then repeats the polling process based on the specified polling time. The function stops when the kernel thread should stop (kthread_should_stop() returns true).</p>
<p>And pciehp_handle_button_press is implemented as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">void pciehp_handle_button_press(struct controller *ctrl)</span><br><span class="line">&#123;</span><br><span class="line">	mutex_lock(&amp;ctrl-&gt;state_lock);</span><br><span class="line">	switch (ctrl-&gt;state) &#123;</span><br><span class="line">	case OFF_STATE:</span><br><span class="line">	case ON_STATE:</span><br><span class="line">		if (ctrl-&gt;state &#x3D;&#x3D; ON_STATE) &#123;</span><br><span class="line">			ctrl-&gt;state &#x3D; BLINKINGOFF_STATE;</span><br><span class="line">			ctrl_info(ctrl, &quot;Slot(%s): Powering off due to button press\n&quot;,</span><br><span class="line">				  slot_name(ctrl));</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			ctrl-&gt;state &#x3D; BLINKINGON_STATE;</span><br><span class="line">			ctrl_info(ctrl, &quot;Slot(%s) Powering on due to button press\n&quot;,</span><br><span class="line">				  slot_name(ctrl));</span><br><span class="line">		&#125;</span><br><span class="line">		&#x2F;* blink power indicator and turn off attention *&#x2F;</span><br><span class="line">		pciehp_set_indicators(ctrl, PCI_EXP_SLTCTL_PWR_IND_BLINK,</span><br><span class="line">				      PCI_EXP_SLTCTL_ATTN_IND_OFF);</span><br><span class="line">		schedule_delayed_work(&amp;ctrl-&gt;button_work, 5 * HZ);</span><br><span class="line">		break;</span><br><span class="line">	case BLINKINGOFF_STATE:</span><br><span class="line">	case BLINKINGON_STATE:</span><br><span class="line">		&#x2F;*</span><br><span class="line">		 * Cancel if we are still blinking; this means that we</span><br><span class="line">		 * press the attention again before the 5 sec. limit</span><br><span class="line">		 * expires to cancel hot-add or hot-remove</span><br><span class="line">		 *&#x2F;</span><br><span class="line">		ctrl_info(ctrl, &quot;Slot(%s): Button cancel\n&quot;, slot_name(ctrl));</span><br><span class="line">		cancel_delayed_work(&amp;ctrl-&gt;button_work);</span><br><span class="line">		if (ctrl-&gt;state &#x3D;&#x3D; BLINKINGOFF_STATE) &#123;</span><br><span class="line">			ctrl-&gt;state &#x3D; ON_STATE;</span><br><span class="line">			pciehp_set_indicators(ctrl, PCI_EXP_SLTCTL_PWR_IND_ON,</span><br><span class="line">					      PCI_EXP_SLTCTL_ATTN_IND_OFF);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			ctrl-&gt;state &#x3D; OFF_STATE;</span><br><span class="line">			pciehp_set_indicators(ctrl, PCI_EXP_SLTCTL_PWR_IND_OFF,</span><br><span class="line">					      PCI_EXP_SLTCTL_ATTN_IND_OFF);</span><br><span class="line">		&#125;</span><br><span class="line">		ctrl_info(ctrl, &quot;Slot(%s): Action canceled due to button press\n&quot;,</span><br><span class="line">			  slot_name(ctrl));</span><br><span class="line">		break;</span><br><span class="line">	default:</span><br><span class="line">		ctrl_err(ctrl, &quot;Slot(%s): Ignoring invalid state %#x\n&quot;,</span><br><span class="line">			 slot_name(ctrl), ctrl-&gt;state);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;ctrl-&gt;state_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Both OFF_STATE and ON_STATE could changed to each other by same press request. </p>
<p>Based on the test results, we preliminarily conclude that there is a race condition between hot-plug operations and kernel boot, leading to unexpected changes in the PCIe slot’s state from off → on → off. (Note: The crucial point here is that pciehp_handle_button_press(ctrl); simultaneously handles both on and off scenarios.)</p>
<p>With reference to the above keywords, we identified a related Bugzilla entry for QEMU version 4.2 by searching for ‘qemu pci device kernel boot race condition’:</p>
<p><a target="_blank" rel="noopener" href="https://bugzilla.kernel.org/show_bug.cgi?id=211691">https://bugzilla.kernel.org/show_bug.cgi?id=211691</a></p>
<p>“The document mentions a virtio-net failover mechanism introduced by QEMU 4.2, addressing the issue of hot-plugging network cards failing during the VM startup phase. This problem arises from a race condition in the QEMU code that sets the PCIe slot’s state. The provided QEMU patch resolves the issue:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/commit/df72184ec15829053b3bb5a0d5801773b6d9ec25">QEMU Patch Link</a></p>
<p>The title of this patch is: ‘pcie: don’t set link state active if the slot is empty.’</p>
<p>Upon reviewing its content, it appears that during PCIe initialization and the hot-plug phase, the ‘reset’ is called, potentially causing inconsistencies in the slot’s state. This patch addresses the problem by preventing the setting of the link state to active if the slot is empty, eliminating the observed issue.”</p>
<p>TIPs:</p>
<p>Search for changes related to the virtual machine process using <code>ausearch</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ausearch -m <span class="string">&quot;VIRT_RESOURCE&quot;</span> -p 63259</span><br></pre></td></tr></table></figure>

<p>Libvirt’s XML and QEMU event update mechanism: Details can be found in TIC-1360 - Cloud VM disk does not exist, capacity inconsistency between UI interface and underlying view (Closed).</p>
<p>Quick reference for PCIe events:</p>
<p>From linux pci_regs.h:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PCI_EXP_SLTCTL      24  <span class="comment">/* Slot Control */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_ABPE    0x0001  <span class="comment">/* Attention Button Pressed Enable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PFDE    0x0002  <span class="comment">/* Power Fault Detected Enable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_MRLSCE  0x0004  <span class="comment">/* MRL Sensor Changed Enable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PDCE    0x0008  <span class="comment">/* Presence Detect Changed Enable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_CCIE    0x0010  <span class="comment">/* Command Completed Interrupt Enable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_HPIE    0x0020  <span class="comment">/* Hot-Plug Interrupt Enable */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_AIC 0x00c0  <span class="comment">/* Attention Indicator Control */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_ATTN_IND_SHIFT 6      <span class="comment">/* Attention Indicator shift */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_ATTN_IND_ON    0x0040 <span class="comment">/* Attention Indicator on */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_ATTN_IND_BLINK 0x0080 <span class="comment">/* Attention Indicator blinking */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_ATTN_IND_OFF   0x00c0 <span class="comment">/* Attention Indicator off */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PIC 0x0300  <span class="comment">/* Power Indicator Control */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PWR_IND_ON     0x0100 <span class="comment">/* Power Indicator on */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PWR_IND_BLINK  0x0200 <span class="comment">/* Power Indicator blinking */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PWR_IND_OFF    0x0300 <span class="comment">/* Power Indicator off */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PCC 0x0400  <span class="comment">/* Power Controller Control */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PWR_ON         0x0000 <span class="comment">/* Power On */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_PWR_OFF        0x0400 <span class="comment">/* Power Off */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_EIC 0x0800  <span class="comment">/* Electromechanical Interlock Control */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  PCI_EXP_SLTCTL_DLLSCE  0x1000  <span class="comment">/* Data Link Layer State Changed Enable */</span></span></span><br></pre></td></tr></table></figure>

<p>QEMU systemtap trace, refer to: <a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/qemu/devel/tracing.html">QEMU Tracing Documentation</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/qemu-trace-stap run /usr/libexec/qemu-kvm pci_cfg_write</span><br></pre></td></tr></table></figure>

<p>Guest os pcie trace analysis:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pending interrupts 0x0010 from Slot Status</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_green_led_on: SLOTCTRL 6c write cmd 100</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pending interrupts 0x0010 from Slot Status</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_set_attention_status: SLOTCTRL 6c write cmd c0</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: Slot(0-7): Attention button pressed</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: Slot(0-7): Powering off due to button press</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pending interrupts 0x0010 from Slot Status</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_green_led_blink: SLOTCTRL 6c write cmd 200</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pending interrupts 0x0010 from Slot Status</span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_set_attention_status: SLOTCTRL 6c write cmd c0</span><br><span class="line"></span><br><span class="line">[一 12月 4 15:06:53 2023] pciehp 0000:00:02.7:pcie004: pciehp_get_power_status: SLOTCTRL 6c value read 2f1</span><br><span class="line">[一 12月 4 15:06:53 2023] pciehp 0000:00:02.7:pcie004: pciehp_unconfigure_device: domain:bus:dev = 0000:08:00</span><br><span class="line">[一 12月 4 15:06:53 2023] pciehp 0000:00:02.7:pcie004: pending interrupts 0x0010 from Slot Status</span><br><span class="line">[一 12月 4 15:06:53 2023] pciehp 0000:00:02.7:pcie004: pciehp_power_off_slot: SLOTCTRL 6c write cmd 40</span><br><span class="line"></span><br><span class="line">[一 12月 4 15:06:54 2023] pciehp 0000:00:02.7:pcie004: pending interrupts 0x0018 from Slot Status</span><br><span class="line">[一 12月 4 15:06:54 2023] pciehp 0000:00:02.7:pcie004: pciehp_green_led_off: SLOTCTRL 6c write cmd 300</span><br><span class="line"></span><br><span class="line">[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_green_led_on: SLOTCTRL 6c write cmd 100</span><br></pre></td></tr></table></figure>

<p>cmd 0x0100</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define  PCI_EXP_SLTCTL_PWR_IND_ON     0x0100 &#x2F;* Power Indicator on *&#x2F;</span><br></pre></td></tr></table></figure>
<p>[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_set_attention_status: SLOTCTRL 6c write cmd c0</p>
<p>cmd 0x00c0<br>0000 0000 1100 0000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define  PCI_EXP_SLTCTL_ATTN_IND_BLINK 0x0080 &#x2F;* Attention Indicator blinking *&#x2F;</span><br><span class="line">#define  PCI_EXP_SLTCTL_ATTN_IND_ON    0x0040 &#x2F;* Attention Indicator on *&#x2F;</span><br></pre></td></tr></table></figure>

<p>[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_green_led_blink: SLOTCTRL 6c write cmd 200</p>
<p>cmd 0x0200</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define  PCI_EXP_SLTCTL_PWR_IND_BLINK  0x0200 &#x2F;* Power Indicator blinking *&#x2F;</span><br></pre></td></tr></table></figure>

<p>[一 12月 4 15:06:48 2023] pciehp 0000:00:02.7:pcie004: pciehp_set_attention_status: SLOTCTRL 6c write cmd c0</p>
<p>cmd 0x00c0<br>0000 0000 1100 0000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define  PCI_EXP_SLTCTL_ATTN_IND_BLINK 0x0080 &#x2F;* Attention Indicator blinking *&#x2F;</span><br><span class="line">#define  PCI_EXP_SLTCTL_ATTN_IND_ON    0x0040 &#x2F;* Attention Indicator on *&#x2F;</span><br></pre></td></tr></table></figure>

<p>[一 12月 4 15:06:53 2023] pciehp 0000:00:02.7:pcie004: pciehp_power_off_slot: SLOTCTRL 6c write cmd 400</p>
<p>cmd 0x0400</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define  PCI_EXP_SLTCTL_PWR_OFF        0x0400 &#x2F;* Power Off *&#x2F;</span><br></pre></td></tr></table></figure>

<p>[一 12月 4 15:06:54 2023] pciehp 0000:00:02.7:pcie004: pciehp_green_led_off: SLOTCTRL 6c write cmd 300<br>cmd 0x0300</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define  PCI_EXP_SLTCTL_PWR_IND_OFF    0x0300 &#x2F;* Power Indicator off *&#x2F;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2023/12/06/2023-12-06/" data-id="clpte86eu0000aucafvj0077k" data-title="The disk in the guest OS is unmounted during the kernel startup process." class="article-share-link">Share</a>
      
      
        <a href="/2023/12/06/2023-12-06/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2023/12/06/2023-12-06/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2023/05/26/understanding-cpu-topology-for-improved-performance/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Understanding CPU Topology for Improved Performance</div>
    </a>
  
</nav>

  
</article>



  <section id="comments" class="vcomment">

  </section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/python/">python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/cpu/">cpu</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio/">virtio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/colo/" rel="tag">colo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpu/" rel="tag">cpu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-balloon/" rel="tag">memory balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/performance/" rel="tag">performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysstat/" rel="tag">sysstat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt-top/" rel="tag">virt-top</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualization/" rel="tag">virtualization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BSOD/" style="font-size: 10px;">BSOD</a> <a href="/tags/DPDK/" style="font-size: 12.86px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/TDP/" style="font-size: 11.43px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 18.57px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/colo/" style="font-size: 10px;">colo</a> <a href="/tags/cpu/" style="font-size: 12.86px;">cpu</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 11.43px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 12.86px;">java</a> <a href="/tags/kernel/" style="font-size: 14.29px;">kernel</a> <a href="/tags/kvm/" style="font-size: 15.71px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 12.86px;">libvirt</a> <a href="/tags/linux/" style="font-size: 17.14px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/memory-balloon/" style="font-size: 10px;">memory balloon</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/performance/" style="font-size: 11.43px;">performance</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 12.86px;">software-arch</a> <a href="/tags/sysstat/" style="font-size: 10px;">sysstat</a> <a href="/tags/system-design/" style="font-size: 12.86px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 17.14px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 14.29px;">virt</a> <a href="/tags/virt-top/" style="font-size: 10px;">virt-top</a> <a href="/tags/virtio/" style="font-size: 17.14px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 17.14px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 17.14px;">virtio-networking</a> <a href="/tags/virtualization/" style="font-size: 10px;">virtualization</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/12/06/2023-12-06/">The disk in the guest OS is unmounted during the kernel startup process.</a>
          </li>
        
          <li>
            <a href="/2023/05/26/understanding-cpu-topology-for-improved-performance/">Understanding CPU Topology for Improved Performance</a>
          </li>
        
          <li>
            <a href="/2023/04/27/virtio-memory-balloon/">Understand virtio memory balloon</a>
          </li>
        
          <li>
            <a href="/2023/04/13/qemu-colo-details/">Qemu Colo Details</a>
          </li>
        
          <li>
            <a href="/2023/03/13/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">KVM虚拟化性能分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>