<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="花の様に">
<meta property="og:url" content="http://hanayo.cn/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:locale">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="ブログ">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-windows-install-virtio-then-reboot-met-BSOD" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/" class="article-date">
  <time class="dt-published" datetime="2023-02-03T02:05:19.000Z" itemprop="datePublished">2023-02-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/">Windows install virtio then reboot met BSOD</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h2><p>This blog is a practice search about windows virtio driver installation.</p>
<h2 id="Backgroud"><a href="#Backgroud" class="headerlink" title="Backgroud"></a>Backgroud</h2><p>For virtualization software, normally guest will install virtio related drivers to get better virtualization performance. But instll virtio driver to windows guest sometimes became complex, so many softwares offer a practice guide about virtio dirver installation</p>
<table>
<thead>
<tr>
<th>Software</th>
<th>practice guide</th>
</tr>
</thead>
<tbody><tr>
<td>Proxmox</td>
<td><a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers">https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers</a> <br /><a target="_blank" rel="noopener" href="https://pve.proxmox.com/wiki/Windows_10_guest_best_practices">https://pve.proxmox.com/wiki/Windows_10_guest_best_practices</a></td>
</tr>
<tr>
<td>IBM Cloud orchestrator</td>
<td><a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/cloud-orchestrator/2.5.0.3?topic=images-installing-virtio-driver-kvm-hypervisor-only">https://www.ibm.com/docs/en/cloud-orchestrator/2.5.0.3?topic=images-installing-virtio-driver-kvm-hypervisor-only</a></td>
</tr>
</tbody></table>
<p>the guide introduce that how to install virtio driver from win-virtio.iso while lauch windows install.</p>
<p>But in practice, if user want install driver to exists guest, windows still get BSOD after virtio driver installed.</p>
<p>So I write this blog to solve related problems.</p>
<h3 id="Newly-virtio-driver-installation"><a href="#Newly-virtio-driver-installation" class="headerlink" title="Newly virtio driver installation"></a>Newly virtio driver installation</h3><p>Windows running root disk attached to ide controller and install virtio driver. Then stop guest and move the disk from ide controller to virtio-serial controller, start guest will meet BSOD (no accessible boot device).</p>
<p>This is because windows do not load the virtio controller when install virtio driver to running vm.</p>
<p>According to P2V practice, how to inject virtio driver to a guest <a target="_blank" rel="noopener" href="https://portal.nutanix.com/page/documents/kbs/details?targetId=kA00e000000kAWeCAM">https://portal.nutanix.com/page/documents/kbs/details?targetId=kA00e000000kAWeCAM</a> </p>
<p>we need manually load driver</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drvload vioser.inf</span><br></pre></td></tr></table></figure>

<p>then install the driver to disk where windows installed:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism &#x2F;image:c:\ &#x2F;add-driver &#x2F;driver:vioscsi.inf</span><br></pre></td></tr></table></figure>

<p>but if you try to do this on a running windows vm, dism will tell you that this operation is not allowed on a running windows. So the kv tell user to do the operation through cmd prompt when windows failed to boot not convinence if there are many guest need do this.</p>
<p>from superuser <a target="_blank" rel="noopener" href="https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio/1253728#1253728">https://superuser.com/questions/1057959/windows-10-in-kvm-change-boot-disk-to-virtio/1253728#1253728</a></p>
<p>other solution is raised, the best one is by setting guest into safeboot mode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit &#x2F;set &quot;&#123;current&#125;&quot; safeboot minimal</span><br></pre></td></tr></table></figure>

<p>windows will load all drivers then change the disk controller seems make sense, but still manually operation is required.</p>
<p>A tricky way is noticed by adding a dummy virtio disk to windows and then install virtio driver, the controller will be loaded at first.</p>
<p>the following steps I followed:</p>
<ol>
<li>Install the virtio driver in windows</li>
<li>Add a additional “dummy” virtio disk. Reboot and check if the “dummy” works.</li>
<li>If Step 2 works, then switch the boot disk to virtio.</li>
<li>Reboot</li>
<li>Remove the additional “dummy” virtio disk</li>
</ol>
<p>because we do not need to do more operation inside guest, so this solution can be changed to a automatic way.</p>
<p>And more discussion can be found on reddit:</p>
<blockquote>
<p>Looks like you’re having the issue of windows refusing to load the virtio storage drivers at boot.</p>
<p>The only thing I found that works for me is using this method - <a target="_blank" rel="noopener" href="https://superuser.com/a/1200899">https://superuser.com/a/1200899</a>. You can also try this method of adding another disk and installing the driver but I personally found that to be very hit and miss.</p>
<p>For the first method you need to use diskpart to assign drive letters to your windows drive and virtio iso this tutorial should help if you don’t know how to do it.</p>
</blockquote>
<p>but luckily, </p>
<blockquote>
<p>You need to install the virtio drivers on a per storage device basis.</p>
<p>I suggest swapping back to sata and add a empty virtio device to your guest. Then boot and install the virtio driver for the new the device. Last step is to delete the old sata device and mount the device image at the virtio device and boot your guest.</p>
<p>Make sure that libvirt didn’t changed the pcie address of your virtio device as windows registers the driver on a per device basis.</p>
</blockquote>
<p>the dummy disk work around can be used because the pci address acutally reused (as the virtio device will be removed and reboot)</p>
<p>This method works well when virtio drivers are newly added, but if you have booted guest with virtio driver installed, change the controller from ide to virtio is complex.</p>
<p>We prefer user to install virtio driver during first windows intallation and make it as a image to avoid controller change.</p>
<h2 id="Virtio-driver-already-installed"><a href="#Virtio-driver-already-installed" class="headerlink" title="Virtio driver already installed"></a>Virtio driver already installed</h2><p>While virtio already installed and reboot windows and the disk controller not changed. After reboot the boot disk is still ide. </p>
<p>If you attach virtio-blk disk to guest, it will be recognized and loaded right now. </p>
<p>But if follow the steps below to attach a dummy disk (in this case you attached a virtio-blk disk actually), change the ide controller to virtio will not work, windows kept report BSOD after changed.</p>
<p>Work around is uninstall the virtio driver and reinstall with the steps than reboot every will works.</p>
<p>I think maybe windows only load all drivers which are newly installed. But for existing driver, it only works per disk basis.</p>
<h2 id="Virtio-scsi-always-works"><a href="#Virtio-scsi-always-works" class="headerlink" title="Virtio-scsi always works"></a>Virtio-scsi always works</h2><p>Cheerfully, if you change the ide/sata controller to virtio-scsi controller after virtio driver installed, windows works well.</p>
<p>More performance test is needed because we kept use virtio-blk for root disk due to some version of virtio driver offered virtio-scsi has bad performance.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/" data-id="cldnw2sji0000r2cabzpp6s00" data-title="Windows install virtio then reboot met BSOD" class="article-share-link">Share</a>
      
      
        <a href="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-live-migration-failed-due-to-libvirt-keepalive-timeout" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/" class="article-date">
  <time class="dt-published" datetime="2023-01-13T08:16:33.000Z" itemprop="datePublished">2023-01-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/libvirt/">libvirt</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/">Live migration failed due to libvirt keepalive timeout</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Live migration is a important part of kvm virtualization at the first day it was designed. However when dive into control plane of libvirt live migration, it became quite complex. So I will describe the basic implementation about it at the early stage.</p>
<h2 id="Libvirt-QEMU-basic-building-blocks"><a href="#Libvirt-QEMU-basic-building-blocks" class="headerlink" title="Libvirt + QEMU basic building blocks"></a>Libvirt + QEMU basic building blocks</h2><p>For KVM based virtualization software, normally use libvirt + QEMU to manage guest’s lifecycle. And for live migration we have to know some basic part between libvirt and QEMU.</p>
<img src="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/libvirt+qemu.png" class="">

<p>the figure below introduces the basic parts and I just list those parts from left to right:</p>
<ul>
<li>virsh: a commandline interface to management domains</li>
<li>libvirt sdk: Python, Go… supported sdk to access libvirt by defined api</li>
<li>Libvirt api: exposed connect (the connection to libvirt), domain (guest), network (virtualization network of a hypervisor), storage volume (storage volume as block device which can be used by domain), storage pool (logically used for allocate and store storage volumes)</li>
<li>QEMU driver: libvirt driver of qemu, it will translate libvirt api invoke to related qemu operations</li>
<li>QEMU: a generic and open source machine emulator and virtualizer</li>
<li>qmp: QEMU machine protocol, is a JSON-based protocol, which allows applications to control a QEMU instance</li>
</ul>
<p>So when we do a live migration operation all those parts will be involved.</p>
<h2 id="Libvirt-live-migration"><a href="#Libvirt-live-migration" class="headerlink" title="Libvirt live migration"></a>Libvirt live migration</h2><p>For the control plane (libvirt), many concepts need to be introduced before we try to comprehensive its migration logic.</p>
<p>According to <a target="_blank" rel="noopener" href="https://libvirt.org/migration.html">https://libvirt.org/migration.html</a> there are two options for network data transport.</p>
<ul>
<li>Native transport: use qemu socket to transport data<ul>
<li>Require network between hypervisor (firewall issue should be solved)</li>
<li>Encryption support is depend on hypervisor</li>
<li>Better performance (minimising the number of data copies)</li>
</ul>
</li>
<li>Tunnelled transport: the data will be transported through libvirt RPC protocol<ul>
<li>Encryption supported</li>
<li>Less firewall issues</li>
<li>Worst performance (due to encryption)</li>
</ul>
</li>
</ul>
<p>And libvirt also support different control plane, the migration support have common features</p>
<ol>
<li>a peer2peer flag decide if we use client to connect to libvirtd servers or libvirtd server manage the connection itself</li>
<li>A destination URI with a form like ‘qemu+ssh://desthost/system’ for libvirtd connection</li>
<li>Data transport URI need a optional URI like ‘tcp://10.0.0.1/‘ means use TCP for data transport to hypervisor or libvirtd server</li>
<li>Normally libvirtd on target will automatically determine its native hypervisor URI so is not required in migratin api</li>
<li>If hypervisor do not offer encryption itself, tunnelled migration should be used</li>
<li>When libvirt daemon can not access network use unix migration</li>
<li>For vm with disks on non-shared storage, remember copy all storages</li>
</ol>
<p>Following are libvirt supported migrations and all available for qemu driver:</p>
<ul>
<li>Native migration, client to two libvirtd servers</li>
<li>Native migration, client to and peer2peer between two libvirtd servers</li>
<li>Tunnelled migration, client and peer2peer between two libvirtd servers</li>
<li>Native migration, client to one libvirtd server</li>
<li>Native migration, peer2peer between two libvirtd servers</li>
<li>Tunnelled migration, peer2peer between two libvirtd servers</li>
<li>Migration using UNIX sockets</li>
<li>Migration of VMs using non-shared images for disks</li>
</ul>
<h2 id="Libvirt-keepalive-of-client"><a href="#Libvirt-keepalive-of-client" class="headerlink" title="Libvirt keepalive of client"></a>Libvirt keepalive of client</h2><p>Libvirt use a C/S architecture and during migration libvirt need to support ‘client to two libvirtd servers’ or ‘client to and peer2peer between two libvirtd servers’. </p>
<p>So connection management between client and server or server and server is important for libvirt. And some common conserns for this architecture:</p>
<ul>
<li>Client and server connection<ul>
<li>Async task not relay on the connection if server implement idempotency<ul>
<li>Domain object lock help with idempotency</li>
</ul>
</li>
<li>Sync task relay on the connection<ul>
<li>All sync tasks should fail if connection keepalive timeout</li>
</ul>
</li>
</ul>
</li>
<li>Server and server connection<ul>
<li>Source server should be treated as client and same with client and server connection</li>
</ul>
</li>
</ul>
<p>In order to solve basic requirements, libvirt introduced keepalive for client connection. Client can set a keepalive timeout with interval and count (server should support this because a keepalive response is required). </p>
<p>Note: </p>
<ul>
<li>Default settings is configured from libvirtd.conf</li>
<li>If set keepalive timeout to 0 means disable keepalive for client</li>
</ul>
<p>The code from <code>src/rpc/virkeepalive.h</code> is quite easy:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">virKeepAlivePtr <span class="title">virKeepAliveNew</span><span class="params">(<span class="keyword">int</span> interval,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">unsigned</span> <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">void</span> *client,</span></span></span><br><span class="line"><span class="function"><span class="params">                                virKeepAliveSendFunc sendCB,</span></span></span><br><span class="line"><span class="function"><span class="params">                                virKeepAliveDeadFunc deadCB,</span></span></span><br><span class="line"><span class="function"><span class="params">                                virKeepAliveFreeFunc freeCB)</span></span></span><br><span class="line"><span class="function">                                <span class="title">ATTRIBUTE_NONNULL</span><span class="params">(<span class="number">3</span>)</span> <span class="title">ATTRIBUTE_NONNULL</span><span class="params">(<span class="number">4</span>)</span></span></span><br><span class="line"><span class="function">                                <span class="title">ATTRIBUTE_NONNULL</span><span class="params">(<span class="number">5</span>)</span> <span class="title">ATTRIBUTE_NONNULL</span><span class="params">(<span class="number">6</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">virKeepAliveStart</span><span class="params">(virKeepAlivePtr ka,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> interval,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">virKeepAliveStop</span><span class="params">(virKeepAlivePtr ka)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">virKeepAliveTimeout</span><span class="params">(virKeepAlivePtr ka)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">virKeepAliveTrigger</span><span class="params">(virKeepAlivePtr ka,</span></span></span><br><span class="line"><span class="function"><span class="params">                         virNetMessagePtr *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">virKeepAliveCheckMessage</span><span class="params">(virKeepAlivePtr ka,</span></span></span><br><span class="line"><span class="function"><span class="params">                              virNetMessagePtr msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                              virNetMessagePtr *response)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="For-libvirt-keepalive-timeout-issue"><a href="#For-libvirt-keepalive-timeout-issue" class="headerlink" title="For libvirt keepalive timeout issue"></a>For libvirt keepalive timeout issue</h2><p>The result from <a target="_blank" rel="noopener" href="https://bugzilla.redhat.com/show_bug.cgi?id=1367620">https://bugzilla.redhat.com/show_bug.cgi?id=1367620</a> butzilla explains a issue of live migration failure due to poor network and the connection between libvirtd servers down which will report a keepalive timeout error.</p>
<p>In libvirtd log (<a target="_blank" rel="noopener" href="https://libvirt.org/kbase/debuglogs.html">https://libvirt.org/kbase/debuglogs.html</a>) we could see:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2023-01-05 05:07:36.721+0000: 114785: info : virKeepAliveTimerInternal:131 : RPC_KEEPALIVE_TIMEOUT: ka&#x3D;0x7f6af4006c60 client&#x3D;0x7f6af400</span><br><span class="line">6a70 countToDeath&#x3D;0 idle&#x3D;30</span><br><span class="line">2023-01-05 05:07:36.721+0000: 114785: debug : virKeepAliveTimerInternal:136 : No response from client 0x7f6af4006a70 after 5 keepalive</span><br><span class="line">messages in 30 seconds</span><br><span class="line">2023-01-05 05:07:36.721+0000: 114785: error : virKeepAliveTimerInternal:138 : internal error: connection closed due to keepalive timeout</span><br></pre></td></tr></table></figure>

<p>And search for client=0x7f6af400 we can find it is a connection created during migration:</p>
<img src="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/libvirtd-migration-keepalive.png" class="">

<p>the dconn is the URI to destination libvirtd server.</p>
<p>For peer2peer live migration, this issue can be workaround by using seperate network for libvirtd connection and data transport.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/" data-id="cld1mheak000qyuwb9r1kfm1f" data-title="Live migration failed due to libvirt keepalive timeout" class="article-share-link">Share</a>
      
      
        <a href="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-nessus-on-centos-7" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/12/15/nessus-on-centos-7/" class="article-date">
  <time class="dt-published" datetime="2022-12-15T08:27:49.000Z" itemprop="datePublished">2022-12-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/devops/">devops</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/12/15/nessus-on-centos-7/">Nessus on centos 7</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>First find download command from official page: <a target="_blank" rel="noopener" href="https://www.tenable.com/downloads/nessus?loginAttempted=true">https://www.tenable.com/downloads/nessus?loginAttempted=true</a> and I get 10.4.1 rpm with curl command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --request GET \</span><br><span class="line">  --url &#x27;https://www.tenable.com/downloads/api/v2/pages/nessus/files/Nessus-10.4.1-es7.x86_64.rpm&#x27; \</span><br><span class="line">  --output &#x27;Nessus-10.4.1-es7.x86_64.rpm&#x27;</span><br></pre></td></tr></table></figure>

<p>and before installation need to disable firewalld and selinux:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line"></span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">set</span> SELINUX=disabled <span class="keyword">in</span> below file</span></span><br><span class="line"></span><br><span class="line">vim /etc/sysconfig/selinux</span><br></pre></td></tr></table></figure>

<p>then install the rpm:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall Nessus-10.4.1-es7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>and start the service:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nessusd</span><br><span class="line"></span><br><span class="line">systemctl enable nessusd  #Gives error</span><br></pre></td></tr></table></figure>

<p>access nessus through 8443</p>
<p>before active access:</p>
<p><a target="_blank" rel="noopener" href="https://www.tenable.com/products/nessus/nessus-essentials">https://www.tenable.com/products/nessus/nessus-essentials</a> to get a activate code and go ahead for your trial of Nessus.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/12/15/nessus-on-centos-7/" data-id="cld1mhean000vyuwbdyvxgkce" data-title="Nessus on centos 7" class="article-share-link">Share</a>
      
      
        <a href="/2022/12/15/nessus-on-centos-7/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/12/15/nessus-on-centos-7/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/security/" rel="tag">security</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-uefi-windows-guest-hang-after-live-migration" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/" class="article-date">
  <time class="dt-published" datetime="2022-11-16T12:12:22.000Z" itemprop="datePublished">2022-11-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/">UEFI Windows guest hang after live migration</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Notes about debug windows hang issue.</p>
<h2 id="Test-case"><a href="#Test-case" class="headerlink" title="Test case"></a>Test case</h2><p>If qemu guest need to use nvidia GPU,  according to <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Video_card_driver_virtualisation_detection">https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Video_card_driver_virtualisation_detection</a> a workaround need to be setup in domain xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>after hidden kvm from guest, the GPU driver could work as expected. But we met an issue with Windows UEFI guest which hidden kvm and hung after live migration.</p>
<p>After searching for google, I got some directions for debug this issue:</p>
<ul>
<li>OVMF live migration issue: OVMF file size changed due to lib upgraded, configuration file length mismatch may cause guest hang</li>
<li>Host CPU feature issue: Host CPU features not match, may cause guest paused</li>
<li>QEMU/Libvirt issue</li>
<li>Windows issue: hidden kvm from guest is not compatible for all windows guest</li>
</ul>
<p>So I did some test try to figure out which component to suspect:</p>
<ul>
<li>Check OVMF version: not changed</li>
<li>Check host CPU feature: not changed</li>
<li>Check QEMU/Libvirt log, no virtualization error or error message exists</li>
<li>Remove the hidden tag to try live migration: Guest not hang</li>
</ul>
<p>We can see that kvm hidden seems to blame, but in order to use GPU on UEFI guest this issue should be resolved. So trace what happened during migration is the next step, open following logs for debug usage:</p>
<ol>
<li><p>OVMF log by following:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">qemu:commandline</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-debugcon&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;file:/var/log/libvirt/qemu/debug.log&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-global&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;isa-debugcon.iobase=0x402&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">qemu:commandline</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>QEMU/libvirt debug, but we already have qemu log under <code>/var/log/libvirt/qemu/</code></p>
</li>
<li><p>Check windows events after reboot</p>
</li>
</ol>
<p>But before we start debug, the environment related issue should be checked. Because we use nested virtualizatin as default, following environment check tests are required:</p>
<ol>
<li>Use baremetal host to test</li>
<li>Use latest qemu and libvirt to test</li>
<li>Use latest edk2 to test</li>
</ol>
<p>While combine test 1 and test 2, we get the result that UEFI wouldn’t hang after live migration. So we decide to test the same scenario on nested environment. And we did not met guest hang issue after upgrade libvirt. Go through the diffs from bug version and upstream:</p>
<p>I found following patch:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-    <span class="keyword">if</span> (!loader || !loader-&gt;nvram || <span class="built_in">virFileExists</span>(loader-&gt;nvram))</span><br><span class="line">+    <span class="keyword">if</span> (!loader || !loader-&gt;nvram ||</span><br><span class="line">+        (<span class="built_in">virFileExists</span>(loader-&gt;nvram) &amp;&amp;</span><br><span class="line">+            <span class="built_in">virFileLength</span>(loader-&gt;templt, <span class="number">-1</span>) == <span class="built_in">virFileLength</span>(loader-&gt;nvram, <span class="number">-1</span>))</span><br><span class="line">+        )</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">+    <span class="built_in">unlink</span>(loader-&gt;nvram);</span><br></pre></td></tr></table></figure>

<p>which is submitted to solve ovmf upgrade issue:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvram: regenerate nvram mapping file from template when firmware being upgraded</span><br></pre></td></tr></table></figure>

<p>After regenerating nvram mapping, the guest could be successfully migrated. Indeed this discovery solve our problem in short term and I want to get the root cause for why the guest hang and this patch is a important hint.</p>
<h2 id="How-ovmf-guest-perform-live-migration"><a href="#How-ovmf-guest-perform-live-migration" class="headerlink" title="How ovmf guest perform live migration"></a>How ovmf guest perform live migration</h2><p>How to perform live migration on ovmf guest. I search on edk2.groups.io try to find the answer.</p>
<p><a target="_blank" rel="noopener" href="https://edk2.groups.io/g/devel/topic/71141681#55046">https://edk2.groups.io/g/devel/topic/71141681#55046</a> and this topic discussed about live migration issue for ovmf guest which is quite helpful.</p>
<p>First of all, topic owner can not perform live migration because OVMF.fd changed its size from 2MB to 4MB which will be checked by qemu and raise length mismatch error like following(I got similar error from my test env):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-kvm: Length mismatch: system.flash1: 0x84000 in != 0x20000:Invalid argument</span><br></pre></td></tr></table></figure>

<p>And the reason of extending the flash size is due to <a target="_blank" rel="noopener" href="https://github.com/tianocore/edk2/commit/b24fca05751f">https://github.com/tianocore/edk2/commit/b24fca05751f</a> windows HCK require which declared that this is a incompatible change. So the solution may be:</p>
<ol>
<li>Stick with the same version of the ROM between VMs you want to migrate</li>
<li>Pad your ROM images to some larger size (e.g. 8MB) so that even if they grow a little bigger then you don’t hit the problem.</li>
</ol>
<p>When think about live migration, all guest’s memory will be migrated to target host, so the memory content of the firmware will be copied to the target host so no matter what loaded at target host memory will be overwritten. So if we want to get rid of this issue, keep the firmware with edk2 version is a good solution.</p>
<p>For legacy guest, BIOS use fixed magic address ranges but UEFI uses dynamically allocated memory, so there is not fixed addresses. When firmware flash image size change, also the content parts will changed too and which can not keep compatible.</p>
<p>But for live migration, due to the memory not changed, the nvram should also not be changed after that. I just quota the answer how ovmf works with live migration:</p>
<blockquote>
<p>With live migration, the running guest doesn’t notice anything. This is<br>a general requirement for live migration (regardless of UEFI or flash).</p>
<p>You are very correct to ask about “skipping” the NVRAM region. With the<br>approach that OvmfPkg originally supported, live migration would simply<br>be unfeasible. The “build” utility would produce a single (unified)<br>OVMF.fd file, which would contain both NVRAM and executable regions, and<br>the guest’s variable updates would modify the one file that would exist.<br>This is inappropriate even without considering live migration, because<br>OVMF binary upgrades (package updates) on the virtualization host would<br>force guests to lose their private variable stores (NVRAMs).</p>
<p>Therefore, the “build” utility produces “split” files too, in addition<br>to the unified OVMF.fd file. Namely, OVMF_CODE.fd and OVMF_VARS.fd.<br>OVMF.fd is simply the concatenation of the latter two.</p>
<p>$ cat OVMF_VARS.fd OVMF_CODE.fd | cmp - OVMF.fd<br>[prints nothing]</p>
<p>When you define a new domain (VM) on a virtualization host, the domain<br>definition saves a reference (pathname) to the OVMF_CODE.fd file.<br>However, the OVMF_VARS.fd file (the variable store <em>template</em>) is not<br>directly referenced; instead, it is <em>copied</em> into a separate (private)<br>file for the domain.</p>
<p>Furthermore, once booted, guest has two flash chips, one that maps the<br>firmware executable OVMF_CODE.fd read-only, and another pflash chip that<br>maps its private varstore file read-write.</p>
<p>This makes it possible to upgrade OVMF_CODE.fd and OVMF_VARS.fd (via<br>package upgrades on the virt host) without messing with varstores that<br>were earlier instantiated from OVMF_VARS.fd. What’s important here is<br>that the various constants in the new (upgraded) OVMF_CODE.fd file<br>remain compatible with the <em>old</em> OVMF_VARS.fd structure, across package<br>upgrades.</p>
<p>If that’s not possible for introducing e.g. a new feature, then the<br>package upgrade must not overwrite the OVMF_CODE.fd file in place, but<br>must provide an additional firmware binary. This firmware binary can<br>then only be used by freshly defined domains (old domains cannot be<br>switched over). Old domains can be switched over manually – and only if<br>the sysadmin decides it is OK to lose the current variable store<br>contents. Then the old varstore file for the domain is deleted<br>(manually), the domain definition is updated, and then a new (logically<br>empty, pristine) varstore can be created from the <em>new</em> OVMF_2_VARS.fd<br>that matches the <em>new</em> OVMF_2_CODE.fd.</p>
<p>During live migration, the “RAM-like” contents of both pflash chips are<br>migrated (the guest-side view of both chips remains the same, including<br>the case when the writeable chip happens to be in “programming mode”,<br>i.e., during a UEFI variable write through the Fault Tolerant Write and<br>Firmware Volume Block(2) protocols).</p>
<p>Once live migration completes, QEMU dumps the full contents of the<br>writeable chip to the backing file (on the destination host). Going<br>forward, flash writes from within the guest are reflected to said<br>host-side file on-line, just like it happened on the source host before<br>live migration. If the file backing the r/w pflash chip is on NFS<br>(shared by both src and dst hosts), then this one-time dumping when the<br>migration completes is superfluous, but it’s also harmless.</p>
<p>The interesting question is, what happens when you power down the VM on<br>the destination host (= post migration), and launch it again there, from<br>zero. In that case, the firmware executable file comes from the<br><em>destination host</em> (it was never persistently migrated from the source<br>host, i.e. never written out on the dst). It simply comes from the OVMF<br>package that had been installed on the destination host, by the<br>sysadmin. However, the varstore pflash does reflect the permanent result<br>of the previous migration. So this is where things can fall apart, if<br>both firmware binaries (on the src host and on the dst host) don’t agree<br>about the internal structure of the varstore pflash.</p>
</blockquote>
<p>from this long reply, we can get thoes points:</p>
<ul>
<li>Live migration should not be awared by guest</li>
<li>Edk2 seperate read-only executable codes and varstore to support firmware upgrade<ul>
<li>OVMF_CODE.fd keep compitable with orignal version</li>
<li>Qemu keep varstores in its nvram which will not be changed</li>
</ul>
</li>
<li>For new features if OVMF_CODE.fd can not keep compitable, use another OVMF_CODE_2.fd instead</li>
<li>Once live migraiton complete, qemu dump all contents to dest host</li>
</ul>
<p>So for qemu guest,  live migration just migrate memory to dest host and if we keep the same varstore and code with source host, it should be supported. Also because the pflash after live migration is actually in memory, so keep the varstore not changed will keep the compitable (no side-effects during runtime).</p>
<p>And another fact is when we turn off kvm hidden, the migration performs well and no any errors during guest runtime occurs in edk2’s log.</p>
<h2 id="Enable-KVM-trace"><a href="#Enable-KVM-trace" class="headerlink" title="Enable KVM trace"></a>Enable KVM trace</h2><p>According to: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/VFIO/comments/80p1q7/high_kvmqemu_cpu_utilization_when_windows_10/">https://www.reddit.com/r/VFIO/comments/80p1q7/high_kvmqemu_cpu_utilization_when_windows_10/</a> a windows performance topic.</p>
<p>Because there is no abvious log shows any error from qemu or libvirt and it seems that the guest hangs but qemu and libvirt works well, I decide to enable kvm tracing and hope to get more clues.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/events/kvm/enable</span><br></pre></td></tr></table></figure>

<p>can we can get tracing by:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/kernel/debug/tracing/trace_pipe</span><br></pre></td></tr></table></figure>

<p>and the following log printed:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;...&gt;-41061 [003] .... 167992.130071: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130072: kvm_msr: msr_read 40000020 = 0xdfa1388fd</span><br><span class="line">&lt;...&gt;-41061 [003] d... 167992.130072: kvm_entry: vcpu 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130073: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130074: kvm_msr: msr_read 40000020 = 0xdfa138912</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130074: kvm_entry: vcpu 3</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130085: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130086: kvm_msr: msr_read 40000020 = 0xdfa138988</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130086: kvm_entry: vcpu 3</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130086: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130087: kvm_msr: msr_read 40000020 = 0xdfa138998</span><br><span class="line">&lt;...&gt;-41061 [003] d... 167992.130088: kvm_entry: vcpu 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130102: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130103: kvm_msr: msr_read 40000020 = 0xdfa138a32</span><br><span class="line">&lt;...&gt;-41061 [003] d... 167992.130103: kvm_entry: vcpu 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130103: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130104: kvm_msr: msr_read 40000020 = 0xdfa138a3f</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130104: kvm_entry: vcpu 3</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130114: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130114: kvm_msr: msr_read 40000020 = 0xdfa138aaa</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130115: kvm_entry: vcpu 3</span><br></pre></td></tr></table></figure>

<p>the vcpus seems run kvm_entry and kvm_exit forever to do msr_read and combine with top:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">top - 12:54:08 up 1 day, 22:42,  1 user,  load average: 5.69, 5.82, 6.10</span><br><span class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  : 87.5 us, 12.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu1  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu2  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu3  : 87.5 us, 12.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 10054364 total,  7086476 free,  2163892 used,   803996 buff&#x2F;cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7563464 avail Mem</span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 41029 root      20   0 5193164   1.6g  17104 S 387.5 17.0 394:17.63 qemu-kvm</span><br></pre></td></tr></table></figure>

<p>guest’s sys usage is quite high use perf to get more details about this process:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf kvm --host top -p `pidof qemu-kvm`</span><br></pre></td></tr></table></figure>

<p>I see that:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Samples: 99K of event &#x27;cycles&#x27;, Event count (approx.): 10268746210</span><br><span class="line">Overhead  Shared Object            Symbol                                                                                                                                                                                          ◆</span><br><span class="line">  18.41%  [kernel]                 [k] vmx_vcpu_run                                                                                                                                                                                ▒</span><br><span class="line">   6.43%  [kernel]                 [k] vcpu_enter_guest                                                                                                                                                                            ▒</span><br><span class="line">   5.58%  [kernel]                 [k] pvclock_clocksource_read                                                                                                                                                                    ▒</span><br><span class="line">   3.84%  [kernel]                 [k] mutex_lock                                                                                                                                                                                  ▒</span><br><span class="line">   2.79%  [kernel]                 [k] vmx_handle_exit</span><br></pre></td></tr></table></figure>

<p>vmx_vcpu_run is high (on intel cpu) this means cpu switch to guest mode and show that guest mode and kernel mode switch spent a lot of time.</p>
<p>And by kvm tracing we can see many vm entry/exit so check the reason why vm exit happend (because the vcpu mode switch now spend too much time)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p> Just use a small piece of the output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@172-24-195-187 ~]# perf stat -e &#39;kvm:*&#39; -a -- sleep 1</span><br><span class="line"></span><br><span class="line"> Performance counter stats for &#39;system wide&#39;:</span><br><span class="line"></span><br><span class="line">           206,380      kvm:kvm_entry</span><br><span class="line">                 0      kvm:kvm_hypercall</span><br><span class="line">                 0      kvm:kvm_hv_hypercall</span><br><span class="line">               263      kvm:kvm_pio</span><br><span class="line">                 0      kvm:kvm_fast_mmio</span><br><span class="line">                 0      kvm:kvm_cpuid</span><br><span class="line">               162      kvm:kvm_apic</span><br><span class="line">           206,395      kvm:kvm_exit</span><br><span class="line">                 0      kvm:kvm_inj_virq</span><br><span class="line">                 0      kvm:kvm_inj_exception</span><br><span class="line">                 0      kvm:kvm_page_fault</span><br><span class="line">           202,600      kvm:kvm_msr</span><br><span class="line">                 0      kvm:kvm_cr</span><br><span class="line">               195      kvm:kvm_pic_set_irq</span><br><span class="line">                81      kvm:kvm_apic_ipi</span><br><span class="line">               370      kvm:kvm_apic_accept_irq</span><br><span class="line">                65      kvm:kvm_eoi</span><br></pre></td></tr></table></figure>

<p>kvm_msr is the main reason for vm exit and which matches kvm tracing.</p>
<p>By collect kvm events:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf kvm --host stat live</span><br></pre></td></tr></table></figure>

<p>we could see MSR_READ and EXTERNAL_INTERRUPT used almost all of the time.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">13:02:10.174121</span><br><span class="line"></span><br><span class="line">Analyze events for all VMs, all VCPUs:</span><br><span class="line"></span><br><span class="line">             VM-EXIT    Samples  Samples%     Time%    Min Time    Max Time         Avg time</span><br><span class="line"></span><br><span class="line">            MSR_READ       6022    78.14%    74.10%      0.71us  21778.22us     42.52us ( +-  17.16% )</span><br><span class="line">  EXTERNAL_INTERRUPT       1494    19.38%    21.65%      0.53us  12810.58us     50.08us ( +-  29.22% )</span><br><span class="line">      IO_INSTRUCTION        126     1.63%     1.16%     23.80us     51.45us     31.73us ( +-   1.56% )</span><br><span class="line">          APIC_WRITE         26     0.34%     0.06%      3.23us     10.96us      8.39us ( +-   4.81% )</span><br><span class="line">         EOI_INDUCED         20     0.26%     0.02%      1.93us      3.27us      2.63us ( +-   3.21% )</span><br><span class="line">       EPT_MISCONFIG         19     0.25%     3.01%     29.30us   9795.61us    548.07us ( +-  93.74% )</span><br><span class="line"></span><br><span class="line">Total Samples:7707, Total events handled time:345545.97us.</span><br></pre></td></tr></table></figure>

<p>from kvm tracing:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;...&gt;-41064 [000] .... 168733.114930: kvm_msr: msr_read 40000020 &#x3D; 0xfb3c08a54</span><br></pre></td></tr></table></figure>

<p>we can find 0x40000020 from linux kernel code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* MSR used to read the per-partition time reference counter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HV_X64_MSR_TIME_REF_COUNT		0x40000020</span></span><br></pre></td></tr></table></figure>

<p>it seems a hyperv clocksource related issue so I just remote the hyperclock field from libvirt xml and the migration issue disappeared after that.</p>
<h2 id="Try-to-find-root-cause"><a href="#Try-to-find-root-cause" class="headerlink" title="Try to find root cause"></a>Try to find root cause</h2><p>Actually we can workaround our issue by remove the clocksource from vm configuration but we do not known the root cause but only a vm_exit and failed to read hyperv clocksource.</p>
<p>So simply trace kernel code for more details.</p>
<p>vmx.h defines lots of EXIT reasons:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXIT_REASON_MSR_READ            31</span></span><br></pre></td></tr></table></figure>

<p>and vmx.c register handlers</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The exit handlers return 1 if the exit was handled fully and guest execution</span></span><br><span class="line"><span class="comment"> * may resume.  Otherwise they set the kvm_run parameter to indicate what needs</span></span><br><span class="line"><span class="comment"> * to be done to userspace and return 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*<span class="keyword">const</span> kvm_vmx_exit_handlers[])</span><span class="params">(struct kvm_vcpu *vcpu)</span> </span>= &#123;</span><br><span class="line">  ...</span><br><span class="line">	[EXIT_REASON_MSR_READ]                = handle_rdmsr,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>than move to handle_rdmsr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_rdmsr</span><span class="params">(struct kvm_vcpu *vcpu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 ecx = vcpu-&gt;arch.regs[VCPU_REGS_RCX];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msr_data</span> <span class="title">msr_info</span>;</span></span><br><span class="line"></span><br><span class="line">	msr_info.index = ecx;</span><br><span class="line">	msr_info.host_initiated = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (vmx_get_msr(vcpu, &amp;msr_info)) &#123;</span><br><span class="line">		trace_kvm_msr_read_ex(ecx);</span><br><span class="line">		kvm_inject_gp(vcpu, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	trace_kvm_msr_read(ecx, msr_info.data);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* <span class="doctag">FIXME:</span> handling of bits 32:63 of rax, rdx */</span></span><br><span class="line">	vcpu-&gt;arch.regs[VCPU_REGS_RAX] = msr_info.data &amp; <span class="number">-1u</span>;</span><br><span class="line">	vcpu-&gt;arch.regs[VCPU_REGS_RDX] = (msr_info.data &gt;&gt; <span class="number">32</span>) &amp; <span class="number">-1u</span>;</span><br><span class="line">	skip_emulated_instruction(vcpu);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because we see the trace from kvm that means <code>trace_kvm_msr_read_ex</code> is executed and will return 1 which means vm could resume.</p>
<p>If you look back to the kvm process trace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf kvm --host top -p &#96;pidof qemu-kvm&#96;</span><br></pre></td></tr></table></figure>

<p>we can find the inside vmx_vcpu_run, the vm vmresume is used and according to the code, the function will finished after <code>kvm_inject_gp(vcpu, 0);</code> and vm will entry guest.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vmx_vcpu_run  &#x2F;proc&#x2F;kcore</span><br><span class="line">Percent│       mov    0x238(%rcx),%rbx</span><br><span class="line">       │       mov    0x230(%rcx),%rdx</span><br><span class="line">       │       mov    0x250(%rcx),%rsi</span><br><span class="line">  0.11 │       mov    0x258(%rcx),%rdi</span><br><span class="line">       │       mov    0x248(%rcx),%rbp</span><br><span class="line">       │       mov    0x260(%rcx),%r8</span><br><span class="line">       │       mov    0x268(%rcx),%r9</span><br><span class="line">  0.03 │       mov    0x270(%rcx),%r10</span><br><span class="line">       │       mov    0x278(%rcx),%r11</span><br><span class="line">       │       mov    0x280(%rcx),%r12</span><br><span class="line">       │       mov    0x288(%rcx),%r13</span><br><span class="line">  0.11 │       mov    0x290(%rcx),%r14</span><br><span class="line">  0.02 │       mov    0x298(%rcx),%r15</span><br><span class="line">       │       mov    0x228(%rcx),%rcx</span><br><span class="line">       │     ↓ jne    2a1</span><br><span class="line">       │       vmlaunch</span><br><span class="line">       │     ↓ jmp    2a4</span><br><span class="line">  0.02 │2a1:   vmresume</span><br><span class="line"> 45.46 │2a4:   mov    %rcx,0x8(%rsp)</span><br><span class="line">  4.07 │       pop    %rcx</span><br><span class="line">  1.50 │       mov    %rax,0x220(%rcx)</span><br><span class="line">  2.07 │       mov    %rbx,0x238(%rcx)</span><br></pre></td></tr></table></figure>

<p>So that means guest will exit due to its own READ_MSR requirement.</p>
<p>Check kernel related code, the function chains are following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmx_get_msr -&gt; kvm_get_msr_common -&gt; kvm_hv_get_msr_common</span><br></pre></td></tr></table></figure>

<p>look into <code>kvm_hv_get_msr_common</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kvm_hv_get_msr_common</span><span class="params">(struct kvm_vcpu *vcpu, u32 msr, u64 *pdata, <span class="keyword">bool</span> host)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (kvm_hv_msr_partition_wide(msr)) &#123;</span><br><span class="line">		<span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">		mutex_lock(&amp;vcpu-&gt;kvm-&gt;arch.hyperv.hv_lock);</span><br><span class="line">		r = kvm_hv_get_msr_pw(vcpu, msr, pdata);</span><br><span class="line">		mutex_unlock(&amp;vcpu-&gt;kvm-&gt;arch.hyperv.hv_lock);</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> kvm_hv_get_msr(vcpu, msr, pdata, host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because msr count matches:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static bool kvm_hv_msr_partition_wide(u32 msr)</span><br><span class="line">&#123;</span><br><span class="line">	bool r &#x3D; false;</span><br><span class="line"></span><br><span class="line">	switch (msr) &#123;</span><br><span class="line">	case HV_X64_MSR_GUEST_OS_ID:</span><br><span class="line">	case HV_X64_MSR_HYPERCALL:</span><br><span class="line">	case HV_X64_MSR_REFERENCE_TSC:</span><br><span class="line">	case HV_X64_MSR_TIME_REF_COUNT:</span><br><span class="line">	case HV_X64_MSR_CRASH_CTL:</span><br><span class="line">	case HV_X64_MSR_CRASH_P0 ... HV_X64_MSR_CRASH_P4:</span><br><span class="line">	case HV_X64_MSR_RESET:</span><br><span class="line">		r &#x3D; true;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so the read fall into <code>kvm_hv_get_msr_pw</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> HV_X64_MSR_TIME_REF_COUNT:</span><br><span class="line">	<span class="comment">/* read-only, but still ignore it if host-initiated */</span></span><br><span class="line">	<span class="keyword">if</span> (!host)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>and finally return 1 or report </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vcpu_unimpl(vcpu, <span class="string">&quot;Hyper-V uhandled wrmsr: 0x%x data 0x%llx\n&quot;</span>,</span><br><span class="line">	    msr, data);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>come to here it seems a guest bug and according to: <a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/12/10/first-steps-in-hyper-v-research/">https://msrc-blog.microsoft.com/2018/12/10/first-steps-in-hyper-v-research/</a> we can get some information about <code>EXIT_REASON_MSR_READ</code></p>
<p>that</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hyper-V handles MSR access (both read and write) in its VMEXIT loop handler. It’s easy to see it in IDA: it’s a large switch case over all the MSRs supported values, with the default case of falling back to rdmsr&#x2F;wrmsr, if that MSR doesn’t have special treatment by the hypervisor. Note that there are authentication checks in the MSR read&#x2F;write handlers, checking the current partition permissions. From there we can find the different MSRs Hyper-V supports, and the functions to handle read and write.</span><br></pre></td></tr></table></figure>

<p>So it seems a Hyper-V feature to access the MSR timeout ref count.</p>
<p>Check qemu doc about ‘Hyper-V Enlightenments’, it explains the usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hv-time</span><br><span class="line">Enables two Hyper-V-specific clocksources available to the guest: MSR-based Hyper-V clocksource (HV_X64_MSR_TIME_REF_COUNT, 0x40000020) and Reference TSC page (enabled via MSR HV_X64_MSR_REFERENCE_TSC, 0x40000021). Both clocksources are per-guest, Reference TSC page clocksource allows for exit-less time stamp readings. Using this enlightenment leads to significant speedup of all timestamp related operations.</span><br></pre></td></tr></table></figure>

<p>and used for speedup of all timestamp related operations but in this case the guest do not response as a result.</p>
<p>And come to here, I noticed that when guest migrated, some lines come into qemu.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2022-11-16T09:53:19.529516Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br><span class="line">2022-11-16T09:53:19.533393Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br><span class="line">2022-11-16T09:53:19.533626Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br><span class="line">2022-11-16T09:53:19.533816Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br></pre></td></tr></table></figure>

<p>qemu-kvm warning TSC frequency mismatched which normally not occurs for guest.</p>
<p>When check kernel code, we can see that:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kvm_arch_set_tsc_khz</span><span class="params">(CPUState *cs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    X86CPU *cpu = X86_CPU(cs);</span><br><span class="line">    CPUX86State *env = &amp;cpu-&gt;env;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!env-&gt;tsc_khz) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = kvm_check_extension(cs-&gt;kvm_state, KVM_CAP_TSC_CONTROL) ?</span><br><span class="line">        kvm_vcpu_ioctl(cs, KVM_SET_TSC_KHZ, env-&gt;tsc_khz) :</span><br><span class="line">        -ENOTSUP;</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* When KVM_SET_TSC_KHZ fails, it&#x27;s an error only if the current</span></span><br><span class="line"><span class="comment">         * TSC frequency doesn&#x27;t match the one we want.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> cur_freq = kvm_check_extension(cs-&gt;kvm_state, KVM_CAP_GET_TSC_KHZ) ?</span><br><span class="line">                       kvm_vcpu_ioctl(cs, KVM_GET_TSC_KHZ) :</span><br><span class="line">                       -ENOTSUP;</span><br><span class="line">        <span class="keyword">if</span> (cur_freq &lt;= <span class="number">0</span> || cur_freq != env-&gt;tsc_khz) &#123;</span><br><span class="line">            warn_report(<span class="string">&quot;TSC frequency mismatch between &quot;</span></span><br><span class="line">                        <span class="string">&quot;VM (%&quot;</span> PRId64 <span class="string">&quot; kHz) and host (%d kHz), &quot;</span></span><br><span class="line">                        <span class="string">&quot;and TSC scaling unavailable&quot;</span>,</span><br><span class="line">                        env-&gt;tsc_khz, cur_freq);</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>qemu tries to KVM_SET_TSC_KHZ but failed will show thoes lines. </p>
<p>From hypervisor functional specification:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The TscScale value is used to adjust the Virtual TSC value across migration events to mitigate TSC frequency changes from one platform to another.</span><br></pre></td></tr></table></figure>

<p>used to cut down the mitigate TSC frequency change for guest.</p>
<p>So look for qemu code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (level == KVM_PUT_FULL_STATE) &#123;</span><br><span class="line">    <span class="comment">/* We don&#x27;t check for kvm_arch_set_tsc_khz() errors here,</span></span><br><span class="line"><span class="comment">     * because TSC frequency mismatch shouldn&#x27;t abort migration,</span></span><br><span class="line"><span class="comment">     * unless the user explicitly asked for a more strict TSC</span></span><br><span class="line"><span class="comment">     * setting (e.g. using an explicit &quot;tsc-freq&quot; option).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    kvm_arch_set_tsc_khz(cpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>during live migration, this trace will be printed but do not abort migration.</p>
<p>Indeed, newer nvidia driver do not require kvm hidden: <a target="_blank" rel="noopener" href="https://www.heiko-sieger.info/passing-through-a-nvidia-rtx-2070-super-gpu/">https://www.heiko-sieger.info/passing-through-a-nvidia-rtx-2070-super-gpu/</a> so the concerns about the use case maybe not necessary.</p>
<p>I write a mail to community to discuss if there is any better way to solve the problem.</p>
<p><a target="_blank" rel="noopener" href="https://lists.nongnu.org/archive/html/qemu-discuss/2022-11/msg00028.html">https://lists.nongnu.org/archive/html/qemu-discuss/2022-11/msg00028.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/11/16/uefi-windows-guest-hang-after-live-migration/" data-id="cld1mhecc0069yuwbhe993dgf" data-title="UEFI Windows guest hang after live migration" class="article-share-link">Share</a>
      
      
        <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/11/16/uefi-windows-guest-hang-after-live-migration/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-plugable-system-in-practice-00" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/11/09/plugable-system-in-practice-00/" class="article-date">
  <time class="dt-published" datetime="2022-11-08T17:43:05.000Z" itemprop="datePublished">2022-11-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/arch-notes/">arch-notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/11/09/plugable-system-in-practice-00/">Plugable system in practice 00</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This blog used to introduce a practice of plugin system implementation of zstack.</p>
<p>I will finish base of plugin load, metadate definition, capability negotiation and usage part of Java. And following section describe abstractions of this implementation.</p>
<h2 id="Abstractions"><a href="#Abstractions" class="headerlink" title="Abstractions"></a>Abstractions</h2><p>I make some abstractions to satisfy our aim.</p>
<ul>
<li>Unique identifer to find plugin and execute it</li>
<li>Capability negotiation and version information</li>
<li>Observer pattern to keep all modules use same way access plugin</li>
</ul>
<h3 id="PluginInterface"><a href="#PluginInterface" class="headerlink" title="PluginInterface"></a>PluginInterface</h3><p>Plugin capability currently defines SUPPORTED and UNSUPPORTED for plugin definition</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">PluginCapabilityState</span> </span>&#123;</span><br><span class="line">    SUPPORTED,</span><br><span class="line">    UNSUPPORTED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Define a plugin interface including three methods:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginInterface</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">pluginUniqueName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">version</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Map&lt;String, PluginCapabilityState&gt; <span class="title">capabilities</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>note: capabilities offer a map about custom plugin and expected use enum value</p>
<p>use reflection to collect interfaces extend this interface as the metadata of all kinds of plugins:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginEndpointSender</span> <span class="keyword">extends</span> <span class="title">PluginInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">send</span><span class="params">(PluginEndpointData message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so we need a manage class as the factory of plugin</p>
<h3 id="PluginManager"><a href="#PluginManager" class="headerlink" title="PluginManager"></a>PluginManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCapabilitySupported</span><span class="params">(String pluginName, String capability)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;T extends PluginInterface&gt; <span class="function">T <span class="title">getPlugin</span><span class="params">(Class&lt;? extends PluginInterface&gt; pluginClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this class defines two methods, first one used to report plugin capability and another one return singleton plugin.</p>
<p>And in order to reduce complexity, only scan interfaces under abstraction module as meta interfaces</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Platform.getReflections().getSubTypesOf(PluginInterface.class).forEach(clz -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!clz.getCanonicalName().contains(<span class="string">&quot;org.zstack.abstraction&quot;</span>)</span><br><span class="line">            || !clz.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interfaceMetadata.contains(clz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CloudRuntimeException(</span><br><span class="line">                String.format(<span class="string">&quot;duplicate PluginProtocol[name: %s]&quot;</span>, clz));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    interfaceMetadata.add(clz);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>then load plugin instances from meta class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">interfaceMetadata.forEach(clz -&gt; Platform.getReflections().getSubTypesOf(clz)</span><br><span class="line">        .forEach(pluginInstanceClz -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PluginInterface pluginInterface = pluginInstanceClz.getConstructor().newInstance();</span><br><span class="line">        <span class="keyword">if</span> (pluginInstances.containsKey(pluginInterface.pluginUniqueName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CloudRuntimeException(String.format(<span class="string">&quot;duplicate plugin[class: %s]&quot;</span>,</span><br><span class="line">                    pluginInstanceClz));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pluginInstances.put(pluginInstanceClz, pluginInterface);</span><br><span class="line">        logger.debug(String.format(<span class="string">&quot;load plugin: %s, name: %s,  capabilities: \n %s&quot;</span>,</span><br><span class="line">                pluginInterface.version(),</span><br><span class="line">                pluginInterface.pluginUniqueName(),</span><br><span class="line">                JSONObjectUtil.toJsonString(pluginInterface.capabilities())));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CloudRuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>class will be used as the key and instance singleton will be stored and ready to use.</p>
<p>Use getPlugin could get the singleton. But currently version and uniqueName do not have specific usage but capabilties could be used to check if the plugin support the feature.</p>
<p>Version is used to check pluginInterface’s compatibility if pluginInterface has any uncompatible change, old version of plugin can run under compatible mode or just rejects load the plugin.</p>
<p>And now all plugins implemented pluginInterface will be loaded and not security check which should be done in pluginInterface and I will design it in next blogs.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Now I implemented part of loading the plugin, for usage is quite easy because developer only need to store the plugin class name as a variable to access the plugin but current safety issue is still should cared by all modules use plugin manager. So in next blog, I will do more works to resolve security requirements.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/11/09/plugable-system-in-practice-00/" data-id="cld1mheb1001ayuwbaify0xrq" data-title="Plugable system in practice 00" class="article-share-link">Share</a>
      
      
        <a href="/2022/11/09/plugable-system-in-practice-00/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/11/09/plugable-system-in-practice-00/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jvm-loaded-classes-rapidly-increased-issue" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/" class="article-date">
  <time class="dt-published" datetime="2022-10-31T06:59:31.000Z" itemprop="datePublished">2022-10-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/">JVM loaded classes rapidly increased issue</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Rapidly-increased-JVM-loaded-classes"><a href="#Rapidly-increased-JVM-loaded-classes" class="headerlink" title="Rapidly increased JVM loaded classes"></a>Rapidly increased JVM loaded classes</h2><p>When debug a oom issue on new version of application. I noticed that </p>
<p>Old version:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.46.48.png" class="">

<p>New version:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.46.40.png" class="">

<p>The classes increased almost twice compare to the old version.</p>
<p>So I just export loaded classes to figure out what classes increased at first.</p>
<p>After a compare, we got a obvious increased class:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.55.30.png" class="">

<p>for the new version</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.55.36.png" class="">

<p>about 25000 Doc classes is loaded and 45439 + 25000 = 70439 seems very near to 74.3k.</p>
<p>So check the heap dump by Dominator tree, by comparing heap usage, one class come into view is that:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-18.05.04.png" class="">

<h2 id="Code-reading"><a href="#Code-reading" class="headerlink" title="Code reading"></a>Code reading</h2><p>ZStack use reflections to get information and offer framework level capabilities.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Reflections reflections = <span class="keyword">new</span> Reflections(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> SubTypesScanner(), <span class="keyword">new</span> MethodAnnotationsScanner(), <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">        <span class="keyword">new</span> TypeAnnotationsScanner(), <span class="keyword">new</span> MethodParameterScanner());</span><br></pre></td></tr></table></figure>

<p>for reflections-0.9.10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    Vfs.Dir dir = Vfs.fromURL(url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Vfs.File file : dir.getFiles()) &#123;</span><br><span class="line">            <span class="comment">// scan if inputs filter accepts file relative path or fqn</span></span><br><span class="line">            Predicate&lt;String&gt; inputsFilter = configuration.getInputsFilter();</span><br><span class="line">            String path = file.getRelativePath();</span><br><span class="line">            String fqn = path.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (inputsFilter == <span class="keyword">null</span> || inputsFilter.apply(path) || inputsFilter.apply(fqn)) &#123;</span><br><span class="line">                Object classObject = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (scanner.acceptsInput(path) || scanner.acceptResult(fqn)) &#123;</span><br><span class="line">                            classObject = scanner.scan(file, classObject);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.isDebugEnabled())</span><br><span class="line">                            log.debug(<span class="string">&quot;could not scan file &quot;</span> + file.getRelativePath() + <span class="string">&quot; in url &quot;</span> + url.toExternalForm() + <span class="string">&quot; with scanner &quot;</span> + scanner.getClass().getSimpleName(), e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        dir.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>with a groovy closure <code>org.zstack.sso.header.APICreateCasClientEventDoc_zh_cn$_run_closure1</code></p>
<p>this part of code executed will skip filter and goes throught all scanners with their acceptsInput and acceptResult directly</p>
<p>refer to ZStack used Scanner, following code will be used:</p>
<p>FieldAnnotationsScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldAnnotationsScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line">        List&lt;Object&gt; fields = getMetadataAdapter().getFields(cls);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Object field : fields) &#123;</span><br><span class="line">            List&lt;String&gt; fieldAnnotations = getMetadataAdapter().getFieldAnnotationNames(field);</span><br><span class="line">            <span class="keyword">for</span> (String fieldAnnotation : fieldAnnotations) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (acceptResult(fieldAnnotation)) &#123;</span><br><span class="line">                    String fieldName = getMetadataAdapter().getFieldName(field);</span><br><span class="line">                    getStore().put(fieldAnnotation, String.format(<span class="string">&quot;%s.%s&quot;</span>, className, fieldName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SubTypeScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubTypesScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** created new SubTypesScanner. will exclude direct Object subtypes */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubTypesScanner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>); <span class="comment">//exclude direct Object subtypes by default</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** created new SubTypesScanner.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> excludeObjectClass if false, include direct &#123;<span class="doctag">@link</span> Object&#125; subtypes in results.  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubTypesScanner</span><span class="params">(<span class="keyword">boolean</span> excludeObjectClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (excludeObjectClass) &#123;</span><br><span class="line">            filterResultsBy(<span class="keyword">new</span> FilterBuilder().exclude(Object.class.getName())); <span class="comment">//exclude direct Object subtypes</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">		String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line">		String superclass = getMetadataAdapter().getSuperclassName(cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acceptResult(superclass)) &#123;</span><br><span class="line">            getStore().put(superclass, className);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String anInterface : (List&lt;String&gt;) getMetadataAdapter().getInterfacesNames(cls)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (acceptResult(anInterface)) &#123;</span><br><span class="line">                getStore().put(anInterface, className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MethodAnnotationsScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAnnotationsScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object method : getMetadataAdapter().getMethods(cls)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String methodAnnotation : (List&lt;String&gt;) getMetadataAdapter().getMethodAnnotationNames(method)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (acceptResult(methodAnnotation)) &#123;</span><br><span class="line">                    getStore().put(methodAnnotation, getMetadataAdapter().getMethodFullKey(cls, method));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TypeAnnotationsScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeAnnotationsScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String annotationType : (List&lt;String&gt;) getMetadataAdapter().getClassAnnotationNames(cls)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (acceptResult(annotationType) ||</span><br><span class="line">                annotationType.equals(Inherited.class.getName())) &#123; <span class="comment">//as an exception, accept Inherited as well</span></span><br><span class="line">                getStore().put(annotationType, className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MethodParameterScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(Object cls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> MetadataAdapter md = getMetadataAdapter();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object method : md.getMethods(cls)) &#123;</span><br><span class="line"></span><br><span class="line">            String signature = md.getParameterNames(method).toString();</span><br><span class="line">            <span class="keyword">if</span> (acceptResult(signature)) &#123;</span><br><span class="line">                getStore().put(signature, md.getMethodFullKey(cls, method));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String returnTypeName = md.getReturnTypeName(method);</span><br><span class="line">            <span class="keyword">if</span> (acceptResult(returnTypeName)) &#123;</span><br><span class="line">                getStore().put(returnTypeName, md.getMethodFullKey(cls, method));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; parameterNames = md.getParameterNames(method);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterNames.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object paramAnnotation : md.getParameterAnnotationNames(method, i)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (acceptResult((String) paramAnnotation)) &#123;</span><br><span class="line">                        getStore().put((String) paramAnnotation, md.getMethodFullKey(cls, method));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All of them only offer scan and not extra processes were defined.</p>
<p>Check abount their <code>acceptsInput()</code> and <code>acceptResult()</code> methods from AbstractScanner:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptsInput</span><span class="params">(String file)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> getMetadataAdapter().acceptsInput(file);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptResult</span><span class="params">(<span class="keyword">final</span> String fqn)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> fqn != <span class="keyword">null</span> &amp;&amp; resultFilter.apply(fqn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>acceptResult will be used by SubTypesScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SubTypesScanner</span><span class="params">(<span class="keyword">boolean</span> excludeObjectClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (excludeObjectClass) &#123;</span><br><span class="line">        filterResultsBy(<span class="keyword">new</span> FilterBuilder().exclude(Object.class.getName())); <span class="comment">//exclude direct Object subtypes</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>to reject direct Object subtypes</p>
<p>and acceptsInput use metadataAdapter(JavassistAdapter.java)，check if file end with .class</p>
<p>so for reflections-0.9.10 if groovy closure file exists will <code>.class</code> suffix and not extend object directly, will be loaded by reflection.</p>
<p>After upgrade to reflections-0.10.2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(configuration.isParallel() ? urls.stream().parallel() : urls.stream()).forEach(url -&gt; &#123;</span><br><span class="line">    Vfs.Dir dir = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        dir = Vfs.fromURL(url);</span><br><span class="line">        <span class="keyword">for</span> (Vfs.File file : dir.getFiles()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (doFilter(file, configuration.getInputsFilter())) &#123;</span><br><span class="line">                ClassFile classFile = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (doFilter(file, scanner::acceptsInput)) &#123;</span><br><span class="line">                            List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</span><br><span class="line">                            <span class="keyword">if</span> (entries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (classFile == <span class="keyword">null</span>) classFile = getClassFile(file);</span><br><span class="line">                                entries = scanner.scan(classFile);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (entries != <span class="keyword">null</span>) collect.get(scanner.index()).addAll(entries);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.trace(<span class="string">&quot;could not scan file &#123;&#125; with scanner &#123;&#125;&quot;</span>, file.getRelativePath(), scanner.getClass().getSimpleName(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.warn(<span class="string">&quot;could not create Vfs.Dir from url. ignoring the exception and continuing&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dir != <span class="keyword">null</span>) dir.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>code of scan changed to new version and scanners moved to enum</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Scanners</span> <span class="keyword">implements</span> <span class="title">Scanner</span>, <span class="title">QueryBuilder</span>, <span class="title">NameHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan type superclasses and interfaces</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;i&gt;Note that &#123;<span class="doctag">@code</span> Object&#125; class is excluded by default, in order to reduce store size.</span></span><br><span class="line"><span class="comment">     * &lt;br&gt;Use &#123;<span class="doctag">@link</span> #filterResultsBy(Predicate)&#125; to change, for example &#123;<span class="doctag">@code</span> SubTypes.filterResultsBy(c -&gt; true)&#125;&lt;/i&gt;</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    SubTypes &#123;</span><br><span class="line">        <span class="comment">/* Object class is excluded by default from subtypes indexing */</span></span><br><span class="line">        &#123; filterResultsBy(<span class="keyword">new</span> FilterBuilder().excludePattern(<span class="string">&quot;java\\.lang\\.Object&quot;</span>)); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            entries.add(entry(classFile.getSuperclass(), classFile.getName()));</span><br><span class="line">            entries.addAll(entries(Arrays.asList(classFile.getInterfaces()), classFile.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan method annotations */</span></span><br><span class="line">    MethodsAnnotated &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            getMethods(classFile).forEach(method -&gt;</span><br><span class="line">                entries.addAll(entries(getAnnotations(method::getAttribute), methodName(classFile, method))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** scan field annotations */</span></span><br><span class="line">    FieldsAnnotated &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            classFile.getFields().forEach(field -&gt;</span><br><span class="line">                entries.addAll(entries(getAnnotations(field::getAttribute), fieldName(classFile, field))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan type annotations */</span></span><br><span class="line">    TypesAnnotated &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptResult</span><span class="params">(String annotation)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.acceptResult(annotation) || annotation.equals(Inherited.class.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            entries.addAll(entries(getAnnotations(classFile::getAttribute), classFile.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan method parameters types and annotations */</span></span><br><span class="line">    MethodsParameter &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            getMethods(classFile).forEach(method -&gt; &#123;</span><br><span class="line">                String value = methodName(classFile, method);</span><br><span class="line">                entries.addAll(entries(getParameters(method), value));</span><br><span class="line">                getParametersAnnotations(method).forEach(annotations -&gt; entries.addAll(entries(annotations, value)));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>almost same logic is supported but check details about the scan() method</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doFilter(file, scanner::acceptsInput)) &#123;</span><br><span class="line">            List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</span><br><span class="line">            <span class="keyword">if</span> (entries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (classFile == <span class="keyword">null</span>) classFile = getClassFile(file);</span><br><span class="line">                entries = scanner.scan(classFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entries != <span class="keyword">null</span>) collect.get(scanner.index()).addAll(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.trace(<span class="string">&quot;could not scan file &#123;&#125; with scanner &#123;&#125;&quot;</span>, file.getRelativePath(), scanner.getClass().getSimpleName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>acceptsInput will be used to do filter which check file end with <code>.class</code> suffix but filterResultsBy is not executed only if <code>entries = scanner.scan(classFile)</code> is used.</p>
<p>So when <code>List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</code> return entries the result won’t be exclude.</p>
<h2 id="Hands-on-test"><a href="#Hands-on-test" class="headerlink" title="Hands-on test"></a>Hands-on test</h2><p>I set up a maven project to test reflections issue with a project:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-14-14.25.25.png" class="">

<p>and main code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zstack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.reflections.Reflections;</span><br><span class="line"><span class="keyword">import</span> org.reflections.scanners.*;</span><br><span class="line"><span class="keyword">import</span> org.reflections.util.ClasspathHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReflections</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">        printLoadedClasses(<span class="keyword">null</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// reflections 0.9.10</span></span><br><span class="line">        Reflections reflections = <span class="keyword">new</span> Reflections(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> SubTypesScanner(<span class="keyword">false</span>), <span class="keyword">new</span> MethodAnnotationsScanner(), <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">            <span class="keyword">new</span> TypeAnnotationsScanner(), <span class="keyword">new</span> MethodParameterScanner());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reflections 0.10.2</span></span><br><span class="line"><span class="comment">//        Reflections reflections = new Reflections(ClasspathHelper.forPackage(&quot;org.zstack&quot;),</span></span><br><span class="line"><span class="comment">//            new SubTypesScanner(false), new MethodAnnotationsScanner(), new FieldAnnotationsScanner(),</span></span><br><span class="line"><span class="comment">//            new TypeAnnotationsScanner(), new MethodParameterScanner());</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">        printLoadedClasses(reflections);</span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printLoadedClasses</span><span class="params">(Reflections reflections)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reflections != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Set&lt;String&gt; types = reflections.getAllTypes();</span><br><span class="line"></span><br><span class="line">            types.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;loaded class number from reflection: &quot;</span> + types.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;loaded class number from jmx: &quot;</span> + ManagementFactory.getClassLoadingMXBean().getLoadedClassCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>finally the output of reflections 0.10.2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">groovy.lang.GroovyObject</span><br><span class="line">java.lang.Cloneable</span><br><span class="line">org.codehaus.groovy.runtime.GeneratedClosure</span><br><span class="line">groovy.lang.GroovyObjectSupport</span><br><span class="line">groovy.lang.Closure</span><br><span class="line">java.util.concurrent.Callable</span><br><span class="line">java.lang.Object</span><br><span class="line">groovy.lang.GroovyCallable</span><br><span class="line">groovy.lang.Script</span><br><span class="line">java.lang.Runnable</span><br><span class="line">java.io.Serializable</span><br><span class="line">org.test.TestGroovy2$_run_closure1</span><br><span class="line">org.zstack.TestGroovy2$_run_closure1</span><br><span class="line">org.test.TestGroovy$_run_closure1</span><br><span class="line">org.zstack.TestGroovy$_run_closure1$_closure2</span><br><span class="line">org.zstack.TestGroovy$_run_closure1</span><br><span class="line">org.zstack.TestGroovy3$_run_closure1$_closure2</span><br><span class="line">org.test.TestGroovy$_run_closure1$_closure2</span><br><span class="line">org.test.TestGroovy3$_run_closure1$_closure2</span><br><span class="line">org.test.TestGroovy3$_run_closure1</span><br><span class="line">org.test.TestGroovy2$_run_closure1$_closure2</span><br><span class="line">org.zstack.TestGroovy2$_run_closure1$_closure2</span><br><span class="line">org.zstack.TestGroovy3$_run_closure1</span><br><span class="line">org.zstack.TestReflections</span><br><span class="line">org.test.TestGroovy2</span><br><span class="line">org.test.TestGroovy3</span><br><span class="line">org.zstack.TestGroovy</span><br><span class="line">org.test.TestGroovy</span><br><span class="line">org.zstack.TestGroovy2</span><br><span class="line">org.zstack.TestGroovy3</span><br><span class="line">loaded class number from reflection: 30</span><br></pre></td></tr></table></figure>

<p>and the reflection 0.10.9:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.zstack.TestReflections</span><br><span class="line">loaded class number from reflection: 1</span><br></pre></td></tr></table></figure>

<p>we can found out that even a specified reflection from class path <code>org.zstack</code> unrelated class still appears.</p>
<p>So I just goolge the reflection issue, it come out directly:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ronmamo/reflections/issues/373">https://github.com/ronmamo/reflections/issues/373</a></p>
<p>we can solve this issue by adding some workaround</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflections 0.10.2</span></span><br><span class="line">ConfigurationBuilder builder = ConfigurationBuilder.build()</span><br><span class="line">        .setUrls(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>))</span><br><span class="line">        .setScanners(<span class="keyword">new</span> SubTypesScanner(<span class="keyword">false</span>),</span><br><span class="line">                <span class="keyword">new</span> MethodAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> TypeAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> MethodParameterScanner())</span><br><span class="line">        .setExpandSuperTypes(<span class="keyword">false</span>)</span><br><span class="line">        .filterInputsBy(<span class="keyword">new</span> FilterBuilder().includePackage(<span class="string">&quot;org.zstack&quot;</span>));</span><br><span class="line">Reflections reflections = <span class="keyword">new</span> Reflections(builder);</span><br></pre></td></tr></table></figure>

<h2 id="Where-is-root-cause"><a href="#Where-is-root-cause" class="headerlink" title="Where is root cause"></a>Where is root cause</h2><p>But after a solve the problem by add some hack for reflections, I still want to known what is the root cause.</p>
<p>So I check the code again try to find out what happened.</p>
<p>Compare scanners between 0.10.2 and 0.9.10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SubTypes</span></span><br><span class="line"><span class="comment">// reflections 0.10.2</span></span><br><span class="line">entries.add(<span class="keyword">this</span>.entry(classFile.getSuperclass(), classFile.getName()));</span><br><span class="line">entries.addAll(<span class="keyword">this</span>.entries(Arrays.asList(classFile.getInterfaces()), classFile.getName()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// reflections 0.9.10</span></span><br><span class="line">filterResultsBy(<span class="keyword">new</span> FilterBuilder().exclude(Object.class.getName())); <span class="comment">//exclude direct Object subtypes</span></span><br><span class="line"></span><br><span class="line">String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line">String superclass = getMetadataAdapter().getSuperclassName(cls);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (acceptResult(superclass)) &#123;</span><br><span class="line">    getStore().put(superclass, className);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String anInterface : (List&lt;String&gt;) getMetadataAdapter().getInterfacesNames(cls)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (acceptResult(anInterface)) &#123;</span><br><span class="line">        getStore().put(anInterface, className);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0.9.10 will filter the superclass before put it into reflections store but 0.10.2 use it directly.</p>
<p>in 0.9.10 scan works like following:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inputsFilter == <span class="keyword">null</span> || inputsFilter.apply(path) || inputsFilter.apply(fqn)) &#123;</span><br><span class="line">    Object classObject = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanner.acceptsInput(path) || scanner.acceptResult(fqn)) &#123;</span><br><span class="line">                classObject = scanner.scan(file, classObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.isDebugEnabled())</span><br><span class="line">                log.debug(<span class="string">&quot;could not scan file &quot;</span> + file.getRelativePath() + <span class="string">&quot; in url &quot;</span> + url.toExternalForm() + <span class="string">&quot; with scanner &quot;</span> + scanner.getClass().getSimpleName(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>scanner will check fqn of class first and then check the interface but in 0.10.2 version:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doFilter(file, scanner::acceptsInput)) &#123;</span><br><span class="line">            List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</span><br><span class="line">            <span class="keyword">if</span> (entries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (classFile == <span class="keyword">null</span>) classFile = getClassFile(file);</span><br><span class="line">                entries = scanner.scan(classFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entries != <span class="keyword">null</span>) collect.get(scanner.index()).addAll(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.trace(<span class="string">&quot;could not scan file &#123;&#125; with scanner &#123;&#125;&quot;</span>, file.getRelativePath(), scanner.getClass().getSimpleName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>File will be checked before scan by Filter but superclass’s belonging is not checked which seems to blame.</p>
<p>But actually, groovy closure does not extend Object but GroovyObject, so reflections will still load groovy closures. So check reflections <code>getAllTypes()</code></p>
<p>for 0.9.10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAllTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; allTypes = Sets.newHashSet(store.getAll(index(SubTypesScanner.class), Object.class.getName()));</span><br><span class="line">    <span class="keyword">if</span> (allTypes.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionsException(<span class="string">&quot;Couldn&#x27;t find subtypes of Object. &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Make sure SubTypesScanner initialized to include Object class - new SubTypesScanner(false)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allTypes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for 0.10.2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAll</span><span class="params">(Scanner scanner)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Set&lt;String&gt;&gt; map = store.getOrDefault(scanner.index(), Collections.emptyMap());</span><br><span class="line">    <span class="keyword">return</span> Stream.concat(map.keySet().stream(), map.values().stream().flatMap(Collection::stream)).collect(Collectors.toCollection(LinkedHashSet::<span class="keyword">new</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All most same but in 0.9.10 Object related types will be returned. So as a result, only java objects is returned.</p>
<p>Work around on 0.10.2 can use following codes:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationBuilder builder = ConfigurationBuilder.build()</span><br><span class="line">        .setUrls(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>))</span><br><span class="line">        .setScanners(<span class="keyword">new</span> SubTypesScanner(<span class="keyword">false</span>),</span><br><span class="line">                <span class="keyword">new</span> MethodAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> TypeAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> MethodParameterScanner())</span><br><span class="line">        .setExpandSuperTypes(<span class="keyword">false</span>)</span><br><span class="line">        .filterInputsBy(<span class="keyword">new</span> FilterBuilder().includePackage(<span class="string">&quot;org.zstack&quot;</span>));</span><br><span class="line">Reflections reflections = <span class="keyword">new</span> Reflections(builder);</span><br></pre></td></tr></table></figure>

<p>filterInputsBy will filter class not in package <code>org.zstack</code> and setExpandSuperTypes will ignore super types of scanned result.</p>
<p>Note: but the result still contains groovy closure even its count cut down to acceptable numbers.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/" data-id="cld1mhecb0062yuwb8beu03im" data-title="JVM loaded classes rapidly increased issue" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-windows-2003-vmware-v2v-hands-on" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/27/windows-2003-vmware-v2v-hands-on/" class="article-date">
  <time class="dt-published" datetime="2022-10-27T07:27:12.000Z" itemprop="datePublished">2022-10-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/v2v/">v2v</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/27/windows-2003-vmware-v2v-hands-on/">Windows 2003 vmware v2v hands-on</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>When use virt-v2v to convert vm from vmware to kvm, windows guest sometimes meet issue after start on kvm. For quite old windows os version, typically windows 2003, may meet following blue screen issue:</p>
<img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/image-2022-10-09-21-15-41-292.png" class="">

<p>with code 0x0000007B.</p>
<p>So I write a hands-on blog to help fix this issue.</p>
<p>When search for this error on vmware kb or MSDN, we can find out that, wrong driver is the main reason cause this problem.</p>
<p>Usually, it’s recommanded to do following check for the v2v vm:</p>
<ol>
<li>Confirm the vm running well on original host, if its already error check configuration first.</li>
<li>Check if virt-v2v failed to install virtio driver to guest during virt-v2v convert.</li>
<li>Check kvm configuration, that root disk use ide to keep compitable.</li>
<li>Check if windows disabled driver installatin by its group policy.</li>
</ol>
<p>Besides those issues, if you migrate a windows 2003 with cd-rom you will also met this blue screen issue. Due to windows will change device order after v2v and root disk not work as expected.</p>
<p>So I write this practical blog to resolve device changed issue on windows 2003 v2v.</p>
<ol>
<li><p>Uninstall vmware guest tools and drivers (avoid failed to install driver issue)</p>
</li>
<li><p>Change the disk controller to ide and reboot guest</p>
<img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.13.33.png" class="">
</li>
<li><p>Attach MergeIde.iso to guest</p>
<img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.13.43.png" class="">
<p>the iso contains a .reg and a .bat file. Run the .reg first and run the .bat. The device will be recorded and prepare for hypervisor change.</p>
</li>
<li><img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.14.29.png" class="">
<p>export ovf template or use virt-v2v to export the vm the kvm.</p>
</li>
<li><img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.10.01.png" class="">
<p>check the vm started without blue screen.</p>
</li>
</ol>
<p>For windows, it seems that with cd-rom or disk order changed guest, after hypervisor migration, windows can not identify the original order of thoes devices due to hardware change. So record the device seems a easy solution for v2v case.</p>
<p>Note: this solution is also useful for Windows XP v2v</p>
<p>Download MergeIDE.iso from: <a target="_blank" rel="noopener" href="https://www.virtualbox.org/wiki/Migrate_Windows">https://www.virtualbox.org/wiki/Migrate_Windows</a></p>
<p>Refer to Microsoft commands: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-US/troubleshoot/windows-client/performance/stop-error-7b-or-inaccessible-boot-device-troubleshooting">https://learn.microsoft.com/en-US/troubleshoot/windows-client/performance/stop-error-7b-or-inaccessible-boot-device-troubleshooting</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/27/windows-2003-vmware-v2v-hands-on/" data-id="cld1mheb6001lyuwb9nbs97t5" data-title="Windows 2003 vmware v2v hands-on" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/27/windows-2003-vmware-v2v-hands-on/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/27/windows-2003-vmware-v2v-hands-on/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-plugable-architecture-design-and-thoughts-about-implementation" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" class="article-date">
  <time class="dt-published" datetime="2022-10-20T16:45:32.000Z" itemprop="datePublished">2022-10-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/arch-notes/">arch-notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/">Plugable module architecture design and thoughts about its implementation</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Software’s complexity grows as time goes by which is suitable to describe ZStack now. Quantities of features has been integrated in the past years and developers suffered on customizing features for some commercial reasons which pushed us to think about how to get rid of customizing feature efforts and focus   on core function to earn more technical advantages.</p>
<p>Generallly, customizing features is harmful when compared to normal features (but maybe it can get commercial benifits so do not take this as absolute     rule), because more customers use normal features.</p>
<p>But because some integration requests already designed which not only require maintainance but also need development for new integration. For example, a feature for security is desing to use third-part machine to do encryption，but when customer use the feature, they all use different machine which caused lots of development cost for us to do the integrations.</p>
<p>In these cases, a plugable architecture is required to cut down the cost and this is the reason to write this blog to record related design and make it a repeatable practice.</p>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><p>For existing systems which need to support multi types of resources, typically use a register way to connect the management layer and application layers. And the application layers use a couple of standard interfaces to keep consistency and seperate implementation from mechanism.</p>
<p>So for the aim of delveloping a plugable module architecture if we still follows the pattern, easily we will be distrubed by the change of core codes from the mechanism. For example, if the core changes the mechanism as a result, application should change all of the interfaces as expected, so development is required which is not satisfied with out target.</p>
<p>Just after that small think, list all requirements before starting design. Following points are the aim of this architecture:</p>
<ul>
<li>Low development efforts or configuration as a service.</li>
<li>No core code dependency. Any changes to mechanism should be avoid.</li>
<li>Security. Plugin module should not cause any security issue.</li>
</ul>
<p>Base on those points, the architecture should be changed to expose its mechanism by interfaces.</p>
<p>For example</p>
<ol>
<li>read plugin configuration and verify it</li>
<li>generate code proxy according to the configuration</li>
<li>limited db access controled by the code proxy</li>
<li>Invokations can be verified by unit test to check the plugin can work as expected</li>
<li>change the configuration the refresh it could update the code proxy</li>
<li>plugin configurations use a specified syntax</li>
<li>if code proxy support runtime refresh can be configured</li>
</ol>
<p>From writing configurations, functional features can be easily supported.</p>
<p>If any requests need data structure support, a configuration map shoud be support for more customize and in this way we can easily create a http client to support some modules.</p>
<p>But if customize feature use any third-part libs, only configuration is not enough to support.</p>
<p>For code level, maybe open source interfaces is still needed.</p>
<p>We should offer read only data structure and functional interfaces but should not involve core codes of Java which in most cases, are aspectj support, spring containers and so on. Only pure java should be used for all plugin modules.</p>
<p>In next section, we will raise examples of two module, one is not suitable for plugable module and other one is suitable for plugable.</p>
<h2 id="Login-module"><a href="#Login-module" class="headerlink" title="Login module"></a>Login module</h2><p>Multiple login methods should be supported because many standard third-part authentication is already exists for example, CAS, oauth2, ldap and so on.</p>
<p>If you already have a customized system for authentication, I seems diffcult to integrate another system with existing one. Because the authentication actually need to transfer sensitive information to do authenticate but which is not safe enough to expose those data for plugin exactly.</p>
<p>From the usage of CAS, oauth2 we can see a generally authentication service just redirect authentication to itself and returns a authentication result and finally redirect to the right page. So sensitive information do not transferred but use a token to verify client’s response instead. </p>
<p>For ldap, just access its database directly to verify if the user is exists and finish authentication. Because ldap just integrated with ZStack so also no data transferred but ldap module itself need to care about the security issue which already resolve by third-part libs.</p>
<p>So when we tries to support plugin for login, password or any key liked information need to be exposed which is quite unsafe and have potential security risks. Compared to ldap verification, password is used directly and also faces the same problem.</p>
<p>For login module integration, two ways are recommended. One is using open-source authentication like CAS or oauth2. Another is integrating ZStack API to use account/user directly.</p>
<p>Following figure shows the flows of login module</p>
<img src="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/figure1.png" class="">

<ul>
<li>Support plugable system, main auth or additinal auth should be exposed</li>
<li>Sensitive information go through the whole flow</li>
<li>CAS and oauth2 use their own authentication which is not related the current architecture</li>
</ul>
<h2 id="Alarm-Event-system"><a href="#Alarm-Event-system" class="headerlink" title="Alarm/Event system"></a>Alarm/Event system</h2><p>For alarm event system, only expose monitor messages which seems more suitable to be developed as a plugable system.</p>
<p>When have lots of endpoint support, some use stantard libs like dingtalk and microsoft teams, offers api for message sending. But when sms system require integration, this became diffcult due to the lack of stantard apis.</p>
<p>So a plugable system can be powerful to reduce development efforts.</p>
<p>For example, sms systems all have their own apis the usages, so the interation of api is the first step. But actually the business scenarios are not only limited on send message. Maybe message distribution strategy is required, and message format is required.</p>
<p>So seperate those parts as followings:</p>
<ul>
<li>Send sms message</li>
<li>Distribution strategy</li>
<li>Message format</li>
<li>….</li>
</ul>
<p>When design plugable system, the most important thing is that we should seperate mechanism requirements and strategy requirements. </p>
<p>For message format, actually, all kinds of message required this feature and can be noted as general feature and mechanism and we can also call it customize message format. The format change do not influence how the message send or comsumed.</p>
<p>Distribution strategy, from the name, we can known that no specific rules or format could be announced because the strategy always changes from one the another.</p>
<p>Send sms message. also the integration part but the message with a format is what we can offered and only how to send the message should be defined and which is I think can be seperated from the system.</p>
<p>And more informations maybe, endpoint type, status and those ZStack defined fields also need to be involved in the plugable system so we get a architecture like following:</p>
<img src="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/figure2.png" class="">

<p>A plugable endpoint in designed to manage endpoint plugins and plugin should obey following rules: </p>
<ul>
<li>Offer endpoint type</li>
<li>Implement interface to send message</li>
<li>Unit test for endpoint plugin</li>
</ul>
<p>And the design of plugable endpoint may like following:</p>
<img src="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/figure3.png" class="">

<p>So plugable endpoint should define a interface require type and send() method’s implementation for the usage. Take the interface to a seperate open source package and publish to maven repository, its easy for develop and easy to use. By reflections, endpoint could be initialized from jar so just add jar to your dependency directory is ok.</p>
<p>To develop a plugin for new sns endpoint no need to known the logic or usage of orignal application system but developer could focus on the send method itself.</p>
<p>On the other hand, application level should extend orignal CURD api to suitable for those plugin definition and keep compitable with other endpoints.</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul>
<li>Database access is not limited which should add limited on database service itself.</li>
<li>Rules for all kind of plugins so that plugins can be managed together and distribution can keep consistency</li>
<li>More examples</li>
<li>For exsiting modules, try to refactor the plugin types to get rid of module dependency</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" data-id="cld1mheas0011yuwbeb60edrj" data-title="Plugable module architecture design and thoughts about its implementation" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jvm-metaspace-memory-leak-analysis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/11/jvm-metaspace-memory-leak-analysis/" class="article-date">
  <time class="dt-published" datetime="2022-10-11T09:13:39.000Z" itemprop="datePublished">2022-10-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/11/jvm-metaspace-memory-leak-analysis/">JVM metaspace memory leak analysis</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Out system became unavailable due to <code>java.lang.OutOfMemoryError: Metaspace</code> and according to a stackoverflow answer: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36051813/java8-java-lang-outofmemoryerror-metaspace">https://stackoverflow.com/questions/36051813/java8-java-lang-outofmemoryerror-metaspace</a>, I started to figure out what wrong with the system.</p>
<p>Before finding start analysis jvm memory dump, we need to known what means memory leak. In this case, we found thread failed to execution because create task failed due to OOM. But there are two typical reason.</p>
<ul>
<li>Too many classes need to be loaded</li>
<li>Memory leak causes some classes not unloaded</li>
</ul>
<p>Everytime you new a object, metaspace will be allocated to store metadata of the object. </p>
<p>Following code could reproduce this issue:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ; i++) &#123;</span><br><span class="line">            Class c = cp.makeClass(<span class="string">&quot;eu.plumbr.demo.Generated&quot;</span> + i).toClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.27.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>so dynamic created class will add new class information into metaspace but if there is no class loader reference to the class, the class will be cleared after GC.</p>
<p>So it’s clear that if memory leak happened to your metaspace, you can find your application no problem when just started and oom happens after it runs for a period of time.</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>A couple of tools are available for memory leak analysis and only refer to what I have used when I figure out this issue.</p>
<h3 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h3><blockquote>
<p> <strong>JConsole</strong> is a graphical monitoring tool to monitor <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Virtual_Machine">Java Virtual Machine</a> (JVM) and Java applications both on a local or remote machine.</p>
<p> JConsole uses underlying features of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Virtual_Machine">Java Virtual Machine</a> to provide information on performance and resource consumption of applications running on the Java platform using <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Management_Extensions">Java Management Extensions</a> (JMX) technology. JConsole comes as part of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Development_Kit">Java Development Kit</a> (JDK) and the graphical console can be started using “jconsole” command. </p>
</blockquote>
<p>As JConsole is a part of JDK, you can easily find it. On macOS, you can use commandline directly</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jconsole</span><br></pre></td></tr></table></figure>

<p>or find your java_home by </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/libexec/java_home -V</span><br></pre></td></tr></table></figure>

<p>the jconsole is under</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/bin/jconsole</span><br></pre></td></tr></table></figure>

<p>and then connect to local or remote application.</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1000.00.54.png" class="">

<p>Note: </p>
<p>In order to use JConsole, jmx need to be enabled for your application’s jvm options</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=10000 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.local.only=false -Djava.rmi.server.hostname=your_ip_address</span><br></pre></td></tr></table></figure>

<p>make sure your ip adress and port is available for remote access.</p>
<p>From JConsole we can monitor loaded class number, unloaded class number, perform gc and check if metaspace is continuously increasing.</p>
<h3 id="VisualVM"><a href="#VisualVM" class="headerlink" title=" VisualVM"></a> VisualVM</h3><p>A replacement for JConsole except jvm monitor, heap dump, application snapshot is available which is quite efficient for memory leak analysis.</p>
<h3 id="Memory-Analyzer-MAT"><a href="#Memory-Analyzer-MAT" class="headerlink" title="Memory Analyzer (MAT)"></a>Memory Analyzer (MAT)</h3><p>The Eclipse Memory Analyzer is a fast and feature-rich <strong>Java heap analyzer</strong> that helps you find memory leaks and reduce memory consumption.Use the Memory Analyzer to analyze productive heap dumps with hundreds of millions of objects, quickly calculate the retained sizes of objects, see who is preventing the Garbage Collector from collecting objects, run a report to automatically extract leak suspects.</p>
<p>My application use openjdk-1.8, so only MemoryAnalyzer-1.11.0.20201202-macosx.cocoa.x86_64.dmg</p>
<p>could be used. After that MAT only support java11.</p>
<h2 id="Start-debug"><a href="#Start-debug" class="headerlink" title="Start debug"></a>Start debug</h2><p>Combining background and tools, finding continuously increasing memory is easy but how to get to the code seems more diffcult.</p>
<p>But we could seperate debug procedure to several steps</p>
<ul>
<li>Do heap dump during a period to known always in memory classes and dynamic classes</li>
<li>Compare heap dump to figure out what increase metaspace</li>
<li>Find a operation that causes the leak</li>
</ul>
<p>Use visualVM connect to java application and monitor for a time</p>
<p>Metaspace leak can be monitored because after manually perforce GC, it still not decrease.</p>
<p>GC performed we have 72246 loaded classes.</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.07.29.png" class="">

<p>after aboubt 1minutes, GC performed but loaded class increased to 72262</p>
<p>![截屏2022-10-11 16.08.23](/Users/kayo/Desktop/blog/JVM metaspace memory leak analysis/截屏2022-10-11 16.08.23.png)</p>
<p>Aboviously there are some leak problems, so still use 1 minute as period and collect two heap dump for next step analysis.</p>
<p>Open the heap dumps with MAT to do compare, from heap dump’s dominator tree</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.40.png" class="">

<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.44.png" class="">

<p>Luckily, we found the increased class at first glance. The SessionFactoryImpl seems to blame.</p>
<p>Except this we found another issue with Groovy’s GStringTemplateEngine which causes groovy.reflection.ClassInfo increases and we will tell the details in next section.</p>
<p>Expand the suspects to get more details about it. By list all objects, query plan cache increased, so just google for this value</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.49.png" class="">

<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.58.png" class="">

<p>from <a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.0/javadocs/org/hibernate/engine/query/spi/QueryPlanCache.html">https://docs.jboss.org/hibernate/orm/5.0/javadocs/org/hibernate/engine/query/spi/QueryPlanCache.html</a>:  Acts as a cache for compiled query plans, as well as query-parameter metadata.</p>
<p>And check its source code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the cache of the actual plans...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BoundedConcurrentHashMap queryPlanCache;</span><br></pre></td></tr></table></figure>

<p>it seems a bounded hashmap and created like below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryPlanCache = <span class="keyword">new</span> BoundedConcurrentHashMap( maxQueryPlanCount, <span class="number">20</span>, BoundedConcurrentHashMap.Eviction.LIRS );</span><br></pre></td></tr></table></figure>

<p>and hibernate use default 2048 as maxQueryPlanCount and LIRS as eviction strategy. So no need to solve a cache increasing.</p>
<h2 id="GStringTemplateEngine"><a href="#GStringTemplateEngine" class="headerlink" title="GStringTemplateEngine"></a>GStringTemplateEngine</h2><p>By debug steps, we find GStringTemplateScript occupied metaspace and thousands of classes are created.</p>
<p>Check its implements, </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groovyClass = loader.parseClass(<span class="keyword">new</span> GroovyCodeSource(templateExpressions.toString(), <span class="string">&quot;GStringTemplateScript&quot;</span> + GStringTemplateEngine.counter.incrementAndGet() + <span class="string">&quot;.groovy&quot;</span>, <span class="string">&quot;x&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>GStringTemplateScript will be created every GStringTemplate created. So for template creation, will cause dynamic class creation and finally let jvm run out of memory.</p>
<p>According to some related fix, <a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/GROOVY-7017">https://issues.apache.org/jira/browse/GROOVY-7017</a> this fix use a seperate class loader to make sure gstring template could be gced from heap but metaspace is still occupied.</p>
<p>And another article talk about: <a target="_blank" rel="noopener" href="https://tigase.net/how-aws-helped-us-optimize-memory-usage-tigase-http-api/">https://tigase.net/how-aws-helped-us-optimize-memory-usage-tigase-http-api/</a> AWS improve Tigase HTTP API Memory usage, following fix is suggested: </p>
<ul>
<li>We load all templates at once using single <code>GStringTemplateEngine</code> and cache generate templates. <strong>No more automatic reloading of templates.</strong></li>
<li>When manual reload of templates is initiated we release old instance of <code>GStringTemplateEngine</code> and parse templates using the new one.</li>
</ul>
<p>So do some test before change our code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.text.GStringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyMetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String EVENT_CHINESE_TEMPLATE = <span class="string">&quot;事件 发生了 事件详情: 名称:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        GStringTemplateEngine engine = <span class="keyword">new</span> GStringTemplateEngine();</span><br><span class="line">        HashMap&lt;Integer, groovy.text.Template&gt; templateHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            groovy.text.Template template = templateHashMap.get(EVENT_CHINESE_TEMPLATE.hashCode());</span><br><span class="line">            <span class="keyword">if</span> (template == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    template = (groovy.text.Template) engine.createTemplate(<span class="keyword">new</span> StringReader(EVENT_CHINESE_TEMPLATE));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                templateHashMap.put(EVENT_CHINESE_TEMPLATE.hashCode(), template);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(template.make().toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MemoryPoolMXBean memoryMXBean : (ManagementFactory.getMemoryPoolMXBeans())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Metaspace&quot;</span>.equals(memoryMXBean.getName())) &#123;</span><br><span class="line">                    System.out.println(memoryMXBean.getUsage().getUsed()/<span class="number">1024</span>/<span class="number">1024</span> + <span class="string">&quot; mb&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>by use templateHashMap as cache to avoid duplicate template creation, we can see Metaspace memory usage not changed</p>
<p>but if change the code without templateHashMap:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.text.GStringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyMetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String EVENT_CHINESE_TEMPLATE = <span class="string">&quot;事件 发生了 事件详情: 名称:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        GStringTemplateEngine engine = <span class="keyword">new</span> GStringTemplateEngine();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            groovy.text.Template template;</span><br><span class="line">            <span class="comment">//= templateHashMap.get(EVENT_CHINESE_TEMPLATE.hashCode());</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                template = (groovy.text.Template) engine.createTemplate(<span class="keyword">new</span> StringReader(EVENT_CHINESE_TEMPLATE));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(template.make().toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MemoryPoolMXBean memoryMXBean : (ManagementFactory.getMemoryPoolMXBeans())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Metaspace&quot;</span>.equals(memoryMXBean.getName())) &#123;</span><br><span class="line">                    System.out.println(memoryMXBean.getUsage().getUsed()/<span class="number">1024</span>/<span class="number">1024</span> + <span class="string">&quot; mb&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>the metaspace will increase until oom.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/" data-id="cld1mhead000kyuwb98bvg0mn" data-title="JVM metaspace memory leak analysis" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/11/jvm-metaspace-memory-leak-analysis/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/11/jvm-metaspace-memory-leak-analysis/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-iommu" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/06/iommu/" class="article-date">
  <time class="dt-published" datetime="2022-10-06T06:55:56.000Z" itemprop="datePublished">2022-10-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>►<a class="article-category-link" href="/categories/linux/memory-management/">memory management</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/06/iommu/">Input–output memory management unit</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>From Wikipedia, the free encyclopedia</p>
<blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computing">computing</a>, an <strong>input–output memory management unit</strong> (<strong>IOMMU</strong>) is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Memory_management_unit">memory management unit</a> (MMU) connecting a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Direct_memory_access">direct-memory-access</a>–capable (DMA-capable) I/O <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_bus">bus</a> to the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Main_memory">main memory</a>. Like a traditional MMU, which translates <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>-visible <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Virtual_address">virtual addresses</a> to <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Physical_address">physical addresses</a>, the IOMMU maps device-visible virtual addresses (also called <em>device addresses</em> or <em>I/O addresses</em> in this context) to physical addresses. Some units also provide <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Memory_protection">memory protection</a> from faulty or malicious devices.</p>
</blockquote>
<p>计算机中，<strong>input–output memory management unit</strong> (<strong>IOMMU</strong>) 是直接连接到主存的一个direct-memory-access-capable（DMA-capable，允许内存直接访问的）I/O总线内存管理单元（MMU）。类似传统的MMU，会翻译CPU可见的虚拟地址为物理地址，IOMMU映射设备可见的虚拟地址（也叫做设备地址或者I/O地址）到物理地址。一些单元也提供内存保护功能，避免设备出错或者受到攻击。</p>
<blockquote>
<p>An example IOMMU is the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Graphics_address_remapping_table">graphics address remapping table</a> (GART) used by <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Accelerated_Graphics_Port">AGP</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/PCI_Express">PCI Express</a> graphics cards on Intel Architecture and AMD computers.</p>
<p>On the x86 architecture, prior to splitting the functionality of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Northbridge_(computing)">northbridge</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Southbridge_(computing)">southbridge</a> between the CPU and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Platform_Controller_Hub">Platform Controller Hub</a> (PCH), I/O virtualization was not performed by the CPU but instead by the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Chipset">chipset</a>.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-1">1]</a>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-2">2]</a></p>
</blockquote>
<p>举个例子，在Intel架构和AMD计算机上被AGP和PCI Express图形卡使用的graphics address remapping table（GART）就是IOMMU</p>
<p>在x86架构，提前拆分CPU，平台控制器HUB（PCH），I/O虚拟化在北桥和南桥的功能并不是CPU直接处理的，而是由芯片组解决的。</p>
<blockquote>
<p>The advantages of having an IOMMU, compared to direct physical addressing of the memory (DMA), include[*<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Wikipedia:Citation_needed">citation needed</a>*]:</p>
<ul>
<li>Large regions of memory can be allocated without the need to be contiguous in physical memory – the IOMMU maps contiguous virtual addresses to the underlying fragmented physical addresses. Thus, the use of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vectored_I/O">vectored I/O</a> (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Scatter-gather">scatter-gather</a> lists) can sometimes be avoided.</li>
<li>Devices that do not support memory addresses long enough to address the entire physical memory can still address the entire memory through the IOMMU, avoiding overheads associated with copying buffers to and from the peripheral’s addressable memory space.</li>
<li>For example, x86 computers can address more than 4 gigabytes of memory with the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Physical_Address_Extension">Physical Address Extension</a> (PAE) feature in an x86 processor. Still, an ordinary 32-bit PCI device simply cannot address the memory above the 4 GiB boundary, and thus it cannot directly access it. Without an IOMMU, the operating system would have to implement time-consuming <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bounce_buffer">bounce buffers</a> (also known as double buffers[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-3">3]</a>).</li>
<li>Memory is protected from malicious devices that are attempting DMA attacks and faulty devices that are attempting errant memory transfers because a device cannot read or write to memory that has not been explicitly allocated (mapped) for it. The memory protection is based on the fact that OS running on the CPU (see figure) exclusively controls both the MMU and the IOMMU. The devices are physically unable to circumvent or corrupt configured memory management tables.</li>
<li>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hardware-assisted_virtualization">virtualization</a>, <em>guest</em> operating systems can use hardware that is not specifically made for virtualization. Higher performance hardware such as graphics cards use DMA to access memory directly; in a virtual environment all memory addresses are re-mapped by the virtual machine software, which causes DMA devices to fail. The IOMMU handles this re-mapping, allowing the native device drivers to be used in a guest operating system.</li>
<li>In some architectures IOMMU also performs <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hardware_interrupt">hardware interrupt</a> re-mapping, in a manner similar to standard memory address re-mapping.</li>
<li>Peripheral memory paging can be supported by an IOMMU. A peripheral using the PCI-SIG PCIe Address Translation Services (ATS) Page Request Interface (PRI) extension can detect and signal the need for memory manager services.</li>
</ul>
<p>For system architectures in which port I/O is a distinct address space from the memory address space, an IOMMU is not used when the CPU communicates with devices via <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/I/O_port">I/O ports</a>. In system architectures in which port I/O and memory are mapped into a suitable address space, an IOMMU can translate port I/O accesses.</p>
</blockquote>
<p>IOMMU的优势，和内存的直接物理映射（DMA）相比，包括：</p>
<ul>
<li>支持分配大片的内存，而且不需要是物理上连续的。IOMMU的映射保证虚拟地址连续，物理地址可以不连续。因此<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vectored_I/O">vectored I/O</a> (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Scatter-gather">scatter-gather</a> lists) 有些时候是不能用的</li>
<li>内存地址长度不支持映射整个物理内存的时候也可以通过IOMMU来找到整个内存的地址。同时可以避免拷贝特定的内存到外围的内存空间而造成损耗<ul>
<li>对x86计算机，具备通过Physical Address Extension（PAE）寻址超过4GB的内存的特性。同时一个普通的32位 PCI设备并不能很简单的找到超过4GB的内存地址，并且也无法访问这个地址。没有IOMMU的情况下，操作系统必须要实现一个消耗时间的bounce buffers（也叫做double buffer）</li>
</ul>
</li>
<li>内存保护，避免恶意设备通过DMA攻击或者错误的设备尝试传输不正确的内存，因为一个设备并不能读或者写并不是这个设备分配映射的内存。内存保护是基于OS在CPU上运行并且排他的控制MMU以及IOMMU的事实实现的。设备在物理上就是没办法去避免或者破坏已经配置好的内存管理表的。<ul>
<li>在虚拟化中，guest操作系统可以使用非特殊的虚拟化模式的硬件（物理硬件）。高性能硬件，比如说图形卡就是使用DMA来直接访问内存的。在虚拟环境中，所有的内存地址都被虚拟机软件重新做了映射，这就会导致DMA设备会访问失败。IOMMU需要处理这个重新映射的行为，并允许本地的硬件驱动能够被虚拟机操作系统使用。</li>
</ul>
</li>
<li>在一些架构中，IOMMU也执行硬件中断的重新映射，类似标准内存地址的重新映射</li>
<li>IOMMU也支持外围的内存页。一个外围的使用PIC-SIG PCIe地址翻译服务（Address Translation Services）页请求接口（Page Request Interface）拓展能够探测并发出信号给需要内存管理的服务</li>
</ul>
<p>对port I/O在内存空间中有有独有地址空间系统架构里，IOMMU并不通过I/O ports进行设备和CPU的沟通。系统架构里，port I/O和内存是映射到合适的地址空间里，IOMMU可以翻译port I/O的访问。</p>
<blockquote>
<p>The disadvantages of having an IOMMU, compared to direct physical addressing of the memory, include:[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-price-of-safety-4">4]</a></p>
<ul>
<li>Some degradation of performance from translation and management overhead (e.g., page table walks).</li>
<li>Consumption of physical memory for the added I/O <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Page_table">page (translation) tables</a>. This can be mitigated if the tables can be shared with the processor.</li>
<li>In order to decrease the page table size the granularity of many IOMMUs is equal to the memory paging (often 4096 bytes), and hence each small buffer that needs protection against DMA attack has to be page aligned and zeroed before making visible to the device. Due to OS memory allocation complexity this means that the device driver needs to use bounce buffers for the sensitive data structures and hence decreasing overall performance.</li>
</ul>
</blockquote>
<p>IOMMU的缺点，和内存直接访问物理地址，包括：</p>
<ul>
<li>因为翻译和管理地址导致的性能损耗（比如page table walks）</li>
<li>增加I/O page（translation）tables需要消耗物理内存。如果处理器可以共享page table就能够给减缓这个问题</li>
<li>为了减少page tables的大小以及减少page的粒度，大部分IOMMUs是和内存页（通常是4096字节）对等的，并且因为每个小buffer都需要避免DMA attack，在提供给设备访问之前，必须要被对齐并且置为0。由于OS内存分配的复杂性，这意味着设备驱动对敏感的数据结构要使用一个弹性的buffers因此降低了性能（因为要动态分配）</li>
</ul>
<blockquote>
<p>When an operating system is running inside a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Virtual_machine">virtual machine</a>, including systems that use <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Paravirtualization">paravirtualization</a>, such as <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Xen">Xen</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a>, it does not usually know the host-physical addresses of memory that it accesses. This makes providing direct access to the computer hardware difficult, because if the guest OS tried to instruct the hardware to perform a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Direct_memory_access">direct memory access</a> (DMA) using guest-physical addresses, it would likely corrupt the memory, as the hardware does not know about the mapping between the guest-physical and host-physical addresses for the given virtual machine. The corruption can be avoided if the hypervisor or host OS intervenes in the I/O operation to apply the translations. However, this approach incurs a delay in the I/O operation.</p>
<p>An IOMMU solves this problem by re-mapping the addresses accessed by the hardware according to the same (or a compatible) translation table that is used to map guest-physical address to host-physical addresses.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-5">5]</a></p>
</blockquote>
<p>当操作系统运行在虚拟机里，包括操作系统辅助虚拟化，比如Xen和KVM，通常情况下是不知道内存要访问的物理机器物理地址的。这个情况下要直接提供计算机的硬件地址是很困难的，因为如果guest OS尝试去命令硬件使用guest的物理地址执行直接内存访问（DMA），将会是一个错误的地址（因为虚拟化，guest的内存空间实际上和host的内存空间不是一回事），这是由于硬件并不知道guest物理地址和host物理地址之间的映射关系。通过host OS的介入把这个I/O操作翻译掉，就能够解决这个问题，而这个方法就会造成I/O操作变慢。</p>
<p>一个IOMMU可以通过宠幸映射硬件关联地址的翻译来解决这个问题，也就是用来做guest物理地址和host物理地址的映射。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/06/iommu/" data-id="cld1mheaa000gyuwbhmka8138" data-title="Input–output memory management unit" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/06/iommu/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/06/iommu/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BSOD/" style="font-size: 10px;">BSOD</a> <a href="/tags/DPDK/" style="font-size: 13.33px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/TDP/" style="font-size: 11.67px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 16.67px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 10px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 13.33px;">java</a> <a href="/tags/kernel/" style="font-size: 11.67px;">kernel</a> <a href="/tags/kvm/" style="font-size: 16.67px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 10px;">libvirt</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 13.33px;">software-arch</a> <a href="/tags/system-design/" style="font-size: 13.33px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 18.33px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 15px;">virt</a> <a href="/tags/virtio/" style="font-size: 11.67px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 18.33px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 18.33px;">virtio-networking</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/">Windows install virtio then reboot met BSOD</a>
          </li>
        
          <li>
            <a href="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/">Live migration failed due to libvirt keepalive timeout</a>
          </li>
        
          <li>
            <a href="/2022/12/15/nessus-on-centos-7/">Nessus on centos 7</a>
          </li>
        
          <li>
            <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/">UEFI Windows guest hang after live migration</a>
          </li>
        
          <li>
            <a href="/2022/11/09/plugable-system-in-practice-00/">Plugable system in practice 00</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>