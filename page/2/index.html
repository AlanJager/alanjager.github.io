<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="花の様に">
<meta property="og:url" content="http://hanayo.cn/page/2/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:locale">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="ブログ">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-uefi-windows-guest-hang-after-live-migration" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/" class="article-date">
  <time class="dt-published" datetime="2022-11-16T12:12:22.000Z" itemprop="datePublished">2022-11-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/">UEFI Windows guest hang after live migration</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Notes about debug windows hang issue.</p>
<h2 id="Test-case"><a href="#Test-case" class="headerlink" title="Test case"></a>Test case</h2><p>If qemu guest need to use nvidia GPU,  according to <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Video_card_driver_virtualisation_detection">https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Video_card_driver_virtualisation_detection</a> a workaround need to be setup in domain xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>after hidden kvm from guest, the GPU driver could work as expected. But we met an issue with Windows UEFI guest which hidden kvm and hung after live migration.</p>
<p>After searching for google, I got some directions for debug this issue:</p>
<ul>
<li>OVMF live migration issue: OVMF file size changed due to lib upgraded, configuration file length mismatch may cause guest hang</li>
<li>Host CPU feature issue: Host CPU features not match, may cause guest paused</li>
<li>QEMU/Libvirt issue</li>
<li>Windows issue: hidden kvm from guest is not compatible for all windows guest</li>
</ul>
<p>So I did some test try to figure out which component to suspect:</p>
<ul>
<li>Check OVMF version: not changed</li>
<li>Check host CPU feature: not changed</li>
<li>Check QEMU/Libvirt log, no virtualization error or error message exists</li>
<li>Remove the hidden tag to try live migration: Guest not hang</li>
</ul>
<p>We can see that kvm hidden seems to blame, but in order to use GPU on UEFI guest this issue should be resolved. So trace what happened during migration is the next step, open following logs for debug usage:</p>
<ol>
<li><p>OVMF log by following:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">qemu:commandline</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-debugcon&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;file:/var/log/libvirt/qemu/debug.log&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-global&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;isa-debugcon.iobase=0x402&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">qemu:commandline</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>QEMU/libvirt debug, but we already have qemu log under <code>/var/log/libvirt/qemu/</code></p>
</li>
<li><p>Check windows events after reboot</p>
</li>
</ol>
<p>But before we start debug, the environment related issue should be checked. Because we use nested virtualizatin as default, following environment check tests are required:</p>
<ol>
<li>Use baremetal host to test</li>
<li>Use latest qemu and libvirt to test</li>
<li>Use latest edk2 to test</li>
</ol>
<p>While combine test 1 and test 2, we get the result that UEFI wouldn’t hang after live migration. So we decide to test the same scenario on nested environment. And we did not met guest hang issue after upgrade libvirt. Go through the diffs from bug version and upstream:</p>
<p>I found following patch:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-    <span class="keyword">if</span> (!loader || !loader-&gt;nvram || <span class="built_in">virFileExists</span>(loader-&gt;nvram))</span><br><span class="line">+    <span class="keyword">if</span> (!loader || !loader-&gt;nvram ||</span><br><span class="line">+        (<span class="built_in">virFileExists</span>(loader-&gt;nvram) &amp;&amp;</span><br><span class="line">+            <span class="built_in">virFileLength</span>(loader-&gt;templt, <span class="number">-1</span>) == <span class="built_in">virFileLength</span>(loader-&gt;nvram, <span class="number">-1</span>))</span><br><span class="line">+        )</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">+    <span class="built_in">unlink</span>(loader-&gt;nvram);</span><br></pre></td></tr></table></figure>

<p>which is submitted to solve ovmf upgrade issue:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvram: regenerate nvram mapping file from template when firmware being upgraded</span><br></pre></td></tr></table></figure>

<p>After regenerating nvram mapping, the guest could be successfully migrated. Indeed this discovery solve our problem in short term and I want to get the root cause for why the guest hang and this patch is a important hint.</p>
<h2 id="How-ovmf-guest-perform-live-migration"><a href="#How-ovmf-guest-perform-live-migration" class="headerlink" title="How ovmf guest perform live migration"></a>How ovmf guest perform live migration</h2><p>How to perform live migration on ovmf guest. I search on edk2.groups.io try to find the answer.</p>
<p><a target="_blank" rel="noopener" href="https://edk2.groups.io/g/devel/topic/71141681#55046">https://edk2.groups.io/g/devel/topic/71141681#55046</a> and this topic discussed about live migration issue for ovmf guest which is quite helpful.</p>
<p>First of all, topic owner can not perform live migration because OVMF.fd changed its size from 2MB to 4MB which will be checked by qemu and raise length mismatch error like following(I got similar error from my test env):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-kvm: Length mismatch: system.flash1: 0x84000 in != 0x20000:Invalid argument</span><br></pre></td></tr></table></figure>

<p>And the reason of extending the flash size is due to <a target="_blank" rel="noopener" href="https://github.com/tianocore/edk2/commit/b24fca05751f">https://github.com/tianocore/edk2/commit/b24fca05751f</a> windows HCK require which declared that this is a incompatible change. So the solution may be:</p>
<ol>
<li>Stick with the same version of the ROM between VMs you want to migrate</li>
<li>Pad your ROM images to some larger size (e.g. 8MB) so that even if they grow a little bigger then you don’t hit the problem.</li>
</ol>
<p>When think about live migration, all guest’s memory will be migrated to target host, so the memory content of the firmware will be copied to the target host so no matter what loaded at target host memory will be overwritten. So if we want to get rid of this issue, keep the firmware with edk2 version is a good solution.</p>
<p>For legacy guest, BIOS use fixed magic address ranges but UEFI uses dynamically allocated memory, so there is not fixed addresses. When firmware flash image size change, also the content parts will changed too and which can not keep compatible.</p>
<p>But for live migration, due to the memory not changed, the nvram should also not be changed after that. I just quota the answer how ovmf works with live migration:</p>
<blockquote>
<p>With live migration, the running guest doesn’t notice anything. This is<br>a general requirement for live migration (regardless of UEFI or flash).</p>
<p>You are very correct to ask about “skipping” the NVRAM region. With the<br>approach that OvmfPkg originally supported, live migration would simply<br>be unfeasible. The “build” utility would produce a single (unified)<br>OVMF.fd file, which would contain both NVRAM and executable regions, and<br>the guest’s variable updates would modify the one file that would exist.<br>This is inappropriate even without considering live migration, because<br>OVMF binary upgrades (package updates) on the virtualization host would<br>force guests to lose their private variable stores (NVRAMs).</p>
<p>Therefore, the “build” utility produces “split” files too, in addition<br>to the unified OVMF.fd file. Namely, OVMF_CODE.fd and OVMF_VARS.fd.<br>OVMF.fd is simply the concatenation of the latter two.</p>
<p>$ cat OVMF_VARS.fd OVMF_CODE.fd | cmp - OVMF.fd<br>[prints nothing]</p>
<p>When you define a new domain (VM) on a virtualization host, the domain<br>definition saves a reference (pathname) to the OVMF_CODE.fd file.<br>However, the OVMF_VARS.fd file (the variable store <em>template</em>) is not<br>directly referenced; instead, it is <em>copied</em> into a separate (private)<br>file for the domain.</p>
<p>Furthermore, once booted, guest has two flash chips, one that maps the<br>firmware executable OVMF_CODE.fd read-only, and another pflash chip that<br>maps its private varstore file read-write.</p>
<p>This makes it possible to upgrade OVMF_CODE.fd and OVMF_VARS.fd (via<br>package upgrades on the virt host) without messing with varstores that<br>were earlier instantiated from OVMF_VARS.fd. What’s important here is<br>that the various constants in the new (upgraded) OVMF_CODE.fd file<br>remain compatible with the <em>old</em> OVMF_VARS.fd structure, across package<br>upgrades.</p>
<p>If that’s not possible for introducing e.g. a new feature, then the<br>package upgrade must not overwrite the OVMF_CODE.fd file in place, but<br>must provide an additional firmware binary. This firmware binary can<br>then only be used by freshly defined domains (old domains cannot be<br>switched over). Old domains can be switched over manually – and only if<br>the sysadmin decides it is OK to lose the current variable store<br>contents. Then the old varstore file for the domain is deleted<br>(manually), the domain definition is updated, and then a new (logically<br>empty, pristine) varstore can be created from the <em>new</em> OVMF_2_VARS.fd<br>that matches the <em>new</em> OVMF_2_CODE.fd.</p>
<p>During live migration, the “RAM-like” contents of both pflash chips are<br>migrated (the guest-side view of both chips remains the same, including<br>the case when the writeable chip happens to be in “programming mode”,<br>i.e., during a UEFI variable write through the Fault Tolerant Write and<br>Firmware Volume Block(2) protocols).</p>
<p>Once live migration completes, QEMU dumps the full contents of the<br>writeable chip to the backing file (on the destination host). Going<br>forward, flash writes from within the guest are reflected to said<br>host-side file on-line, just like it happened on the source host before<br>live migration. If the file backing the r/w pflash chip is on NFS<br>(shared by both src and dst hosts), then this one-time dumping when the<br>migration completes is superfluous, but it’s also harmless.</p>
<p>The interesting question is, what happens when you power down the VM on<br>the destination host (= post migration), and launch it again there, from<br>zero. In that case, the firmware executable file comes from the<br><em>destination host</em> (it was never persistently migrated from the source<br>host, i.e. never written out on the dst). It simply comes from the OVMF<br>package that had been installed on the destination host, by the<br>sysadmin. However, the varstore pflash does reflect the permanent result<br>of the previous migration. So this is where things can fall apart, if<br>both firmware binaries (on the src host and on the dst host) don’t agree<br>about the internal structure of the varstore pflash.</p>
</blockquote>
<p>from this long reply, we can get thoes points:</p>
<ul>
<li>Live migration should not be awared by guest</li>
<li>Edk2 seperate read-only executable codes and varstore to support firmware upgrade<ul>
<li>OVMF_CODE.fd keep compitable with orignal version</li>
<li>Qemu keep varstores in its nvram which will not be changed</li>
</ul>
</li>
<li>For new features if OVMF_CODE.fd can not keep compitable, use another OVMF_CODE_2.fd instead</li>
<li>Once live migraiton complete, qemu dump all contents to dest host</li>
</ul>
<p>So for qemu guest,  live migration just migrate memory to dest host and if we keep the same varstore and code with source host, it should be supported. Also because the pflash after live migration is actually in memory, so keep the varstore not changed will keep the compitable (no side-effects during runtime).</p>
<p>And another fact is when we turn off kvm hidden, the migration performs well and no any errors during guest runtime occurs in edk2’s log.</p>
<h2 id="Enable-KVM-trace"><a href="#Enable-KVM-trace" class="headerlink" title="Enable KVM trace"></a>Enable KVM trace</h2><p>According to: <a target="_blank" rel="noopener" href="https://www.reddit.com/r/VFIO/comments/80p1q7/high_kvmqemu_cpu_utilization_when_windows_10/">https://www.reddit.com/r/VFIO/comments/80p1q7/high_kvmqemu_cpu_utilization_when_windows_10/</a> a windows performance topic.</p>
<p>Because there is no abvious log shows any error from qemu or libvirt and it seems that the guest hangs but qemu and libvirt works well, I decide to enable kvm tracing and hope to get more clues.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/events/kvm/enable</span><br></pre></td></tr></table></figure>

<p>can we can get tracing by:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/kernel/debug/tracing/trace_pipe</span><br></pre></td></tr></table></figure>

<p>and the following log printed:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;...&gt;-41061 [003] .... 167992.130071: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130072: kvm_msr: msr_read 40000020 = 0xdfa1388fd</span><br><span class="line">&lt;...&gt;-41061 [003] d... 167992.130072: kvm_entry: vcpu 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130073: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130074: kvm_msr: msr_read 40000020 = 0xdfa138912</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130074: kvm_entry: vcpu 3</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130085: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130086: kvm_msr: msr_read 40000020 = 0xdfa138988</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130086: kvm_entry: vcpu 3</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130086: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130087: kvm_msr: msr_read 40000020 = 0xdfa138998</span><br><span class="line">&lt;...&gt;-41061 [003] d... 167992.130088: kvm_entry: vcpu 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130102: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41061 [003] .... 167992.130103: kvm_msr: msr_read 40000020 = 0xdfa138a32</span><br><span class="line">&lt;...&gt;-41061 [003] d... 167992.130103: kvm_entry: vcpu 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130103: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130104: kvm_msr: msr_read 40000020 = 0xdfa138a3f</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130104: kvm_entry: vcpu 3</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130114: kvm_exit: reason MSR_READ rip 0xfffff8008f9d0c0d info 0 0</span><br><span class="line">&lt;...&gt;-41064 [002] .... 167992.130114: kvm_msr: msr_read 40000020 = 0xdfa138aaa</span><br><span class="line">&lt;...&gt;-41064 [002] d... 167992.130115: kvm_entry: vcpu 3</span><br></pre></td></tr></table></figure>

<p>the vcpus seems run kvm_entry and kvm_exit forever to do msr_read and combine with top:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">top - 12:54:08 up 1 day, 22:42,  1 user,  load average: 5.69, 5.82, 6.10</span><br><span class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  : 87.5 us, 12.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu1  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu2  :100.0 us,  0.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu3  : 87.5 us, 12.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem : 10054364 total,  7086476 free,  2163892 used,   803996 buff&#x2F;cache</span><br><span class="line">KiB Swap:        0 total,        0 free,        0 used.  7563464 avail Mem</span><br><span class="line"></span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 41029 root      20   0 5193164   1.6g  17104 S 387.5 17.0 394:17.63 qemu-kvm</span><br></pre></td></tr></table></figure>

<p>guest’s sys usage is quite high use perf to get more details about this process:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf kvm --host top -p `pidof qemu-kvm`</span><br></pre></td></tr></table></figure>

<p>I see that:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Samples: 99K of event &#x27;cycles&#x27;, Event count (approx.): 10268746210</span><br><span class="line">Overhead  Shared Object            Symbol                                                                                                                                                                                          ◆</span><br><span class="line">  18.41%  [kernel]                 [k] vmx_vcpu_run                                                                                                                                                                                ▒</span><br><span class="line">   6.43%  [kernel]                 [k] vcpu_enter_guest                                                                                                                                                                            ▒</span><br><span class="line">   5.58%  [kernel]                 [k] pvclock_clocksource_read                                                                                                                                                                    ▒</span><br><span class="line">   3.84%  [kernel]                 [k] mutex_lock                                                                                                                                                                                  ▒</span><br><span class="line">   2.79%  [kernel]                 [k] vmx_handle_exit</span><br></pre></td></tr></table></figure>

<p>vmx_vcpu_run is high (on intel cpu) this means cpu switch to guest mode and show that guest mode and kernel mode switch spent a lot of time.</p>
<p>And by kvm tracing we can see many vm entry/exit so check the reason why vm exit happend (because the vcpu mode switch now spend too much time)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p> Just use a small piece of the output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@172-24-195-187 ~]# perf stat -e &#39;kvm:*&#39; -a -- sleep 1</span><br><span class="line"></span><br><span class="line"> Performance counter stats for &#39;system wide&#39;:</span><br><span class="line"></span><br><span class="line">           206,380      kvm:kvm_entry</span><br><span class="line">                 0      kvm:kvm_hypercall</span><br><span class="line">                 0      kvm:kvm_hv_hypercall</span><br><span class="line">               263      kvm:kvm_pio</span><br><span class="line">                 0      kvm:kvm_fast_mmio</span><br><span class="line">                 0      kvm:kvm_cpuid</span><br><span class="line">               162      kvm:kvm_apic</span><br><span class="line">           206,395      kvm:kvm_exit</span><br><span class="line">                 0      kvm:kvm_inj_virq</span><br><span class="line">                 0      kvm:kvm_inj_exception</span><br><span class="line">                 0      kvm:kvm_page_fault</span><br><span class="line">           202,600      kvm:kvm_msr</span><br><span class="line">                 0      kvm:kvm_cr</span><br><span class="line">               195      kvm:kvm_pic_set_irq</span><br><span class="line">                81      kvm:kvm_apic_ipi</span><br><span class="line">               370      kvm:kvm_apic_accept_irq</span><br><span class="line">                65      kvm:kvm_eoi</span><br></pre></td></tr></table></figure>

<p>kvm_msr is the main reason for vm exit and which matches kvm tracing.</p>
<p>By collect kvm events:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf kvm --host stat live</span><br></pre></td></tr></table></figure>

<p>we could see MSR_READ and EXTERNAL_INTERRUPT used almost all of the time.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">13:02:10.174121</span><br><span class="line"></span><br><span class="line">Analyze events for all VMs, all VCPUs:</span><br><span class="line"></span><br><span class="line">             VM-EXIT    Samples  Samples%     Time%    Min Time    Max Time         Avg time</span><br><span class="line"></span><br><span class="line">            MSR_READ       6022    78.14%    74.10%      0.71us  21778.22us     42.52us ( +-  17.16% )</span><br><span class="line">  EXTERNAL_INTERRUPT       1494    19.38%    21.65%      0.53us  12810.58us     50.08us ( +-  29.22% )</span><br><span class="line">      IO_INSTRUCTION        126     1.63%     1.16%     23.80us     51.45us     31.73us ( +-   1.56% )</span><br><span class="line">          APIC_WRITE         26     0.34%     0.06%      3.23us     10.96us      8.39us ( +-   4.81% )</span><br><span class="line">         EOI_INDUCED         20     0.26%     0.02%      1.93us      3.27us      2.63us ( +-   3.21% )</span><br><span class="line">       EPT_MISCONFIG         19     0.25%     3.01%     29.30us   9795.61us    548.07us ( +-  93.74% )</span><br><span class="line"></span><br><span class="line">Total Samples:7707, Total events handled time:345545.97us.</span><br></pre></td></tr></table></figure>

<p>from kvm tracing:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;...&gt;-41064 [000] .... 168733.114930: kvm_msr: msr_read 40000020 &#x3D; 0xfb3c08a54</span><br></pre></td></tr></table></figure>

<p>we can find 0x40000020 from linux kernel code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* MSR used to read the per-partition time reference counter */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HV_X64_MSR_TIME_REF_COUNT		0x40000020</span></span><br></pre></td></tr></table></figure>

<p>it seems a hyperv clocksource related issue so I just remote the hyperclock field from libvirt xml and the migration issue disappeared after that.</p>
<h2 id="Try-to-find-root-cause"><a href="#Try-to-find-root-cause" class="headerlink" title="Try to find root cause"></a>Try to find root cause</h2><p>Actually we can workaround our issue by remove the clocksource from vm configuration but we do not known the root cause but only a vm_exit and failed to read hyperv clocksource.</p>
<p>So simply trace kernel code for more details.</p>
<p>vmx.h defines lots of EXIT reasons:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXIT_REASON_MSR_READ            31</span></span><br></pre></td></tr></table></figure>

<p>and vmx.c register handlers</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The exit handlers return 1 if the exit was handled fully and guest execution</span></span><br><span class="line"><span class="comment"> * may resume.  Otherwise they set the kvm_run parameter to indicate what needs</span></span><br><span class="line"><span class="comment"> * to be done to userspace and return 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*<span class="keyword">const</span> kvm_vmx_exit_handlers[])</span><span class="params">(struct kvm_vcpu *vcpu)</span> </span>= &#123;</span><br><span class="line">  ...</span><br><span class="line">	[EXIT_REASON_MSR_READ]                = handle_rdmsr,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>than move to handle_rdmsr</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_rdmsr</span><span class="params">(struct kvm_vcpu *vcpu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u32 ecx = vcpu-&gt;arch.regs[VCPU_REGS_RCX];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msr_data</span> <span class="title">msr_info</span>;</span></span><br><span class="line"></span><br><span class="line">	msr_info.index = ecx;</span><br><span class="line">	msr_info.host_initiated = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (vmx_get_msr(vcpu, &amp;msr_info)) &#123;</span><br><span class="line">		trace_kvm_msr_read_ex(ecx);</span><br><span class="line">		kvm_inject_gp(vcpu, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	trace_kvm_msr_read(ecx, msr_info.data);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* <span class="doctag">FIXME:</span> handling of bits 32:63 of rax, rdx */</span></span><br><span class="line">	vcpu-&gt;arch.regs[VCPU_REGS_RAX] = msr_info.data &amp; <span class="number">-1u</span>;</span><br><span class="line">	vcpu-&gt;arch.regs[VCPU_REGS_RDX] = (msr_info.data &gt;&gt; <span class="number">32</span>) &amp; <span class="number">-1u</span>;</span><br><span class="line">	skip_emulated_instruction(vcpu);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because we see the trace from kvm that means <code>trace_kvm_msr_read_ex</code> is executed and will return 1 which means vm could resume.</p>
<p>If you look back to the kvm process trace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf kvm --host top -p &#96;pidof qemu-kvm&#96;</span><br></pre></td></tr></table></figure>

<p>we can find the inside vmx_vcpu_run, the vm vmresume is used and according to the code, the function will finished after <code>kvm_inject_gp(vcpu, 0);</code> and vm will entry guest.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vmx_vcpu_run  &#x2F;proc&#x2F;kcore</span><br><span class="line">Percent│       mov    0x238(%rcx),%rbx</span><br><span class="line">       │       mov    0x230(%rcx),%rdx</span><br><span class="line">       │       mov    0x250(%rcx),%rsi</span><br><span class="line">  0.11 │       mov    0x258(%rcx),%rdi</span><br><span class="line">       │       mov    0x248(%rcx),%rbp</span><br><span class="line">       │       mov    0x260(%rcx),%r8</span><br><span class="line">       │       mov    0x268(%rcx),%r9</span><br><span class="line">  0.03 │       mov    0x270(%rcx),%r10</span><br><span class="line">       │       mov    0x278(%rcx),%r11</span><br><span class="line">       │       mov    0x280(%rcx),%r12</span><br><span class="line">       │       mov    0x288(%rcx),%r13</span><br><span class="line">  0.11 │       mov    0x290(%rcx),%r14</span><br><span class="line">  0.02 │       mov    0x298(%rcx),%r15</span><br><span class="line">       │       mov    0x228(%rcx),%rcx</span><br><span class="line">       │     ↓ jne    2a1</span><br><span class="line">       │       vmlaunch</span><br><span class="line">       │     ↓ jmp    2a4</span><br><span class="line">  0.02 │2a1:   vmresume</span><br><span class="line"> 45.46 │2a4:   mov    %rcx,0x8(%rsp)</span><br><span class="line">  4.07 │       pop    %rcx</span><br><span class="line">  1.50 │       mov    %rax,0x220(%rcx)</span><br><span class="line">  2.07 │       mov    %rbx,0x238(%rcx)</span><br></pre></td></tr></table></figure>

<p>So that means guest will exit due to its own READ_MSR requirement.</p>
<p>Check kernel related code, the function chains are following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmx_get_msr -&gt; kvm_get_msr_common -&gt; kvm_hv_get_msr_common</span><br></pre></td></tr></table></figure>

<p>look into <code>kvm_hv_get_msr_common</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kvm_hv_get_msr_common</span><span class="params">(struct kvm_vcpu *vcpu, u32 msr, u64 *pdata, <span class="keyword">bool</span> host)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (kvm_hv_msr_partition_wide(msr)) &#123;</span><br><span class="line">		<span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">		mutex_lock(&amp;vcpu-&gt;kvm-&gt;arch.hyperv.hv_lock);</span><br><span class="line">		r = kvm_hv_get_msr_pw(vcpu, msr, pdata);</span><br><span class="line">		mutex_unlock(&amp;vcpu-&gt;kvm-&gt;arch.hyperv.hv_lock);</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> kvm_hv_get_msr(vcpu, msr, pdata, host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because msr count matches:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">static bool kvm_hv_msr_partition_wide(u32 msr)</span><br><span class="line">&#123;</span><br><span class="line">	bool r &#x3D; false;</span><br><span class="line"></span><br><span class="line">	switch (msr) &#123;</span><br><span class="line">	case HV_X64_MSR_GUEST_OS_ID:</span><br><span class="line">	case HV_X64_MSR_HYPERCALL:</span><br><span class="line">	case HV_X64_MSR_REFERENCE_TSC:</span><br><span class="line">	case HV_X64_MSR_TIME_REF_COUNT:</span><br><span class="line">	case HV_X64_MSR_CRASH_CTL:</span><br><span class="line">	case HV_X64_MSR_CRASH_P0 ... HV_X64_MSR_CRASH_P4:</span><br><span class="line">	case HV_X64_MSR_RESET:</span><br><span class="line">		r &#x3D; true;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so the read fall into <code>kvm_hv_get_msr_pw</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> HV_X64_MSR_TIME_REF_COUNT:</span><br><span class="line">	<span class="comment">/* read-only, but still ignore it if host-initiated */</span></span><br><span class="line">	<span class="keyword">if</span> (!host)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>and finally return 1 or report </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vcpu_unimpl(vcpu, <span class="string">&quot;Hyper-V uhandled wrmsr: 0x%x data 0x%llx\n&quot;</span>,</span><br><span class="line">	    msr, data);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>come to here it seems a guest bug and according to: <a target="_blank" rel="noopener" href="https://msrc-blog.microsoft.com/2018/12/10/first-steps-in-hyper-v-research/">https://msrc-blog.microsoft.com/2018/12/10/first-steps-in-hyper-v-research/</a> we can get some information about <code>EXIT_REASON_MSR_READ</code></p>
<p>that</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hyper-V handles MSR access (both read and write) in its VMEXIT loop handler. It’s easy to see it in IDA: it’s a large switch case over all the MSRs supported values, with the default case of falling back to rdmsr&#x2F;wrmsr, if that MSR doesn’t have special treatment by the hypervisor. Note that there are authentication checks in the MSR read&#x2F;write handlers, checking the current partition permissions. From there we can find the different MSRs Hyper-V supports, and the functions to handle read and write.</span><br></pre></td></tr></table></figure>

<p>So it seems a Hyper-V feature to access the MSR timeout ref count.</p>
<p>Check qemu doc about ‘Hyper-V Enlightenments’, it explains the usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hv-time</span><br><span class="line">Enables two Hyper-V-specific clocksources available to the guest: MSR-based Hyper-V clocksource (HV_X64_MSR_TIME_REF_COUNT, 0x40000020) and Reference TSC page (enabled via MSR HV_X64_MSR_REFERENCE_TSC, 0x40000021). Both clocksources are per-guest, Reference TSC page clocksource allows for exit-less time stamp readings. Using this enlightenment leads to significant speedup of all timestamp related operations.</span><br></pre></td></tr></table></figure>

<p>and used for speedup of all timestamp related operations but in this case the guest do not response as a result.</p>
<p>And come to here, I noticed that when guest migrated, some lines come into qemu.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2022-11-16T09:53:19.529516Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br><span class="line">2022-11-16T09:53:19.533393Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br><span class="line">2022-11-16T09:53:19.533626Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br><span class="line">2022-11-16T09:53:19.533816Z qemu-kvm: warning: TSC frequency mismatch between VM (2095020 kHz) and host (2095087 kHz), and TSC scaling unavailable</span><br></pre></td></tr></table></figure>

<p>qemu-kvm warning TSC frequency mismatched which normally not occurs for guest.</p>
<p>When check kernel code, we can see that:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">kvm_arch_set_tsc_khz</span><span class="params">(CPUState *cs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    X86CPU *cpu = X86_CPU(cs);</span><br><span class="line">    CPUX86State *env = &amp;cpu-&gt;env;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!env-&gt;tsc_khz) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = kvm_check_extension(cs-&gt;kvm_state, KVM_CAP_TSC_CONTROL) ?</span><br><span class="line">        kvm_vcpu_ioctl(cs, KVM_SET_TSC_KHZ, env-&gt;tsc_khz) :</span><br><span class="line">        -ENOTSUP;</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* When KVM_SET_TSC_KHZ fails, it&#x27;s an error only if the current</span></span><br><span class="line"><span class="comment">         * TSC frequency doesn&#x27;t match the one we want.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> cur_freq = kvm_check_extension(cs-&gt;kvm_state, KVM_CAP_GET_TSC_KHZ) ?</span><br><span class="line">                       kvm_vcpu_ioctl(cs, KVM_GET_TSC_KHZ) :</span><br><span class="line">                       -ENOTSUP;</span><br><span class="line">        <span class="keyword">if</span> (cur_freq &lt;= <span class="number">0</span> || cur_freq != env-&gt;tsc_khz) &#123;</span><br><span class="line">            warn_report(<span class="string">&quot;TSC frequency mismatch between &quot;</span></span><br><span class="line">                        <span class="string">&quot;VM (%&quot;</span> PRId64 <span class="string">&quot; kHz) and host (%d kHz), &quot;</span></span><br><span class="line">                        <span class="string">&quot;and TSC scaling unavailable&quot;</span>,</span><br><span class="line">                        env-&gt;tsc_khz, cur_freq);</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>qemu tries to KVM_SET_TSC_KHZ but failed will show thoes lines. </p>
<p>From hypervisor functional specification:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The TscScale value is used to adjust the Virtual TSC value across migration events to mitigate TSC frequency changes from one platform to another.</span><br></pre></td></tr></table></figure>

<p>used to cut down the mitigate TSC frequency change for guest.</p>
<p>So look for qemu code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (level == KVM_PUT_FULL_STATE) &#123;</span><br><span class="line">    <span class="comment">/* We don&#x27;t check for kvm_arch_set_tsc_khz() errors here,</span></span><br><span class="line"><span class="comment">     * because TSC frequency mismatch shouldn&#x27;t abort migration,</span></span><br><span class="line"><span class="comment">     * unless the user explicitly asked for a more strict TSC</span></span><br><span class="line"><span class="comment">     * setting (e.g. using an explicit &quot;tsc-freq&quot; option).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    kvm_arch_set_tsc_khz(cpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>during live migration, this trace will be printed but do not abort migration.</p>
<p>Indeed, newer nvidia driver do not require kvm hidden: <a target="_blank" rel="noopener" href="https://www.heiko-sieger.info/passing-through-a-nvidia-rtx-2070-super-gpu/">https://www.heiko-sieger.info/passing-through-a-nvidia-rtx-2070-super-gpu/</a> so the concerns about the use case maybe not necessary.</p>
<p>I write a mail to community to discuss if there is any better way to solve the problem.</p>
<p><a target="_blank" rel="noopener" href="https://lists.nongnu.org/archive/html/qemu-discuss/2022-11/msg00028.html">https://lists.nongnu.org/archive/html/qemu-discuss/2022-11/msg00028.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/11/16/uefi-windows-guest-hang-after-live-migration/" data-id="cld1mhecc0069yuwbhe993dgf" data-title="UEFI Windows guest hang after live migration" class="article-share-link">Share</a>
      
      
        <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/11/16/uefi-windows-guest-hang-after-live-migration/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-plugable-system-in-practice-00" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/11/09/plugable-system-in-practice-00/" class="article-date">
  <time class="dt-published" datetime="2022-11-08T17:43:05.000Z" itemprop="datePublished">2022-11-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/arch-notes/">arch-notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/11/09/plugable-system-in-practice-00/">Plugable system in practice 00</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This blog used to introduce a practice of plugin system implementation of zstack.</p>
<p>I will finish base of plugin load, metadate definition, capability negotiation and usage part of Java. And following section describe abstractions of this implementation.</p>
<h2 id="Abstractions"><a href="#Abstractions" class="headerlink" title="Abstractions"></a>Abstractions</h2><p>I make some abstractions to satisfy our aim.</p>
<ul>
<li>Unique identifer to find plugin and execute it</li>
<li>Capability negotiation and version information</li>
<li>Observer pattern to keep all modules use same way access plugin</li>
</ul>
<h3 id="PluginInterface"><a href="#PluginInterface" class="headerlink" title="PluginInterface"></a>PluginInterface</h3><p>Plugin capability currently defines SUPPORTED and UNSUPPORTED for plugin definition</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">PluginCapabilityState</span> </span>&#123;</span><br><span class="line">    SUPPORTED,</span><br><span class="line">    UNSUPPORTED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Define a plugin interface including three methods:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginInterface</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">pluginUniqueName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">version</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Map&lt;String, PluginCapabilityState&gt; <span class="title">capabilities</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>note: capabilities offer a map about custom plugin and expected use enum value</p>
<p>use reflection to collect interfaces extend this interface as the metadata of all kinds of plugins:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginEndpointSender</span> <span class="keyword">extends</span> <span class="title">PluginInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">send</span><span class="params">(PluginEndpointData message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so we need a manage class as the factory of plugin</p>
<h3 id="PluginManager"><a href="#PluginManager" class="headerlink" title="PluginManager"></a>PluginManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PluginManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCapabilitySupported</span><span class="params">(String pluginName, String capability)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;T extends PluginInterface&gt; <span class="function">T <span class="title">getPlugin</span><span class="params">(Class&lt;? extends PluginInterface&gt; pluginClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this class defines two methods, first one used to report plugin capability and another one return singleton plugin.</p>
<p>And in order to reduce complexity, only scan interfaces under abstraction module as meta interfaces</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Platform.getReflections().getSubTypesOf(PluginInterface.class).forEach(clz -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!clz.getCanonicalName().contains(<span class="string">&quot;org.zstack.abstraction&quot;</span>)</span><br><span class="line">            || !clz.isInterface()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (interfaceMetadata.contains(clz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CloudRuntimeException(</span><br><span class="line">                String.format(<span class="string">&quot;duplicate PluginProtocol[name: %s]&quot;</span>, clz));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    interfaceMetadata.add(clz);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>then load plugin instances from meta class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">interfaceMetadata.forEach(clz -&gt; Platform.getReflections().getSubTypesOf(clz)</span><br><span class="line">        .forEach(pluginInstanceClz -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PluginInterface pluginInterface = pluginInstanceClz.getConstructor().newInstance();</span><br><span class="line">        <span class="keyword">if</span> (pluginInstances.containsKey(pluginInterface.pluginUniqueName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CloudRuntimeException(String.format(<span class="string">&quot;duplicate plugin[class: %s]&quot;</span>,</span><br><span class="line">                    pluginInstanceClz));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pluginInstances.put(pluginInstanceClz, pluginInterface);</span><br><span class="line">        logger.debug(String.format(<span class="string">&quot;load plugin: %s, name: %s,  capabilities: \n %s&quot;</span>,</span><br><span class="line">                pluginInterface.version(),</span><br><span class="line">                pluginInterface.pluginUniqueName(),</span><br><span class="line">                JSONObjectUtil.toJsonString(pluginInterface.capabilities())));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CloudRuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>class will be used as the key and instance singleton will be stored and ready to use.</p>
<p>Use getPlugin could get the singleton. But currently version and uniqueName do not have specific usage but capabilties could be used to check if the plugin support the feature.</p>
<p>Version is used to check pluginInterface’s compatibility if pluginInterface has any uncompatible change, old version of plugin can run under compatible mode or just rejects load the plugin.</p>
<p>And now all plugins implemented pluginInterface will be loaded and not security check which should be done in pluginInterface and I will design it in next blogs.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Now I implemented part of loading the plugin, for usage is quite easy because developer only need to store the plugin class name as a variable to access the plugin but current safety issue is still should cared by all modules use plugin manager. So in next blog, I will do more works to resolve security requirements.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/11/09/plugable-system-in-practice-00/" data-id="cld1mheb1001ayuwbaify0xrq" data-title="Plugable system in practice 00" class="article-share-link">Share</a>
      
      
        <a href="/2022/11/09/plugable-system-in-practice-00/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/11/09/plugable-system-in-practice-00/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jvm-loaded-classes-rapidly-increased-issue" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/" class="article-date">
  <time class="dt-published" datetime="2022-10-31T06:59:31.000Z" itemprop="datePublished">2022-10-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/">JVM loaded classes rapidly increased issue</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Rapidly-increased-JVM-loaded-classes"><a href="#Rapidly-increased-JVM-loaded-classes" class="headerlink" title="Rapidly increased JVM loaded classes"></a>Rapidly increased JVM loaded classes</h2><p>When debug a oom issue on new version of application. I noticed that </p>
<p>Old version:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.46.48.png" class="">

<p>New version:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.46.40.png" class="">

<p>The classes increased almost twice compare to the old version.</p>
<p>So I just export loaded classes to figure out what classes increased at first.</p>
<p>After a compare, we got a obvious increased class:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.55.30.png" class="">

<p>for the new version</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-17.55.36.png" class="">

<p>about 25000 Doc classes is loaded and 45439 + 25000 = 70439 seems very near to 74.3k.</p>
<p>So check the heap dump by Dominator tree, by comparing heap usage, one class come into view is that:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-12-18.05.04.png" class="">

<h2 id="Code-reading"><a href="#Code-reading" class="headerlink" title="Code reading"></a>Code reading</h2><p>ZStack use reflections to get information and offer framework level capabilities.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Reflections reflections = <span class="keyword">new</span> Reflections(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>),</span><br><span class="line">        <span class="keyword">new</span> SubTypesScanner(), <span class="keyword">new</span> MethodAnnotationsScanner(), <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">        <span class="keyword">new</span> TypeAnnotationsScanner(), <span class="keyword">new</span> MethodParameterScanner());</span><br></pre></td></tr></table></figure>

<p>for reflections-0.9.10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(URL url)</span> </span>&#123;</span><br><span class="line">    Vfs.Dir dir = Vfs.fromURL(url);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Vfs.File file : dir.getFiles()) &#123;</span><br><span class="line">            <span class="comment">// scan if inputs filter accepts file relative path or fqn</span></span><br><span class="line">            Predicate&lt;String&gt; inputsFilter = configuration.getInputsFilter();</span><br><span class="line">            String path = file.getRelativePath();</span><br><span class="line">            String fqn = path.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (inputsFilter == <span class="keyword">null</span> || inputsFilter.apply(path) || inputsFilter.apply(fqn)) &#123;</span><br><span class="line">                Object classObject = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (scanner.acceptsInput(path) || scanner.acceptResult(fqn)) &#123;</span><br><span class="line">                            classObject = scanner.scan(file, classObject);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.isDebugEnabled())</span><br><span class="line">                            log.debug(<span class="string">&quot;could not scan file &quot;</span> + file.getRelativePath() + <span class="string">&quot; in url &quot;</span> + url.toExternalForm() + <span class="string">&quot; with scanner &quot;</span> + scanner.getClass().getSimpleName(), e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        dir.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>with a groovy closure <code>org.zstack.sso.header.APICreateCasClientEventDoc_zh_cn$_run_closure1</code></p>
<p>this part of code executed will skip filter and goes throught all scanners with their acceptsInput and acceptResult directly</p>
<p>refer to ZStack used Scanner, following code will be used:</p>
<p>FieldAnnotationsScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldAnnotationsScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line">        List&lt;Object&gt; fields = getMetadataAdapter().getFields(cls);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Object field : fields) &#123;</span><br><span class="line">            List&lt;String&gt; fieldAnnotations = getMetadataAdapter().getFieldAnnotationNames(field);</span><br><span class="line">            <span class="keyword">for</span> (String fieldAnnotation : fieldAnnotations) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (acceptResult(fieldAnnotation)) &#123;</span><br><span class="line">                    String fieldName = getMetadataAdapter().getFieldName(field);</span><br><span class="line">                    getStore().put(fieldAnnotation, String.format(<span class="string">&quot;%s.%s&quot;</span>, className, fieldName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SubTypeScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubTypesScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** created new SubTypesScanner. will exclude direct Object subtypes */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubTypesScanner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>); <span class="comment">//exclude direct Object subtypes by default</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** created new SubTypesScanner.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> excludeObjectClass if false, include direct &#123;<span class="doctag">@link</span> Object&#125; subtypes in results.  */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubTypesScanner</span><span class="params">(<span class="keyword">boolean</span> excludeObjectClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (excludeObjectClass) &#123;</span><br><span class="line">            filterResultsBy(<span class="keyword">new</span> FilterBuilder().exclude(Object.class.getName())); <span class="comment">//exclude direct Object subtypes</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">		String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line">		String superclass = getMetadataAdapter().getSuperclassName(cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acceptResult(superclass)) &#123;</span><br><span class="line">            getStore().put(superclass, className);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (String anInterface : (List&lt;String&gt;) getMetadataAdapter().getInterfacesNames(cls)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (acceptResult(anInterface)) &#123;</span><br><span class="line">                getStore().put(anInterface, className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MethodAnnotationsScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAnnotationsScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object method : getMetadataAdapter().getMethods(cls)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String methodAnnotation : (List&lt;String&gt;) getMetadataAdapter().getMethodAnnotationNames(method)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (acceptResult(methodAnnotation)) &#123;</span><br><span class="line">                    getStore().put(methodAnnotation, getMetadataAdapter().getMethodFullKey(cls, method));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TypeAnnotationsScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeAnnotationsScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(<span class="keyword">final</span> Object cls)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String annotationType : (List&lt;String&gt;) getMetadataAdapter().getClassAnnotationNames(cls)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (acceptResult(annotationType) ||</span><br><span class="line">                annotationType.equals(Inherited.class.getName())) &#123; <span class="comment">//as an exception, accept Inherited as well</span></span><br><span class="line">                getStore().put(annotationType, className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MethodParameterScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterScanner</span> <span class="keyword">extends</span> <span class="title">AbstractScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(Object cls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> MetadataAdapter md = getMetadataAdapter();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object method : md.getMethods(cls)) &#123;</span><br><span class="line"></span><br><span class="line">            String signature = md.getParameterNames(method).toString();</span><br><span class="line">            <span class="keyword">if</span> (acceptResult(signature)) &#123;</span><br><span class="line">                getStore().put(signature, md.getMethodFullKey(cls, method));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String returnTypeName = md.getReturnTypeName(method);</span><br><span class="line">            <span class="keyword">if</span> (acceptResult(returnTypeName)) &#123;</span><br><span class="line">                getStore().put(returnTypeName, md.getMethodFullKey(cls, method));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; parameterNames = md.getParameterNames(method);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterNames.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object paramAnnotation : md.getParameterAnnotationNames(method, i)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (acceptResult((String) paramAnnotation)) &#123;</span><br><span class="line">                        getStore().put((String) paramAnnotation, md.getMethodFullKey(cls, method));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All of them only offer scan and not extra processes were defined.</p>
<p>Check abount their <code>acceptsInput()</code> and <code>acceptResult()</code> methods from AbstractScanner:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptsInput</span><span class="params">(String file)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> getMetadataAdapter().acceptsInput(file);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptResult</span><span class="params">(<span class="keyword">final</span> String fqn)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> fqn != <span class="keyword">null</span> &amp;&amp; resultFilter.apply(fqn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>acceptResult will be used by SubTypesScanner</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SubTypesScanner</span><span class="params">(<span class="keyword">boolean</span> excludeObjectClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (excludeObjectClass) &#123;</span><br><span class="line">        filterResultsBy(<span class="keyword">new</span> FilterBuilder().exclude(Object.class.getName())); <span class="comment">//exclude direct Object subtypes</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>to reject direct Object subtypes</p>
<p>and acceptsInput use metadataAdapter(JavassistAdapter.java)，check if file end with .class</p>
<p>so for reflections-0.9.10 if groovy closure file exists will <code>.class</code> suffix and not extend object directly, will be loaded by reflection.</p>
<p>After upgrade to reflections-0.10.2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(configuration.isParallel() ? urls.stream().parallel() : urls.stream()).forEach(url -&gt; &#123;</span><br><span class="line">    Vfs.Dir dir = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        dir = Vfs.fromURL(url);</span><br><span class="line">        <span class="keyword">for</span> (Vfs.File file : dir.getFiles()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (doFilter(file, configuration.getInputsFilter())) &#123;</span><br><span class="line">                ClassFile classFile = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (doFilter(file, scanner::acceptsInput)) &#123;</span><br><span class="line">                            List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</span><br><span class="line">                            <span class="keyword">if</span> (entries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (classFile == <span class="keyword">null</span>) classFile = getClassFile(file);</span><br><span class="line">                                entries = scanner.scan(classFile);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (entries != <span class="keyword">null</span>) collect.get(scanner.index()).addAll(entries);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.trace(<span class="string">&quot;could not scan file &#123;&#125; with scanner &#123;&#125;&quot;</span>, file.getRelativePath(), scanner.getClass().getSimpleName(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.warn(<span class="string">&quot;could not create Vfs.Dir from url. ignoring the exception and continuing&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dir != <span class="keyword">null</span>) dir.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>code of scan changed to new version and scanners moved to enum</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Scanners</span> <span class="keyword">implements</span> <span class="title">Scanner</span>, <span class="title">QueryBuilder</span>, <span class="title">NameHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan type superclasses and interfaces</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;i&gt;Note that &#123;<span class="doctag">@code</span> Object&#125; class is excluded by default, in order to reduce store size.</span></span><br><span class="line"><span class="comment">     * &lt;br&gt;Use &#123;<span class="doctag">@link</span> #filterResultsBy(Predicate)&#125; to change, for example &#123;<span class="doctag">@code</span> SubTypes.filterResultsBy(c -&gt; true)&#125;&lt;/i&gt;</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    SubTypes &#123;</span><br><span class="line">        <span class="comment">/* Object class is excluded by default from subtypes indexing */</span></span><br><span class="line">        &#123; filterResultsBy(<span class="keyword">new</span> FilterBuilder().excludePattern(<span class="string">&quot;java\\.lang\\.Object&quot;</span>)); &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            entries.add(entry(classFile.getSuperclass(), classFile.getName()));</span><br><span class="line">            entries.addAll(entries(Arrays.asList(classFile.getInterfaces()), classFile.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan method annotations */</span></span><br><span class="line">    MethodsAnnotated &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            getMethods(classFile).forEach(method -&gt;</span><br><span class="line">                entries.addAll(entries(getAnnotations(method::getAttribute), methodName(classFile, method))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** scan field annotations */</span></span><br><span class="line">    FieldsAnnotated &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            classFile.getFields().forEach(field -&gt;</span><br><span class="line">                entries.addAll(entries(getAnnotations(field::getAttribute), fieldName(classFile, field))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan type annotations */</span></span><br><span class="line">    TypesAnnotated &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptResult</span><span class="params">(String annotation)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.acceptResult(annotation) || annotation.equals(Inherited.class.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            entries.addAll(entries(getAnnotations(classFile::getAttribute), classFile.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** scan method parameters types and annotations */</span></span><br><span class="line">    MethodsParameter &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(ClassFile classFile, List&lt;Map.Entry&lt;String, String&gt;&gt; entries)</span> </span>&#123;</span><br><span class="line">            getMethods(classFile).forEach(method -&gt; &#123;</span><br><span class="line">                String value = methodName(classFile, method);</span><br><span class="line">                entries.addAll(entries(getParameters(method), value));</span><br><span class="line">                getParametersAnnotations(method).forEach(annotations -&gt; entries.addAll(entries(annotations, value)));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>almost same logic is supported but check details about the scan() method</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doFilter(file, scanner::acceptsInput)) &#123;</span><br><span class="line">            List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</span><br><span class="line">            <span class="keyword">if</span> (entries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (classFile == <span class="keyword">null</span>) classFile = getClassFile(file);</span><br><span class="line">                entries = scanner.scan(classFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entries != <span class="keyword">null</span>) collect.get(scanner.index()).addAll(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.trace(<span class="string">&quot;could not scan file &#123;&#125; with scanner &#123;&#125;&quot;</span>, file.getRelativePath(), scanner.getClass().getSimpleName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>acceptsInput will be used to do filter which check file end with <code>.class</code> suffix but filterResultsBy is not executed only if <code>entries = scanner.scan(classFile)</code> is used.</p>
<p>So when <code>List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</code> return entries the result won’t be exclude.</p>
<h2 id="Hands-on-test"><a href="#Hands-on-test" class="headerlink" title="Hands-on test"></a>Hands-on test</h2><p>I set up a maven project to test reflections issue with a project:</p>
<img src="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/%E6%88%AA%E5%B1%8F2022-10-14-14.25.25.png" class="">

<p>and main code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zstack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.reflections.Reflections;</span><br><span class="line"><span class="keyword">import</span> org.reflections.scanners.*;</span><br><span class="line"><span class="keyword">import</span> org.reflections.util.ClasspathHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestReflections</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">        printLoadedClasses(<span class="keyword">null</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// reflections 0.9.10</span></span><br><span class="line">        Reflections reflections = <span class="keyword">new</span> Reflections(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>),</span><br><span class="line">            <span class="keyword">new</span> SubTypesScanner(<span class="keyword">false</span>), <span class="keyword">new</span> MethodAnnotationsScanner(), <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">            <span class="keyword">new</span> TypeAnnotationsScanner(), <span class="keyword">new</span> MethodParameterScanner());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reflections 0.10.2</span></span><br><span class="line"><span class="comment">//        Reflections reflections = new Reflections(ClasspathHelper.forPackage(&quot;org.zstack&quot;),</span></span><br><span class="line"><span class="comment">//            new SubTypesScanner(false), new MethodAnnotationsScanner(), new FieldAnnotationsScanner(),</span></span><br><span class="line"><span class="comment">//            new TypeAnnotationsScanner(), new MethodParameterScanner());</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">        printLoadedClasses(reflections);</span><br><span class="line">        System.out.println(<span class="string">&quot;==========================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printLoadedClasses</span><span class="params">(Reflections reflections)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reflections != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Set&lt;String&gt; types = reflections.getAllTypes();</span><br><span class="line"></span><br><span class="line">            types.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;loaded class number from reflection: &quot;</span> + types.size());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;loaded class number from jmx: &quot;</span> + ManagementFactory.getClassLoadingMXBean().getLoadedClassCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>finally the output of reflections 0.10.2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">groovy.lang.GroovyObject</span><br><span class="line">java.lang.Cloneable</span><br><span class="line">org.codehaus.groovy.runtime.GeneratedClosure</span><br><span class="line">groovy.lang.GroovyObjectSupport</span><br><span class="line">groovy.lang.Closure</span><br><span class="line">java.util.concurrent.Callable</span><br><span class="line">java.lang.Object</span><br><span class="line">groovy.lang.GroovyCallable</span><br><span class="line">groovy.lang.Script</span><br><span class="line">java.lang.Runnable</span><br><span class="line">java.io.Serializable</span><br><span class="line">org.test.TestGroovy2$_run_closure1</span><br><span class="line">org.zstack.TestGroovy2$_run_closure1</span><br><span class="line">org.test.TestGroovy$_run_closure1</span><br><span class="line">org.zstack.TestGroovy$_run_closure1$_closure2</span><br><span class="line">org.zstack.TestGroovy$_run_closure1</span><br><span class="line">org.zstack.TestGroovy3$_run_closure1$_closure2</span><br><span class="line">org.test.TestGroovy$_run_closure1$_closure2</span><br><span class="line">org.test.TestGroovy3$_run_closure1$_closure2</span><br><span class="line">org.test.TestGroovy3$_run_closure1</span><br><span class="line">org.test.TestGroovy2$_run_closure1$_closure2</span><br><span class="line">org.zstack.TestGroovy2$_run_closure1$_closure2</span><br><span class="line">org.zstack.TestGroovy3$_run_closure1</span><br><span class="line">org.zstack.TestReflections</span><br><span class="line">org.test.TestGroovy2</span><br><span class="line">org.test.TestGroovy3</span><br><span class="line">org.zstack.TestGroovy</span><br><span class="line">org.test.TestGroovy</span><br><span class="line">org.zstack.TestGroovy2</span><br><span class="line">org.zstack.TestGroovy3</span><br><span class="line">loaded class number from reflection: 30</span><br></pre></td></tr></table></figure>

<p>and the reflection 0.10.9:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.zstack.TestReflections</span><br><span class="line">loaded class number from reflection: 1</span><br></pre></td></tr></table></figure>

<p>we can found out that even a specified reflection from class path <code>org.zstack</code> unrelated class still appears.</p>
<p>So I just goolge the reflection issue, it come out directly:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ronmamo/reflections/issues/373">https://github.com/ronmamo/reflections/issues/373</a></p>
<p>we can solve this issue by adding some workaround</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflections 0.10.2</span></span><br><span class="line">ConfigurationBuilder builder = ConfigurationBuilder.build()</span><br><span class="line">        .setUrls(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>))</span><br><span class="line">        .setScanners(<span class="keyword">new</span> SubTypesScanner(<span class="keyword">false</span>),</span><br><span class="line">                <span class="keyword">new</span> MethodAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> TypeAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> MethodParameterScanner())</span><br><span class="line">        .setExpandSuperTypes(<span class="keyword">false</span>)</span><br><span class="line">        .filterInputsBy(<span class="keyword">new</span> FilterBuilder().includePackage(<span class="string">&quot;org.zstack&quot;</span>));</span><br><span class="line">Reflections reflections = <span class="keyword">new</span> Reflections(builder);</span><br></pre></td></tr></table></figure>

<h2 id="Where-is-root-cause"><a href="#Where-is-root-cause" class="headerlink" title="Where is root cause"></a>Where is root cause</h2><p>But after a solve the problem by add some hack for reflections, I still want to known what is the root cause.</p>
<p>So I check the code again try to find out what happened.</p>
<p>Compare scanners between 0.10.2 and 0.9.10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SubTypes</span></span><br><span class="line"><span class="comment">// reflections 0.10.2</span></span><br><span class="line">entries.add(<span class="keyword">this</span>.entry(classFile.getSuperclass(), classFile.getName()));</span><br><span class="line">entries.addAll(<span class="keyword">this</span>.entries(Arrays.asList(classFile.getInterfaces()), classFile.getName()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// reflections 0.9.10</span></span><br><span class="line">filterResultsBy(<span class="keyword">new</span> FilterBuilder().exclude(Object.class.getName())); <span class="comment">//exclude direct Object subtypes</span></span><br><span class="line"></span><br><span class="line">String className = getMetadataAdapter().getClassName(cls);</span><br><span class="line">String superclass = getMetadataAdapter().getSuperclassName(cls);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (acceptResult(superclass)) &#123;</span><br><span class="line">    getStore().put(superclass, className);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String anInterface : (List&lt;String&gt;) getMetadataAdapter().getInterfacesNames(cls)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (acceptResult(anInterface)) &#123;</span><br><span class="line">        getStore().put(anInterface, className);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0.9.10 will filter the superclass before put it into reflections store but 0.10.2 use it directly.</p>
<p>in 0.9.10 scan works like following:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inputsFilter == <span class="keyword">null</span> || inputsFilter.apply(path) || inputsFilter.apply(fqn)) &#123;</span><br><span class="line">    Object classObject = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanner.acceptsInput(path) || scanner.acceptResult(fqn)) &#123;</span><br><span class="line">                classObject = scanner.scan(file, classObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.isDebugEnabled())</span><br><span class="line">                log.debug(<span class="string">&quot;could not scan file &quot;</span> + file.getRelativePath() + <span class="string">&quot; in url &quot;</span> + url.toExternalForm() + <span class="string">&quot; with scanner &quot;</span> + scanner.getClass().getSimpleName(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>scanner will check fqn of class first and then check the interface but in 0.10.2 version:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Scanner scanner : configuration.getScanners()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doFilter(file, scanner::acceptsInput)) &#123;</span><br><span class="line">            List&lt;Map.Entry&lt;String, String&gt;&gt; entries = scanner.scan(file);</span><br><span class="line">            <span class="keyword">if</span> (entries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (classFile == <span class="keyword">null</span>) classFile = getClassFile(file);</span><br><span class="line">                entries = scanner.scan(classFile);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entries != <span class="keyword">null</span>) collect.get(scanner.index()).addAll(entries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log != <span class="keyword">null</span>) log.trace(<span class="string">&quot;could not scan file &#123;&#125; with scanner &#123;&#125;&quot;</span>, file.getRelativePath(), scanner.getClass().getSimpleName(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>File will be checked before scan by Filter but superclass’s belonging is not checked which seems to blame.</p>
<p>But actually, groovy closure does not extend Object but GroovyObject, so reflections will still load groovy closures. So check reflections <code>getAllTypes()</code></p>
<p>for 0.9.10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAllTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; allTypes = Sets.newHashSet(store.getAll(index(SubTypesScanner.class), Object.class.getName()));</span><br><span class="line">    <span class="keyword">if</span> (allTypes.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionsException(<span class="string">&quot;Couldn&#x27;t find subtypes of Object. &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Make sure SubTypesScanner initialized to include Object class - new SubTypesScanner(false)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allTypes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for 0.10.2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAll</span><span class="params">(Scanner scanner)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Set&lt;String&gt;&gt; map = store.getOrDefault(scanner.index(), Collections.emptyMap());</span><br><span class="line">    <span class="keyword">return</span> Stream.concat(map.keySet().stream(), map.values().stream().flatMap(Collection::stream)).collect(Collectors.toCollection(LinkedHashSet::<span class="keyword">new</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All most same but in 0.9.10 Object related types will be returned. So as a result, only java objects is returned.</p>
<p>Work around on 0.10.2 can use following codes:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationBuilder builder = ConfigurationBuilder.build()</span><br><span class="line">        .setUrls(ClasspathHelper.forPackage(<span class="string">&quot;org.zstack&quot;</span>))</span><br><span class="line">        .setScanners(<span class="keyword">new</span> SubTypesScanner(<span class="keyword">false</span>),</span><br><span class="line">                <span class="keyword">new</span> MethodAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> FieldAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> TypeAnnotationsScanner(),</span><br><span class="line">                <span class="keyword">new</span> MethodParameterScanner())</span><br><span class="line">        .setExpandSuperTypes(<span class="keyword">false</span>)</span><br><span class="line">        .filterInputsBy(<span class="keyword">new</span> FilterBuilder().includePackage(<span class="string">&quot;org.zstack&quot;</span>));</span><br><span class="line">Reflections reflections = <span class="keyword">new</span> Reflections(builder);</span><br></pre></td></tr></table></figure>

<p>filterInputsBy will filter class not in package <code>org.zstack</code> and setExpandSuperTypes will ignore super types of scanned result.</p>
<p>Note: but the result still contains groovy closure even its count cut down to acceptable numbers.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/" data-id="cld1mhecb0062yuwb8beu03im" data-title="JVM loaded classes rapidly increased issue" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/31/jvm-loaded-classes-rapidly-increased-issue/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-windows-2003-vmware-v2v-hands-on" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/27/windows-2003-vmware-v2v-hands-on/" class="article-date">
  <time class="dt-published" datetime="2022-10-27T07:27:12.000Z" itemprop="datePublished">2022-10-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/v2v/">v2v</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/27/windows-2003-vmware-v2v-hands-on/">Windows 2003 vmware v2v hands-on</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>When use virt-v2v to convert vm from vmware to kvm, windows guest sometimes meet issue after start on kvm. For quite old windows os version, typically windows 2003, may meet following blue screen issue:</p>
<img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/image-2022-10-09-21-15-41-292.png" class="">

<p>with code 0x0000007B.</p>
<p>So I write a hands-on blog to help fix this issue.</p>
<p>When search for this error on vmware kb or MSDN, we can find out that, wrong driver is the main reason cause this problem.</p>
<p>Usually, it’s recommanded to do following check for the v2v vm:</p>
<ol>
<li>Confirm the vm running well on original host, if its already error check configuration first.</li>
<li>Check if virt-v2v failed to install virtio driver to guest during virt-v2v convert.</li>
<li>Check kvm configuration, that root disk use ide to keep compitable.</li>
<li>Check if windows disabled driver installatin by its group policy.</li>
</ol>
<p>Besides those issues, if you migrate a windows 2003 with cd-rom you will also met this blue screen issue. Due to windows will change device order after v2v and root disk not work as expected.</p>
<p>So I write this practical blog to resolve device changed issue on windows 2003 v2v.</p>
<ol>
<li><p>Uninstall vmware guest tools and drivers (avoid failed to install driver issue)</p>
</li>
<li><p>Change the disk controller to ide and reboot guest</p>
<img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.13.33.png" class="">
</li>
<li><p>Attach MergeIde.iso to guest</p>
<img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.13.43.png" class="">
<p>the iso contains a .reg and a .bat file. Run the .reg first and run the .bat. The device will be recorded and prepare for hypervisor change.</p>
</li>
<li><img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.14.29.png" class="">
<p>export ovf template or use virt-v2v to export the vm the kvm.</p>
</li>
<li><img src="/2022/10/27/windows-2003-vmware-v2v-hands-on/%E6%88%AA%E5%B1%8F2022-10-25-11.10.01.png" class="">
<p>check the vm started without blue screen.</p>
</li>
</ol>
<p>For windows, it seems that with cd-rom or disk order changed guest, after hypervisor migration, windows can not identify the original order of thoes devices due to hardware change. So record the device seems a easy solution for v2v case.</p>
<p>Note: this solution is also useful for Windows XP v2v</p>
<p>Download MergeIDE.iso from: <a target="_blank" rel="noopener" href="https://www.virtualbox.org/wiki/Migrate_Windows">https://www.virtualbox.org/wiki/Migrate_Windows</a></p>
<p>Refer to Microsoft commands: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-US/troubleshoot/windows-client/performance/stop-error-7b-or-inaccessible-boot-device-troubleshooting">https://learn.microsoft.com/en-US/troubleshoot/windows-client/performance/stop-error-7b-or-inaccessible-boot-device-troubleshooting</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/27/windows-2003-vmware-v2v-hands-on/" data-id="cld1mheb6001lyuwb9nbs97t5" data-title="Windows 2003 vmware v2v hands-on" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/27/windows-2003-vmware-v2v-hands-on/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/27/windows-2003-vmware-v2v-hands-on/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-plugable-architecture-design-and-thoughts-about-implementation" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" class="article-date">
  <time class="dt-published" datetime="2022-10-20T16:45:32.000Z" itemprop="datePublished">2022-10-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/arch-notes/">arch-notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/">Plugable module architecture design and thoughts about its implementation</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Software’s complexity grows as time goes by which is suitable to describe ZStack now. Quantities of features has been integrated in the past years and developers suffered on customizing features for some commercial reasons which pushed us to think about how to get rid of customizing feature efforts and focus   on core function to earn more technical advantages.</p>
<p>Generallly, customizing features is harmful when compared to normal features (but maybe it can get commercial benifits so do not take this as absolute     rule), because more customers use normal features.</p>
<p>But because some integration requests already designed which not only require maintainance but also need development for new integration. For example, a feature for security is desing to use third-part machine to do encryption，but when customer use the feature, they all use different machine which caused lots of development cost for us to do the integrations.</p>
<p>In these cases, a plugable architecture is required to cut down the cost and this is the reason to write this blog to record related design and make it a repeatable practice.</p>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><p>For existing systems which need to support multi types of resources, typically use a register way to connect the management layer and application layers. And the application layers use a couple of standard interfaces to keep consistency and seperate implementation from mechanism.</p>
<p>So for the aim of delveloping a plugable module architecture if we still follows the pattern, easily we will be distrubed by the change of core codes from the mechanism. For example, if the core changes the mechanism as a result, application should change all of the interfaces as expected, so development is required which is not satisfied with out target.</p>
<p>Just after that small think, list all requirements before starting design. Following points are the aim of this architecture:</p>
<ul>
<li>Low development efforts or configuration as a service.</li>
<li>No core code dependency. Any changes to mechanism should be avoid.</li>
<li>Security. Plugin module should not cause any security issue.</li>
</ul>
<p>Base on those points, the architecture should be changed to expose its mechanism by interfaces.</p>
<p>For example</p>
<ol>
<li>read plugin configuration and verify it</li>
<li>generate code proxy according to the configuration</li>
<li>limited db access controled by the code proxy</li>
<li>Invokations can be verified by unit test to check the plugin can work as expected</li>
<li>change the configuration the refresh it could update the code proxy</li>
<li>plugin configurations use a specified syntax</li>
<li>if code proxy support runtime refresh can be configured</li>
</ol>
<p>From writing configurations, functional features can be easily supported.</p>
<p>If any requests need data structure support, a configuration map shoud be support for more customize and in this way we can easily create a http client to support some modules.</p>
<p>But if customize feature use any third-part libs, only configuration is not enough to support.</p>
<p>For code level, maybe open source interfaces is still needed.</p>
<p>We should offer read only data structure and functional interfaces but should not involve core codes of Java which in most cases, are aspectj support, spring containers and so on. Only pure java should be used for all plugin modules.</p>
<p>In next section, we will raise examples of two module, one is not suitable for plugable module and other one is suitable for plugable.</p>
<h2 id="Login-module"><a href="#Login-module" class="headerlink" title="Login module"></a>Login module</h2><p>Multiple login methods should be supported because many standard third-part authentication is already exists for example, CAS, oauth2, ldap and so on.</p>
<p>If you already have a customized system for authentication, I seems diffcult to integrate another system with existing one. Because the authentication actually need to transfer sensitive information to do authenticate but which is not safe enough to expose those data for plugin exactly.</p>
<p>From the usage of CAS, oauth2 we can see a generally authentication service just redirect authentication to itself and returns a authentication result and finally redirect to the right page. So sensitive information do not transferred but use a token to verify client’s response instead. </p>
<p>For ldap, just access its database directly to verify if the user is exists and finish authentication. Because ldap just integrated with ZStack so also no data transferred but ldap module itself need to care about the security issue which already resolve by third-part libs.</p>
<p>So when we tries to support plugin for login, password or any key liked information need to be exposed which is quite unsafe and have potential security risks. Compared to ldap verification, password is used directly and also faces the same problem.</p>
<p>For login module integration, two ways are recommended. One is using open-source authentication like CAS or oauth2. Another is integrating ZStack API to use account/user directly.</p>
<p>Following figure shows the flows of login module</p>
<img src="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/figure1.png" class="">

<ul>
<li>Support plugable system, main auth or additinal auth should be exposed</li>
<li>Sensitive information go through the whole flow</li>
<li>CAS and oauth2 use their own authentication which is not related the current architecture</li>
</ul>
<h2 id="Alarm-Event-system"><a href="#Alarm-Event-system" class="headerlink" title="Alarm/Event system"></a>Alarm/Event system</h2><p>For alarm event system, only expose monitor messages which seems more suitable to be developed as a plugable system.</p>
<p>When have lots of endpoint support, some use stantard libs like dingtalk and microsoft teams, offers api for message sending. But when sms system require integration, this became diffcult due to the lack of stantard apis.</p>
<p>So a plugable system can be powerful to reduce development efforts.</p>
<p>For example, sms systems all have their own apis the usages, so the interation of api is the first step. But actually the business scenarios are not only limited on send message. Maybe message distribution strategy is required, and message format is required.</p>
<p>So seperate those parts as followings:</p>
<ul>
<li>Send sms message</li>
<li>Distribution strategy</li>
<li>Message format</li>
<li>….</li>
</ul>
<p>When design plugable system, the most important thing is that we should seperate mechanism requirements and strategy requirements. </p>
<p>For message format, actually, all kinds of message required this feature and can be noted as general feature and mechanism and we can also call it customize message format. The format change do not influence how the message send or comsumed.</p>
<p>Distribution strategy, from the name, we can known that no specific rules or format could be announced because the strategy always changes from one the another.</p>
<p>Send sms message. also the integration part but the message with a format is what we can offered and only how to send the message should be defined and which is I think can be seperated from the system.</p>
<p>And more informations maybe, endpoint type, status and those ZStack defined fields also need to be involved in the plugable system so we get a architecture like following:</p>
<img src="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/figure2.png" class="">

<p>A plugable endpoint in designed to manage endpoint plugins and plugin should obey following rules: </p>
<ul>
<li>Offer endpoint type</li>
<li>Implement interface to send message</li>
<li>Unit test for endpoint plugin</li>
</ul>
<p>And the design of plugable endpoint may like following:</p>
<img src="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/figure3.png" class="">

<p>So plugable endpoint should define a interface require type and send() method’s implementation for the usage. Take the interface to a seperate open source package and publish to maven repository, its easy for develop and easy to use. By reflections, endpoint could be initialized from jar so just add jar to your dependency directory is ok.</p>
<p>To develop a plugin for new sns endpoint no need to known the logic or usage of orignal application system but developer could focus on the send method itself.</p>
<p>On the other hand, application level should extend orignal CURD api to suitable for those plugin definition and keep compitable with other endpoints.</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul>
<li>Database access is not limited which should add limited on database service itself.</li>
<li>Rules for all kind of plugins so that plugins can be managed together and distribution can keep consistency</li>
<li>More examples</li>
<li>For exsiting modules, try to refactor the plugin types to get rid of module dependency</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" data-id="cld1mheas0011yuwbeb60edrj" data-title="Plugable module architecture design and thoughts about its implementation" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/21/plugable-architecture-design-and-thoughts-about-implementation/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jvm-metaspace-memory-leak-analysis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/11/jvm-metaspace-memory-leak-analysis/" class="article-date">
  <time class="dt-published" datetime="2022-10-11T09:13:39.000Z" itemprop="datePublished">2022-10-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/11/jvm-metaspace-memory-leak-analysis/">JVM metaspace memory leak analysis</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Out system became unavailable due to <code>java.lang.OutOfMemoryError: Metaspace</code> and according to a stackoverflow answer: <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36051813/java8-java-lang-outofmemoryerror-metaspace">https://stackoverflow.com/questions/36051813/java8-java-lang-outofmemoryerror-metaspace</a>, I started to figure out what wrong with the system.</p>
<p>Before finding start analysis jvm memory dump, we need to known what means memory leak. In this case, we found thread failed to execution because create task failed due to OOM. But there are two typical reason.</p>
<ul>
<li>Too many classes need to be loaded</li>
<li>Memory leak causes some classes not unloaded</li>
</ul>
<p>Everytime you new a object, metaspace will be allocated to store metadata of the object. </p>
<p>Following code could reproduce this issue:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; ; i++) &#123;</span><br><span class="line">            Class c = cp.makeClass(<span class="string">&quot;eu.plumbr.demo.Generated&quot;</span> + i).toClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.27.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>so dynamic created class will add new class information into metaspace but if there is no class loader reference to the class, the class will be cleared after GC.</p>
<p>So it’s clear that if memory leak happened to your metaspace, you can find your application no problem when just started and oom happens after it runs for a period of time.</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>A couple of tools are available for memory leak analysis and only refer to what I have used when I figure out this issue.</p>
<h3 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h3><blockquote>
<p> <strong>JConsole</strong> is a graphical monitoring tool to monitor <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Virtual_Machine">Java Virtual Machine</a> (JVM) and Java applications both on a local or remote machine.</p>
<p> JConsole uses underlying features of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Virtual_Machine">Java Virtual Machine</a> to provide information on performance and resource consumption of applications running on the Java platform using <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Management_Extensions">Java Management Extensions</a> (JMX) technology. JConsole comes as part of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_Development_Kit">Java Development Kit</a> (JDK) and the graphical console can be started using “jconsole” command. </p>
</blockquote>
<p>As JConsole is a part of JDK, you can easily find it. On macOS, you can use commandline directly</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jconsole</span><br></pre></td></tr></table></figure>

<p>or find your java_home by </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/libexec/java_home -V</span><br></pre></td></tr></table></figure>

<p>the jconsole is under</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/bin/jconsole</span><br></pre></td></tr></table></figure>

<p>and then connect to local or remote application.</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1000.00.54.png" class="">

<p>Note: </p>
<p>In order to use JConsole, jmx need to be enabled for your application’s jvm options</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=10000 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.local.only=false -Djava.rmi.server.hostname=your_ip_address</span><br></pre></td></tr></table></figure>

<p>make sure your ip adress and port is available for remote access.</p>
<p>From JConsole we can monitor loaded class number, unloaded class number, perform gc and check if metaspace is continuously increasing.</p>
<h3 id="VisualVM"><a href="#VisualVM" class="headerlink" title=" VisualVM"></a> VisualVM</h3><p>A replacement for JConsole except jvm monitor, heap dump, application snapshot is available which is quite efficient for memory leak analysis.</p>
<h3 id="Memory-Analyzer-MAT"><a href="#Memory-Analyzer-MAT" class="headerlink" title="Memory Analyzer (MAT)"></a>Memory Analyzer (MAT)</h3><p>The Eclipse Memory Analyzer is a fast and feature-rich <strong>Java heap analyzer</strong> that helps you find memory leaks and reduce memory consumption.Use the Memory Analyzer to analyze productive heap dumps with hundreds of millions of objects, quickly calculate the retained sizes of objects, see who is preventing the Garbage Collector from collecting objects, run a report to automatically extract leak suspects.</p>
<p>My application use openjdk-1.8, so only MemoryAnalyzer-1.11.0.20201202-macosx.cocoa.x86_64.dmg</p>
<p>could be used. After that MAT only support java11.</p>
<h2 id="Start-debug"><a href="#Start-debug" class="headerlink" title="Start debug"></a>Start debug</h2><p>Combining background and tools, finding continuously increasing memory is easy but how to get to the code seems more diffcult.</p>
<p>But we could seperate debug procedure to several steps</p>
<ul>
<li>Do heap dump during a period to known always in memory classes and dynamic classes</li>
<li>Compare heap dump to figure out what increase metaspace</li>
<li>Find a operation that causes the leak</li>
</ul>
<p>Use visualVM connect to java application and monitor for a time</p>
<p>Metaspace leak can be monitored because after manually perforce GC, it still not decrease.</p>
<p>GC performed we have 72246 loaded classes.</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.07.29.png" class="">

<p>after aboubt 1minutes, GC performed but loaded class increased to 72262</p>
<p>![截屏2022-10-11 16.08.23](/Users/kayo/Desktop/blog/JVM metaspace memory leak analysis/截屏2022-10-11 16.08.23.png)</p>
<p>Aboviously there are some leak problems, so still use 1 minute as period and collect two heap dump for next step analysis.</p>
<p>Open the heap dumps with MAT to do compare, from heap dump’s dominator tree</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.40.png" class="">

<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.17.44.png" class="">

<p>Luckily, we found the increased class at first glance. The SessionFactoryImpl seems to blame.</p>
<p>Except this we found another issue with Groovy’s GStringTemplateEngine which causes groovy.reflection.ClassInfo increases and we will tell the details in next section.</p>
<p>Expand the suspects to get more details about it. By list all objects, query plan cache increased, so just google for this value</p>
<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.49.png" class="">

<img src="/2022/10/11/jvm-metaspace-memory-leak-analysis/%E6%88%AA%E5%B1%8F2022-10-1116.30.58.png" class="">

<p>from <a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.0/javadocs/org/hibernate/engine/query/spi/QueryPlanCache.html">https://docs.jboss.org/hibernate/orm/5.0/javadocs/org/hibernate/engine/query/spi/QueryPlanCache.html</a>:  Acts as a cache for compiled query plans, as well as query-parameter metadata.</p>
<p>And check its source code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the cache of the actual plans...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BoundedConcurrentHashMap queryPlanCache;</span><br></pre></td></tr></table></figure>

<p>it seems a bounded hashmap and created like below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryPlanCache = <span class="keyword">new</span> BoundedConcurrentHashMap( maxQueryPlanCount, <span class="number">20</span>, BoundedConcurrentHashMap.Eviction.LIRS );</span><br></pre></td></tr></table></figure>

<p>and hibernate use default 2048 as maxQueryPlanCount and LIRS as eviction strategy. So no need to solve a cache increasing.</p>
<h2 id="GStringTemplateEngine"><a href="#GStringTemplateEngine" class="headerlink" title="GStringTemplateEngine"></a>GStringTemplateEngine</h2><p>By debug steps, we find GStringTemplateScript occupied metaspace and thousands of classes are created.</p>
<p>Check its implements, </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groovyClass = loader.parseClass(<span class="keyword">new</span> GroovyCodeSource(templateExpressions.toString(), <span class="string">&quot;GStringTemplateScript&quot;</span> + GStringTemplateEngine.counter.incrementAndGet() + <span class="string">&quot;.groovy&quot;</span>, <span class="string">&quot;x&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>GStringTemplateScript will be created every GStringTemplate created. So for template creation, will cause dynamic class creation and finally let jvm run out of memory.</p>
<p>According to some related fix, <a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/GROOVY-7017">https://issues.apache.org/jira/browse/GROOVY-7017</a> this fix use a seperate class loader to make sure gstring template could be gced from heap but metaspace is still occupied.</p>
<p>And another article talk about: <a target="_blank" rel="noopener" href="https://tigase.net/how-aws-helped-us-optimize-memory-usage-tigase-http-api/">https://tigase.net/how-aws-helped-us-optimize-memory-usage-tigase-http-api/</a> AWS improve Tigase HTTP API Memory usage, following fix is suggested: </p>
<ul>
<li>We load all templates at once using single <code>GStringTemplateEngine</code> and cache generate templates. <strong>No more automatic reloading of templates.</strong></li>
<li>When manual reload of templates is initiated we release old instance of <code>GStringTemplateEngine</code> and parse templates using the new one.</li>
</ul>
<p>So do some test before change our code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.text.GStringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyMetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String EVENT_CHINESE_TEMPLATE = <span class="string">&quot;事件 发生了 事件详情: 名称:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        GStringTemplateEngine engine = <span class="keyword">new</span> GStringTemplateEngine();</span><br><span class="line">        HashMap&lt;Integer, groovy.text.Template&gt; templateHashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            groovy.text.Template template = templateHashMap.get(EVENT_CHINESE_TEMPLATE.hashCode());</span><br><span class="line">            <span class="keyword">if</span> (template == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    template = (groovy.text.Template) engine.createTemplate(<span class="keyword">new</span> StringReader(EVENT_CHINESE_TEMPLATE));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                templateHashMap.put(EVENT_CHINESE_TEMPLATE.hashCode(), template);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(template.make().toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MemoryPoolMXBean memoryMXBean : (ManagementFactory.getMemoryPoolMXBeans())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Metaspace&quot;</span>.equals(memoryMXBean.getName())) &#123;</span><br><span class="line">                    System.out.println(memoryMXBean.getUsage().getUsed()/<span class="number">1024</span>/<span class="number">1024</span> + <span class="string">&quot; mb&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>by use templateHashMap as cache to avoid duplicate template creation, we can see Metaspace memory usage not changed</p>
<p>but if change the code without templateHashMap:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> groovy.text.GStringTemplateEngine;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.ManagementFactory;</span><br><span class="line"><span class="keyword">import</span> java.lang.management.MemoryPoolMXBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroovyMetaspaceOOM</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String EVENT_CHINESE_TEMPLATE = <span class="string">&quot;事件 发生了 事件详情: 名称:&quot;</span>;</span><br><span class="line"></span><br><span class="line">        GStringTemplateEngine engine = <span class="keyword">new</span> GStringTemplateEngine();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            groovy.text.Template template;</span><br><span class="line">            <span class="comment">//= templateHashMap.get(EVENT_CHINESE_TEMPLATE.hashCode());</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                template = (groovy.text.Template) engine.createTemplate(<span class="keyword">new</span> StringReader(EVENT_CHINESE_TEMPLATE));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException | IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(template.make().toString());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (MemoryPoolMXBean memoryMXBean : (ManagementFactory.getMemoryPoolMXBeans())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Metaspace&quot;</span>.equals(memoryMXBean.getName())) &#123;</span><br><span class="line">                    System.out.println(memoryMXBean.getUsage().getUsed()/<span class="number">1024</span>/<span class="number">1024</span> + <span class="string">&quot; mb&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.gc();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>the metaspace will increase until oom.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/11/jvm-metaspace-memory-leak-analysis/" data-id="cld1mhead000kyuwb98bvg0mn" data-title="JVM metaspace memory leak analysis" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/11/jvm-metaspace-memory-leak-analysis/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/11/jvm-metaspace-memory-leak-analysis/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-iommu" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/06/iommu/" class="article-date">
  <time class="dt-published" datetime="2022-10-06T06:55:56.000Z" itemprop="datePublished">2022-10-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>►<a class="article-category-link" href="/categories/linux/memory-management/">memory management</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/10/06/iommu/">Input–output memory management unit</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>From Wikipedia, the free encyclopedia</p>
<blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computing">computing</a>, an <strong>input–output memory management unit</strong> (<strong>IOMMU</strong>) is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Memory_management_unit">memory management unit</a> (MMU) connecting a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Direct_memory_access">direct-memory-access</a>–capable (DMA-capable) I/O <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_bus">bus</a> to the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Main_memory">main memory</a>. Like a traditional MMU, which translates <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a>-visible <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Virtual_address">virtual addresses</a> to <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Physical_address">physical addresses</a>, the IOMMU maps device-visible virtual addresses (also called <em>device addresses</em> or <em>I/O addresses</em> in this context) to physical addresses. Some units also provide <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Memory_protection">memory protection</a> from faulty or malicious devices.</p>
</blockquote>
<p>计算机中，<strong>input–output memory management unit</strong> (<strong>IOMMU</strong>) 是直接连接到主存的一个direct-memory-access-capable（DMA-capable，允许内存直接访问的）I/O总线内存管理单元（MMU）。类似传统的MMU，会翻译CPU可见的虚拟地址为物理地址，IOMMU映射设备可见的虚拟地址（也叫做设备地址或者I/O地址）到物理地址。一些单元也提供内存保护功能，避免设备出错或者受到攻击。</p>
<blockquote>
<p>An example IOMMU is the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Graphics_address_remapping_table">graphics address remapping table</a> (GART) used by <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Accelerated_Graphics_Port">AGP</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/PCI_Express">PCI Express</a> graphics cards on Intel Architecture and AMD computers.</p>
<p>On the x86 architecture, prior to splitting the functionality of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Northbridge_(computing)">northbridge</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Southbridge_(computing)">southbridge</a> between the CPU and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Platform_Controller_Hub">Platform Controller Hub</a> (PCH), I/O virtualization was not performed by the CPU but instead by the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Chipset">chipset</a>.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-1">1]</a>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-2">2]</a></p>
</blockquote>
<p>举个例子，在Intel架构和AMD计算机上被AGP和PCI Express图形卡使用的graphics address remapping table（GART）就是IOMMU</p>
<p>在x86架构，提前拆分CPU，平台控制器HUB（PCH），I/O虚拟化在北桥和南桥的功能并不是CPU直接处理的，而是由芯片组解决的。</p>
<blockquote>
<p>The advantages of having an IOMMU, compared to direct physical addressing of the memory (DMA), include[*<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Wikipedia:Citation_needed">citation needed</a>*]:</p>
<ul>
<li>Large regions of memory can be allocated without the need to be contiguous in physical memory – the IOMMU maps contiguous virtual addresses to the underlying fragmented physical addresses. Thus, the use of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vectored_I/O">vectored I/O</a> (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Scatter-gather">scatter-gather</a> lists) can sometimes be avoided.</li>
<li>Devices that do not support memory addresses long enough to address the entire physical memory can still address the entire memory through the IOMMU, avoiding overheads associated with copying buffers to and from the peripheral’s addressable memory space.</li>
<li>For example, x86 computers can address more than 4 gigabytes of memory with the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Physical_Address_Extension">Physical Address Extension</a> (PAE) feature in an x86 processor. Still, an ordinary 32-bit PCI device simply cannot address the memory above the 4 GiB boundary, and thus it cannot directly access it. Without an IOMMU, the operating system would have to implement time-consuming <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bounce_buffer">bounce buffers</a> (also known as double buffers[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-3">3]</a>).</li>
<li>Memory is protected from malicious devices that are attempting DMA attacks and faulty devices that are attempting errant memory transfers because a device cannot read or write to memory that has not been explicitly allocated (mapped) for it. The memory protection is based on the fact that OS running on the CPU (see figure) exclusively controls both the MMU and the IOMMU. The devices are physically unable to circumvent or corrupt configured memory management tables.</li>
<li>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hardware-assisted_virtualization">virtualization</a>, <em>guest</em> operating systems can use hardware that is not specifically made for virtualization. Higher performance hardware such as graphics cards use DMA to access memory directly; in a virtual environment all memory addresses are re-mapped by the virtual machine software, which causes DMA devices to fail. The IOMMU handles this re-mapping, allowing the native device drivers to be used in a guest operating system.</li>
<li>In some architectures IOMMU also performs <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hardware_interrupt">hardware interrupt</a> re-mapping, in a manner similar to standard memory address re-mapping.</li>
<li>Peripheral memory paging can be supported by an IOMMU. A peripheral using the PCI-SIG PCIe Address Translation Services (ATS) Page Request Interface (PRI) extension can detect and signal the need for memory manager services.</li>
</ul>
<p>For system architectures in which port I/O is a distinct address space from the memory address space, an IOMMU is not used when the CPU communicates with devices via <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/I/O_port">I/O ports</a>. In system architectures in which port I/O and memory are mapped into a suitable address space, an IOMMU can translate port I/O accesses.</p>
</blockquote>
<p>IOMMU的优势，和内存的直接物理映射（DMA）相比，包括：</p>
<ul>
<li>支持分配大片的内存，而且不需要是物理上连续的。IOMMU的映射保证虚拟地址连续，物理地址可以不连续。因此<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Vectored_I/O">vectored I/O</a> (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Scatter-gather">scatter-gather</a> lists) 有些时候是不能用的</li>
<li>内存地址长度不支持映射整个物理内存的时候也可以通过IOMMU来找到整个内存的地址。同时可以避免拷贝特定的内存到外围的内存空间而造成损耗<ul>
<li>对x86计算机，具备通过Physical Address Extension（PAE）寻址超过4GB的内存的特性。同时一个普通的32位 PCI设备并不能很简单的找到超过4GB的内存地址，并且也无法访问这个地址。没有IOMMU的情况下，操作系统必须要实现一个消耗时间的bounce buffers（也叫做double buffer）</li>
</ul>
</li>
<li>内存保护，避免恶意设备通过DMA攻击或者错误的设备尝试传输不正确的内存，因为一个设备并不能读或者写并不是这个设备分配映射的内存。内存保护是基于OS在CPU上运行并且排他的控制MMU以及IOMMU的事实实现的。设备在物理上就是没办法去避免或者破坏已经配置好的内存管理表的。<ul>
<li>在虚拟化中，guest操作系统可以使用非特殊的虚拟化模式的硬件（物理硬件）。高性能硬件，比如说图形卡就是使用DMA来直接访问内存的。在虚拟环境中，所有的内存地址都被虚拟机软件重新做了映射，这就会导致DMA设备会访问失败。IOMMU需要处理这个重新映射的行为，并允许本地的硬件驱动能够被虚拟机操作系统使用。</li>
</ul>
</li>
<li>在一些架构中，IOMMU也执行硬件中断的重新映射，类似标准内存地址的重新映射</li>
<li>IOMMU也支持外围的内存页。一个外围的使用PIC-SIG PCIe地址翻译服务（Address Translation Services）页请求接口（Page Request Interface）拓展能够探测并发出信号给需要内存管理的服务</li>
</ul>
<p>对port I/O在内存空间中有有独有地址空间系统架构里，IOMMU并不通过I/O ports进行设备和CPU的沟通。系统架构里，port I/O和内存是映射到合适的地址空间里，IOMMU可以翻译port I/O的访问。</p>
<blockquote>
<p>The disadvantages of having an IOMMU, compared to direct physical addressing of the memory, include:[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-price-of-safety-4">4]</a></p>
<ul>
<li>Some degradation of performance from translation and management overhead (e.g., page table walks).</li>
<li>Consumption of physical memory for the added I/O <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Page_table">page (translation) tables</a>. This can be mitigated if the tables can be shared with the processor.</li>
<li>In order to decrease the page table size the granularity of many IOMMUs is equal to the memory paging (often 4096 bytes), and hence each small buffer that needs protection against DMA attack has to be page aligned and zeroed before making visible to the device. Due to OS memory allocation complexity this means that the device driver needs to use bounce buffers for the sensitive data structures and hence decreasing overall performance.</li>
</ul>
</blockquote>
<p>IOMMU的缺点，和内存直接访问物理地址，包括：</p>
<ul>
<li>因为翻译和管理地址导致的性能损耗（比如page table walks）</li>
<li>增加I/O page（translation）tables需要消耗物理内存。如果处理器可以共享page table就能够给减缓这个问题</li>
<li>为了减少page tables的大小以及减少page的粒度，大部分IOMMUs是和内存页（通常是4096字节）对等的，并且因为每个小buffer都需要避免DMA attack，在提供给设备访问之前，必须要被对齐并且置为0。由于OS内存分配的复杂性，这意味着设备驱动对敏感的数据结构要使用一个弹性的buffers因此降低了性能（因为要动态分配）</li>
</ul>
<blockquote>
<p>When an operating system is running inside a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Virtual_machine">virtual machine</a>, including systems that use <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Paravirtualization">paravirtualization</a>, such as <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Xen">Xen</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a>, it does not usually know the host-physical addresses of memory that it accesses. This makes providing direct access to the computer hardware difficult, because if the guest OS tried to instruct the hardware to perform a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Direct_memory_access">direct memory access</a> (DMA) using guest-physical addresses, it would likely corrupt the memory, as the hardware does not know about the mapping between the guest-physical and host-physical addresses for the given virtual machine. The corruption can be avoided if the hypervisor or host OS intervenes in the I/O operation to apply the translations. However, this approach incurs a delay in the I/O operation.</p>
<p>An IOMMU solves this problem by re-mapping the addresses accessed by the hardware according to the same (or a compatible) translation table that is used to map guest-physical address to host-physical addresses.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit#cite_note-5">5]</a></p>
</blockquote>
<p>当操作系统运行在虚拟机里，包括操作系统辅助虚拟化，比如Xen和KVM，通常情况下是不知道内存要访问的物理机器物理地址的。这个情况下要直接提供计算机的硬件地址是很困难的，因为如果guest OS尝试去命令硬件使用guest的物理地址执行直接内存访问（DMA），将会是一个错误的地址（因为虚拟化，guest的内存空间实际上和host的内存空间不是一回事），这是由于硬件并不知道guest物理地址和host物理地址之间的映射关系。通过host OS的介入把这个I/O操作翻译掉，就能够解决这个问题，而这个方法就会造成I/O操作变慢。</p>
<p>一个IOMMU可以通过宠幸映射硬件关联地址的翻译来解决这个问题，也就是用来做guest物理地址和host物理地址的映射。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/10/06/iommu/" data-id="cld1mheaa000gyuwbhmka8138" data-title="Input–output memory management unit" class="article-share-link">Share</a>
      
      
        <a href="/2022/10/06/iommu/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/10/06/iommu/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-kvm-mmu-rework-the-x86-tdp-direct-mapped-case" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/" class="article-date">
  <time class="dt-published" datetime="2022-09-29T04:03:02.000Z" itemprop="datePublished">2022-09-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/">kvm: mmu: Rework the x86 TDP direct mapped case</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Over the years, the needs for KVM&#39;s x86 MMU have grown from running small</span><br><span class="line">guests to live migrating multi-terabyte VMs with hundreds of vCPUs. Where</span><br><span class="line">we previously depended upon shadow paging to run all guests, we now have</span><br><span class="line">the use of two dimensional paging (TDP). This RFC proposes and</span><br><span class="line">demonstrates two major changes to the MMU. First, an iterator abstraction </span><br><span class="line">that simplifies traversal of TDP paging structures when running an L1</span><br><span class="line">guest. This abstraction takes advantage of the relative simplicity of TDP</span><br><span class="line">to simplify the implementation of MMU functions. Second, this RFC changes</span><br><span class="line">the synchronization model to enable more parallelism than the monolithic</span><br><span class="line">MMU lock. This &quot;direct mode&quot; MMU is currently in use at Google and has</span><br><span class="line">given us the performance necessary to live migrate our 416 vCPU, 12TiB</span><br><span class="line">m2-ultramem-416 VMs.</span><br></pre></td></tr></table></figure>

<p>过去的数年里，对KVM’s x86 MMU的需求从运行小虚拟机发展到需要支持在线迁移数T内存上百个vCPU的虚拟机。而我们以前试用shadow paging来运行虚拟机，目前我们使用two dimensional paging(TDP)。这个提议说明了两个主要的针对MMU的修改。首先，增加了一个用于L1 guest运行时简化访问TDP paging数据结构的迭代器抽象。这个抽象使用了一个相对简单的TDP来简化MMU功能的实现。其次，这个RFC修改了同步模型来支持并行的而不是使用现在这个巨大的MMU锁。这个“direct mode” MMU在google内部使用并且已经提供了热迁移416 vCPU + 12TB内存的虚拟机的性能了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">The primary motivation for this work was to handle page faults in</span><br><span class="line">parallel. When VMs have hundreds of vCPUs and terabytes of memory, KVM&#39;s</span><br><span class="line">MMU lock suffers from extreme contention, resulting in soft-lockups and</span><br><span class="line">jitter in the guest. To demonstrate this I also written, and will submit</span><br><span class="line">a demand paging test to KVM selftests. The test creates N vCPUs, which</span><br><span class="line">each touch disjoint regions of memory. Page faults are picked up by N</span><br><span class="line">user fault FD handlers, one for each vCPU. Over a 1 second profile of</span><br><span class="line">the demand paging test, with 416 vCPUs and 4G per vCPU, 98% of the</span><br><span class="line">execution time was spent waiting for the MMU lock! With this patch</span><br><span class="line">series the total execution time for the test was reduced by 89% and the</span><br><span class="line">execution was dominated by get_user_pages and the user fault FD ioctl.</span><br><span class="line">As a secondary benefit, the iterator-based implementation does not use</span><br><span class="line">the rmap or struct kvm_mmu_pages, saving ~0.2% of guest memory in KVM</span><br><span class="line">overheads.</span><br></pre></td></tr></table></figure>

<p>这个工作的主要动机就是并行的处理page fault。当虚拟机油上百个vCPU和数T内存的时候，KVM的MMU锁竞争会非常的激烈，导致guest进入kernel loop或者是都懂状体啊。为了展示这个改动的结果，我实现了一个paging test用于KVM的测试。这个测试会创建一个N vCPUs每一个vCPU都来弄乱一部分内存。Page faults会被N个用户态错误FD处理，每一个对应一个vCPU。在任意1s的测试面里，416个vCPUS以及一个vCPU 4G内存，98%的时间会消耗在MMU lock上。通过这部分补丁，89%的时间都被节省了，处理逻辑被get_user_pages以及用户fault FD ioctl处理了。另外一个好处，基于迭代器的实现并不使用rmap或者是kvm_mmu_pages的数据结构，节约了大约0.2%的kvm虚拟机内存损耗。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">The goal of this  RFC is to demonstrate and gather feedback on the</span><br><span class="line">iterator pattern, the memory savings it enables for the &quot;direct case&quot;</span><br><span class="line">and the changes to the synchronization model. Though they are interwoven</span><br><span class="line">in this series, I will separate the iterator from the synchronization</span><br><span class="line">changes in a future series. I recognize that some feature work will be</span><br><span class="line">needed to make this patch set ready for merging. That work is detailed</span><br><span class="line">at the end of this cover letter.</span><br></pre></td></tr></table></figure>

<p>这篇RFC是为了展示并且收集对于迭代器模式的反馈，内存的节省在使用“direct case”之后启用了 并且修改了同步模型。虽然他们之前紧密关联，我将会在之后的改动里把迭代器从同步模型里分离出来。我意识到在合并之前还有一些工作要做。这部分工作的细节附在这个letter之后。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">The overall purpose of the KVM MMU is to program paging structures</span><br><span class="line">(CR3&#x2F;EPT&#x2F;NPT) to encode the mapping of guest addresses to host physical</span><br><span class="line">addresses (HPA), and to provide utilities for other KVM features, for</span><br><span class="line">example dirty logging. The definition of the L1 guest physical address</span><br><span class="line">(GPA) to HPA mapping comes in two parts: KVM&#39;s memslots map GPA to HVA,</span><br><span class="line">and the kernel MM&#x2F;x86 host page tables map HVA -&gt; HPA. Without TDP, the</span><br><span class="line">MMU must program the x86 page tables to encode the full translation of</span><br><span class="line">guest virtual addresses (GVA) to HPA. This requires &quot;shadowing&quot; the</span><br><span class="line">guest&#39;s page tables to create a composite x86 paging structure. This</span><br><span class="line">solution is complicated, requires separate paging structures for each</span><br><span class="line">guest CR3, and requires emulating guest page table changes. The TDP case</span><br><span class="line">is much simpler. In this case, KVM lets the guest control CR3 and</span><br><span class="line">programs the EPT&#x2F;NPT paging structures with the GPA -&gt; HPA mapping. The</span><br><span class="line">guest has no way to change this mapping and only one version of the</span><br><span class="line">paging structure is needed per L1 address space (normal execution or</span><br><span class="line">system management mode, on x86).</span><br></pre></td></tr></table></figure>

<p>KVM MMU的主要目的是通过程序实现分页数据结构（CR3/EPT/NPT）来把虚拟机地址encode成物理机物理地址，以及提供其他KVM特性，比如dirty logging。对L1 guest的物理地址到Host物理地址的映射可以分为两个部分。KVM的memslots映射GPA到HVA，然后kernel MM/x86的host page tables映射HVA到HPA。在没有TDP的情况下，MMU必须把整个GVA到HPA的过程通过编程的方式实现，这个就需要用到“shadowing”也就guest的page tables来创建一个复合的x86 paging结构。这个实现方法是很复杂的，需要根据每个guest的CR3把分页结构分离开，并且模拟guest的page table变化。TDP的场景就更容易一些，这个场景里，KVM让guest控制CR3并且编程了一个EPT/NPT的分页数据结构来做GPA到HPA的映射。这样guest就不需要修改这个映射，并且只需要在每个L1guest的地址空间维护一个版本的分页数据结构（一般的在x86上的形式）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">This RFC implements a &quot;direct MMU&quot; through alternative implementations</span><br><span class="line">of MMU functions for running L1 guests with TDP. The direct MMU gets its</span><br><span class="line">name from the direct role bit in struct kvm_mmu_page in the existing MMU</span><br><span class="line">implementation, which indicates that the PTEs in a page table (and their</span><br><span class="line">children) map a linear range of L1 GPAs. Though the direct MMU does not</span><br><span class="line">currently use struct kvm_mmu_page, all of its pages would implicitly</span><br><span class="line">have that bit set. The direct MMU falls back to the existing shadow</span><br><span class="line">paging implementation when TDP is not available, and interoperates with</span><br><span class="line">the existing shadow paging implementation for nesting. </span><br></pre></td></tr></table></figure>

<p>这篇RFC实现了一个可选的使用MMU功能来结合TDP运行L1 guest的“direct MMU”功能。这个direct MMU的命名是因为直接从kvm_mmu_page的role bit获取了一个direct role（也是目前MMU里已有的实现）表示page table的PTEs（以及他们的子page）映射了一个组线性的L1 GPA地址。虽然direct MMU并没有使用kvm_mmu_page，不过所有的page都会做这个设置。当TDP不可用的时候direct MMU会降级到已有的shadow paging功能并且如果是嵌套虚拟化，也会联动到已有的shadow paging功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In order to handle page faults in parallel, the MMU needs to allow a</span><br><span class="line">variety of changes to PTEs concurrently. The first step in this series</span><br><span class="line">is to replace the MMU lock with a read&#x2F;write lock to enable multiple</span><br><span class="line">threads to perform operations at the same time and interoperate with</span><br><span class="line">functions that still need the monolithic lock. With threads handling</span><br><span class="line">page faults in parallel, the functions operating on the page table</span><br><span class="line">need to: a) ensure PTE modifications are atomic, and  b) ensure that page</span><br><span class="line">table memory is freed and accessed safely Conveniently, the iterator</span><br><span class="line">pattern introduced in this series handles both concerns.</span><br></pre></td></tr></table></figure>

<p>为了并行处理page fault，MMU需要允许并发修改PTEs（page table entry）。这部分补丁的第一步就是把MMU锁替换为读/写锁来弃用多线程来支持同时执行操作，并且把原本的需要一个大锁的函数也做了改动。通过线程并行处理page tauls，对应的page table的功能需要</p>
<ol>
<li>保证PTE的修改是原子的</li>
<li>保证page table的内存是空闲的并且可以被安全的访问。</li>
</ol>
<p>为了更方便的解决这两个问题，我们引入了迭代器模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">The direct walk iterator implements a pre-order traversal of the TDP</span><br><span class="line">paging structures. Threads are able to read and write page table memory</span><br><span class="line">safely in this traversal through the use of RCU and page table memory is</span><br><span class="line">freed in RCU callbacks, as part of a three step process. (More on that</span><br><span class="line">below.) To ensure that PTEs are updated atomically, the iterator</span><br><span class="line">provides a function for updating the current pte. If the update</span><br><span class="line">succeeds, the iterator handles bookkeeping based on the current and</span><br><span class="line">previous value of the PTE. If it fails, some other thread will have</span><br><span class="line">succeeded, and the iterator repeats that PTE on the next iteration,</span><br><span class="line">transparently retrying the operation. The iterator also handles yielding</span><br><span class="line">and reacquiring the appropriate MMU lock, and flushing the TLB or</span><br><span class="line">queuing work to be done on the next flush.</span><br></pre></td></tr></table></figure>

<p>这个direct walk iterator实现了一个顺序的TDP paging结构的遍历。线程通过使用RCU允许安全的在这个遍历过程里读和写page table的内存，并且page table的内存会在RCU的callbacks里释放，并作为处理逻辑的第三个步骤的一部分（不仅是底下这部分）。为了保证PTEs被原子的更新，迭代器提供了一个更新当前pte的方法。如果更新成功，迭代器会对之前和现在的PTE值做一个记录。如果失败了，其他线程会执行成功，迭代器会在下一次迭代继续重复这个PTE，并显式的重试一下。迭代器充实也会处理yielding并且重新获取合适的MMU lock，并且刷新TLB或者保存修改的内容到下一次flush位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In order to minimize TLB flushes, we expand the tlbs_dirty count to</span><br><span class="line">track unflushed changes made through the iterator, so that other threads</span><br><span class="line">know that the in-memory page tables they traverse might not be what the</span><br><span class="line">guest is using to access memory. Page table pages that have been</span><br><span class="line">disconnected from the paging structure root are freed in a three step</span><br><span class="line">process. First the pages are filled with special, nonpresent PTEs so</span><br><span class="line">that guest accesses to them, through the paging structure caches result</span><br><span class="line">in TDP page faults. Second, the pages are added to a disconnected list,</span><br><span class="line">a snapshot of which is transferred to a free list, after each TLB flush.</span><br><span class="line">The TLB flush clears the paging structure caches, so the guest will no</span><br><span class="line">longer use the disconnected pages. Lastly, the free list is processed</span><br><span class="line">asynchronously to queue RCU callbacks which free the memory. The RCU</span><br><span class="line">grace period ensures no kernel threads are using the disconnected pages.</span><br><span class="line">This allows the MMU to leave the guest in an inconsistent, but safe,</span><br><span class="line">state with respect to the in-memory paging structure. When functions</span><br><span class="line">need to guarantee that the guest will use the in-memory state after a</span><br><span class="line">traversal, they can either flush the TLBs unconditionally or, if using</span><br><span class="line">the MMU lock in write mode, flush the TLBs under the lock only if the</span><br><span class="line">tlbs_dirty count is elevated.</span><br></pre></td></tr></table></figure>

<p>为了最小化TLB的flush，我们拓展了tlbs_dirty count来跟踪没有flush的迭代器修改，因此其他线程就能知道内存的page tables并不是guest当前要访问的内存（因为没刷新）。Page tables pages将会从paging数据结构里堵啊开，并且对应的pages就会被释放掉。</p>
<ol>
<li>page将会用特殊的，并未出现的PTEs写满，因此guest访问这些地址的时候就是通过paging的cache，最后抛出一个TDP的page faults。</li>
<li>pages将会被加入到一个disconnected的list里，一个快照记录需要被释放的信息，然后按顺序做TLB flush。TLB的flush会清理对应的paging数据结构的缓存，所以guest将没办法访问disconnected的page</li>
<li>free list会被异步处理，并且进入队列等RCU的callbacks来释放内存。</li>
</ol>
<p>RCU grace period保证没有内核线程会使用这些disconnected的pages。这个允许MMU通过内存中的paging数据结构让guest保持一个不一致但是安全的状态。如果一些方法需要保证guest需要使用遍历之后的内存中的状态，可以直接flush这个TLB或者是使用写模式的MMU锁，flush TLB操作需要保证tlbs_dirty比较高的时候拿到锁执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The use of the direct MMU can be controlled by a module parameter which</span><br><span class="line">is snapshotted on VM creation and follows the life of the VM. This</span><br><span class="line">snapshot is used in many functions to decide whether or not to use</span><br><span class="line">direct MMU handlers for a given operation. This is a maintenance burden</span><br><span class="line">and in future versions of this series I will address that and remove</span><br><span class="line">some of the code the direct MMU replaces. I am especially interested in</span><br><span class="line">feedback from the community as to how this series can best be merged. I</span><br><span class="line">see two broad approaches: replacement and integration or modularization.</span><br></pre></td></tr></table></figure>

<p>Direct MMU的使用可以通过模块参数，一个随着虚拟机的创建并伴随VM生命周期的参数控制。这个快照在很多方法里面用来判断是否需要使用direct MMU的处理。这是一个不太好维护的东西，未来需要去掉一些direct MMU相关的代码。我很期待社区的反馈来保证这些code在最好的状态合并。目前我认为有两个方法，替换+集成 或者是模块化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Replacement and integration would require amending the existing shadow</span><br><span class="line">paging implementation to use a similar iterator pattern. This would mean</span><br><span class="line">expanding the iterator to work with an rmap to support shadow paging and</span><br><span class="line">reconciling the synchronization changes made to the direct case with the</span><br><span class="line">complexities of shadow paging and nesting.</span><br></pre></td></tr></table></figure>

<p>替换和集成需要给目前的shadow paging增加类似的迭代器模式。也就意味着拓展迭代器并能够和rmap一起工作来支持shadow paging以及使得原本的同步修改模式和direct模式来适应复杂的shadow paging以及nesting</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">The modularization approach would require factoring out the &quot;direct MMU&quot;</span><br><span class="line">or &quot;TDP MMU&quot; and &quot;shadow MMU(s).&quot; The function pointers in the MMU</span><br><span class="line">struct would need to be expanded to fully encompass the interface of the</span><br><span class="line">MMU and multiple, simpler, implementations of those functions would be</span><br><span class="line">needed. As it is, use of the module parameter snapshot gives us a rough</span><br><span class="line">outline of the previously undocumented shape of the MMU interface, which</span><br><span class="line">could facilitate modularization. Modularization could allow for the</span><br><span class="line">separation of the shadow paging implementations for running guests</span><br><span class="line">without TDP, and running nested guests with TDP, and the breakup of</span><br><span class="line">paging_tmpl.h.</span><br></pre></td></tr></table></figure>

<p>模块化主要是重构几个分开的部分“direct MMU”或者“TDP MMU”以及“shadow MMU”。需要把MMU的结构拓展为一个完整的包含MMU以及多MMU，单MMU并实现这些对应的接口。试用类似模块参数快照能够给出一个粗略的MMU接口的大致的轮廓，也能够作为模块化的基础。模块化允许shadow paging在guest中的使用，也支持嵌套虚拟化的guest试用TDP，也是paging_tmpl.h的突破。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In addition to the integration question, below are some of the work</span><br><span class="line">items I plan to address before sending the series out again:</span><br></pre></td></tr></table></figure>

<p>关于集成的部分我重新列了一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Disentangle the iterator pattern from the synchronization changes</span><br><span class="line">	Currently the direct_walk_iterator is very closely tied to the use</span><br><span class="line">	of atomic operations, RCU, and a rwlock for MMU operations. This</span><br><span class="line">	does not need to be the case: instead I would like to see those</span><br><span class="line">	synchronization changes built on top of this iterator pattern.</span><br><span class="line"></span><br><span class="line">Support 5 level paging and PAE</span><br><span class="line">	Currently the direct walk iterator only supports 4 level, 64bit</span><br><span class="line">	architectures.</span><br><span class="line"></span><br><span class="line">Support MMU memory reclaim</span><br><span class="line">	Currently this patch series does not respect memory limits applied</span><br><span class="line">	through kvm_vm_ioctl_set_nr_mmu_pages.</span><br><span class="line"></span><br><span class="line">Support nonpaging guests</span><br><span class="line">	Guests that are not using virtual addresses can be direct mapped,</span><br><span class="line">	even without TDP.</span><br><span class="line"></span><br><span class="line">Implement fast invalidation of all PTEs</span><br><span class="line">	This series was prepared between when the fast invalidate_all</span><br><span class="line">	mechanism was removed and when it was re-added. Currently, there</span><br><span class="line">	is no fast path for invalidating all direct MMU PTEs.</span><br><span class="line"></span><br><span class="line">Move more operations to execute concurrently</span><br><span class="line">	In this patch series, only page faults are able to execute</span><br><span class="line">	concurrently, however several other functions can also execute</span><br><span class="line">	concurrently, simply by changing the write lock acquisition to a</span><br><span class="line">	read lock.</span><br></pre></td></tr></table></figure>

<p>把迭代器从同步修改里分离出来</p>
<p>目前的direct_walk_iterator是和原子操作，RCU和MMU操作的读写锁。但实际上没有必要这样，其实这些同步修改应该实现在迭代器模式之上。</p>
<p>支持5级的paging以及PAE</p>
<p>目前direct walk interator只支持4级，64bit的架构</p>
<p>支持MMU的内存回收</p>
<p>当前这个补丁并没有支持kvm_vm_ioctl_set_nr_mmu_pages内存相关的限制</p>
<p>支持nonpaging guests</p>
<p>guest如果没使用虚拟地址的也能直接映射，甚至不需要TDP</p>
<p>实现快速的对所有PTEs的失效检测</p>
<p>增加更多的并发操作</p>
<p>refer to:<br><a target="_blank" rel="noopener" href="https://www.spinics.net/lists/kvm/msg196464.html">https://www.spinics.net/lists/kvm/msg196464.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/" data-id="cld1mhecc0066yuwba332a3x4" data-title="kvm: mmu: Rework the x86 TDP direct mapped case" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-libvirt-memory-snapshot" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/28/libvirt-memory-snapshot/" class="article-date">
  <time class="dt-published" datetime="2022-09-28T01:19:10.372Z" itemprop="datePublished">2022-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>virDomainDefParseXML -&gt; virDomainDiskDefParseXML -&gt; virDomainDeviceInfoParseXML -&gt; virDomainDeviceAddressParseXML -&gt; virPCIDeviceAddressParseXML</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (devaddr) &#123;</span><br><span class="line">    if (virDomainParseLegacyDeviceAddress(devaddr,</span><br><span class="line">                                          &amp;def-&gt;info.addr.pci) &lt; 0) &#123;</span><br><span class="line">        virReportError(VIR_ERR_INTERNAL_ERROR,</span><br><span class="line">                       _(&quot;Unable to parse devaddr parameter &#39;%s&#39;&quot;),</span><br><span class="line">                       devaddr);</span><br><span class="line">        goto error;</span><br><span class="line">    &#125;</span><br><span class="line">    def-&gt;info.type &#x3D; VIR_DOMAIN_DEVICE_ADDRESS_TYPE_PCI;</span><br><span class="line">&#125; else &#123;</span><br></pre></td></tr></table></figure>

<p>qemuDomainSaveInternal -&gt; </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if (!(cookie &#x3D; qemuDomainSaveCookieNew(vm)))</span><br><span class="line">    goto endjob;</span><br><span class="line"></span><br><span class="line">if (!(data &#x3D; virQEMUSaveDataNew(xml, cookie, was_running, compressed,</span><br><span class="line">                                driver-&gt;xmlopt)))</span><br><span class="line">    goto endjob;</span><br><span class="line">xml &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">ret &#x3D; qemuDomainSaveMemory(driver, vm, path, data, compressedpath,</span><br><span class="line">                           flags, QEMU_ASYNC_JOB_SAVE);</span><br><span class="line">if (ret &lt; 0)</span><br><span class="line">    goto endjob;</span><br><span class="line"></span><br><span class="line">&#x2F;* Shut it down *&#x2F;</span><br><span class="line">qemuProcessStop(driver, vm, VIR_DOMAIN_SHUTOFF_SAVED,</span><br><span class="line">                QEMU_ASYNC_JOB_SAVE, 0);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">        rc &#x3D; qemuMonitorMigrateToFd(priv-&gt;mon,</span><br><span class="line">                                    QEMU_MONITOR_MIGRATE_BACKGROUND,</span><br><span class="line">                                    fd);</span><br><span class="line">                                    </span><br><span class="line">int</span><br><span class="line">qemuMonitorMigrateToFd(qemuMonitorPtr mon,</span><br><span class="line">                       unsigned int flags,</span><br><span class="line">                       int fd)</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line">    VIR_DEBUG(&quot;fd&#x3D;%d flags&#x3D;0x%x&quot;, fd, flags);</span><br><span class="line"></span><br><span class="line">    QEMU_CHECK_MONITOR(mon);</span><br><span class="line"></span><br><span class="line">    if (qemuMonitorSendFileHandle(mon, &quot;migrate&quot;, fd) &lt; 0)</span><br><span class="line">        return -1;</span><br><span class="line"></span><br><span class="line">    ret &#x3D; qemuMonitorJSONMigrate(mon, flags, &quot;fd:migrate&quot;);</span><br><span class="line"></span><br><span class="line">    if (ret &lt; 0) &#123;</span><br><span class="line">        if (qemuMonitorCloseFileHandle(mon, &quot;migrate&quot;) &lt; 0)</span><br><span class="line">            VIR_WARN(&quot;failed to close migration handle&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>qemu should support sendFD (qemu is should using a unix socket monitor)</p>
<p>qemu monitor get fd (SCM_RIGHTS) </p>
<p>SCM_RIGHTS<br>              Send or receive a set of open file descriptors from<br>              another process.  The data portion contains an integer<br>              array of the file descriptors.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* Perform the migration *&#x2F;</span><br><span class="line">if (qemuMigrationSrcToFile(driver, vm, fd, compressedpath, asyncJob) &lt; 0)</span><br><span class="line">    goto cleanup;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemuMonitorJSONMigrate</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/28/libvirt-memory-snapshot/" data-id="cld1mheaj000oyuwbei0mcdcw" data-title="" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/28/libvirt-memory-snapshot/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/28/libvirt-memory-snapshot/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-a-simplified-TDP-with-large-tables" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/27/a-simplified-TDP-with-large-tables/" class="article-date">
  <time class="dt-published" datetime="2022-09-27T13:34:44.000Z" itemprop="datePublished">2022-09-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/27/a-simplified-TDP-with-large-tables/">A Simplified TDP with Large Tables</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Abstract. Among the performance bottlenecks for the virtual machine, memory comes next to the I/O as the second major source of overhead to be addressed. While the SPT and TDP have proved to be quite effective and mature solutions in memory virtualization, it is not yet guaranteed that they perform equally well for arbitrary kind of workloads, especially considering that the performance of HPC workloads is more sensitive to the virtual than to the native execution environment. We propose that based on the current TDP design, modification could be made to reduce the 2D page table walk with the help of large page table. By doing this, not only the guest and host context switching due to guest page fault could be avoided, but also the second dimension of paging could be potentially simplified, which will lead to better performance.</p>
</blockquote>
<p>目前内存的损耗已经成为所有虚拟机性能瓶颈中，仅次于I/O的损耗。虽然已经证明了SPT和TDP是非常有效和成熟的内存虚拟化解决方法，但是相比于非虚拟机环境来说，内存虚拟化的性能对任何类型的负载，特别是高性能计算这种对性能特别敏感的情况是没有提供保证的。所以我们基于现在的TDP的设计提出了一些可行的修改，通过large page table检查少2D页表的查找。通过这个改动，不仅仅是guest和host的上下文切换导致的guest page fault可以被避免（这里说的应该是context change之后，会碰到page fault，large page table似乎是不是增加了page的大小，这样页表的条数就减少了，即使context change也不会发生table entry的变化，减少了page fault？可以继续看看）。同时second dimension of paging（也就是TDP）也可以被简化并获得更好的性能</p>
<blockquote>
<p>In the context of system virtualization, SPT (shadow page table) and TDP (twodimensional paging)1 are the two mature solutions for memory virtualization in the current hypervisors. Both of them perform address translation transparently from the guest to the host. In dealing with the translation chain from GVA (guest virtual address) to HPA (host physical address), the SPT combines the three intermediate steps for each GVA→HPA into a single entry, which contains the wanted address and saves further efforts to walk through both of the guest and host page tables as long as the cached entry is not invalidated in any form. However, as SPT is a part of the hypervisor and must be kept as consistent as possible with the guest page table, the processor had to exit from the guest to host mode to update the SPT and make it accessible, during which a considerable number of CPU cycles could have been wasted. TDP comes as a remedy by keeping GVA→GPA translation in the guest, while shifting GPA→HPA translation from the hypervisor to the processor. The expensive vmexit and vmentry due to guest page fault are avoided by TDP. Unfortunately in case of TLB-miss (translation look-aside block) the multi-level page table must still be walked through to fetch the missing data from the memory. Because of this nature, the TLB is not quite helpful in preventing page table from being walked when running workloads with poor temporal locality or cache access behavior. As a result, 1 TDP it is known as the AMD NPT and Intel EPT. For technical neutrality reason TDP is used to refer to the paging mechanism with hardware assistance the performance gain could be more or less offset by the overhead. We attempt to combine the merits of the two methods and meanwhile avoid the downsides of them by adapting the mmu code in the hypervisor.</p>
</blockquote>
<p>在系统虚拟化中，SPT（shadow page table 影子页表）和TDP（twodimensional paging我也不知道咋翻译）是当前hypervisor（VMM，虚拟机监视器）成熟的内存虚拟化解决方案。这两个方案显而易见的就是做guest到host的地址翻译。主要是处理GVA（虚拟机 虚拟地址）到HPA（宿主机 物理地址）的翻译链。SPT把三个中间步骤结合在一起（这里简单解释一下就是 虚拟机虚拟地址-&gt;虚拟机内存地址-&gt;宿主机虚拟地址-&gt;虚拟机物理地址）实际上每一步都有一个对应的entry，SPT总是会把这些内容放在cache里面来节省需要访问所有关联关系的时间，所以为了保证SPT的内容都是一致的，处理器需要从guest模式exit到host模式来更新STP的内容（这是因为kernel提供了这个功能，所以如果发生了Host上的进程切换，映射关系可能需要更新，所以其实很多CPU时间就损耗在这个切换上了。TDP应运而生（remedy，其实是治疗药物的意思，意译了一下）通过在guest上保持guest虚拟地址到guest物理地址的翻译不变，把guest物理地址到host物理地址的翻译从hypervisor层（kvm kernel）转移到了处理器上，而结果就是上面提到的exit就可以避免了（主要是guest page fault之后，需要一层一层往上找，如果是STP，就需要exit退出guest模式，如果处理器能处理host的地址翻译，那么就不需要exit，处理器能完成这个工作）。当然如果TLB-miss的话（意思是说page table的缓存，也就是 TLB，会记录活跃的内存页page，如果TLB中包含，那么可以直接从cache里返回地址。否则就要走正常的寻址逻辑-&gt;多级页表）还是需要查询多级页表在内存里找到对应的数据。因为这个特性，TLB其实在很多时候并不能解决没有时间局限性的或者是缓存访问的行为（这里解释一下，比如存在一个pageA，有时间局限性意思是说未来短时间内可能会被多次访问，没有的意思就是说，随机访问很多不同page的情况）。所以结果是，TDP实际上就是AMD的NPT和Intel的EPT。基于技术中立的态度（指不偏向AMD或者Intel），TPD被用来作为硬件辅助分页机制来提升部分性能的机制。我们尝试调整hypervisor（kvm）的mmu代码，尝试结合这两个方法，同时避免一些已有的缺点。</p>
<p>评论：</p>
<p>讲的非常的准确，优点/缺点，以及要做什么</p>
<blockquote>
<p>For TLB contains a number of the most recently accessed GPA→HPA mappings, the more likely these entries will be needed in future, the more time could be saved from the page table walk in subsequent operations. To the nature of the paging methods themselves, the efficiency of both SPT and TDP rely on to what extent the cached results of the previous page table walks could be reused. Since the SPT cannot be maintained without interrupting the guest execution and exit to the host kernel mode, there will be little chance other than reducing the occurrence of the page fault in the guest to improve the performance of SPT. This, however, largely depends on the memory access behavior of the individual workload and remains beyond the control of the hypervisor. TDP, on the hand, bears the hope for performance improvement. Currently the TDP is adopting the same paging mode as the host does, known as “multi-level page table walk-through”. It is an N-ary tree structure [1], where N could be 1024 in 32-bit mode, or 512 in 64-bit or 32-bit PAE modes. In the 32-bit mode only 2 level page table are involved for walking through, which poses minor overhead. However, the overhead grows quickly non-negligible as the paging level increases. In spite of the various paging modes adopted in the guest, only two modes - the 64-bit and the 32-bit PAE modes are available for the TDP. In the worst case if all TLB large missed, up to 24 memory accesses are possible for a single address translation.</p>
</blockquote>
<p>TLB包含了最近访问的GPA-&gt;HPA的映射，这些将来要被继续访问的条目如果保存的越多（因为TLB是cache，所以有这么样的假设，所以cache不适用的场景都是类似的，比如超出cache上限等），那么就能够节约更多的查询page table这个操作消耗的时间。结合这两个分页方法本身，SPT和TDP的性能，取决于用什么cache来拓展之前的page table查询结果，并且可以被复用。因为SPT需要通过中断的方式维护（主要是vm exit然后更新）所以实际上CPU上导致的损耗使得优化SPT的可能性很低。当然SPT很大程度上和单个负载的内存访问方式有关系，（比如一直没有上下文切换，也只访问热点数据，那又是没啥问题的）。TPD，实际上更有可能提升性能。目前TDP采用的是和host一样的分页模式，也就是（multi-level page table walk-through 多级页表访问）。是一个N长度数组的树结构，N可以是32位模式的1024，或者是64位和32位PAE模式的512。在32位模式，只有两级页表能够在访问中使用，这种情况下损耗更下一些。当然随着分页级别的增加，这个损耗变得不容忽视。不管guest里面可能采用各种不同的分页级别设置，TDP只支持64位和32位PAE模式。最差的情况下TLB没有命中的话，最差的情况一次地址翻译需要24次内存访问（TODO）</p>
<p>评论：</p>
<p>介绍了一下当前访问过程中存在的一些问题</p>
<blockquote>
<p>Though undesirable, this has presumably been done for two reasons: 1. compatibility between the host and guest paging modes, and more importantly, 2. efficiency in memory utilization. However, as the TDP table is in the hypervisor and invisible to the guest, it is actually up to the hypervisor to adopt the paging mode without having to maintain this kind of compatibility [2]. For the tree structure forms a hierarchy of the 1-to-many mappings, mappings could be built in a “lazy” way only on demand, significant amount of memory space for entries could be saved compared with the 1-to-1 mapping based structure, say, an array. On the other hand, this structure also means more memory access and time cost while looking up an element within it. As performance rather than memory saving comes as the top concern, paging methods more efficient than the current one may exist. One candidate is naturally a 1-to-1 mapping based structure, such as an array, or a hash list. With more memory being invested to save all the possible GPPFN (guest physical page frame number) to HPPFN (host physical page frame number) mappings, fewer memory accesses suffice2 in the second dimension of the TDP. By doing this, the whole translation from GVA to HPA is expected to be effectively simplified and accelerated due to a reduced paging structure in TDP table. In addition, a simplified TDP method combines the merits of both TDP and SPT - to avoid the vmexit as well as to maintain the relatively short mapping chains from GVA to HPA. Until significant change is made available to the paging mode of the current processor, it could be a better practice merely by modifying the current hypervisor software.</p>
</blockquote>
<p>尽管这很讨厌（要说什么特殊条件了），这个可能通过以下两个原因能够解决：1. host和guest使用完全相同的paging mode（很重要）2. 提升内存使用率。然而，TPD table是保存在hypervisor并且对guest不可见，所以实际上只需要hypervisor采用对应的paging模式，而没有必要维护兼容性。用树状的层级结构表示1对多的映射，映射可以按需是否使用lazy的方式，相比于1对1映射能保存大量的内存空间的条目。另一方面，这个数据结构也意味着更多的内存访问，以及访问的时间消耗。因为主要考虑性能而不是节省内存，比当前这个方式效率更高的方法肯定是存在的。比如默认的1对1映射的数据结构，比如数组或者hash列表。随着更多的内存被用于保存可能被使用的GPPFN（guest physical page frame number）和 HPPFN（host physical page fram number）的映射，使用TDP映射需要访问内存的时间就更少了。通过减少TDP table里paging数据结构的层级，整个GVA到HPA的翻译，会变得更加简化，并且加速。同时，简化TDP方法，并结合TDP和SPT的特点（避免vmexit，同时维护一个很短的GVA到HPA的映射关系）。除非处理器的分页模式发生重大变革，目前来说修改当前的hypervisor是最好的方法。</p>
<p>评论：</p>
<p>所以还是改原本的code，没有办法在结构上改进，提升也是有限的</p>
<blockquote>
<p>Major work focusing on improving the memory virtualization could be summarized as the following. To work around the unfavorable sides and combine the best qualities of SPT and TDP, one attempt is to enable the hypervisor to reconfigure its paging method at run-time as a response to the ever changing behavior of the workloads in memory accessing, which were implemented in the past in a few hypervisors such as Xen and Palacios according to [3,4]. Although not all workloads could be benefited from this, overall performance gain have been observed for the selected benchmarks. The downside, however, is that it adds further complexity to the hypervisor with the methods of performance metric sampling, paging method decision making, as well as the dynamic switching logic. Furthermore, such activities in the kernel could also do harm to the performance.</p>
</blockquote>
<p>主要的改进内存虚拟化的工作总结如下。去掉SPT和TDP里面不好的部分，结合他们的特点，一个尝试就是让hypervisor在运行时重新设置paging方法，并作为内存访问的负载的一个变化行为，这已经在过去的一些hypervisor上实现了，比如Xen和Palscios。虽然不是所有的负载都适用于这个方法， 所有的性能提升都是对应不同的基准来观测的。当然这个缺点就是要增加hypervisor的复杂度，主要是影响性能检测，决定分页方法，同时还有动态切换。当然，kernel里这样的行为也是会影响性能的。</p>
<p>评论：</p>
<p>突然开始保守了，前面可能吹太猛了，因为模型上没有变化，只能控制面改了</p>
<blockquote>
<p>To reduce the overhead for walking through the multi-level page tables in TDP, a hashed list is applied to provide direct address mapping for GPA [2]. In contrast with the O(n<sup>2</sup>) complexity of the conventional multi-level forward page tables for both GVA→GPA and GPA→HPA translations, the hashed page table has only one paging level and achieves a complexity of O(n) in theory. The performance is at least not worse due to the reduced page table walk and cache pressure, showed by the benchmark. Since the hash table is a data structure more capable in searching, inserting and deleting etc., and relatively easier to be implemented within the existing framework of the hardware and software, current TDP design could be simplified by applying it for better performance. As more reflections were cast on the current multi-level paging modes, a variety of changes have been prompted for a simplified paging work. Theoretically, a “flat nested page table” could be formed by combining the intermediate page levels from 4 to 1, which results in an 8 memory access for the translation from GVA to HPA, and a reduced overhead for 2D TDP walk [5]. By extending the processor and hypervisor with the “direct segment” function, the memory access for the GVA to HPA translation could even be further reduced to 4 or 0 [6].</p>
</blockquote>
<p>为了TDP访问减少多级页表造成的损耗，增加一个hash列表来提供GPA的直接映射（GPA到HPA）。对比原本的GVA-&gt;GPA和GPA-&gt;HPA翻译的O(n<sup>2</sup>)的多级页表访问复杂度，使用哈希页表，只有一层分页级别，所以理论上复杂度只有O(n)。结合测试基准，性能在减少了页表的访问以及缓存的压力之后并没有变差。因为哈希表是一个便于搜索插入和删除的数据结构并且在很多框架软件硬件上都很容易时间，目前的TDP设计可以被简化成使用哈希表来获取更好的性能。当然对更多的针对目前的多级页表模式的改进可以被提出来用来简化寻址工作。理论上“flat nested page table” 一个很大的内嵌页表修改页级别从4改成1，最多也就是需要8次内存访问，同时减少2D TDP的查询。通过拓展处理器以及hypervisor的direct segment方法，内存的翻译可以被减少到4-0次</p>
<p>评论：</p>
<p>把原本的多级页表，改成了单层的hash表</p>
<p>比如原本的页表是1024，通过多级，可以保存1024<sup>n</sup>的页信息，虽然查询的时间长了，但是保存的地址多了，寻址上，在没有cache的情况下，找的时间就会指数级增加</p>
<p>换成hash表，查询速度变快了，但是相对的保存的条目数量就受到了page table的限制，因此提出的改进其实希望是一个很大的hash表</p>
<blockquote>
<p>For the TLB plays a critical role in reducing the address translation overhead [7] and justifies the use of TDP, it becomes another concern besides the paging level. Specific to the AMD processor, a way is suggested in [8] to accelerate the TDP walk for guest by extending the existing page walk cache also to include the nested dimension of the 2D page walk, caching the nested page table translations, as well as skipping multiple page entry references. This technique has already gained its application in some AMD processors. Not limited to virtual cases, attention is paid in [9] to compare the effectiveness of five MMU cache organizations, which shows that two of the newly introduced structures - the variants of the translation outperform the existing structures in many situations.</p>
</blockquote>
<p>TLB在减少地址翻译的损耗扮演了一个很重要的角色，并且很适合TDP的使用场景，所以它成为了除了paging level之外的另外一个条件。仅限AMD处理器，实际上有一个加速guest TDP查询的方法，就是增加已有的page walk cache并且包含嵌套的2D page walk。缓存嵌套的页表翻译，同时跳过多页面引用。这个技术已经在一些AMD处理器的一些应用上被采用了。不仅限于虚拟化场景，其实对比与其他五个MMU cache组织，也说明了最新的两个结构，对于翻译性能的提升，在很多情况都是优于已有的结构的。</p>
<p>评论：</p>
<p>我的cache无限大，速度够快，那其实根本不需要page，直接都放到cache里不是更好</p>
<blockquote>
<p>As a potential technical breakthrough, TDP is different from SPT in many aspects. However, for compatibility reason, the main structure of SPT is still reused by TDP. This, though at first may seem quite misleading, enables the TDP to fit seamlessly into the current framework previously created for SPT. As far as TDP feature is available in the hardware, it is preferred to SPT for general better performance. While in the absence of TDP hardware feature, SPT may serve as a fall-back way and the only choice for the hypervisor to perform the guest-to-host address translation.</p>
</blockquote>
<p>作为一个潜在的技术重大突破，TDP其实和SPT在很多方面都不一样。然而，因为很多兼容性原因，SPT的主要数据结构都被TDP复用了。因此一开始看的时候会感觉非常误导，启用TDP和现有的为SPT创建的框架无缝衔接。目前为止，TDP特性在硬件上可用，相比SPT来说有更好的性能。因为缺少TDP的硬件特性，SPT可以所谓一个备用方，也是hypervisor层来实现guest到host地址翻译的唯一方法。</p>
<p>评论：</p>
<p>好像也没想出啥好办法，开始叹气</p>


<blockquote>
<p>In KVM, SPT and TDP share the same data structure of the virtual MMU and page tables (surprisingly, both are named as shadow page table). The shadow page table is organized as shown by Fig. 1, of which kvm mmu page is the basic unit gluing all information about the shadow pages together. For each level of the shadow page table, a pageful of 64-bit sptes containing the translations for this page are pointed to by *spt, whose role regarding the paging mode, dirty and access bits, level etc. are defined by the corresponding bits in role. The page pointed to by spt will have its page-&gt;private pointing back at the shadow page structure. The sptes in spt point either at guest pages, or at lower-level shadow pages [10]. As the sptes contained in a shadow page may be either one level of the PML4, PDP, PD and PT, the pte parents provides the reverse mapping for the pte/ptes pointing at the current page’s spt. The bit 0 of parent ptes is used to differentiate this number from one to many. If bit 0 is zero, only one spte points at this pages and parent ptes points at this single spte, otherwise, multiple sptes are pointing at this page and the parent ptes &amp; 0x1 points at a data structure with a list of parent ptes. spt array forms a directed acyclic graph structure, with the shadow page as a node, and guest pages as leaves [10].</p>
</blockquote>
<p>在KVM中，SPT和TDP使用相同的数据结构，也就是virtual MMU和page tables（很惊讶，他们都叫做shadow page table）。shadow page tables的结构如Fig.1所示。kvm mmu page是一个基础的单元，把所有shadow pages相关的信息黏合在一起（突然想到python是glue language）。对任意一级的shadow page table来说，一个64bit的sptes整个page包含了这个page所有的翻译，是通过*spt指针指向的，里面的role字段则是表示paging mode，dirty bit，access bit以及级别等等。都是在role里面的比特位定义的。spt指向的page有对应的page-&gt;priavte pointing back的从shadow page structure指回去的指针。spt中的spte指针也只想guest的page，或者是更低级别的shadow page。因为shadow page包含的sptes也可能是另外一个级别的PML4，PDP，PD和PT，对应的pte parents需要提供对pte/ptes指针的反向指针，指向当前page的spt。Parent ptes的第一个比特位，bit0是用来区分是一对多还是一对一，如果bit0是zero，那么说明当前page的spte指针只有一个spte和page parent对应。否则说明有多个sptes指向这个page，同时parent page的ptes &amp; 0x1 指向一个数据结构，表示一个parent ptes的列表。spt数据组织了一个直接非环图结构，shadow page作为一个node，guest的page作为叶子结点。</p>
<p>评论：</p>
<p>这段没看懂，回头继续看</p>
<blockquote>
<p>KVM MMU also maintains the minimal pieces of information to mark the current state and keep the sptes up to date. unsync indicates if the translations in the current page are still consistent with the guest’s translation. Inconsistence arises when the translation has been modified before the TLB is flushed, which has been read by the guest. unsync children counts the sptes in the page pointing at pages that are unsync or have unsynchronized children. unsync child bitmap is a bitmap indicating which sptes in spt point (directly or indirectly) at pages that may be unsynchronized. For more detailed description, the related Linux kernel documentation [10] is available for reference.</p>
</blockquote>
<p>KVM MMU也维护了一个最小程组的信息，来标记当前的状态以及保证sptes是最新状态。如果当前的page和guest的翻译还是一致的就不会标记为需要同步。如果翻译被改动，而TLB还没刷新就会guest读到的内容不一致（因为正确的映射关系是通过shadow page维护的，guest的TLB只是cache，如果没有即使更新就会出现shadow page和TLB不一致的情况）</p>
<p>Unsync children会计算当前page的指向没同步的或者是存在没同步的子节点的stpes的数量，</p>
<p>Unsync children bitmap是一个bitmap标记spt指针的sptes（直接或间接的）指向页面的这些指针可能没有同步。</p>
<p>更多细节的描述可以看Linux kernel的文档。</p>
<p>评论：</p>
<p>操作系统代码不熟，需要回炉重造</p>
<blockquote>
<p>Multiple kvm mmu page instances are linked by an hlist node structure headed by hlist head, which form the elements in the hash list - mmu page hash pointed to by kvm-&gt;arch. Meanwhile it’s also linked to either the lists active mmu pages or zapped obsolete pages in the kvm-&gt;arch, depending on the current state of the entries contained by this page. Both SPT and TDP keep their “shadow page table” entries and other related information in the same structure. The major difference lies in the hypervisor configuration of the runtime behaviors upon paging-fault-related events in the guest. While the SPT relies on the mechanism of “guest page write-protecting” and “host kernel mode trapping” upon guest page fault for keeping the SPT synchronized with the guest page table, the TDP achieves the same result by a hardware mechanism. As VMCB (virtual machine control block) by AMD or VMCS (virtual machine control structure) by Intel is the basic hardware facility the TDP makes use of, it’s the key thing making difference. Code snippet in Fig. 2 shows the configuration of VMCB for TDP, and that the root address of the TDP page table is kept in the VMCB structure. Meanwhile the guest is configured as exitless for paging-fault exception, which means that the page fault events is handled by the processor. With this configuration, guest is left running undisturbed when the guest page fault occurs.</p>
</blockquote>
<p>多个kvm mmu page实例会被连接到一个hlist数据结构的head上，组织称一个hash list。kvm-&gt;arch来指向mmu page hash指针。同时也会在kvm-&gt;arch连接到active的mmu page或者是过期的page，取决于当前这个page包含的entries的状态。SPT和TDP会保持他们的shadow page table entires和其他的关联信息在相同的数据结构里。主要的不同是hypervisor的runtime行为配置对guest中paging-fault相关的事件的处理。因为SPT依赖于guest page write-protecting的机制，以及host kernel mode trapping，当出现guest page fault的时候，为了保证SPT和guest的page同步，TDP需要实现一个硬件的机制。在VMCB（virtual machine control block）AMD的数据结构以及VMCS（virtual machine control structure）intel的数据结构提供给TDP使用，也是最关键的部分。</p>
<p>代码放在了Fig2，展示了给TDP用的VMCB的配置，对应TDP page的root address被保存在VMCB数据结构里。同时guest配置为碰到page fault错误也不做vm exit（即不走shadow page table的逻辑），这个page fault交给处理器处理。通过这个配置，guest就不会因为page fault受到过多影响（指退出guest mode）</p>


<blockquote>
<p>Besides, as SPT maps GVA to HPA, the spt entries are created and maintained in a per-process way, which leads to poor reusability hence higher memory consumption. These are obvious downsides especially when multiple processes are running in parallel. In contrast, the TDP maintains only the mappings from GPA to HPA, which effectively eliminated such problems associated with SPT. Guest page table is also accessed by the physical processor and forms the first dimension of the entire page table walk. In this way the TDP can not only eliminate the cost for frequent switching between the host and guest modes due to SPT synchronization, but also simplify the mappings and maintenance efforts the “shadow page tables” needs.</p>
</blockquote>
<p>除此之外，比如SPT用来映射GVA到HPA，对应的spt条目由每个进程创建和维护，在内存消耗很大的场景下重用性很差（因为进程切换，大部分换出换入）。特别是多进程并行的时候，这些缺陷显而易见。对比之下，TDP仅维护了GPA到HPA的映射，有效的减轻了SPT这样的问题。Guest page table也会被物理处理器访问，并且构建了完整的page的访问。在这个情况下TDP不仅可以减少在host和guest之间因为SPT同步导致不断切换的问题，也能简化shadow page tables映射的麻烦。</p>
<p>评论：</p>
<p>又重新讲了一下TDP的作用，感觉有点重复</p>
<blockquote>
<p>Two stages are involved in the buildup of the TDP table, namely, the creation of the virtual mmu, and the filling of TDP page tables upon guest page fault during the execution of the guest. As Fig. 3 depicts, in the context of the function kvm vm ioctl, the virtual mmu is created for the first time along with the guest VCPU. It is also when the VMCB is configured. One thing to be noticed is that, as the root address of the TDP page table, the root hpa of the kvm mmu is left without to be allocated a page table, which is deferred to the second stage.</p>
</blockquote>
<p>构建TDP table需要两个阶段，首先是创建virtual mmu并且在guest执行的时候发生page fault时填充TDP表。如Fig3所示，kvm vm ioctl功能的上下文中，virtual mmu是首先被创建的，并且不和guest VCPU相关。这也是VMCB被配置的时候。值得注意的是，TDP pagetable的root address中，kvm mmu的root hpa会被保留并且不分配给page table，接下来就到第二阶段了。</p>
<blockquote>
<p>Figure 4 depicts the context function vcpu enter guest, in which operations related to the second stage take place. This function serves as an interface for the inner loop3 in the internal architecture of the QEMU-KVM, dealing with host-guest mode switching. Before the guest mode is entered by the processor, much preparation work needs to be done in this context, including the checking and handling of many events, exceptions, requests as well as mmu reloading or I/O emulation. The only thing needed for mmu reloading is to allocate a page for the TDP table and make the starting address of it known to the root hpa of the kvm mmu and the CR3 of the VCPU, which is performed by kvm mmu load.</p>
</blockquote>
<p>Fig4说明了vcpu enter guest功能呢，也就是第二阶段发生的时候。这个功能作为一个接口在QEMU-KVM的架构中使用，处理host-guest mode的切换。在guest mode enter之前，很多的准备工作要基于这个上下文完成。包含检查以及处理很多的事件，异常，请求以及mmu加载或者是I/O模拟，需要对mmu加载做的工作就是给TDP表的page分配，并且设置一个起始地址给kvm mmu的root hpa，并且设置VCPU的CR3，这就是kvm mmu load需要做的事情。</p>


<blockquote>
<p>Guest begins to execute until it can’t proceed any further due to some faulty conditions. More often than not, control flow had to be returned to the hypervisor or the host OS kernel to handle the events the guest encountered. Obviously too much vmexit are an interference and grave source of overhead for the guest. With TDP, however, guest is free from vmexit upon guest paging faults. As the guest enters for the first time into execution, the paging mode is enabled and the guest page tables are initialized, however, the TDP tables are still empty. Any fresh access to a page by the guest will first trigger a guest page fault. After the fault is fixed by the guest, another page fault in the second dimension of the TDP is triggered due to the missing entry in TDP table.</p>
</blockquote>
<p>guest开始执行直到无法处理其他的条件。大部分情况下，当guest发出一些事件的时候流程处理会转交给hypervisor或者host kernel。显然大部分vmexit就是导致guest性能损耗的原因。通过TDP，guest就能够避免因为page fault导致的vmexit。因为guest一开始就进入了执行状态，paging模式被启用，并且guest的page tables也被初始化了，然而TDP的table还是空的。任意的对新页的访问都会导致guest page fault。放这个错误被处理之后，另外一个page fault在TDP模型里面就是TDP table里缺少条目。</p>
<blockquote>
<p>tdp page fault is the page fault handler in this case. As illustrated by Fig. 5, first the host page frame number - pfn is calculated for the faulting address through a chain of functions in try async pf. The pfn is then mapped one level after another into the corresponding positions of the TDP tables by the function direct map. In a predefined format, the entry for a faulting address is split into pieces of PML4E, PDPE, PDE, PTE as well as offset in a page. During the loop, iterator - an instance of the structure kvm shadow walk iterator is used to retrieve the latest physical, virtual addresses and position in the TDP tables for a given address, of which iterator.level determines the number of times for the mapping process.</p>
</blockquote>
<p>tdp page fault就是这个场景下的处理逻辑。和Fig5画的一样，首先host page frame number（pfn）会通过这个一系列async pf的函数给错误的地址计算一个pfn。这个pfn被加入到层级映射里面，来映射到一个具体的TDP表的位置。在预定义的情况下，这个给faulting address用的条目可以被分为PML4E，PDPE，PDE，PTE也就是page的offset。再循环里，一个kvm shadow walk迭代器的实力会被用来滴贵的访问最后一个物理、虚拟地址并且找到对应的地址在TDP table里的位置，这个迭代器里面的level也就是对应的进程多少级映射的信息。</p>


<blockquote>
<p>Although the conventional TDP shown in Fig. 6 is mature and the default configuration for better performance, for a certain kind of workloads the limitation is still obvious. They may suffer large overhead due to walking into the second dimension of multi-level page table upon heavy TLB-miss. It is ideal to have a “flat” TDP table by which the wanted pfn can be obtained with a single lookup. Unfortunately, there has long been a problem to allocate large chunk of physically continuous memory in the kernel space. Three functions, namely vmalloc(), kmalloc() and get free pages are used to allocate memory in the current Linux Kernel. The first allocates memory continuous only in virtual address, which is easier to perform but not desired dealing with performance. The second and the third allocate memory chunk continuous in both virtual and physical addresses, however, the maximum memory size allocated is quite limited, thus tends to fall short of the expectation for this purpose. In addition, kmalloc() is very likely to fail allocating large amount of memory, especially in low-memory situations [11]. The amount of memory get free pages can allocate is also limited within 2MAX ORDER−1, where MAX ORDER in the current Linux Kernel for x86 is 11, which means that each time at most 4MB memory can be obtained in the hypervisor. In this condition what we could do is to make the TDP table as “flat” as possible, and to reduce the number of paging with it. Here “flat” means large and physically continuous memory chunk for TDP table. Instead of having thousands of TDP tables managed by their own kvm mmu page instances, we want to merge as many TDP tables as possible into a larger table managed by fewer kvm mmu page instances.</p>
</blockquote>
<p>虽然通常的TDP使用表示在Fig6，是一个非常成熟的作为默认性能更好的设置，并且对于一些确切的负载上有的限制还是很明显的。比如有非常多TLB-miss的时候，需要做非常多的多级页表查询造成很大的性能损耗。如果存在一个flat的TDP table，保证pfn的查询只需要一次，那么就非常理想了。不幸的是，内核空间里面没有办法分配一个连续的长的物理内存来处理这个问题。三个方法，分别是vmalloc()，kmalloc()以及获取空闲page来在当前linux内核中分配内存。第一个方法仅在虚拟地址分配连续内存，这个方法简单，但是没办法达到满意的性能。第二个个第三个方法，会在虚拟和物理地址上都分配连续的地址，而最大的内存大小是很有限的，因此还是不能够达到预期。附带一提kmalloc是非常容易分配大量内存失败的，特别是内存少的场景。通过获取空闲page来分配内存也被限制在2<sup>MAX_ORDER-1</sup>,这个MAX_ORDER在当前的x86 kernel里面是11，也就是说最多4MB的内存可以被分配给hypervisor使用。在这个场景下，我们可以让这个TDP table尽量的大，来减少page的数量，这个flat表示给TDP table使用的很大并且物理连续的内存块。代替原本的由KVM mmu管理的上千个TDP table，我们希望尽可能的把这些TDP table合并起来，并使用更少的kvm mmu page实例来管理。</p>


<blockquote>
<p>There could be various ways to implement this, depending on how the indices of a page table entry are split. Two things are to be noticed for this: 1. to leave the indices for paging as long as possible, and 2. to reuse the current source code for KVM as much as we can. Consequently, we come up with a quite straightforward design by merging the bits for currently used indices within a guest page table entry. As Figs. 7 and 8 depict, the former PML4, PDP (higher 18 bits) could be combined as a single index to the root of a TDP table segment, and similarly PD and PT (lower 18 bits) as the index for a physical page. By filling the TDP table entries in a linear ascend order for the GPPFN, the HPPFN could be obtained conveniently by a single lookup into the table. As a result, for the currently used maximal address space of a the 64-bit(48 bits effectively in use) guest, we may have 218 = 256K segments for the TDP tables, with the index of each segment ranging from 0 to 218 − 1 to the host physical pages. The TDP table size is enlarged by 29 times, while the number of the table segments could be reduced to 1 29 of the former. This is actually a f</p>
</blockquote>
<p>有很多不同的方法可以实现这个，主要是看选择用什么方式来拆分page table entry。</p>
<p>两个值得注意的点：</p>
<ol>
<li>需要保证分页的索引尽可能的长</li>
<li>尽可能的复用当前的kvm代码</li>
</ol>
<p>因此我们选择了一个非常直接的设计，也就是把bits索引合并到一整个page table entry里。</p>
<p>如Fig7和Fig8战士的，之前的PML4，PDP（高18位）可以被结合成单个索引，作为TDP table segment的根。类似的PD和PT（低18位）可以作为物理页的索引。通过线性的递增GPPFN和HPPFN来填充TDP的页表，就能够简单的实现一个table的单词查询访问。结果上来说，通过使用最大的64位地址空间（有效位为48位）的guest，我们可以有大约2<sup>18</sup> = 256k 个段用于TDP tables。每个段的索引就是从0到2<sup>18</sup>-1对应到host的物理页。TDP表的大小被扩大了2<sup>9</sup>倍，而对应的table段的数量减少到了之前的 1/2<sup>9</sup></p>



<blockquote>
<p>This is actually a fundamental change to the current mmu implementation. Several data structures and functions oriented to the operations upon 4KB∗29 = 2MB TDP page table must be adopted to the type upon 4KB ∗ 218 = 1GB. For example, as depicted by Fig. 9, the data structure of kvm mmu page could be modified as following to reflect the change: 1. since in a “flat” table, there is only two levels and a single root table as parents, the parents-children relation is quite obvious. Besides, all the first level pages have a common parent but no children at all. Members such as unsync children, parent ptes and unsync child bitmap are not necessary; 2. members as gfn, role, unsync etc. are multiplied by 512 to hold the informations previously owned by an individual 4KB ∗ 2<sup>9</sup> = 2MB page table; 3. spt points to a table segment covering an area of 4KB ∗ 2<sup>18</sup> = 1GB; 4. link is moved to a newly introduced structure - page entity to identify the 4KB ∗ 2<sup>9</sup> = 2MB pages that are either in the active or zapped obselete list. By modifying it this way, the depth of the TDP table hierarchy could be reduced from 4 to 2, while the width expanded from 2<sup>9</sup> to 2<sup>18</sup>.</p>
</blockquote>
<p>这其实是一个对当前mmu实现的基础修改。不同的基于原本的4KB * 2<sup>9</sup> = 2MB的TDP page table的操作需要支持到现在的 4KB * 2<sup>18</sup> = 1GB。举个例子，比如图9所示，kvm_mmu_page的数据结构可以被修改为如下的映射：</p>
<ol>
<li>在一个“flat”表里，只有两个层级和一个单根的表作为parents，亲子关系非常的清晰。此外，第一级的页面有一个共同的parent，但是没有子级。比如没有sync的子节点，parent ptes以及没有同步的子bitmap是没有必要的</li>
<li>里面的参数比如gfn，角色，未同步等，会被分为512保存，而之前每一个4KB ∗ 2<sup>9</sup> = 2MB page table</li>
<li>spt指针指向一个table段并覆盖一个4KB * 2<sup>18</sup> = 1GB的部分</li>
<li>link会被连接到一个新的数据结构来区别是4KB ∗ 2<sup>9</sup> = 2MB page是active还是弃用状态。</li>
</ol>
<p>通过这些修改，TDP table结构的深度从4变味了2，并且宽度从2<sup>9</sup> 变成了 2<sup>18</sup> </p>


<blockquote>
<p>Since each kvm mmu page instance contains 2<sup>18</sup>  table entries now, there will be less kvm mmu page instances in use, which means that 2<sup>18</sup>  rather than 2<sup>9</sup>  sptes need to be mapped to a single kvm mmu page instance. This could be achieved by masking out the lower 30 bits of an address and setting the obtained page descriptor’s private field to this kvm mmu page instance, as shown in Fig. 10. Other major affected functions include 1. shadow walk init, 2. kvm mmu get page, 3. direct map, 4. kvm mmu prepare zap page, 5. kvm mmu commit zap page and 6. mmu alloc direct roots</p>
</blockquote>
<p>因为每个kvm mmu page的实例包含2<sup>18</sup> 个条目，因此只会有更少的kvm mmu page，也就意味着2<sup>18</sup> 而不是2<sup>9</sup>个sptes需要被映射到一个kvm mmu page实例。通过把低30位地址内容作为page表述的私有比阿亮就能够给解决这个问题了如fig10所示。另外一些主要的功能影响包括：</p>
<ol>
<li>shadow walk int</li>
<li>kvm mmu get page</li>
<li>direct map</li>
<li>kvm mmu prepare zap pages</li>
<li>kvm mmu commit zap page</li>
<li>mmu alloc direct roots</li>
</ol>


<blockquote>
<p>Taken a guest commonly with 4GB memory as an example. A page contains 4KB/8B = 512 entries, and for the 4GB, 4GB/4KB = 220 entries are needed, so 220/512 = 2048 pages of 4KB size should be used to save all the table entries. All together it makes a space of about 4KB ∗ 2048 = 8MB size. Although this may be far more than in the conventional TDP case, it is a modest demand and acceptable compared with a host machine configured with dozens of GB RAM.</p>
</blockquote>
<p>以常见的guest内存4GB为例，一个page包含4KB/8B也就是512个条目（也就是512条索引一个page），4GB的情况就有4GB/4KB=2<sup>20</sup>个条目（需要索引），</p>
<p>2<sup>20</sup> / 512 = 2048个4KB的page作为索引保存所有table条目。一共需要4KB * 2048 = 8MB大小。虽然这个比常见的TDP场景差的远，不过是一个最简单的可以接受的用来配置host和GB RAM的规则。</p>
<blockquote>
<p>On the other hand, with the 2MB TDP large pages, only 4 kvm mmu page instances are sufficient to cover the entire 4GB address space. Only 4 entries are filled in the root table, which poses no pressure at all to the TLB. For an arbitrary guest virtual address, at most 2 ∗ 5 + 4 = 14 (10 in hypervisor, 4 in guest) memory accesses are enough to get the host physical address - far less than that of the current translation scheme (20 in hypervisor, 4 in guest). With a flatter TDP page table and reduced number of memory access, the KVM guest is expected to be less sensitive to workloads and yield higher performance.</p>
</blockquote>
<p>另一方面，用2MB的TDP大page，只需要4个kvm mmu page实例来覆盖4GB的空间。只需要在root table里面加4个条目。实际上对TLB不会造成太大压力。对于个简单的guest内存来说 至少 4 * 5 + 4 = 14 （hypervisor10次，guest4次）的内存访问是足够获取host地址的，而不是目前的（hypervisor20次，guest4次）。使用更flatter的TDP page table并且减少内存访问，KVM guest有希望运行的对负载更不敏感同时性能更好。</p>
<blockquote>
<p>We studied the current implementation of the SPT and TDP for the KVM, and attempted to simplify the second dimension paging of the TDP based on a change of the table structure and the related functions in the hypervisor. With this change on software, the current TDP paging level could be reduced and the overall guest performance will be improved. We have implemented a part of this design and found that, the large TDP page table could be allocated without problem as long as the amount is less than 4MB. However, as it is a relative radical change to the traditional mainstream KVM source code, many functions within the mmu code are affected, an executable implementation as well as a benchmark result are unfortunately not yet available. In future we will keep on engaging with this task and work out a concrete solution based on this design.</p>
</blockquote>
<p>目前研究了SPT和TDP的kvm上的实现，并且计划简化TPD的second dimension paging的基于TDP的表结构修改以及相关的hypervisor功能呢。通过软件层面的这个修改，目前的TDP级别减少并且guest整体的性能会提升。我们实现了部分设计并且发现使用一个很大的TDP page table小于4MB的时候可以成功分配。然而有一个相关的改动就是原本的主干的KVM代码，很多mmu相关的code都被影响了，一个可执行的benchmark目前并不可用，未来希望继续做相关的具体实现和设计。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ol>
<li>Preiss, B.R., Eng, P.: Data Structures and Algorithms with Object-Oriented Design Patterns in Java. Wiley, Chichester (1999) </li>
<li>Hoang, G., Bae, C., Lange, J., Zhang, L., Dinda, P., Joseph, R.: A case for alternative nested paging models for virtualized systems. Comput. Archit. Lett. 9, 17–20, University of Michigan (2010)</li>
<li>Wang, X., Zang, J., Wang, Z., Luo, Y., Li, X.: Selective hardware/software memory virtualization, VEE 2011, Department of Computer Science and Technology, Beijing University, March 2011</li>
<li>Bae, C.S., Lange, J.R., Dinda, P.A.: Enhancing virtualized application performance through dynamic adaptive paging mode selection, Northwestern University and University of Pittsburgh, ICAC 2011, June 2011</li>
<li>Ahn, J., Jin, S., Huh, J.: Revisiting hardware-assisted page walks for virtualized systems. Computer Science Department, KAIST, ISCA 2012, April 2012</li>
<li>Gandhi, J., Basu, A., Hill, M.D., Swift, M.M.: Efficient memory virtualization. University of Wisconsin-Madison and AMD Research, October 2014</li>
<li>Adavanced Micro Devices Inc, AMD-V Nested Paging White Paper. Adavanced Micro Devices, July 2008</li>
<li>Bhargave, R., Serebin, B., Spadini, F., Manne, S.: Accelerating two-dimensional page walks for virtualized systems. Computing Solutions Group and Advanced Architecture &amp; Technology Lab, March 2008</li>
<li>Barr, T.W., Cox, A.L., Rixner, S.: Translation Caching: Skip, Don’t Walk (the Page Table), Rice University, June 2010</li>
<li>Linux kernel Documentation about MMU in KVM. <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/">https://www.kernel.org/doc/</a> Documentation/virtual/kvm/mmu.txt</li>
<li>Johnson, M.K.: Memory allocation. Linux Journal, issue 16, August 1995. http:// <a target="_blank" rel="noopener" href="http://www.linuxjournal.com/article/1133">www.linuxjournal.com/article/1133</a> </li>
<li>Rubini, A., Corbet, J.: Linux Device Drivers, 2nd edn, June 2014. <a target="_blank" rel="noopener" href="http://www.xml.com/ldd/chapter/book/ch13.html">http://www.xml.com/ldd/chapter/book/ch13.html</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/27/a-simplified-TDP-with-large-tables/" data-id="cld1mhecj0076yuwb1brrabt2" data-title="A Simplified TDP with Large Tables" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/27/a-simplified-TDP-with-large-tables/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/27/a-simplified-TDP-with-large-tables/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/python/">python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio/">virtio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpu/" rel="tag">cpu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/performance/" rel="tag">performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysstat/" rel="tag">sysstat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt-top/" rel="tag">virt-top</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BSOD/" style="font-size: 10px;">BSOD</a> <a href="/tags/DPDK/" style="font-size: 12.86px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/TDP/" style="font-size: 11.43px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 18.57px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/cpu/" style="font-size: 11.43px;">cpu</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 10px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 12.86px;">java</a> <a href="/tags/kernel/" style="font-size: 14.29px;">kernel</a> <a href="/tags/kvm/" style="font-size: 15.71px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 12.86px;">libvirt</a> <a href="/tags/linux/" style="font-size: 17.14px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 12.86px;">software-arch</a> <a href="/tags/sysstat/" style="font-size: 10px;">sysstat</a> <a href="/tags/system-design/" style="font-size: 12.86px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 17.14px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 14.29px;">virt</a> <a href="/tags/virt-top/" style="font-size: 10px;">virt-top</a> <a href="/tags/virtio/" style="font-size: 15.71px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 17.14px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 17.14px;">virtio-networking</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/13/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">KVM虚拟化性能分析</a>
          </li>
        
          <li>
            <a href="/2023/03/09/cpu-features-about-kvm-hidden/">Cpu features about kvm hidden</a>
          </li>
        
          <li>
            <a href="/2023/03/03/virtio-on-linux/">Virtio on Linux</a>
          </li>
        
          <li>
            <a href="/2023/03/01/cpu-feature-configuration-code-diving/">Cpu feature configuration code diving</a>
          </li>
        
          <li>
            <a href="/2023/02/23/packed-virtqueue-how-to-reduce-overhead-with-virtio/">Packed virtqueue: How to reduce overhead with virtio</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>