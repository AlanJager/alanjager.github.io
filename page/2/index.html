<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="花の様に">
<meta property="og:url" content="http://hanayo.cn/page/2/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:locale">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="ブログ">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-kvm-mmu-rework-the-x86-tdp-direct-mapped-case" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/" class="article-date">
  <time class="dt-published" datetime="2022-09-29T04:03:02.000Z" itemprop="datePublished">2022-09-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/">kvm: mmu: Rework the x86 TDP direct mapped case</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Over the years, the needs for KVM&#39;s x86 MMU have grown from running small</span><br><span class="line">guests to live migrating multi-terabyte VMs with hundreds of vCPUs. Where</span><br><span class="line">we previously depended upon shadow paging to run all guests, we now have</span><br><span class="line">the use of two dimensional paging (TDP). This RFC proposes and</span><br><span class="line">demonstrates two major changes to the MMU. First, an iterator abstraction </span><br><span class="line">that simplifies traversal of TDP paging structures when running an L1</span><br><span class="line">guest. This abstraction takes advantage of the relative simplicity of TDP</span><br><span class="line">to simplify the implementation of MMU functions. Second, this RFC changes</span><br><span class="line">the synchronization model to enable more parallelism than the monolithic</span><br><span class="line">MMU lock. This &quot;direct mode&quot; MMU is currently in use at Google and has</span><br><span class="line">given us the performance necessary to live migrate our 416 vCPU, 12TiB</span><br><span class="line">m2-ultramem-416 VMs.</span><br></pre></td></tr></table></figure>

<p>过去的数年里，对KVM’s x86 MMU的需求从运行小虚拟机发展到需要支持在线迁移数T内存上百个vCPU的虚拟机。而我们以前试用shadow paging来运行虚拟机，目前我们使用two dimensional paging(TDP)。这个提议说明了两个主要的针对MMU的修改。首先，增加了一个用于L1 guest运行时简化访问TDP paging数据结构的迭代器抽象。这个抽象使用了一个相对简单的TDP来简化MMU功能的实现。其次，这个RFC修改了同步模型来支持并行的而不是使用现在这个巨大的MMU锁。这个“direct mode” MMU在google内部使用并且已经提供了热迁移416 vCPU + 12TB内存的虚拟机的性能了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">The primary motivation for this work was to handle page faults in</span><br><span class="line">parallel. When VMs have hundreds of vCPUs and terabytes of memory, KVM&#39;s</span><br><span class="line">MMU lock suffers from extreme contention, resulting in soft-lockups and</span><br><span class="line">jitter in the guest. To demonstrate this I also written, and will submit</span><br><span class="line">a demand paging test to KVM selftests. The test creates N vCPUs, which</span><br><span class="line">each touch disjoint regions of memory. Page faults are picked up by N</span><br><span class="line">user fault FD handlers, one for each vCPU. Over a 1 second profile of</span><br><span class="line">the demand paging test, with 416 vCPUs and 4G per vCPU, 98% of the</span><br><span class="line">execution time was spent waiting for the MMU lock! With this patch</span><br><span class="line">series the total execution time for the test was reduced by 89% and the</span><br><span class="line">execution was dominated by get_user_pages and the user fault FD ioctl.</span><br><span class="line">As a secondary benefit, the iterator-based implementation does not use</span><br><span class="line">the rmap or struct kvm_mmu_pages, saving ~0.2% of guest memory in KVM</span><br><span class="line">overheads.</span><br></pre></td></tr></table></figure>

<p>这个工作的主要动机就是并行的处理page fault。当虚拟机油上百个vCPU和数T内存的时候，KVM的MMU锁竞争会非常的激烈，导致guest进入kernel loop或者是都懂状体啊。为了展示这个改动的结果，我实现了一个paging test用于KVM的测试。这个测试会创建一个N vCPUs每一个vCPU都来弄乱一部分内存。Page faults会被N个用户态错误FD处理，每一个对应一个vCPU。在任意1s的测试面里，416个vCPUS以及一个vCPU 4G内存，98%的时间会消耗在MMU lock上。通过这部分补丁，89%的时间都被节省了，处理逻辑被get_user_pages以及用户fault FD ioctl处理了。另外一个好处，基于迭代器的实现并不使用rmap或者是kvm_mmu_pages的数据结构，节约了大约0.2%的kvm虚拟机内存损耗。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">The goal of this  RFC is to demonstrate and gather feedback on the</span><br><span class="line">iterator pattern, the memory savings it enables for the &quot;direct case&quot;</span><br><span class="line">and the changes to the synchronization model. Though they are interwoven</span><br><span class="line">in this series, I will separate the iterator from the synchronization</span><br><span class="line">changes in a future series. I recognize that some feature work will be</span><br><span class="line">needed to make this patch set ready for merging. That work is detailed</span><br><span class="line">at the end of this cover letter.</span><br></pre></td></tr></table></figure>

<p>这篇RFC是为了展示并且收集对于迭代器模式的反馈，内存的节省在使用“direct case”之后启用了 并且修改了同步模型。虽然他们之前紧密关联，我将会在之后的改动里把迭代器从同步模型里分离出来。我意识到在合并之前还有一些工作要做。这部分工作的细节附在这个letter之后。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">The overall purpose of the KVM MMU is to program paging structures</span><br><span class="line">(CR3&#x2F;EPT&#x2F;NPT) to encode the mapping of guest addresses to host physical</span><br><span class="line">addresses (HPA), and to provide utilities for other KVM features, for</span><br><span class="line">example dirty logging. The definition of the L1 guest physical address</span><br><span class="line">(GPA) to HPA mapping comes in two parts: KVM&#39;s memslots map GPA to HVA,</span><br><span class="line">and the kernel MM&#x2F;x86 host page tables map HVA -&gt; HPA. Without TDP, the</span><br><span class="line">MMU must program the x86 page tables to encode the full translation of</span><br><span class="line">guest virtual addresses (GVA) to HPA. This requires &quot;shadowing&quot; the</span><br><span class="line">guest&#39;s page tables to create a composite x86 paging structure. This</span><br><span class="line">solution is complicated, requires separate paging structures for each</span><br><span class="line">guest CR3, and requires emulating guest page table changes. The TDP case</span><br><span class="line">is much simpler. In this case, KVM lets the guest control CR3 and</span><br><span class="line">programs the EPT&#x2F;NPT paging structures with the GPA -&gt; HPA mapping. The</span><br><span class="line">guest has no way to change this mapping and only one version of the</span><br><span class="line">paging structure is needed per L1 address space (normal execution or</span><br><span class="line">system management mode, on x86).</span><br></pre></td></tr></table></figure>

<p>KVM MMU的主要目的是通过程序实现分页数据结构（CR3/EPT/NPT）来把虚拟机地址encode成物理机物理地址，以及提供其他KVM特性，比如dirty logging。对L1 guest的物理地址到Host物理地址的映射可以分为两个部分。KVM的memslots映射GPA到HVA，然后kernel MM/x86的host page tables映射HVA到HPA。在没有TDP的情况下，MMU必须把整个GVA到HPA的过程通过编程的方式实现，这个就需要用到“shadowing”也就guest的page tables来创建一个复合的x86 paging结构。这个实现方法是很复杂的，需要根据每个guest的CR3把分页结构分离开，并且模拟guest的page table变化。TDP的场景就更容易一些，这个场景里，KVM让guest控制CR3并且编程了一个EPT/NPT的分页数据结构来做GPA到HPA的映射。这样guest就不需要修改这个映射，并且只需要在每个L1guest的地址空间维护一个版本的分页数据结构（一般的在x86上的形式）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">This RFC implements a &quot;direct MMU&quot; through alternative implementations</span><br><span class="line">of MMU functions for running L1 guests with TDP. The direct MMU gets its</span><br><span class="line">name from the direct role bit in struct kvm_mmu_page in the existing MMU</span><br><span class="line">implementation, which indicates that the PTEs in a page table (and their</span><br><span class="line">children) map a linear range of L1 GPAs. Though the direct MMU does not</span><br><span class="line">currently use struct kvm_mmu_page, all of its pages would implicitly</span><br><span class="line">have that bit set. The direct MMU falls back to the existing shadow</span><br><span class="line">paging implementation when TDP is not available, and interoperates with</span><br><span class="line">the existing shadow paging implementation for nesting. </span><br></pre></td></tr></table></figure>

<p>这篇RFC实现了一个可选的使用MMU功能来结合TDP运行L1 guest的“direct MMU”功能。这个direct MMU的命名是因为直接从kvm_mmu_page的role bit获取了一个direct role（也是目前MMU里已有的实现）表示page table的PTEs（以及他们的子page）映射了一个组线性的L1 GPA地址。虽然direct MMU并没有使用kvm_mmu_page，不过所有的page都会做这个设置。当TDP不可用的时候direct MMU会降级到已有的shadow paging功能并且如果是嵌套虚拟化，也会联动到已有的shadow paging功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In order to handle page faults in parallel, the MMU needs to allow a</span><br><span class="line">variety of changes to PTEs concurrently. The first step in this series</span><br><span class="line">is to replace the MMU lock with a read&#x2F;write lock to enable multiple</span><br><span class="line">threads to perform operations at the same time and interoperate with</span><br><span class="line">functions that still need the monolithic lock. With threads handling</span><br><span class="line">page faults in parallel, the functions operating on the page table</span><br><span class="line">need to: a) ensure PTE modifications are atomic, and  b) ensure that page</span><br><span class="line">table memory is freed and accessed safely Conveniently, the iterator</span><br><span class="line">pattern introduced in this series handles both concerns.</span><br></pre></td></tr></table></figure>

<p>为了并行处理page fault，MMU需要允许并发修改PTEs（page table entry）。这部分补丁的第一步就是把MMU锁替换为读/写锁来弃用多线程来支持同时执行操作，并且把原本的需要一个大锁的函数也做了改动。通过线程并行处理page tauls，对应的page table的功能需要</p>
<ol>
<li>保证PTE的修改是原子的</li>
<li>保证page table的内存是空闲的并且可以被安全的访问。</li>
</ol>
<p>为了更方便的解决这两个问题，我们引入了迭代器模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">The direct walk iterator implements a pre-order traversal of the TDP</span><br><span class="line">paging structures. Threads are able to read and write page table memory</span><br><span class="line">safely in this traversal through the use of RCU and page table memory is</span><br><span class="line">freed in RCU callbacks, as part of a three step process. (More on that</span><br><span class="line">below.) To ensure that PTEs are updated atomically, the iterator</span><br><span class="line">provides a function for updating the current pte. If the update</span><br><span class="line">succeeds, the iterator handles bookkeeping based on the current and</span><br><span class="line">previous value of the PTE. If it fails, some other thread will have</span><br><span class="line">succeeded, and the iterator repeats that PTE on the next iteration,</span><br><span class="line">transparently retrying the operation. The iterator also handles yielding</span><br><span class="line">and reacquiring the appropriate MMU lock, and flushing the TLB or</span><br><span class="line">queuing work to be done on the next flush.</span><br></pre></td></tr></table></figure>

<p>这个direct walk iterator实现了一个顺序的TDP paging结构的遍历。线程通过使用RCU允许安全的在这个遍历过程里读和写page table的内存，并且page table的内存会在RCU的callbacks里释放，并作为处理逻辑的第三个步骤的一部分（不仅是底下这部分）。为了保证PTEs被原子的更新，迭代器提供了一个更新当前pte的方法。如果更新成功，迭代器会对之前和现在的PTE值做一个记录。如果失败了，其他线程会执行成功，迭代器会在下一次迭代继续重复这个PTE，并显式的重试一下。迭代器充实也会处理yielding并且重新获取合适的MMU lock，并且刷新TLB或者保存修改的内容到下一次flush位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In order to minimize TLB flushes, we expand the tlbs_dirty count to</span><br><span class="line">track unflushed changes made through the iterator, so that other threads</span><br><span class="line">know that the in-memory page tables they traverse might not be what the</span><br><span class="line">guest is using to access memory. Page table pages that have been</span><br><span class="line">disconnected from the paging structure root are freed in a three step</span><br><span class="line">process. First the pages are filled with special, nonpresent PTEs so</span><br><span class="line">that guest accesses to them, through the paging structure caches result</span><br><span class="line">in TDP page faults. Second, the pages are added to a disconnected list,</span><br><span class="line">a snapshot of which is transferred to a free list, after each TLB flush.</span><br><span class="line">The TLB flush clears the paging structure caches, so the guest will no</span><br><span class="line">longer use the disconnected pages. Lastly, the free list is processed</span><br><span class="line">asynchronously to queue RCU callbacks which free the memory. The RCU</span><br><span class="line">grace period ensures no kernel threads are using the disconnected pages.</span><br><span class="line">This allows the MMU to leave the guest in an inconsistent, but safe,</span><br><span class="line">state with respect to the in-memory paging structure. When functions</span><br><span class="line">need to guarantee that the guest will use the in-memory state after a</span><br><span class="line">traversal, they can either flush the TLBs unconditionally or, if using</span><br><span class="line">the MMU lock in write mode, flush the TLBs under the lock only if the</span><br><span class="line">tlbs_dirty count is elevated.</span><br></pre></td></tr></table></figure>

<p>为了最小化TLB的flush，我们拓展了tlbs_dirty count来跟踪没有flush的迭代器修改，因此其他线程就能知道内存的page tables并不是guest当前要访问的内存（因为没刷新）。Page tables pages将会从paging数据结构里堵啊开，并且对应的pages就会被释放掉。</p>
<ol>
<li>page将会用特殊的，并未出现的PTEs写满，因此guest访问这些地址的时候就是通过paging的cache，最后抛出一个TDP的page faults。</li>
<li>pages将会被加入到一个disconnected的list里，一个快照记录需要被释放的信息，然后按顺序做TLB flush。TLB的flush会清理对应的paging数据结构的缓存，所以guest将没办法访问disconnected的page</li>
<li>free list会被异步处理，并且进入队列等RCU的callbacks来释放内存。</li>
</ol>
<p>RCU grace period保证没有内核线程会使用这些disconnected的pages。这个允许MMU通过内存中的paging数据结构让guest保持一个不一致但是安全的状态。如果一些方法需要保证guest需要使用遍历之后的内存中的状态，可以直接flush这个TLB或者是使用写模式的MMU锁，flush TLB操作需要保证tlbs_dirty比较高的时候拿到锁执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The use of the direct MMU can be controlled by a module parameter which</span><br><span class="line">is snapshotted on VM creation and follows the life of the VM. This</span><br><span class="line">snapshot is used in many functions to decide whether or not to use</span><br><span class="line">direct MMU handlers for a given operation. This is a maintenance burden</span><br><span class="line">and in future versions of this series I will address that and remove</span><br><span class="line">some of the code the direct MMU replaces. I am especially interested in</span><br><span class="line">feedback from the community as to how this series can best be merged. I</span><br><span class="line">see two broad approaches: replacement and integration or modularization.</span><br></pre></td></tr></table></figure>

<p>Direct MMU的使用可以通过模块参数，一个随着虚拟机的创建并伴随VM生命周期的参数控制。这个快照在很多方法里面用来判断是否需要使用direct MMU的处理。这是一个不太好维护的东西，未来需要去掉一些direct MMU相关的代码。我很期待社区的反馈来保证这些code在最好的状态合并。目前我认为有两个方法，替换+集成 或者是模块化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Replacement and integration would require amending the existing shadow</span><br><span class="line">paging implementation to use a similar iterator pattern. This would mean</span><br><span class="line">expanding the iterator to work with an rmap to support shadow paging and</span><br><span class="line">reconciling the synchronization changes made to the direct case with the</span><br><span class="line">complexities of shadow paging and nesting.</span><br></pre></td></tr></table></figure>

<p>替换和集成需要给目前的shadow paging增加类似的迭代器模式。也就意味着拓展迭代器并能够和rmap一起工作来支持shadow paging以及使得原本的同步修改模式和direct模式来适应复杂的shadow paging以及nesting</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">The modularization approach would require factoring out the &quot;direct MMU&quot;</span><br><span class="line">or &quot;TDP MMU&quot; and &quot;shadow MMU(s).&quot; The function pointers in the MMU</span><br><span class="line">struct would need to be expanded to fully encompass the interface of the</span><br><span class="line">MMU and multiple, simpler, implementations of those functions would be</span><br><span class="line">needed. As it is, use of the module parameter snapshot gives us a rough</span><br><span class="line">outline of the previously undocumented shape of the MMU interface, which</span><br><span class="line">could facilitate modularization. Modularization could allow for the</span><br><span class="line">separation of the shadow paging implementations for running guests</span><br><span class="line">without TDP, and running nested guests with TDP, and the breakup of</span><br><span class="line">paging_tmpl.h.</span><br></pre></td></tr></table></figure>

<p>模块化主要是重构几个分开的部分“direct MMU”或者“TDP MMU”以及“shadow MMU”。需要把MMU的结构拓展为一个完整的包含MMU以及多MMU，单MMU并实现这些对应的接口。试用类似模块参数快照能够给出一个粗略的MMU接口的大致的轮廓，也能够作为模块化的基础。模块化允许shadow paging在guest中的使用，也支持嵌套虚拟化的guest试用TDP，也是paging_tmpl.h的突破。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In addition to the integration question, below are some of the work</span><br><span class="line">items I plan to address before sending the series out again:</span><br></pre></td></tr></table></figure>

<p>关于集成的部分我重新列了一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Disentangle the iterator pattern from the synchronization changes</span><br><span class="line">	Currently the direct_walk_iterator is very closely tied to the use</span><br><span class="line">	of atomic operations, RCU, and a rwlock for MMU operations. This</span><br><span class="line">	does not need to be the case: instead I would like to see those</span><br><span class="line">	synchronization changes built on top of this iterator pattern.</span><br><span class="line"></span><br><span class="line">Support 5 level paging and PAE</span><br><span class="line">	Currently the direct walk iterator only supports 4 level, 64bit</span><br><span class="line">	architectures.</span><br><span class="line"></span><br><span class="line">Support MMU memory reclaim</span><br><span class="line">	Currently this patch series does not respect memory limits applied</span><br><span class="line">	through kvm_vm_ioctl_set_nr_mmu_pages.</span><br><span class="line"></span><br><span class="line">Support nonpaging guests</span><br><span class="line">	Guests that are not using virtual addresses can be direct mapped,</span><br><span class="line">	even without TDP.</span><br><span class="line"></span><br><span class="line">Implement fast invalidation of all PTEs</span><br><span class="line">	This series was prepared between when the fast invalidate_all</span><br><span class="line">	mechanism was removed and when it was re-added. Currently, there</span><br><span class="line">	is no fast path for invalidating all direct MMU PTEs.</span><br><span class="line"></span><br><span class="line">Move more operations to execute concurrently</span><br><span class="line">	In this patch series, only page faults are able to execute</span><br><span class="line">	concurrently, however several other functions can also execute</span><br><span class="line">	concurrently, simply by changing the write lock acquisition to a</span><br><span class="line">	read lock.</span><br></pre></td></tr></table></figure>

<p>把迭代器从同步修改里分离出来</p>
<p>目前的direct_walk_iterator是和原子操作，RCU和MMU操作的读写锁。但实际上没有必要这样，其实这些同步修改应该实现在迭代器模式之上。</p>
<p>支持5级的paging以及PAE</p>
<p>目前direct walk interator只支持4级，64bit的架构</p>
<p>支持MMU的内存回收</p>
<p>当前这个补丁并没有支持kvm_vm_ioctl_set_nr_mmu_pages内存相关的限制</p>
<p>支持nonpaging guests</p>
<p>guest如果没使用虚拟地址的也能直接映射，甚至不需要TDP</p>
<p>实现快速的对所有PTEs的失效检测</p>
<p>增加更多的并发操作</p>
<p>refer to:<br><a target="_blank" rel="noopener" href="https://www.spinics.net/lists/kvm/msg196464.html">https://www.spinics.net/lists/kvm/msg196464.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/" data-id="cld1mhecc0066yuwba332a3x4" data-title="kvm: mmu: Rework the x86 TDP direct mapped case" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/29/kvm-mmu-rework-the-x86-tdp-direct-mapped-case/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-libvirt-memory-snapshot" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/28/libvirt-memory-snapshot/" class="article-date">
  <time class="dt-published" datetime="2022-09-28T01:19:10.372Z" itemprop="datePublished">2022-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>virDomainDefParseXML -&gt; virDomainDiskDefParseXML -&gt; virDomainDeviceInfoParseXML -&gt; virDomainDeviceAddressParseXML -&gt; virPCIDeviceAddressParseXML</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (devaddr) &#123;</span><br><span class="line">    if (virDomainParseLegacyDeviceAddress(devaddr,</span><br><span class="line">                                          &amp;def-&gt;info.addr.pci) &lt; 0) &#123;</span><br><span class="line">        virReportError(VIR_ERR_INTERNAL_ERROR,</span><br><span class="line">                       _(&quot;Unable to parse devaddr parameter &#39;%s&#39;&quot;),</span><br><span class="line">                       devaddr);</span><br><span class="line">        goto error;</span><br><span class="line">    &#125;</span><br><span class="line">    def-&gt;info.type &#x3D; VIR_DOMAIN_DEVICE_ADDRESS_TYPE_PCI;</span><br><span class="line">&#125; else &#123;</span><br></pre></td></tr></table></figure>

<p>qemuDomainSaveInternal -&gt; </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if (!(cookie &#x3D; qemuDomainSaveCookieNew(vm)))</span><br><span class="line">    goto endjob;</span><br><span class="line"></span><br><span class="line">if (!(data &#x3D; virQEMUSaveDataNew(xml, cookie, was_running, compressed,</span><br><span class="line">                                driver-&gt;xmlopt)))</span><br><span class="line">    goto endjob;</span><br><span class="line">xml &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">ret &#x3D; qemuDomainSaveMemory(driver, vm, path, data, compressedpath,</span><br><span class="line">                           flags, QEMU_ASYNC_JOB_SAVE);</span><br><span class="line">if (ret &lt; 0)</span><br><span class="line">    goto endjob;</span><br><span class="line"></span><br><span class="line">&#x2F;* Shut it down *&#x2F;</span><br><span class="line">qemuProcessStop(driver, vm, VIR_DOMAIN_SHUTOFF_SAVED,</span><br><span class="line">                QEMU_ASYNC_JOB_SAVE, 0);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">        rc &#x3D; qemuMonitorMigrateToFd(priv-&gt;mon,</span><br><span class="line">                                    QEMU_MONITOR_MIGRATE_BACKGROUND,</span><br><span class="line">                                    fd);</span><br><span class="line">                                    </span><br><span class="line">int</span><br><span class="line">qemuMonitorMigrateToFd(qemuMonitorPtr mon,</span><br><span class="line">                       unsigned int flags,</span><br><span class="line">                       int fd)</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line">    VIR_DEBUG(&quot;fd&#x3D;%d flags&#x3D;0x%x&quot;, fd, flags);</span><br><span class="line"></span><br><span class="line">    QEMU_CHECK_MONITOR(mon);</span><br><span class="line"></span><br><span class="line">    if (qemuMonitorSendFileHandle(mon, &quot;migrate&quot;, fd) &lt; 0)</span><br><span class="line">        return -1;</span><br><span class="line"></span><br><span class="line">    ret &#x3D; qemuMonitorJSONMigrate(mon, flags, &quot;fd:migrate&quot;);</span><br><span class="line"></span><br><span class="line">    if (ret &lt; 0) &#123;</span><br><span class="line">        if (qemuMonitorCloseFileHandle(mon, &quot;migrate&quot;) &lt; 0)</span><br><span class="line">            VIR_WARN(&quot;failed to close migration handle&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>qemu should support sendFD (qemu is should using a unix socket monitor)</p>
<p>qemu monitor get fd (SCM_RIGHTS) </p>
<p>SCM_RIGHTS<br>              Send or receive a set of open file descriptors from<br>              another process.  The data portion contains an integer<br>              array of the file descriptors.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* Perform the migration *&#x2F;</span><br><span class="line">if (qemuMigrationSrcToFile(driver, vm, fd, compressedpath, asyncJob) &lt; 0)</span><br><span class="line">    goto cleanup;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemuMonitorJSONMigrate</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/28/libvirt-memory-snapshot/" data-id="cld1mheaj000oyuwbei0mcdcw" data-title="" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/28/libvirt-memory-snapshot/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/28/libvirt-memory-snapshot/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-a-simplified-TDP-with-large-tables" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/27/a-simplified-TDP-with-large-tables/" class="article-date">
  <time class="dt-published" datetime="2022-09-27T13:34:44.000Z" itemprop="datePublished">2022-09-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/27/a-simplified-TDP-with-large-tables/">A Simplified TDP with Large Tables</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Abstract. Among the performance bottlenecks for the virtual machine, memory comes next to the I/O as the second major source of overhead to be addressed. While the SPT and TDP have proved to be quite effective and mature solutions in memory virtualization, it is not yet guaranteed that they perform equally well for arbitrary kind of workloads, especially considering that the performance of HPC workloads is more sensitive to the virtual than to the native execution environment. We propose that based on the current TDP design, modification could be made to reduce the 2D page table walk with the help of large page table. By doing this, not only the guest and host context switching due to guest page fault could be avoided, but also the second dimension of paging could be potentially simplified, which will lead to better performance.</p>
</blockquote>
<p>目前内存的损耗已经成为所有虚拟机性能瓶颈中，仅次于I/O的损耗。虽然已经证明了SPT和TDP是非常有效和成熟的内存虚拟化解决方法，但是相比于非虚拟机环境来说，内存虚拟化的性能对任何类型的负载，特别是高性能计算这种对性能特别敏感的情况是没有提供保证的。所以我们基于现在的TDP的设计提出了一些可行的修改，通过large page table检查少2D页表的查找。通过这个改动，不仅仅是guest和host的上下文切换导致的guest page fault可以被避免（这里说的应该是context change之后，会碰到page fault，large page table似乎是不是增加了page的大小，这样页表的条数就减少了，即使context change也不会发生table entry的变化，减少了page fault？可以继续看看）。同时second dimension of paging（也就是TDP）也可以被简化并获得更好的性能</p>
<blockquote>
<p>In the context of system virtualization, SPT (shadow page table) and TDP (twodimensional paging)1 are the two mature solutions for memory virtualization in the current hypervisors. Both of them perform address translation transparently from the guest to the host. In dealing with the translation chain from GVA (guest virtual address) to HPA (host physical address), the SPT combines the three intermediate steps for each GVA→HPA into a single entry, which contains the wanted address and saves further efforts to walk through both of the guest and host page tables as long as the cached entry is not invalidated in any form. However, as SPT is a part of the hypervisor and must be kept as consistent as possible with the guest page table, the processor had to exit from the guest to host mode to update the SPT and make it accessible, during which a considerable number of CPU cycles could have been wasted. TDP comes as a remedy by keeping GVA→GPA translation in the guest, while shifting GPA→HPA translation from the hypervisor to the processor. The expensive vmexit and vmentry due to guest page fault are avoided by TDP. Unfortunately in case of TLB-miss (translation look-aside block) the multi-level page table must still be walked through to fetch the missing data from the memory. Because of this nature, the TLB is not quite helpful in preventing page table from being walked when running workloads with poor temporal locality or cache access behavior. As a result, 1 TDP it is known as the AMD NPT and Intel EPT. For technical neutrality reason TDP is used to refer to the paging mechanism with hardware assistance the performance gain could be more or less offset by the overhead. We attempt to combine the merits of the two methods and meanwhile avoid the downsides of them by adapting the mmu code in the hypervisor.</p>
</blockquote>
<p>在系统虚拟化中，SPT（shadow page table 影子页表）和TDP（twodimensional paging我也不知道咋翻译）是当前hypervisor（VMM，虚拟机监视器）成熟的内存虚拟化解决方案。这两个方案显而易见的就是做guest到host的地址翻译。主要是处理GVA（虚拟机 虚拟地址）到HPA（宿主机 物理地址）的翻译链。SPT把三个中间步骤结合在一起（这里简单解释一下就是 虚拟机虚拟地址-&gt;虚拟机内存地址-&gt;宿主机虚拟地址-&gt;虚拟机物理地址）实际上每一步都有一个对应的entry，SPT总是会把这些内容放在cache里面来节省需要访问所有关联关系的时间，所以为了保证SPT的内容都是一致的，处理器需要从guest模式exit到host模式来更新STP的内容（这是因为kernel提供了这个功能，所以如果发生了Host上的进程切换，映射关系可能需要更新，所以其实很多CPU时间就损耗在这个切换上了。TDP应运而生（remedy，其实是治疗药物的意思，意译了一下）通过在guest上保持guest虚拟地址到guest物理地址的翻译不变，把guest物理地址到host物理地址的翻译从hypervisor层（kvm kernel）转移到了处理器上，而结果就是上面提到的exit就可以避免了（主要是guest page fault之后，需要一层一层往上找，如果是STP，就需要exit退出guest模式，如果处理器能处理host的地址翻译，那么就不需要exit，处理器能完成这个工作）。当然如果TLB-miss的话（意思是说page table的缓存，也就是 TLB，会记录活跃的内存页page，如果TLB中包含，那么可以直接从cache里返回地址。否则就要走正常的寻址逻辑-&gt;多级页表）还是需要查询多级页表在内存里找到对应的数据。因为这个特性，TLB其实在很多时候并不能解决没有时间局限性的或者是缓存访问的行为（这里解释一下，比如存在一个pageA，有时间局限性意思是说未来短时间内可能会被多次访问，没有的意思就是说，随机访问很多不同page的情况）。所以结果是，TDP实际上就是AMD的NPT和Intel的EPT。基于技术中立的态度（指不偏向AMD或者Intel），TPD被用来作为硬件辅助分页机制来提升部分性能的机制。我们尝试调整hypervisor（kvm）的mmu代码，尝试结合这两个方法，同时避免一些已有的缺点。</p>
<p>评论：</p>
<p>讲的非常的准确，优点/缺点，以及要做什么</p>
<blockquote>
<p>For TLB contains a number of the most recently accessed GPA→HPA mappings, the more likely these entries will be needed in future, the more time could be saved from the page table walk in subsequent operations. To the nature of the paging methods themselves, the efficiency of both SPT and TDP rely on to what extent the cached results of the previous page table walks could be reused. Since the SPT cannot be maintained without interrupting the guest execution and exit to the host kernel mode, there will be little chance other than reducing the occurrence of the page fault in the guest to improve the performance of SPT. This, however, largely depends on the memory access behavior of the individual workload and remains beyond the control of the hypervisor. TDP, on the hand, bears the hope for performance improvement. Currently the TDP is adopting the same paging mode as the host does, known as “multi-level page table walk-through”. It is an N-ary tree structure [1], where N could be 1024 in 32-bit mode, or 512 in 64-bit or 32-bit PAE modes. In the 32-bit mode only 2 level page table are involved for walking through, which poses minor overhead. However, the overhead grows quickly non-negligible as the paging level increases. In spite of the various paging modes adopted in the guest, only two modes - the 64-bit and the 32-bit PAE modes are available for the TDP. In the worst case if all TLB large missed, up to 24 memory accesses are possible for a single address translation.</p>
</blockquote>
<p>TLB包含了最近访问的GPA-&gt;HPA的映射，这些将来要被继续访问的条目如果保存的越多（因为TLB是cache，所以有这么样的假设，所以cache不适用的场景都是类似的，比如超出cache上限等），那么就能够节约更多的查询page table这个操作消耗的时间。结合这两个分页方法本身，SPT和TDP的性能，取决于用什么cache来拓展之前的page table查询结果，并且可以被复用。因为SPT需要通过中断的方式维护（主要是vm exit然后更新）所以实际上CPU上导致的损耗使得优化SPT的可能性很低。当然SPT很大程度上和单个负载的内存访问方式有关系，（比如一直没有上下文切换，也只访问热点数据，那又是没啥问题的）。TPD，实际上更有可能提升性能。目前TDP采用的是和host一样的分页模式，也就是（multi-level page table walk-through 多级页表访问）。是一个N长度数组的树结构，N可以是32位模式的1024，或者是64位和32位PAE模式的512。在32位模式，只有两级页表能够在访问中使用，这种情况下损耗更下一些。当然随着分页级别的增加，这个损耗变得不容忽视。不管guest里面可能采用各种不同的分页级别设置，TDP只支持64位和32位PAE模式。最差的情况下TLB没有命中的话，最差的情况一次地址翻译需要24次内存访问（TODO）</p>
<p>评论：</p>
<p>介绍了一下当前访问过程中存在的一些问题</p>
<blockquote>
<p>Though undesirable, this has presumably been done for two reasons: 1. compatibility between the host and guest paging modes, and more importantly, 2. efficiency in memory utilization. However, as the TDP table is in the hypervisor and invisible to the guest, it is actually up to the hypervisor to adopt the paging mode without having to maintain this kind of compatibility [2]. For the tree structure forms a hierarchy of the 1-to-many mappings, mappings could be built in a “lazy” way only on demand, significant amount of memory space for entries could be saved compared with the 1-to-1 mapping based structure, say, an array. On the other hand, this structure also means more memory access and time cost while looking up an element within it. As performance rather than memory saving comes as the top concern, paging methods more efficient than the current one may exist. One candidate is naturally a 1-to-1 mapping based structure, such as an array, or a hash list. With more memory being invested to save all the possible GPPFN (guest physical page frame number) to HPPFN (host physical page frame number) mappings, fewer memory accesses suffice2 in the second dimension of the TDP. By doing this, the whole translation from GVA to HPA is expected to be effectively simplified and accelerated due to a reduced paging structure in TDP table. In addition, a simplified TDP method combines the merits of both TDP and SPT - to avoid the vmexit as well as to maintain the relatively short mapping chains from GVA to HPA. Until significant change is made available to the paging mode of the current processor, it could be a better practice merely by modifying the current hypervisor software.</p>
</blockquote>
<p>尽管这很讨厌（要说什么特殊条件了），这个可能通过以下两个原因能够解决：1. host和guest使用完全相同的paging mode（很重要）2. 提升内存使用率。然而，TPD table是保存在hypervisor并且对guest不可见，所以实际上只需要hypervisor采用对应的paging模式，而没有必要维护兼容性。用树状的层级结构表示1对多的映射，映射可以按需是否使用lazy的方式，相比于1对1映射能保存大量的内存空间的条目。另一方面，这个数据结构也意味着更多的内存访问，以及访问的时间消耗。因为主要考虑性能而不是节省内存，比当前这个方式效率更高的方法肯定是存在的。比如默认的1对1映射的数据结构，比如数组或者hash列表。随着更多的内存被用于保存可能被使用的GPPFN（guest physical page frame number）和 HPPFN（host physical page fram number）的映射，使用TDP映射需要访问内存的时间就更少了。通过减少TDP table里paging数据结构的层级，整个GVA到HPA的翻译，会变得更加简化，并且加速。同时，简化TDP方法，并结合TDP和SPT的特点（避免vmexit，同时维护一个很短的GVA到HPA的映射关系）。除非处理器的分页模式发生重大变革，目前来说修改当前的hypervisor是最好的方法。</p>
<p>评论：</p>
<p>所以还是改原本的code，没有办法在结构上改进，提升也是有限的</p>
<blockquote>
<p>Major work focusing on improving the memory virtualization could be summarized as the following. To work around the unfavorable sides and combine the best qualities of SPT and TDP, one attempt is to enable the hypervisor to reconfigure its paging method at run-time as a response to the ever changing behavior of the workloads in memory accessing, which were implemented in the past in a few hypervisors such as Xen and Palacios according to [3,4]. Although not all workloads could be benefited from this, overall performance gain have been observed for the selected benchmarks. The downside, however, is that it adds further complexity to the hypervisor with the methods of performance metric sampling, paging method decision making, as well as the dynamic switching logic. Furthermore, such activities in the kernel could also do harm to the performance.</p>
</blockquote>
<p>主要的改进内存虚拟化的工作总结如下。去掉SPT和TDP里面不好的部分，结合他们的特点，一个尝试就是让hypervisor在运行时重新设置paging方法，并作为内存访问的负载的一个变化行为，这已经在过去的一些hypervisor上实现了，比如Xen和Palscios。虽然不是所有的负载都适用于这个方法， 所有的性能提升都是对应不同的基准来观测的。当然这个缺点就是要增加hypervisor的复杂度，主要是影响性能检测，决定分页方法，同时还有动态切换。当然，kernel里这样的行为也是会影响性能的。</p>
<p>评论：</p>
<p>突然开始保守了，前面可能吹太猛了，因为模型上没有变化，只能控制面改了</p>
<blockquote>
<p>To reduce the overhead for walking through the multi-level page tables in TDP, a hashed list is applied to provide direct address mapping for GPA [2]. In contrast with the O(n<sup>2</sup>) complexity of the conventional multi-level forward page tables for both GVA→GPA and GPA→HPA translations, the hashed page table has only one paging level and achieves a complexity of O(n) in theory. The performance is at least not worse due to the reduced page table walk and cache pressure, showed by the benchmark. Since the hash table is a data structure more capable in searching, inserting and deleting etc., and relatively easier to be implemented within the existing framework of the hardware and software, current TDP design could be simplified by applying it for better performance. As more reflections were cast on the current multi-level paging modes, a variety of changes have been prompted for a simplified paging work. Theoretically, a “flat nested page table” could be formed by combining the intermediate page levels from 4 to 1, which results in an 8 memory access for the translation from GVA to HPA, and a reduced overhead for 2D TDP walk [5]. By extending the processor and hypervisor with the “direct segment” function, the memory access for the GVA to HPA translation could even be further reduced to 4 or 0 [6].</p>
</blockquote>
<p>为了TDP访问减少多级页表造成的损耗，增加一个hash列表来提供GPA的直接映射（GPA到HPA）。对比原本的GVA-&gt;GPA和GPA-&gt;HPA翻译的O(n<sup>2</sup>)的多级页表访问复杂度，使用哈希页表，只有一层分页级别，所以理论上复杂度只有O(n)。结合测试基准，性能在减少了页表的访问以及缓存的压力之后并没有变差。因为哈希表是一个便于搜索插入和删除的数据结构并且在很多框架软件硬件上都很容易时间，目前的TDP设计可以被简化成使用哈希表来获取更好的性能。当然对更多的针对目前的多级页表模式的改进可以被提出来用来简化寻址工作。理论上“flat nested page table” 一个很大的内嵌页表修改页级别从4改成1，最多也就是需要8次内存访问，同时减少2D TDP的查询。通过拓展处理器以及hypervisor的direct segment方法，内存的翻译可以被减少到4-0次</p>
<p>评论：</p>
<p>把原本的多级页表，改成了单层的hash表</p>
<p>比如原本的页表是1024，通过多级，可以保存1024<sup>n</sup>的页信息，虽然查询的时间长了，但是保存的地址多了，寻址上，在没有cache的情况下，找的时间就会指数级增加</p>
<p>换成hash表，查询速度变快了，但是相对的保存的条目数量就受到了page table的限制，因此提出的改进其实希望是一个很大的hash表</p>
<blockquote>
<p>For the TLB plays a critical role in reducing the address translation overhead [7] and justifies the use of TDP, it becomes another concern besides the paging level. Specific to the AMD processor, a way is suggested in [8] to accelerate the TDP walk for guest by extending the existing page walk cache also to include the nested dimension of the 2D page walk, caching the nested page table translations, as well as skipping multiple page entry references. This technique has already gained its application in some AMD processors. Not limited to virtual cases, attention is paid in [9] to compare the effectiveness of five MMU cache organizations, which shows that two of the newly introduced structures - the variants of the translation outperform the existing structures in many situations.</p>
</blockquote>
<p>TLB在减少地址翻译的损耗扮演了一个很重要的角色，并且很适合TDP的使用场景，所以它成为了除了paging level之外的另外一个条件。仅限AMD处理器，实际上有一个加速guest TDP查询的方法，就是增加已有的page walk cache并且包含嵌套的2D page walk。缓存嵌套的页表翻译，同时跳过多页面引用。这个技术已经在一些AMD处理器的一些应用上被采用了。不仅限于虚拟化场景，其实对比与其他五个MMU cache组织，也说明了最新的两个结构，对于翻译性能的提升，在很多情况都是优于已有的结构的。</p>
<p>评论：</p>
<p>我的cache无限大，速度够快，那其实根本不需要page，直接都放到cache里不是更好</p>
<blockquote>
<p>As a potential technical breakthrough, TDP is different from SPT in many aspects. However, for compatibility reason, the main structure of SPT is still reused by TDP. This, though at first may seem quite misleading, enables the TDP to fit seamlessly into the current framework previously created for SPT. As far as TDP feature is available in the hardware, it is preferred to SPT for general better performance. While in the absence of TDP hardware feature, SPT may serve as a fall-back way and the only choice for the hypervisor to perform the guest-to-host address translation.</p>
</blockquote>
<p>作为一个潜在的技术重大突破，TDP其实和SPT在很多方面都不一样。然而，因为很多兼容性原因，SPT的主要数据结构都被TDP复用了。因此一开始看的时候会感觉非常误导，启用TDP和现有的为SPT创建的框架无缝衔接。目前为止，TDP特性在硬件上可用，相比SPT来说有更好的性能。因为缺少TDP的硬件特性，SPT可以所谓一个备用方，也是hypervisor层来实现guest到host地址翻译的唯一方法。</p>
<p>评论：</p>
<p>好像也没想出啥好办法，开始叹气</p>


<blockquote>
<p>In KVM, SPT and TDP share the same data structure of the virtual MMU and page tables (surprisingly, both are named as shadow page table). The shadow page table is organized as shown by Fig. 1, of which kvm mmu page is the basic unit gluing all information about the shadow pages together. For each level of the shadow page table, a pageful of 64-bit sptes containing the translations for this page are pointed to by *spt, whose role regarding the paging mode, dirty and access bits, level etc. are defined by the corresponding bits in role. The page pointed to by spt will have its page-&gt;private pointing back at the shadow page structure. The sptes in spt point either at guest pages, or at lower-level shadow pages [10]. As the sptes contained in a shadow page may be either one level of the PML4, PDP, PD and PT, the pte parents provides the reverse mapping for the pte/ptes pointing at the current page’s spt. The bit 0 of parent ptes is used to differentiate this number from one to many. If bit 0 is zero, only one spte points at this pages and parent ptes points at this single spte, otherwise, multiple sptes are pointing at this page and the parent ptes &amp; 0x1 points at a data structure with a list of parent ptes. spt array forms a directed acyclic graph structure, with the shadow page as a node, and guest pages as leaves [10].</p>
</blockquote>
<p>在KVM中，SPT和TDP使用相同的数据结构，也就是virtual MMU和page tables（很惊讶，他们都叫做shadow page table）。shadow page tables的结构如Fig.1所示。kvm mmu page是一个基础的单元，把所有shadow pages相关的信息黏合在一起（突然想到python是glue language）。对任意一级的shadow page table来说，一个64bit的sptes整个page包含了这个page所有的翻译，是通过*spt指针指向的，里面的role字段则是表示paging mode，dirty bit，access bit以及级别等等。都是在role里面的比特位定义的。spt指向的page有对应的page-&gt;priavte pointing back的从shadow page structure指回去的指针。spt中的spte指针也只想guest的page，或者是更低级别的shadow page。因为shadow page包含的sptes也可能是另外一个级别的PML4，PDP，PD和PT，对应的pte parents需要提供对pte/ptes指针的反向指针，指向当前page的spt。Parent ptes的第一个比特位，bit0是用来区分是一对多还是一对一，如果bit0是zero，那么说明当前page的spte指针只有一个spte和page parent对应。否则说明有多个sptes指向这个page，同时parent page的ptes &amp; 0x1 指向一个数据结构，表示一个parent ptes的列表。spt数据组织了一个直接非环图结构，shadow page作为一个node，guest的page作为叶子结点。</p>
<p>评论：</p>
<p>这段没看懂，回头继续看</p>
<blockquote>
<p>KVM MMU also maintains the minimal pieces of information to mark the current state and keep the sptes up to date. unsync indicates if the translations in the current page are still consistent with the guest’s translation. Inconsistence arises when the translation has been modified before the TLB is flushed, which has been read by the guest. unsync children counts the sptes in the page pointing at pages that are unsync or have unsynchronized children. unsync child bitmap is a bitmap indicating which sptes in spt point (directly or indirectly) at pages that may be unsynchronized. For more detailed description, the related Linux kernel documentation [10] is available for reference.</p>
</blockquote>
<p>KVM MMU也维护了一个最小程组的信息，来标记当前的状态以及保证sptes是最新状态。如果当前的page和guest的翻译还是一致的就不会标记为需要同步。如果翻译被改动，而TLB还没刷新就会guest读到的内容不一致（因为正确的映射关系是通过shadow page维护的，guest的TLB只是cache，如果没有即使更新就会出现shadow page和TLB不一致的情况）</p>
<p>Unsync children会计算当前page的指向没同步的或者是存在没同步的子节点的stpes的数量，</p>
<p>Unsync children bitmap是一个bitmap标记spt指针的sptes（直接或间接的）指向页面的这些指针可能没有同步。</p>
<p>更多细节的描述可以看Linux kernel的文档。</p>
<p>评论：</p>
<p>操作系统代码不熟，需要回炉重造</p>
<blockquote>
<p>Multiple kvm mmu page instances are linked by an hlist node structure headed by hlist head, which form the elements in the hash list - mmu page hash pointed to by kvm-&gt;arch. Meanwhile it’s also linked to either the lists active mmu pages or zapped obsolete pages in the kvm-&gt;arch, depending on the current state of the entries contained by this page. Both SPT and TDP keep their “shadow page table” entries and other related information in the same structure. The major difference lies in the hypervisor configuration of the runtime behaviors upon paging-fault-related events in the guest. While the SPT relies on the mechanism of “guest page write-protecting” and “host kernel mode trapping” upon guest page fault for keeping the SPT synchronized with the guest page table, the TDP achieves the same result by a hardware mechanism. As VMCB (virtual machine control block) by AMD or VMCS (virtual machine control structure) by Intel is the basic hardware facility the TDP makes use of, it’s the key thing making difference. Code snippet in Fig. 2 shows the configuration of VMCB for TDP, and that the root address of the TDP page table is kept in the VMCB structure. Meanwhile the guest is configured as exitless for paging-fault exception, which means that the page fault events is handled by the processor. With this configuration, guest is left running undisturbed when the guest page fault occurs.</p>
</blockquote>
<p>多个kvm mmu page实例会被连接到一个hlist数据结构的head上，组织称一个hash list。kvm-&gt;arch来指向mmu page hash指针。同时也会在kvm-&gt;arch连接到active的mmu page或者是过期的page，取决于当前这个page包含的entries的状态。SPT和TDP会保持他们的shadow page table entires和其他的关联信息在相同的数据结构里。主要的不同是hypervisor的runtime行为配置对guest中paging-fault相关的事件的处理。因为SPT依赖于guest page write-protecting的机制，以及host kernel mode trapping，当出现guest page fault的时候，为了保证SPT和guest的page同步，TDP需要实现一个硬件的机制。在VMCB（virtual machine control block）AMD的数据结构以及VMCS（virtual machine control structure）intel的数据结构提供给TDP使用，也是最关键的部分。</p>
<p>代码放在了Fig2，展示了给TDP用的VMCB的配置，对应TDP page的root address被保存在VMCB数据结构里。同时guest配置为碰到page fault错误也不做vm exit（即不走shadow page table的逻辑），这个page fault交给处理器处理。通过这个配置，guest就不会因为page fault受到过多影响（指退出guest mode）</p>


<blockquote>
<p>Besides, as SPT maps GVA to HPA, the spt entries are created and maintained in a per-process way, which leads to poor reusability hence higher memory consumption. These are obvious downsides especially when multiple processes are running in parallel. In contrast, the TDP maintains only the mappings from GPA to HPA, which effectively eliminated such problems associated with SPT. Guest page table is also accessed by the physical processor and forms the first dimension of the entire page table walk. In this way the TDP can not only eliminate the cost for frequent switching between the host and guest modes due to SPT synchronization, but also simplify the mappings and maintenance efforts the “shadow page tables” needs.</p>
</blockquote>
<p>除此之外，比如SPT用来映射GVA到HPA，对应的spt条目由每个进程创建和维护，在内存消耗很大的场景下重用性很差（因为进程切换，大部分换出换入）。特别是多进程并行的时候，这些缺陷显而易见。对比之下，TDP仅维护了GPA到HPA的映射，有效的减轻了SPT这样的问题。Guest page table也会被物理处理器访问，并且构建了完整的page的访问。在这个情况下TDP不仅可以减少在host和guest之间因为SPT同步导致不断切换的问题，也能简化shadow page tables映射的麻烦。</p>
<p>评论：</p>
<p>又重新讲了一下TDP的作用，感觉有点重复</p>
<blockquote>
<p>Two stages are involved in the buildup of the TDP table, namely, the creation of the virtual mmu, and the filling of TDP page tables upon guest page fault during the execution of the guest. As Fig. 3 depicts, in the context of the function kvm vm ioctl, the virtual mmu is created for the first time along with the guest VCPU. It is also when the VMCB is configured. One thing to be noticed is that, as the root address of the TDP page table, the root hpa of the kvm mmu is left without to be allocated a page table, which is deferred to the second stage.</p>
</blockquote>
<p>构建TDP table需要两个阶段，首先是创建virtual mmu并且在guest执行的时候发生page fault时填充TDP表。如Fig3所示，kvm vm ioctl功能的上下文中，virtual mmu是首先被创建的，并且不和guest VCPU相关。这也是VMCB被配置的时候。值得注意的是，TDP pagetable的root address中，kvm mmu的root hpa会被保留并且不分配给page table，接下来就到第二阶段了。</p>
<blockquote>
<p>Figure 4 depicts the context function vcpu enter guest, in which operations related to the second stage take place. This function serves as an interface for the inner loop3 in the internal architecture of the QEMU-KVM, dealing with host-guest mode switching. Before the guest mode is entered by the processor, much preparation work needs to be done in this context, including the checking and handling of many events, exceptions, requests as well as mmu reloading or I/O emulation. The only thing needed for mmu reloading is to allocate a page for the TDP table and make the starting address of it known to the root hpa of the kvm mmu and the CR3 of the VCPU, which is performed by kvm mmu load.</p>
</blockquote>
<p>Fig4说明了vcpu enter guest功能呢，也就是第二阶段发生的时候。这个功能作为一个接口在QEMU-KVM的架构中使用，处理host-guest mode的切换。在guest mode enter之前，很多的准备工作要基于这个上下文完成。包含检查以及处理很多的事件，异常，请求以及mmu加载或者是I/O模拟，需要对mmu加载做的工作就是给TDP表的page分配，并且设置一个起始地址给kvm mmu的root hpa，并且设置VCPU的CR3，这就是kvm mmu load需要做的事情。</p>


<blockquote>
<p>Guest begins to execute until it can’t proceed any further due to some faulty conditions. More often than not, control flow had to be returned to the hypervisor or the host OS kernel to handle the events the guest encountered. Obviously too much vmexit are an interference and grave source of overhead for the guest. With TDP, however, guest is free from vmexit upon guest paging faults. As the guest enters for the first time into execution, the paging mode is enabled and the guest page tables are initialized, however, the TDP tables are still empty. Any fresh access to a page by the guest will first trigger a guest page fault. After the fault is fixed by the guest, another page fault in the second dimension of the TDP is triggered due to the missing entry in TDP table.</p>
</blockquote>
<p>guest开始执行直到无法处理其他的条件。大部分情况下，当guest发出一些事件的时候流程处理会转交给hypervisor或者host kernel。显然大部分vmexit就是导致guest性能损耗的原因。通过TDP，guest就能够避免因为page fault导致的vmexit。因为guest一开始就进入了执行状态，paging模式被启用，并且guest的page tables也被初始化了，然而TDP的table还是空的。任意的对新页的访问都会导致guest page fault。放这个错误被处理之后，另外一个page fault在TDP模型里面就是TDP table里缺少条目。</p>
<blockquote>
<p>tdp page fault is the page fault handler in this case. As illustrated by Fig. 5, first the host page frame number - pfn is calculated for the faulting address through a chain of functions in try async pf. The pfn is then mapped one level after another into the corresponding positions of the TDP tables by the function direct map. In a predefined format, the entry for a faulting address is split into pieces of PML4E, PDPE, PDE, PTE as well as offset in a page. During the loop, iterator - an instance of the structure kvm shadow walk iterator is used to retrieve the latest physical, virtual addresses and position in the TDP tables for a given address, of which iterator.level determines the number of times for the mapping process.</p>
</blockquote>
<p>tdp page fault就是这个场景下的处理逻辑。和Fig5画的一样，首先host page frame number（pfn）会通过这个一系列async pf的函数给错误的地址计算一个pfn。这个pfn被加入到层级映射里面，来映射到一个具体的TDP表的位置。在预定义的情况下，这个给faulting address用的条目可以被分为PML4E，PDPE，PDE，PTE也就是page的offset。再循环里，一个kvm shadow walk迭代器的实力会被用来滴贵的访问最后一个物理、虚拟地址并且找到对应的地址在TDP table里的位置，这个迭代器里面的level也就是对应的进程多少级映射的信息。</p>


<blockquote>
<p>Although the conventional TDP shown in Fig. 6 is mature and the default configuration for better performance, for a certain kind of workloads the limitation is still obvious. They may suffer large overhead due to walking into the second dimension of multi-level page table upon heavy TLB-miss. It is ideal to have a “flat” TDP table by which the wanted pfn can be obtained with a single lookup. Unfortunately, there has long been a problem to allocate large chunk of physically continuous memory in the kernel space. Three functions, namely vmalloc(), kmalloc() and get free pages are used to allocate memory in the current Linux Kernel. The first allocates memory continuous only in virtual address, which is easier to perform but not desired dealing with performance. The second and the third allocate memory chunk continuous in both virtual and physical addresses, however, the maximum memory size allocated is quite limited, thus tends to fall short of the expectation for this purpose. In addition, kmalloc() is very likely to fail allocating large amount of memory, especially in low-memory situations [11]. The amount of memory get free pages can allocate is also limited within 2MAX ORDER−1, where MAX ORDER in the current Linux Kernel for x86 is 11, which means that each time at most 4MB memory can be obtained in the hypervisor. In this condition what we could do is to make the TDP table as “flat” as possible, and to reduce the number of paging with it. Here “flat” means large and physically continuous memory chunk for TDP table. Instead of having thousands of TDP tables managed by their own kvm mmu page instances, we want to merge as many TDP tables as possible into a larger table managed by fewer kvm mmu page instances.</p>
</blockquote>
<p>虽然通常的TDP使用表示在Fig6，是一个非常成熟的作为默认性能更好的设置，并且对于一些确切的负载上有的限制还是很明显的。比如有非常多TLB-miss的时候，需要做非常多的多级页表查询造成很大的性能损耗。如果存在一个flat的TDP table，保证pfn的查询只需要一次，那么就非常理想了。不幸的是，内核空间里面没有办法分配一个连续的长的物理内存来处理这个问题。三个方法，分别是vmalloc()，kmalloc()以及获取空闲page来在当前linux内核中分配内存。第一个方法仅在虚拟地址分配连续内存，这个方法简单，但是没办法达到满意的性能。第二个个第三个方法，会在虚拟和物理地址上都分配连续的地址，而最大的内存大小是很有限的，因此还是不能够达到预期。附带一提kmalloc是非常容易分配大量内存失败的，特别是内存少的场景。通过获取空闲page来分配内存也被限制在2<sup>MAX_ORDER-1</sup>,这个MAX_ORDER在当前的x86 kernel里面是11，也就是说最多4MB的内存可以被分配给hypervisor使用。在这个场景下，我们可以让这个TDP table尽量的大，来减少page的数量，这个flat表示给TDP table使用的很大并且物理连续的内存块。代替原本的由KVM mmu管理的上千个TDP table，我们希望尽可能的把这些TDP table合并起来，并使用更少的kvm mmu page实例来管理。</p>


<blockquote>
<p>There could be various ways to implement this, depending on how the indices of a page table entry are split. Two things are to be noticed for this: 1. to leave the indices for paging as long as possible, and 2. to reuse the current source code for KVM as much as we can. Consequently, we come up with a quite straightforward design by merging the bits for currently used indices within a guest page table entry. As Figs. 7 and 8 depict, the former PML4, PDP (higher 18 bits) could be combined as a single index to the root of a TDP table segment, and similarly PD and PT (lower 18 bits) as the index for a physical page. By filling the TDP table entries in a linear ascend order for the GPPFN, the HPPFN could be obtained conveniently by a single lookup into the table. As a result, for the currently used maximal address space of a the 64-bit(48 bits effectively in use) guest, we may have 218 = 256K segments for the TDP tables, with the index of each segment ranging from 0 to 218 − 1 to the host physical pages. The TDP table size is enlarged by 29 times, while the number of the table segments could be reduced to 1 29 of the former. This is actually a f</p>
</blockquote>
<p>有很多不同的方法可以实现这个，主要是看选择用什么方式来拆分page table entry。</p>
<p>两个值得注意的点：</p>
<ol>
<li>需要保证分页的索引尽可能的长</li>
<li>尽可能的复用当前的kvm代码</li>
</ol>
<p>因此我们选择了一个非常直接的设计，也就是把bits索引合并到一整个page table entry里。</p>
<p>如Fig7和Fig8战士的，之前的PML4，PDP（高18位）可以被结合成单个索引，作为TDP table segment的根。类似的PD和PT（低18位）可以作为物理页的索引。通过线性的递增GPPFN和HPPFN来填充TDP的页表，就能够简单的实现一个table的单词查询访问。结果上来说，通过使用最大的64位地址空间（有效位为48位）的guest，我们可以有大约2<sup>18</sup> = 256k 个段用于TDP tables。每个段的索引就是从0到2<sup>18</sup>-1对应到host的物理页。TDP表的大小被扩大了2<sup>9</sup>倍，而对应的table段的数量减少到了之前的 1/2<sup>9</sup></p>



<blockquote>
<p>This is actually a fundamental change to the current mmu implementation. Several data structures and functions oriented to the operations upon 4KB∗29 = 2MB TDP page table must be adopted to the type upon 4KB ∗ 218 = 1GB. For example, as depicted by Fig. 9, the data structure of kvm mmu page could be modified as following to reflect the change: 1. since in a “flat” table, there is only two levels and a single root table as parents, the parents-children relation is quite obvious. Besides, all the first level pages have a common parent but no children at all. Members such as unsync children, parent ptes and unsync child bitmap are not necessary; 2. members as gfn, role, unsync etc. are multiplied by 512 to hold the informations previously owned by an individual 4KB ∗ 2<sup>9</sup> = 2MB page table; 3. spt points to a table segment covering an area of 4KB ∗ 2<sup>18</sup> = 1GB; 4. link is moved to a newly introduced structure - page entity to identify the 4KB ∗ 2<sup>9</sup> = 2MB pages that are either in the active or zapped obselete list. By modifying it this way, the depth of the TDP table hierarchy could be reduced from 4 to 2, while the width expanded from 2<sup>9</sup> to 2<sup>18</sup>.</p>
</blockquote>
<p>这其实是一个对当前mmu实现的基础修改。不同的基于原本的4KB * 2<sup>9</sup> = 2MB的TDP page table的操作需要支持到现在的 4KB * 2<sup>18</sup> = 1GB。举个例子，比如图9所示，kvm_mmu_page的数据结构可以被修改为如下的映射：</p>
<ol>
<li>在一个“flat”表里，只有两个层级和一个单根的表作为parents，亲子关系非常的清晰。此外，第一级的页面有一个共同的parent，但是没有子级。比如没有sync的子节点，parent ptes以及没有同步的子bitmap是没有必要的</li>
<li>里面的参数比如gfn，角色，未同步等，会被分为512保存，而之前每一个4KB ∗ 2<sup>9</sup> = 2MB page table</li>
<li>spt指针指向一个table段并覆盖一个4KB * 2<sup>18</sup> = 1GB的部分</li>
<li>link会被连接到一个新的数据结构来区别是4KB ∗ 2<sup>9</sup> = 2MB page是active还是弃用状态。</li>
</ol>
<p>通过这些修改，TDP table结构的深度从4变味了2，并且宽度从2<sup>9</sup> 变成了 2<sup>18</sup> </p>


<blockquote>
<p>Since each kvm mmu page instance contains 2<sup>18</sup>  table entries now, there will be less kvm mmu page instances in use, which means that 2<sup>18</sup>  rather than 2<sup>9</sup>  sptes need to be mapped to a single kvm mmu page instance. This could be achieved by masking out the lower 30 bits of an address and setting the obtained page descriptor’s private field to this kvm mmu page instance, as shown in Fig. 10. Other major affected functions include 1. shadow walk init, 2. kvm mmu get page, 3. direct map, 4. kvm mmu prepare zap page, 5. kvm mmu commit zap page and 6. mmu alloc direct roots</p>
</blockquote>
<p>因为每个kvm mmu page的实例包含2<sup>18</sup> 个条目，因此只会有更少的kvm mmu page，也就意味着2<sup>18</sup> 而不是2<sup>9</sup>个sptes需要被映射到一个kvm mmu page实例。通过把低30位地址内容作为page表述的私有比阿亮就能够给解决这个问题了如fig10所示。另外一些主要的功能影响包括：</p>
<ol>
<li>shadow walk int</li>
<li>kvm mmu get page</li>
<li>direct map</li>
<li>kvm mmu prepare zap pages</li>
<li>kvm mmu commit zap page</li>
<li>mmu alloc direct roots</li>
</ol>


<blockquote>
<p>Taken a guest commonly with 4GB memory as an example. A page contains 4KB/8B = 512 entries, and for the 4GB, 4GB/4KB = 220 entries are needed, so 220/512 = 2048 pages of 4KB size should be used to save all the table entries. All together it makes a space of about 4KB ∗ 2048 = 8MB size. Although this may be far more than in the conventional TDP case, it is a modest demand and acceptable compared with a host machine configured with dozens of GB RAM.</p>
</blockquote>
<p>以常见的guest内存4GB为例，一个page包含4KB/8B也就是512个条目（也就是512条索引一个page），4GB的情况就有4GB/4KB=2<sup>20</sup>个条目（需要索引），</p>
<p>2<sup>20</sup> / 512 = 2048个4KB的page作为索引保存所有table条目。一共需要4KB * 2048 = 8MB大小。虽然这个比常见的TDP场景差的远，不过是一个最简单的可以接受的用来配置host和GB RAM的规则。</p>
<blockquote>
<p>On the other hand, with the 2MB TDP large pages, only 4 kvm mmu page instances are sufficient to cover the entire 4GB address space. Only 4 entries are filled in the root table, which poses no pressure at all to the TLB. For an arbitrary guest virtual address, at most 2 ∗ 5 + 4 = 14 (10 in hypervisor, 4 in guest) memory accesses are enough to get the host physical address - far less than that of the current translation scheme (20 in hypervisor, 4 in guest). With a flatter TDP page table and reduced number of memory access, the KVM guest is expected to be less sensitive to workloads and yield higher performance.</p>
</blockquote>
<p>另一方面，用2MB的TDP大page，只需要4个kvm mmu page实例来覆盖4GB的空间。只需要在root table里面加4个条目。实际上对TLB不会造成太大压力。对于个简单的guest内存来说 至少 4 * 5 + 4 = 14 （hypervisor10次，guest4次）的内存访问是足够获取host地址的，而不是目前的（hypervisor20次，guest4次）。使用更flatter的TDP page table并且减少内存访问，KVM guest有希望运行的对负载更不敏感同时性能更好。</p>
<blockquote>
<p>We studied the current implementation of the SPT and TDP for the KVM, and attempted to simplify the second dimension paging of the TDP based on a change of the table structure and the related functions in the hypervisor. With this change on software, the current TDP paging level could be reduced and the overall guest performance will be improved. We have implemented a part of this design and found that, the large TDP page table could be allocated without problem as long as the amount is less than 4MB. However, as it is a relative radical change to the traditional mainstream KVM source code, many functions within the mmu code are affected, an executable implementation as well as a benchmark result are unfortunately not yet available. In future we will keep on engaging with this task and work out a concrete solution based on this design.</p>
</blockquote>
<p>目前研究了SPT和TDP的kvm上的实现，并且计划简化TPD的second dimension paging的基于TDP的表结构修改以及相关的hypervisor功能呢。通过软件层面的这个修改，目前的TDP级别减少并且guest整体的性能会提升。我们实现了部分设计并且发现使用一个很大的TDP page table小于4MB的时候可以成功分配。然而有一个相关的改动就是原本的主干的KVM代码，很多mmu相关的code都被影响了，一个可执行的benchmark目前并不可用，未来希望继续做相关的具体实现和设计。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ol>
<li>Preiss, B.R., Eng, P.: Data Structures and Algorithms with Object-Oriented Design Patterns in Java. Wiley, Chichester (1999) </li>
<li>Hoang, G., Bae, C., Lange, J., Zhang, L., Dinda, P., Joseph, R.: A case for alternative nested paging models for virtualized systems. Comput. Archit. Lett. 9, 17–20, University of Michigan (2010)</li>
<li>Wang, X., Zang, J., Wang, Z., Luo, Y., Li, X.: Selective hardware/software memory virtualization, VEE 2011, Department of Computer Science and Technology, Beijing University, March 2011</li>
<li>Bae, C.S., Lange, J.R., Dinda, P.A.: Enhancing virtualized application performance through dynamic adaptive paging mode selection, Northwestern University and University of Pittsburgh, ICAC 2011, June 2011</li>
<li>Ahn, J., Jin, S., Huh, J.: Revisiting hardware-assisted page walks for virtualized systems. Computer Science Department, KAIST, ISCA 2012, April 2012</li>
<li>Gandhi, J., Basu, A., Hill, M.D., Swift, M.M.: Efficient memory virtualization. University of Wisconsin-Madison and AMD Research, October 2014</li>
<li>Adavanced Micro Devices Inc, AMD-V Nested Paging White Paper. Adavanced Micro Devices, July 2008</li>
<li>Bhargave, R., Serebin, B., Spadini, F., Manne, S.: Accelerating two-dimensional page walks for virtualized systems. Computing Solutions Group and Advanced Architecture &amp; Technology Lab, March 2008</li>
<li>Barr, T.W., Cox, A.L., Rixner, S.: Translation Caching: Skip, Don’t Walk (the Page Table), Rice University, June 2010</li>
<li>Linux kernel Documentation about MMU in KVM. <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/">https://www.kernel.org/doc/</a> Documentation/virtual/kvm/mmu.txt</li>
<li>Johnson, M.K.: Memory allocation. Linux Journal, issue 16, August 1995. http:// <a target="_blank" rel="noopener" href="http://www.linuxjournal.com/article/1133">www.linuxjournal.com/article/1133</a> </li>
<li>Rubini, A., Corbet, J.: Linux Device Drivers, 2nd edn, June 2014. <a target="_blank" rel="noopener" href="http://www.xml.com/ldd/chapter/book/ch13.html">http://www.xml.com/ldd/chapter/book/ch13.html</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/27/a-simplified-TDP-with-large-tables/" data-id="cld1mhecj0076yuwb1brrabt2" data-title="A Simplified TDP with Large Tables" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/27/a-simplified-TDP-with-large-tables/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/27/a-simplified-TDP-with-large-tables/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-some-thought-about-software-engineer-interview" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/23/some-thought-about-software-engineer-interview/" class="article-date">
  <time class="dt-published" datetime="2022-09-23T07:40:26.000Z" itemprop="datePublished">2022-09-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/management/">management</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/23/some-thought-about-software-engineer-interview/">Some thought about software engineer interview</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>I can’t stop thinking about how to interview a suitable software engineer for my team, because a graduate is fired only after joining my team for three months. There are some points to figure the reasons about the story:</p>
<ul>
<li>Low learning efficiency, can not figure out what is supposed to be known, for example, basic git usage to submit a patch, learn it over month.</li>
<li>Bad code kills, code is not good and can not comprehen the code even after your explaination and testing.</li>
<li>Bad manners, diss the colleague to explain why he didn’t do his work as expected.</li>
</ul>
<p>Notice: I’m not sure if those requests are only requested in my country, but actually his buddy and colleague cost a lot of energy to solve his own problems. </p>
<p>Fortunately, I am very sharp to colleague’s work so that guy didn’t disturb me very much. But after that I start thinking about is there any way to get a more suitable devloper to avoid this situation from happening again. (Maybe for undergraduate, our the interview is too easy)</p>
<h2 id="Details-about-current-interview"><a href="#Details-about-current-interview" class="headerlink" title="Details about current interview"></a>Details about current interview</h2><h3 id="Introduction-for-current-interview"><a href="#Introduction-for-current-interview" class="headerlink" title="Introduction for current interview"></a>Introduction for current interview</h3><p>Typically, every interviewee need to intend two or three around technical interview. </p>
<ol>
<li>interview for basic skills, like code skills or knowledges we required</li>
<li>interview for project engineering, explain technical view of experinenced project and know a big picture  of a project.</li>
<li>interview for code reading/writing and math problem capability (but not always used)</li>
</ol>
<p>But many teams only interview their own candidate, the skills maybe not well interviewed or not executed as expected, because we do not have any objective test to get the result of every interview. Only perspective point is used so when try to scale a team or required more developers the period is more longer than we expected.</p>
<h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><p>From last failure, some basic requirements need to be recorded.</p>
<ul>
<li>Learning skiils. Self-driving is essential for a developer</li>
<li>Code skills. Typlically not read code but comprehend the code</li>
<li>Good manners. May be a optional quality but it is important for teamwork</li>
</ul>
<p>Except those requrements more basic requirements is involved in current list:</p>
<ul>
<li>System knownledge, operation system usage, architecture and so on.</li>
<li>Code skills, code usage (including useful lib, programming language implementation)</li>
<li>Communication skills, throught interview not actually maybe pretended</li>
<li>Teamwork skills, for those who have work experience</li>
</ul>
<p>So more personal skills need to be involved in interview in my expectation. But in my opinion, it’s not a good thing for devloper as a interviewer need to judge interviewee’s those aspects directly.</p>
<p>Well formed questions need to be collected for all those aspects we required for a “suitable developer”.</p>
<h3 id="Research-before-planning"><a href="#Research-before-planning" class="headerlink" title="Research before planning"></a>Research before planning</h3><p>More research need to be done before we get some solutions.</p>
<p>When I search “how to interview software engineers”. I got this page:</p>
<p><a target="_blank" rel="noopener" href="https://arc.dev/employer-blog/software-engineer-interview-questions/">https://arc.dev/employer-blog/software-engineer-interview-questions/</a></p>
<p>There are some interesting questions:</p>
<ol>
<li>Discuss one of your previous projects and explain how you completed it successfully.</li>
<li>When you ran into an obstacle with your project, how did you handle the issue?</li>
<li>What are your thoughts on unit testing?</li>
<li>What is your process for finding a bug in an application?</li>
</ol>
<p>Combine with experience and actual works, the debug skills and project skills can be easily tested.</p>
<p>So those kind of open questions seems a good way for a interview.</p>
<p>Besides those questions, knowledge test should also be used for graduate, but this is quite easy.</p>
<h2 id="Plan"><a href="#Plan" class="headerlink" title="Plan"></a>Plan</h2><p>According to below discuss, we decide to make a plan to help us feel easy with interviews.</p>
<ul>
<li>Change seperated interview for the whole backend team. </li>
<li>Use prepared questions to interview in order to get objective result from different interviewers.</li>
<li>Add more tests for graduate</li>
<li>Logic analysis test should be involved in the interview questions</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/23/some-thought-about-software-engineer-interview/" data-id="cld1mheb5001hyuwbeiku3dbd" data-title="Some thought about software engineer interview" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/23/some-thought-about-software-engineer-interview/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/23/some-thought-about-software-engineer-interview/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/interview/" rel="tag">interview</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-build-internal-maven-repos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/22/build-internal-maven-repos/" class="article-date">
  <time class="dt-published" datetime="2022-09-22T05:58:26.000Z" itemprop="datePublished">2022-09-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/project-related-works/">project-related-works</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/22/build-internal-maven-repos/">Build internal maven repositories</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Build-internal-maven-repositories"><a href="#Build-internal-maven-repositories" class="headerlink" title="Build internal maven repositories"></a>Build internal maven repositories</h1><h2 id="Installation-of-management-tool"><a href="#Installation-of-management-tool" class="headerlink" title="Installation of management tool"></a>Installation of management tool</h2><p>Choose sonatype nexus repository manager to bulid internal maven repositories.</p>
<p>Download link: <a target="_blank" rel="noopener" href="https://help.sonatype.com/repomanager3/product-information/download">https://help.sonatype.com/repomanager3/product-information/download</a></p>
<p>Select a tar match your system and execute following commands:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.sonatype.com/nexus/3/nexus-3.41.1-01-unix.tar.gz</span><br><span class="line">tar zxvf nexus-3.41.1-01-unix.tar.gz</span><br><span class="line">cd nexus-3.41.1-01/bin/</span><br><span class="line">./nexus start</span><br></pre></td></tr></table></figure>

<p>Because use root to start nexus, check the log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /root/sonatype-work/nexus3/log/nexus.log</span><br></pre></td></tr></table></figure>

<p>application is started</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line">Started Sonatype Nexus OSS 3.41.1-01</span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>But we want this application run as service, so do more configuration for systemd, create a file <code>/etc/systemd/system/nexus.service</code> contains:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nexus service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">ExecStart=/root/nexus-3.41.1-01/bin/nexus start</span><br><span class="line">ExecStop=/root/nexus-3.41.1-01/bin/nexus stop</span><br><span class="line">User=root</span><br><span class="line">Restart=on-abort</span><br><span class="line">TimeoutSec=600</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>then enable and start nexus:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable nexus.service</span><br><span class="line">sudo systemctl start nexus.service</span><br></pre></td></tr></table></figure>

<p>after that management tool installation finished, let’s start to build internal maven repositories.</p>
<h2 id="Create-private-repository"><a href="#Create-private-repository" class="headerlink" title="Create private repository"></a>Create private repository</h2><p>First, access sonatype nexus by 8081 port and finish the wizard.</p>
<h3 id="Repository-types"><a href="#Repository-types" class="headerlink" title="Repository types"></a>Repository types</h3><p>According to nexus docs, there are several proxy types for nexus:</p>
<ul>
<li>Proxy repository: is a type linked to remote repository, which act as cache for the local request</li>
<li>Hosted repository: local stored and follow maven policy </li>
<li>Repository group: combine multi repositories as one</li>
</ul>
<p>So our usage, we choose maven2 hosted repository to publish our own jar. </p>
<p>Following configurations are used for this repository:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">format: maven2</span><br><span class="line">type: hosted</span><br><span class="line">layout policy: strict</span><br><span class="line">content disposition: inline</span><br><span class="line">blob store: default</span><br><span class="line">deployment policy: disable redeploy</span><br></pre></td></tr></table></figure>

<p>And try to upload first jar to our hosted repository</p>
<p>Access<code>http://your_nexus_address/#browse/upload:your_repo </code> this page to uplaod jar with group id and artifact id.</p>
<p>Then, change pom.xml to enable the repository:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://your_nexus_address/repository/your_repo/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>But if use maven3 need to update settings to allow http access. </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>zstack-premium-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://your_nexus_address/repository/your_repo/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Test mvn install the lib is download as expected.</p>
<h2 id="Deploy-project-to-the-repository"><a href="#Deploy-project-to-the-repository" class="headerlink" title="Deploy project to the repository"></a>Deploy project to the repository</h2><p>Add distribution management into your pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>your_repo_id<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>readable name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>your_repo_address<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>to set which repo address your deployment should go, then add server related setttings to your .m2/settting.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>your_repo_id<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">username</span>&gt;</span>your_username<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">password</span>&gt;</span>your_password<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Then use <code>mvn deploy</code> to finish upload.</p>
<p>There are some errors during the configuration phase.</p>
<ul>
<li><p>Error status code 401, means authentication failure,  use <code>mvn -X</code> to check</p>
<p>[DEBUG] Reading global settings from /opt/maven/conf/settings.xml<br>[DEBUG] Reading user settings from /root/.m2/settings.xml<br>two configuration files are used, change the global one with the sever section fix the issue.</p>
</li>
<li><p>Error status code 400, nexus repository should change the deployment policy to allow redeploy</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/22/build-internal-maven-repos/" data-id="cld1mhea20008yuwbd9ts255q" data-title="Build internal maven repositories" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/22/build-internal-maven-repos/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/22/build-internal-maven-repos/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-shared-timeout-impelments-under-multi-thread-context-model" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/" class="article-date">
  <time class="dt-published" datetime="2022-09-20T05:38:16.000Z" itemprop="datePublished">2022-09-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/arch-notes/">arch-notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/">Shared timeout implements under multi-thread context model</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>This blog shows timeout impelents under multi-thread Java application. Discuss its advantage and disadvantage, also tell difficulties we meet in practice.</p>
<h2 id="Why-shared-timeout"><a href="#Why-shared-timeout" class="headerlink" title="Why shared timeout"></a>Why shared timeout</h2><p>For a complex micro service system, message is a basic way used for communication between all modules. So timeout is come into used, for every API or message, to avoid unfinished tasks.</p>
<p>Let’s think if you what to do something without timeout, it may never finished with response. So timeout does the matter to help user and system get rid of those situations.</p>
<p>But when we talk about shared timeout, what is it and what it does. </p>
<p>For example, one API may sending several message to execute on different services and finally finished. During the process, if a timeout happen, API should return as timeouted as we expected. So the design of timeout mechanism should share a same period of timeout.</p>
<p>Assume API timeout is T and three messages tend to be used for API’s execution, and message<sub>1</sub> use time T<sub>1</sub>, message<sub>2</sub> use time T<sub>2</sub> and message<sub>3</sub> use time T<sub>3</sub> , in shared timeout situation, message<sub>1</sub>‘s timeout is T , message<sub>2</sub>‘s timeout is T - T<sub>1</sub>,  message<sub>3</sub>‘s timeout is T - T<sub>1</sub> - T<sub>2</sub>. The remaining timeout should be used for next message to confirm all sub messages could be timeouted as expected.</p>
<h2 id="Application-level-implements"><a href="#Application-level-implements" class="headerlink" title="Application level implements"></a>Application level implements</h2><p>For message level timeout, the easiest way to implement timeout management is on message bus. Every timeout the message received, check its timeout header and calculate its remaining timeout seems to make sense. </p>
<p>But if we record its timeout by decrease message used time. The machanism became more complex, because every messages time usage need to be recorded but for most product the message profiling is disable to avoid any performance overhead. </p>
<p>In order to solve this problem, we use message deadline as metadata for message lifecyle. Every new coming message should be set a deadline due to its configuration and every sub message calculate its remaining timeout by using the deadline time substract current time. So with a general service to get current time this timeout mechanism get more efficient.</p>
<h2 id="More-challenges"><a href="#More-challenges" class="headerlink" title="More challenges"></a>More challenges</h2><p>In multi-thread application. Lifecyle maintanence of message’s timeout is really matter. </p>
<p>Espacially, ZStack use in-process micro services architecture, messages pass through memory or http, for API message, the timeout always works well, but for internal messages more problems came out.</p>
<p>For example, a async invoker util functios may send several messages but they shares the same thread before handling, so the thread’s context will be used as message’s initial context where the timeout stored.</p>
<p>When thread context changed we can clear the context by thread pool’s thread lifecyle hook.</p>
<p>But some user case the timeout do not work as expected.</p>
<ul>
<li>GC task (in memory task triggered by a fixed time rate or any system event)</li>
<li>Thread level task (async and sync task queue)</li>
</ul>
<h3 id="GC-task"><a href="#GC-task" class="headerlink" title="GC task"></a>GC task</h3><p>GC task is used to handling some unexpected async operation or retry to delete some resource and so on. </p>
<p>If a thread submit the task executes the task itself, the context will be used directly, and actually the context mess up the GC task’s execution. So always use a new thread to start GC job is a good choice.</p>
<p>For multi-thread application, message dilevery and handling involves different threads, especially some task driver might be used to construct work flow and task execution. So the timeout context need be passed from one thread to another.</p>
<p>Assume Thread1 do task1 and finished with submit a new task2, maybe sometimes after Thread2 start to handle task2 but at this time task2 is required to contain timeout. Or the timeout cannot be passed.</p>
<h3 id="Fixed-thread-task"><a href="#Fixed-thread-task" class="headerlink" title="Fixed thread task"></a>Fixed thread task</h3><p>Same thread handling all tasks, so task should store its context when submitted to task queue.</p>
<p>Execution need to recover task context before execution.</p>
<h3 id="Benefits-of-the-concepts"><a href="#Benefits-of-the-concepts" class="headerlink" title="Benefits of the concepts"></a>Benefits of the concepts</h3><p>For a in-process arch, use a global level timeout during api or inner task lifecycle and the whole timeout can be managed.</p>
<h2 id="Easy-implements"><a href="#Easy-implements" class="headerlink" title="Easy implements"></a>Easy implements</h2><p>In java program, use aop to maintain the timeout get/set seems a good choice.</p>
<p>A typical ZStack task workflow, usually use api at the first step. A new coming api message, ZStack will set timeout to it, but in order to know parent messages timeout, we need to manage the timeout information to the message.</p>
<p>So a design named TaskContext is created to contains the global variables during whole task lifecycle. Use aop, all async tasks will use its parent TaskContext and clear it before start. With TaskContext, the timeout can be managed.</p>
<p>But some user scenarios still need to be discussed, list it before details:</p>
<ul>
<li>Inner message is used as the start of a task, it should support timeout.</li>
<li>API use a inner message configured with timeout which should be supported.</li>
<li>How did new coming mechanism aware of the timeout from task context</li>
<li>How to avoid task context be messed</li>
</ul>
<h3 id="Inner-message"><a href="#Inner-message" class="headerlink" title="Inner message"></a>Inner message</h3><p>Inner message level timeout configuration need to be supported as some tasks is executed by GC task which we mentioned, may send inner message directly, so timeout maybe requested for those tasks</p>
<h3 id="Duplicate-configuration"><a href="#Duplicate-configuration" class="headerlink" title="Duplicate configuration"></a>Duplicate configuration</h3><p>For api messages, it may use a workflow contains several inner messsages when those messages all have timeout configuration, we need to use the origin timeout but do not use new configured one.</p>
<h3 id="Aware-of-timeout"><a href="#Aware-of-timeout" class="headerlink" title="Aware of timeout"></a>Aware of timeout</h3><p>It not practical, becamse task context is a in-memory variable and marked by thread-id, so everytime the thread switched the task context need to be copied to the new thread. If any mechanism do not support task context copy, it will result in timeout loss, if any inner message used, a new timeout will be set from timeout manager. And it seems no good solution to make the new mechanism aware of this. That’s the shortage of using aop.</p>
<h3 id="Do-not-touch-task-context"><a href="#Do-not-touch-task-context" class="headerlink" title="Do not touch task context"></a>Do not touch task context</h3><p>Only timeout manager should use task context for timeout handling and other task context usage including     manually clear it or set value should be avoid.</p>
<p>But for some reason the access of TaskContext supposed to be available to core module for timeout or other context usage (for example, task id), so only keep it cleared after thread context switch and only assign value to framework known fields to avoid any mess up operations from other developer.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Actually task context is more likely a global variable for every thread to use. Keep it from abuse and oom is the first task and aop in involved to resolve this problem. So how to trace task context seems the next valuable target of this version of code.</p>
<h2 id="Check-the-code"><a href="#Check-the-code" class="headerlink" title="Check the code"></a>Check the code</h2><p><a target="_blank" rel="noopener" href="https://github.com/zstackio/zstack">https://github.com/zstackio/zstack</a> check the code if you are interested in this feature.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/" data-id="cld1mheax0017yuwbfudbeuxv" data-title="Shared timeout implements under multi-thread context model" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-guest-free-page-hinting-notes-01" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/04/guest-free-page-hinting-notes-01/" class="article-date">
  <time class="dt-published" datetime="2022-09-04T13:41:09.000Z" itemprop="datePublished">2022-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/04/guest-free-page-hinting-notes-01/">Guest Free Page Hinting notes 01</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>基于virtio1.2的推送，在virtio-balloon设备下有一条新特性：free page hints</p>
<p>因为不太了解这个东西具体做了啥，查了一番资料</p>
<h2 id="KVM-Guest-Free-Page-Hinting"><a href="#KVM-Guest-Free-Page-Hinting" class="headerlink" title="KVM: Guest Free Page Hinting"></a>KVM: Guest Free Page Hinting</h2><p>在2019年2月有这样一封邮件记录 <a target="_blank" rel="noopener" href="https://lwn.net/Articles/778432/">https://lwn.net/Articles/778432/</a></p>
<blockquote>
<p>The following patch-set proposes an efficient mechanism for handing freed memory between the guest and the host. It enables the guests with no page cache to rapidly free and reclaims memory to and from the host respectively.</p>
</blockquote>
<p>看起来主要目的是为了优化guest和host之间的空闲内存管理，避免出现需要快速释放或者回收page cache内存</p>
<p>同时里面提到了</p>
<p> Known code re-work:</p>
<ul>
<li>Plan to re-use Wei’s work, which communicates the poison value to the host.</li>
<li>The nomenclatures used in virtio-balloon needs to be changed so that the code can easily be distinguished from Wei’s Free Page Hint code.</li>
<li>Sorting based on zonenum, to avoid repetitive zone locks for the same zone.</li>
</ul>
<p>需要对virtio-balloon做一些修改来来保证代码能够和这部分Free Page Hint的代码保持区别。</p>
<p>这么说感觉好像是Hint的代码和virtio-balloon是两套</p>
<h2 id="Virtio-balloon-support-free-page-reporting"><a href="#Virtio-balloon-support-free-page-reporting" class="headerlink" title="Virtio-balloon: support free page reporting"></a>Virtio-balloon: support free page reporting</h2><p>基于上面查到的资料，又发现了另外一篇直接提到Virtio-balloon的改动 <a target="_blank" rel="noopener" href="https://lwn.net/Articles/759413/">https://lwn.net/Articles/759413/</a></p>
<p>里面新增的 VIRTIO_BALLOON_F_FREE_PAGE_HINT 是可以和 <a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.pdf">https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.pdf</a> virtio1.2的spec对应上的</p>
<p>摘抄一下里面的描述</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Live migration needs to transfer the VM&#39;s memory from the source machine</span><br><span class="line">to the destination round by round. For the 1st round, all the VM&#39;s memory</span><br><span class="line">is transferred. From the 2nd round, only the pieces of memory that were</span><br><span class="line">written by the guest (after the 1st round) are transferred. One method</span><br><span class="line">that is popularly used by the hypervisor to track which part of memory is</span><br><span class="line">written is to write-protect all the guest memory.</span><br><span class="line"></span><br><span class="line">This feature enables the optimization by skipping the transfer of guest</span><br><span class="line">free pages during VM live migration. It is not concerned that the memory</span><br><span class="line">pages are used after they are given to the hypervisor as a hint of the</span><br><span class="line">free pages, because they will be tracked by the hypervisor and transferred</span><br><span class="line">in the subsequent round if they are used and written.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>针对热迁移场景，会不停的copy memory。第一轮会复制所有内存，后续只需要复制guest写过的内存。</p>
<p>因此hypervisor需要记录guest写过哪些内存，然后全都复制一遍。</p>
<p>而这个功能是用来优化guest free page transfer的。即忽略这些已经被标记为free page的内容，如果后续这些page被使用了或者被写了，下一轮内存拷贝才考虑这些page。</p>
<p>通过这段描述，可以知道这个优化需要提供一个机制，来提供free page hint，并以此为基础来优化live migration。</p>
<h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2><p>在准备看代码之前，发现了一段很有意思的内容</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- mm&#x2F;get_from_free_page_list: The new implementation to get free page</span><br><span class="line">  hints based on the suggestions from Linus:</span><br><span class="line">  https:&#x2F;&#x2F;lkml.org&#x2F;lkml&#x2F;2018&#x2F;6&#x2F;11&#x2F;764</span><br><span class="line">  This avoids the complex call chain, and looks more prudent.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对获取 <code>get_from_free_page_list</code> 操作，linus回了很长的一段建议</p>
<p>里面很有意思的是，是不是要加一个新的 GFP_NONE，来标记分配失败？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Maybe it will help to have GFP_NONE which will make any allocation</span><br><span class="line">fail if attempted. Linus, would this address your comment?</span><br></pre></td></tr></table></figure>

<p>而linus的回复是，如果不用这么复杂的会引起内存分配的调用，用一个简单的机制来避免这个问题发生感觉更好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">So instead of having virtio_balloon_send_free_pages() call a really</span><br><span class="line">generic complex chain of functions that in _some_ cases can do memory</span><br><span class="line">allocation, why isn&#39;t there a short-circuited &quot;vitruque_add_datum()&quot;</span><br><span class="line">that is guaranteed to never do anything like that?</span><br></pre></td></tr></table></figure>

<p>中间还有很长的一些简化代码的建议，里面有这么一句话，评价这部分代码太复杂并且太脆弱了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The whole sequence of events really looks &quot;this is too much</span><br><span class="line">complexity, and way too fragile&quot; to me at so many levels.</span><br></pre></td></tr></table></figure>

<p>让我联想到目前ZStack里面一些功能的实现逻辑存在情况</p>
<ol>
<li>实现了机制B解决机制A的问题</li>
<li>复用了，不熟悉的机制A，忽略了A本身存在的问题</li>
</ol>
<p>结合一个实际功能说一下这个问题，比如vm的kernel panic检测，有两个必要选项</p>
<ol>
<li>给vm增加一个pvpanic的xml配置</li>
<li>虚拟机内部需要启用内核pvpanic模块</li>
</ol>
<p>因此这个功能实现需要guest和host相互配合才能判定是否可用</p>
<p>基于这个前提，guest内部的逻辑需要提供传递guest内部是否支持pvpanic的信息，host上需要从配置中获取是否配置过pvpanic，因此实现这个逻辑的时候需要分别查询这两个信息。而查询host上的配置最终导致了一些控制面的bug。</p>
<p>后来反思这个问题的时候，只从host配置获取的逻辑出发，但是忽略了运行时配置不会变更的前提，其实并没有必要增加一个多余的查询逻辑，反而导致这个问题依赖了已有的配置查询机制，最终引起了更复杂的现象。</p>
<p>kernel的开源世界也会有人碰到这样的问题，所以整理好功能设计的方法论还是很重要的，至少能够指导怎么做能设计的更好，提升committer和coder的水平。</p>
<p>反过来想想：</p>
<ol>
<li>guest tool在运行时返回的云主机所支持的特性，实际上总是和他的版本绑定的，只要获取过一次其实就不需要反复获取了。</li>
<li>如果guest tool版本发生了变化，才需要重新获取这个信息</li>
<li>提供主动更新guest tool特性的功能即可</li>
</ol>
<p>其实这样拆解这个问题，云主机其实本身就应该保存这些特性信息而不需要总是去获取，这样机制的设计可以简化很多。</p>
<p>而之前的设计出发点并不是基于对整个功能的理解，而是类似新增 <code>GFP_NONE</code> 来解决问题的思路。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/04/guest-free-page-hinting-notes-01/" data-id="cld1mhea8000cyuwbca2qgz2p" data-title="Guest Free Page Hinting notes 01" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/04/guest-free-page-hinting-notes-01/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/04/guest-free-page-hinting-notes-01/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-java-class-getname-and-getsimplename-get-me-confuse" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" class="article-date">
  <time class="dt-published" datetime="2022-09-04T13:37:27.000Z" itemprop="datePublished">2022-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/">Java Class getName() vs getSimpleName()</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Work with Java reflection and invoke getSimpleName() met <code>java.lang.NoClassDefFoundError</code></p>
<p>Use getName() instead, the logic seems work well.</p>
<p>Before compare these two methods’ difference go through the code quickly.</p>
<h2 id="Class-getName"><a href="#Class-getName" class="headerlink" title="Class::getName()"></a>Class::getName()</h2><p>for getName()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public String getName() &#123;</span><br><span class="line">    String name &#x3D; this.name;</span><br><span class="line">    if (name &#x3D;&#x3D; null)</span><br><span class="line">        this.name &#x3D; name &#x3D; getName0();</span><br><span class="line">    return name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and the getName0() is native method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native String getName0();</span><br></pre></td></tr></table></figure>



<h2 id="Class-getSimpleName"><a href="#Class-getSimpleName" class="headerlink" title="Class::getSimpleName()"></a>Class::getSimpleName()</h2><p>for getSimpleName()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public String getSimpleName() &#123;</span><br><span class="line">    if (isArray())</span><br><span class="line">        return getComponentType().getSimpleName()+&quot;[]&quot;;</span><br><span class="line"></span><br><span class="line">    String simpleName &#x3D; getSimpleBinaryName();</span><br><span class="line">    if (simpleName &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; top level class</span><br><span class="line">        simpleName &#x3D; getName();</span><br><span class="line">        return simpleName.substring(simpleName.lastIndexOf(&quot;.&quot;)+1); &#x2F;&#x2F; strip the package name</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; According to JLS3 &quot;Binary Compatibility&quot; (13.1) the binary</span><br><span class="line">    &#x2F;&#x2F; name of non-package classes (not top level) is the binary</span><br><span class="line">    &#x2F;&#x2F; name of the immediately enclosing class followed by a &#39;$&#39; followed by:</span><br><span class="line">    &#x2F;&#x2F; (for nested and inner classes): the simple name.</span><br><span class="line">    &#x2F;&#x2F; (for local classes): 1 or more digits followed by the simple name.</span><br><span class="line">    &#x2F;&#x2F; (for anonymous classes): 1 or more digits.</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Since getSimpleBinaryName() will strip the binary name of</span><br><span class="line">    &#x2F;&#x2F; the immediatly enclosing class, we are now looking at a</span><br><span class="line">    &#x2F;&#x2F; string that matches the regular expression &quot;\$[0-9]*&quot;</span><br><span class="line">    &#x2F;&#x2F; followed by a simple name (considering the simple of an</span><br><span class="line">    &#x2F;&#x2F; anonymous class to be the empty string).</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Remove leading &quot;\$[0-9]*&quot; from the name</span><br><span class="line">    int length &#x3D; simpleName.length();</span><br><span class="line">    if (length &lt; 1 || simpleName.charAt(0) !&#x3D; &#39;$&#39;)</span><br><span class="line">        throw new InternalError(&quot;Malformed class name&quot;);</span><br><span class="line">    int index &#x3D; 1;</span><br><span class="line">    while (index &lt; length &amp;&amp; isAsciiDigit(simpleName.charAt(index)))</span><br><span class="line">        index++;</span><br><span class="line">    &#x2F;&#x2F; Eventually, this is the empty string iff this is an anonymous class</span><br><span class="line">    return simpleName.substring(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The main part is </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String simpleName &#x3D; getSimpleBinaryName();</span><br></pre></td></tr></table></figure>

<p>And then get enclosingClass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private String getSimpleBinaryName() &#123;</span><br><span class="line">    Class&lt;?&gt; enclosingClass &#x3D; getEnclosingClass();</span><br><span class="line">    if (enclosingClass &#x3D;&#x3D; null) &#x2F;&#x2F; top level class</span><br><span class="line">        return null;</span><br><span class="line">    &#x2F;&#x2F; Otherwise, strip the enclosing class&#39; name</span><br><span class="line">    try &#123;</span><br><span class="line">        return getName().substring(enclosingClass.getName().length());</span><br><span class="line">    &#125; catch (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">        throw new InternalError(&quot;Malformed class name&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>what is enclosingClass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; There are five kinds of classes (or interfaces):</span><br><span class="line">&#x2F;&#x2F; a) Top level classes</span><br><span class="line">&#x2F;&#x2F; b) Nested classes (static member classes)</span><br><span class="line">&#x2F;&#x2F; c) Inner classes (non-static member classes)</span><br><span class="line">&#x2F;&#x2F; d) Local classes (named classes declared within a method)</span><br><span class="line">&#x2F;&#x2F; e) Anonymous classes</span><br></pre></td></tr></table></figure>

<p>in my case it tend to be a) Top level classes, so next part of code goes to getDeclaringClass()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; JVM Spec 4.8.6: A class must have an EnclosingMethod</span><br><span class="line">&#x2F;&#x2F; attribute if and only if it is a local class or an</span><br><span class="line">&#x2F;&#x2F; anonymous class.</span><br><span class="line">EnclosingMethodInfo enclosingInfo &#x3D; getEnclosingMethodInfo();</span><br><span class="line">Class&lt;?&gt; enclosingCandidate;</span><br><span class="line"></span><br><span class="line">if (enclosingInfo &#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; This is a top level or a nested class or an inner class (a, b, or c)</span><br><span class="line">    enclosingCandidate &#x3D; getDeclaringClass();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Class&lt;?&gt; enclosingClass &#x3D; enclosingInfo.getEnclosingClass();</span><br><span class="line">    &#x2F;&#x2F; This is a local class or an anonymous class (d or e)</span><br><span class="line">    if (enclosingClass &#x3D;&#x3D; this || enclosingClass &#x3D;&#x3D; null)</span><br><span class="line">        throw new InternalError(&quot;Malformed enclosing method information&quot;);</span><br><span class="line">    else</span><br><span class="line">        enclosingCandidate &#x3D; enclosingClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>and then getDeclaringClass0() will be used.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@CallerSensitive</span><br><span class="line">public Class&lt;?&gt; getDeclaringClass() throws SecurityException &#123;</span><br><span class="line">    final Class&lt;?&gt; candidate &#x3D; getDeclaringClass0();</span><br><span class="line"></span><br><span class="line">    if (candidate !&#x3D; null)</span><br><span class="line">        candidate.checkPackageAccess(</span><br><span class="line">                ClassLoader.getClassLoader(Reflection.getCallerClass()), true);</span><br><span class="line">    return candidate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>which is a native method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native Class&lt;?&gt; getDeclaringClass0();</span><br></pre></td></tr></table></figure>



<h2 id="Comparision"><a href="#Comparision" class="headerlink" title="Comparision"></a>Comparision</h2><p>From the code before this section, aboveously the getSimpleName() always call native method but getName() may use Class’s local variable directly. </p>
<p>So see the local variable before we come to conclusion.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; cache the name to reduce the number of calls into the VM</span><br><span class="line">private transient String name;</span><br></pre></td></tr></table></figure>

<p>the name used by getName() use a transient String as cache to reduce the number of calls into VM.</p>
<p>And combine to getName()’s implement, the first time getName0() invoked, this name is set.</p>
<p>And go for Java doc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String getSimpleName()</span><br></pre></td></tr></table></figure>

<p>Returns the simple name of the underlying class as given in the source code. Returns an empty string if the underlying class is anonymous.</p>
<p>The simple name of an array is the simple name of the component type with “[]” appended. In particular the simple name of an array whose component type is anonymous is “[]”.</p>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the simple name of the underlying class</p>
</li>
<li><p><strong>Since:</strong></p>
<p>1.5</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String getName()</span><br></pre></td></tr></table></figure>

<p>Returns the name of the entity (class, interface, array class, primitive type, or void) represented by this <code>Class</code> object, as a <code>String</code>.</p>
<p>If this class object represents a reference type that is not an array type then the binary name of the class is returned, as specified by The Java™ Language Specification.</p>
<p>If this class object represents a primitive type or void, then the name returned is a <code>String</code> equal to the Java language keyword corresponding to the primitive type or void.</p>
<p>If this class object represents a class of arrays, then the internal form of the name consists of the name of the element type preceded by one or more ‘<code>[</code>‘ characters representing the depth of the array nesting. The encoding of element type names is as follows:</p>
<blockquote>
<table>
<thead>
<tr>
<th>Element Type</th>
<th></th>
<th>Encoding</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td></td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td></td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td></td>
<td>C</td>
</tr>
<tr>
<td>class or interface</td>
<td></td>
<td>L<em>classname</em>;</td>
</tr>
<tr>
<td>double</td>
<td></td>
<td>D</td>
</tr>
<tr>
<td>float</td>
<td></td>
<td>F</td>
</tr>
<tr>
<td>int</td>
<td></td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td></td>
<td>J</td>
</tr>
<tr>
<td>short</td>
<td></td>
<td>S</td>
</tr>
</tbody></table>
</blockquote>
<p>The class or interface name <em>classname</em> is the binary name of the class specified above.</p>
<p>Examples:</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String.class.getName()</span><br><span class="line">  returns &quot;java.lang.String&quot;</span><br><span class="line">byte.class.getName()</span><br><span class="line">  returns &quot;byte&quot;</span><br><span class="line">(new Object[3]).getClass().getName()</span><br><span class="line">  returns &quot;[Ljava.lang.Object;&quot;</span><br><span class="line">(new int[3][4][5][6][7][8][9]).getClass().getName()</span><br><span class="line">  returns &quot;[[[[[[[I&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the name of the class or interface represented by this object.</p>
</li>
</ul>
<p>and more details for the error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class NoClassDefFoundError</span><br><span class="line">extends LinkageError</span><br></pre></td></tr></table></figure>

<p>Thrown if the Java Virtual Machine or a <code>ClassLoader</code> instance tries to load in the definition of a class (as part of a normal method call or as part of creating a new instance using the <code>new</code> expression) and no definition of the class could be found.</p>
<p>The searched-for class definition existed when the currently executing class was compiled, but the definition can no longer be found.</p>
<p>So that means class found at compile time but not available at runtime <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17973970/how-to-solve-java-lang-noclassdeffounderror">Refer this link</a></p>
<p>Check for our configuration: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;xxx&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xxx&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.1&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;scope&gt;system&lt;&#x2F;scope&gt;</span><br><span class="line">    &lt;systemPath&gt;$&#123;project.basedir&#125;&#x2F;ext-libs&#x2F;xxx&lt;&#x2F;systemPath&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>use a system scope.</p>
<p>According to maven doc:</p>
<p>There are 6 scopes:</p>
<ul>
<li><strong>compile</strong><br>This is the default scope, used if none is specified. Compile dependencies are available in all classpaths of a project. Furthermore, those dependencies are propagated to dependent projects.</li>
<li><strong>provided</strong><br>This is much like <code>compile</code>, but indicates you expect the JDK or a container to provide the dependency at runtime. For example, when building a web application for the Java Enterprise Edition, you would set the dependency on the Servlet API and related Java EE APIs to scope <code>provided</code> because the web container provides those classes. A dependency with this scope is added to the classpath used for compilation and test, but not the runtime classpath. It is not transitive.</li>
<li><strong>runtime</strong><br>This scope indicates that the dependency is not required for compilation, but is for execution. Maven includes a dependency with this scope in the runtime and test classpaths, but not the compile classpath.</li>
<li><strong>test</strong><br>This scope indicates that the dependency is not required for normal use of the application, and is only available for the test compilation and execution phases. This scope is not transitive. Typically this scope is used for test libraries such as JUnit and Mockito. It is also used for non-test libraries such as Apache Commons IO if those libraries are used in unit tests (src/test/java) but not in the model code (src/main/java).</li>
<li><strong>system</strong><br>This scope is similar to <code>provided</code> except that you have to provide the JAR which contains it explicitly. The artifact is always available and is not looked up in a repository.</li>
<li><strong>import</strong><br>This scope is only supported on a dependency of type <code>pom</code> in the <code>&lt;dependencyManagement&gt;</code> section. It indicates the dependency is to be replaced with the effective list of dependencies in the specified POM’s <code>&lt;dependencyManagement&gt;</code> section. Since they are replaced, dependencies with a scope of <code>import</code> do not actually participate in limiting the transitivity of a dependency.</li>
</ul>
<p>system most like provided but <code>a dependency with this scope is added to the classpath used for compilation and test, but not the runtime classpath</code></p>
<p>so runtime getSimpleName() will met exception.</p>
<h2 id="Class-loader"><a href="#Class-loader" class="headerlink" title="Class loader"></a>Class loader</h2><p>get back to the error call trace again:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.NoClassDefFoundError: xxxxx</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.Class.getDeclaringClass0(Native Method) ~[?:1.8.0_161]</span><br></pre></td></tr></table></figure>

<p>and another class not found exception:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.ClassNotFoundException: xxxxx</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:381) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.Class.getDeclaringClass0(Native Method) ~[?:1.8.0_161]</span><br></pre></td></tr></table></figure>

<p>when try to get simple name of class A extends B</p>
<p>find A and try to define A but need to define B first, but B is not available at runtime so a exception raised.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" data-id="cld1mheac000jyuwb7lxm4rbw" data-title="Java Class getName() vs getSimpleName()" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Dive-into-edk2-ovmf-fisrt-debug-trip" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" class="article-date">
  <time class="dt-published" datetime="2022-07-27T12:02:47.000Z" itemprop="datePublished">2022-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/">Dive into edk2-ovmf fisrt debug trip</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Prepare-environment"><a href="#Prepare-environment" class="headerlink" title="Prepare environment"></a>Prepare environment</h2><p>install compiler related rpm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo=* --enablerepo=ali* install -y make gcc binutils iasl nasm libuuid-devel gcc-c++</span><br></pre></td></tr></table></figure>

<p>if cross-build firmware on x86 machine, install cross compilers:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo=* --enablerepo=ali* install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnu</span><br></pre></td></tr></table></figure>

<p>get source code</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tianocore/edk2.git</span><br><span class="line">cd edk2</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure>

<p>than setup environment variables:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source edksetup.sh</span><br></pre></td></tr></table></figure>

<p>build base tools at first:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C BaseTools</span><br></pre></td></tr></table></figure>

<p>note: only need once</p>
<h2 id="Build-firmware"><a href="#Build-firmware" class="headerlink" title="Build firmware"></a>Build firmware</h2><p>Then build firmware for x64 qemu:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a X64 -p OvmfPkg/OvmfPkgX64.dsc</span><br></pre></td></tr></table></figure>

<p>The firmware volumes built can be found in <code>Build/OvmfX64/DEBUG_GCC5/FV</code>.</p>
<p>Building the aarch64 firmware instead:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a AARCH64 -p ArmVirtPkg/ArmVirtQemu.dsc</span><br></pre></td></tr></table></figure>

<p>The build results land in <code>Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV</code>.</p>
<p>Qemu expects the aarch64 firmware images being 64M im size. The firmware images can’t be used as-is because of that, some padding is needed to create an image which can be used for pflash:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dd of=&quot;QEMU_EFI-pflash.raw&quot; if=&quot;/dev/zero&quot; bs=1M count=64</span><br><span class="line">dd of=&quot;QEMU_EFI-pflash.raw&quot; if=&quot;QEMU_EFI.fd&quot; conv=notrunc</span><br><span class="line">dd of=&quot;QEMU_VARS-pflash.raw&quot; if=&quot;/dev/zero&quot; bs=1M count=64</span><br><span class="line">dd of=&quot;QEMU_VARS-pflash.raw&quot; if=&quot;QEMU_VARS.fd&quot; conv=notrunc</span><br></pre></td></tr></table></figure>

<p>There are a bunch of compile time options, typically enabled using <code>-D NAME</code> or <code>-D NAME=TRUE</code>. Options which are enabled by default can be turned off using <code>-D NAME=FALSE</code>. Available options are defined in the <code>*.dsc</code> files referenced by the <code>build</code> command. So a feature-complete build looks more like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a X64 -p OvmfPkg/OvmfPkgX64.dsc \</span><br><span class="line">    -D FD_SIZE_4MB \</span><br><span class="line">    -D NETWORK_IP6_ENABLE \</span><br><span class="line">    -D NETWORK_HTTP_BOOT_ENABLE \</span><br><span class="line">    -D NETWORK_TLS_ENABLE \</span><br><span class="line">    -D TPM2_ENABLE</span><br></pre></td></tr></table></figure>

<p>From <code>OvmfPkgX64.dsc</code> lots of features is defined.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  #</span><br><span class="line">  # Network definition</span><br><span class="line">  #</span><br><span class="line">  DEFINE NETWORK_TLS_ENABLE             &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_IP6_ENABLE             &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_HTTP_BOOT_ENABLE       &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_ALLOW_HTTP_CONNECTIONS &#x3D; TRUE</span><br><span class="line">  DEFINE NETWORK_ISCSI_ENABLE           &#x3D; TRUE</span><br><span class="line"></span><br><span class="line">!include NetworkPkg&#x2F;NetworkDefines.dsc.inc</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  # Device drivers</span><br><span class="line">  #</span><br><span class="line">  DEFINE PVSCSI_ENABLE           &#x3D; TRUE</span><br><span class="line">  DEFINE MPT_SCSI_ENABLE         &#x3D; TRUE</span><br><span class="line">  DEFINE LSI_SCSI_ENABLE         &#x3D; FALSE</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  # Flash size selection. Setting FD_SIZE_IN_KB on the command line directly to</span><br><span class="line">  # one of the supported values, in place of any of the convenience macros, is</span><br><span class="line">  # permitted.</span><br><span class="line">  #</span><br><span class="line">!ifdef $(FD_SIZE_1MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 1024</span><br><span class="line">!else</span><br><span class="line">!ifdef $(FD_SIZE_2MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 2048</span><br><span class="line">!else</span><br><span class="line">!ifdef $(FD_SIZE_4MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 4096</span><br><span class="line">!else</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 4096</span><br></pre></td></tr></table></figure>

<p>Secure boot support (on x64) requires SMM mode. Well, it builds and works without SMM, but it’s not secure then. Without SMM nothing prevents the guest OS writing directly to flash, bypassing the firmware, so protected UEFI variables are not actually protected.</p>
<p>Also suspend (S3) support works with enabled SMM only in case parts of the firmware (PEI specifically, see below for details) run in 32bit mode. So the secure boot variant must be compiled this way:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a IA32 -a X64 -p OvmfPkg/OvmfPkgIa32X64.dsc \</span><br><span class="line">    -D FD_SIZE_4MB \</span><br><span class="line">    -D SECURE_BOOT_ENABLE \</span><br><span class="line">    -D SMM_REQUIRE \</span><br><span class="line">    [ ... add network + tpm + other options as needed ... ]</span><br></pre></td></tr></table></figure>

<p>The <code>FD_SIZE_4MB</code> option creates a larger firmware image, being 4MB instead of 2MB (default) in size, offering more space for both code and vars. The RHEL/CentOS builds use that. The Fedora builds are 2MB in size, for historical reasons.</p>
<p>If you need 32-bit firmware builds for some reason, here is how to do it:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a ARM -p ArmVirtPkg/ArmVirtQemu.dsc</span><br><span class="line">build -t GCC5 -a IA32 -p OvmfPkg/OvmfPkgIa32.dsc</span><br></pre></td></tr></table></figure>

<p>The build results will be in in <code>Build/ArmVirtQemu-ARM/DEBUG_GCC5/FV</code> and <code>Build/OvmfIa32/DEBUG_GCC5/FV</code></p>
<h3 id="Booting-fresh-firmware-builds"><a href="#Booting-fresh-firmware-builds" class="headerlink" title="Booting fresh firmware builds"></a>Booting fresh firmware builds</h3><p>The x86 firmware builds create three different images:</p>
<ul>
<li><p><code>OVMF_VARS.fd</code></p>
<p>This is the firmware volume for persistent UEFI variables, i.e. where the firmware stores all configuration (boot entries and boot order, secure boot keys, …). Typically this is used as template for an empty variable store and each VM gets its own private copy, libvirt for example stores them in <code>/var/lib/libvirt/qemu/nvram</code>.</p>
</li>
<li><p><code>OVMF_CODE.fd</code></p>
<p>This is the firmware volume with the code. Separating this from VARS does (a) allow for easy firmware updates, and (b) allows to map the code read-only into the guest.</p>
</li>
<li><p><code>OVMF.fd</code></p>
<p>The all-in-one image with both <code>CODE</code> and <code>VARS</code>. This can be loaded as ROM using <code>-bios</code>, with two drawbacks: (a) UEFI variables are not persistent, and (b) it does not work for <code>SMM_REQUIRE=TRUE</code> builds.</p>
</li>
</ul>
<p>qemu handles pflash storage as block devices, so we have to create block devices for the firmware images:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CODE=$&#123;WORKSPACE&#125;/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd</span><br><span class="line">VARS=$&#123;WORKSPACE&#125;/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_VARS.fd</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -blockdev node-name=code,driver=file,filename=$&#123;CODE&#125;,read-only=on \</span><br><span class="line">  -blockdev node-name=vars,driver=file,filename=$&#123;VARS&#125;,snapshot=on \</span><br><span class="line">  -machine q35,pflash0=code,pflash1=vars \</span><br><span class="line">  [ ... ]</span><br></pre></td></tr></table></figure>

<p>Here is the arm version of that (using the padded files created using <code>dd</code>, see above):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CODE=$&#123;WORKSPACE&#125;/Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV/QEMU_EFI-pflash.raw</span><br><span class="line">VARS=$&#123;WORKSPACE&#125;/Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV/QEMU_VARS-pflash.raw</span><br><span class="line">qemu-system-aarch64 \</span><br><span class="line">  -blockdev node-name=code,driver=file,filename=$&#123;CODE&#125;,read-only=on \</span><br><span class="line">  -blockdev node-name=vars,driver=file,filename=$&#123;VARS&#125;,snapshot=on \</span><br><span class="line">  -machine virt,pflash0=code,pflash1=vars \</span><br><span class="line">  [ ... ]</span><br></pre></td></tr></table></figure>

<h3 id="Source-code-structure"><a href="#Source-code-structure" class="headerlink" title="Source code structure"></a>Source code structure</h3><p>The core edk2 repo holds a number of packages, each package has its own toplevel directory. Here are the most interesting ones:</p>
<ul>
<li><p>OvmfPkg</p>
<p>This holds both the x64-specific code (i.e. OVMF itself) and virtualization-specific code shared by all architectures (virtio drivers).</p>
</li>
<li><p>ArmVirtPkg</p>
<p>Arm specific virtual machine support code.</p>
</li>
<li><p>MdePkg, MdeModulePkg</p>
<p>Most core code is here (PCI support, USB support, generic services and drivers, …).</p>
</li>
<li><p>PcAtChipsetPkg</p>
<p>Some Intel architecture drivers and libs.</p>
</li>
<li><p>ArmPkg, ArmPlatformPkg</p>
<p>Common Arm architecture support code.</p>
</li>
<li><p>CryptoPkg, NetworkPkg, FatPkg, CpuPkg, …</p>
<p>As the names of the packages already suggest: Crypto support (using openssl), Network support (including network boot), FAT Filesystem driver, …</p>
</li>
</ul>
<h3 id="Firmware-boot-phases"><a href="#Firmware-boot-phases" class="headerlink" title="Firmware boot phases"></a>Firmware boot phases</h3><p>The firmware modules in the edk2 repo often named after the boot phase they are running in. Most drivers are named <code>SomeThing**Dxe**</code> for example.</p>
<ul>
<li><p>ResetVector</p>
<p>This is where code execution starts after a machine reset. The code will do the bare minimum needed to enter SEC. On x64 the most important step is the transition from 16-bit real mode to 32-bit mode or 64bit long mode.</p>
</li>
<li><p>SEC (Security)</p>
<p>This code typically loads and uncompresses the code for PEI and SEC. On physical hardware SEC often lives in ROM memory and can not be updated. The PEI and DXE firmware volumes are loaded from (updateable) flash.</p>
<p>With OVMF both SEC firmware volume and the compressed volume holding PXE and DXE code are part of the OVMF_CODE image and will simply be mapped into guest memory.</p>
</li>
<li><p>PEI (Pre-EFI Initialization)</p>
<p>Platform Initialization is done here. Initialize the chipset. Not much to do here in virtual machines, other than loading the x64 e820 memory map (via fw_cfg) from qemu, or get the memory map from the device tree (on aarch64). The virtual hardware is ready-to-go without much extra preaparation.</p>
<p>PEIMs (PEI Modules) can implement functionality which must be executed before entering the DXE phase. This includes security-sensitive things like initializing SMM mode and locking down flash memory.</p>
</li>
<li><p>DXE (Driver Execution Environment)</p>
<p>When PEI is done it hands over control to the full EFI environment contained in the DXE firmware volume. Most code is here. All kinds of drivers. the firmware setup efi app, …</p>
<p>Strictly speaking this isn’t only one phase. The code for all phases after PEI is part of the DXE firmware volume though.</p>
</li>
</ul>
<h2 id="Add-debug-to-EDK2"><a href="#Add-debug-to-EDK2" class="headerlink" title="Add debug to EDK2"></a>Add debug to EDK2</h2><p>The default OVMF build writes debug messages to IO port 0x402.  The following qemu command line options save them in the file called debug.log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-debugcon file:debug.log -global isa-debugcon.iobase=0x402</span><br></pre></td></tr></table></figure>

<p>Or with build option</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D DEBUG_ON_SERIAL_PORT</span><br></pre></td></tr></table></figure>

<p>serial output can be captured</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-serial file:serial.log</span><br></pre></td></tr></table></figure>

<p>note:</p>
<p>The RELEASE build target (‘-b RELEASE’ build option, see below) disables all debug messages.  The default build target is DEBUG.</p>
<p>more build scripts:</p>
<p>On systems with the bash shell you can use OvmfPkg/build.sh to simplify<br>building and running OVMF.</p>
<p>So, for example, to build + run OVMF X64:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a X64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a X64 qemu</span></span><br></pre></td></tr></table></figure>

<p>And to run a 64-bit UEFI bootable ISO image:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ OvmfPkg/build.sh -a X64 qemu -cdrom /path/to/disk-image.iso</span><br></pre></td></tr></table></figure>

<p>To build a 32-bit OVMF without debug messages using GCC 4.8:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a IA32 -b RELEASE -t GCC48</span></span><br></pre></td></tr></table></figure>



<h2 id="UEFI-Windows-7-amp-Windows-2008-Server"><a href="#UEFI-Windows-7-amp-Windows-2008-Server" class="headerlink" title="UEFI Windows 7 &amp; Windows 2008 Server"></a>UEFI Windows 7 &amp; Windows 2008 Server</h2><ul>
<li>One of the ‘-vga std’ and ‘-vga qxl’ QEMU options should be used.</li>
<li>Only one video mode, 1024x768x32, is supported at OS runtime.</li>
<li>The ‘-vga qxl’ QEMU option is recommended. After booting the installed guest OS, select the video card in Device Manager, and upgrade its driver to the QXL XDDM one. Download location:  <a target="_blank" rel="noopener" href="http://www.spice-space.org/download.html">http://www.spice-space.org/download.html</a>, Guest | Windows binaries. This enables further resolutions at OS runtime, and provides S3  (suspend/resume) capability.</li>
</ul>
<h2 id="Debug-in-practice"><a href="#Debug-in-practice" class="headerlink" title="Debug in practice"></a>Debug in practice</h2><h3 id="Test-with-qemu-commandline"><a href="#Test-with-qemu-commandline" class="headerlink" title="Test with qemu commandline"></a>Test with qemu commandline</h3><p>add with config in libvirt vm xml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;qemu:commandline&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;-debugcon&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;file:&#x2F;var&#x2F;log&#x2F;libvirt&#x2F;qemu&#x2F;debug.log&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;-global&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;isa-debugcon.iobase&#x3D;0x402&#39;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;qemu:commandline&gt;</span><br></pre></td></tr></table></figure>

<p>debug log will be found in <code>/var/log/libvirt/qemu/debug.log</code></p>
<p>before we met Win2012 internal reboot issue, use debug to check what happen, the log repeat following lines but guest seems hang on vnc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Register PPI Notify: DCD0BE23-9586-40F4-B643-06522CED4EDE</span><br><span class="line">Install PPI: 8C8CE578-8A3D-4F1C-9935-896185C32DD3</span><br><span class="line">Install PPI: 5473C07A-3DCB-4DCA-BD6F-1E9689E7349A</span><br><span class="line">The 0th FV start address is 0x00000820000, size is 0x000E0000, handle is 0x820000</span><br><span class="line">Register PPI Notify: 49EDB1C1-BF21-4761-BB12-EB0031AABB39</span><br><span class="line">Register PPI Notify: EA7CA24B-DED5-4DAD-A389-BF827E8F9B38</span><br><span class="line">Install PPI: B9E0ABFE-5979-4914-977F-6DEE78C278A6</span><br><span class="line">Install PPI: DBE23AA9-A345-4B97-85B6-B226F1617389</span><br><span class="line">DiscoverPeimsAndOrderWithApriori(): Found 0xB PEI FFS files in the 0th FV</span><br><span class="line">Loading PEIM 9B3ADA4F-AE56-4C24-8DEA-F03B7558AE50</span><br><span class="line">Loading PEIM at 0x0000082BE40 EntryPoint&#x3D;0x0000082F201 PcdPeim.efi</span><br><span class="line">Install PPI: 06E81C58-4AD7-44BC-8390-F10265F72480</span><br><span class="line">Install PPI: 01F34D25-4DE2-23AD-3FF3-36353FF323F1</span><br><span class="line">Install PPI: 4D8B155B-C059-4C8F-8926-06FD4331DB8A</span><br><span class="line">Install PPI: A60C6B59-E459-425D-9C69-0BCC9CB27D81</span><br><span class="line">Register PPI Notify: 605EA650-C65C-42E1-BA80-91A52AB618C6</span><br><span class="line">Loading PEIM A3610442-E69F-4DF3-82CA-2360C4031A23</span><br><span class="line">Loading PEIM at 0x00000830B40 EntryPoint&#x3D;0x00000831F5F ReportStatusCodeRouterPei.efi</span><br><span class="line">Install PPI: 0065D394-9951-4144-82A3-0AFC8579C251</span><br><span class="line">Install PPI: 229832D3-7A30-4B36-B827-F40CB7D45436</span><br><span class="line">Loading PEIM 9D225237-FA01-464C-A949-BAABC02D31D0</span><br><span class="line">Loading PEIM at 0x00000832B40 EntryPoint&#x3D;0x00000833D89 StatusCodeHandlerPei.efi</span><br><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A6DF PlatformPei.efi</span><br><span class="line">Select Item: 0x0</span><br><span class="line">FW CFG Signature: 0x554D4551</span><br><span class="line">Select Item: 0x1</span><br><span class="line">FW CFG Revision: 0x3</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)</span><br><span class="line">SEC: Normal boot</span><br><span class="line">DecompressMemFvs: OutputBuffer@A00000+0xCE0090 ScratchBuffer@1700000+0x10000 PcdOvmfDecompressionScratchEnd&#x3D;0x1710000</span><br></pre></td></tr></table></figure>

<p>track the log to edk2 code, the entry seems start at:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the PEI Core entry point address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in,out]  Fv                 The firmware volume to search</span></span><br><span class="line"><span class="comment">  @param[out]     PeiCoreEntryPoint  The entry point of the PEI Core image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">VOID</span><br><span class="line">FindPeiCoreImageBase (</span><br><span class="line">  IN OUT  EFI_FIRMWARE_VOLUME_HEADER       **BootFv,</span><br><span class="line">     OUT  EFI_PHYSICAL_ADDRESS             *PeiCoreImageBase</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  BOOLEAN S3Resume;</span><br><span class="line"></span><br><span class="line">  *PeiCoreImageBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  S3Resume = IsS3Resume ();</span><br><span class="line">  <span class="keyword">if</span> (S3Resume &amp;&amp; !FeaturePcdGet (PcdSmmSmramRequire)) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// A malicious runtime OS may have injected something into our previously</span></span><br><span class="line">    <span class="comment">// decoded PEI FV, but we don&#x27;t care about that unless SMM/SMRAM is required.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((DEBUG_VERBOSE, <span class="string">&quot;SEC: S3 resume\n&quot;</span>));</span><br><span class="line">    GetS3ResumePeiFv (BootFv);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We&#x27;re either not resuming, or resuming &quot;securely&quot; -- we&#x27;ll decompress</span></span><br><span class="line">    <span class="comment">// both PEI FV and DXE FV from pristine flash.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((DEBUG_VERBOSE, <span class="string">&quot;SEC: %a\n&quot;</span>,</span><br><span class="line">      S3Resume ? <span class="string">&quot;S3 resume (with PEI decompression)&quot;</span> : <span class="string">&quot;Normal boot&quot;</span>));</span><br><span class="line">    FindMainFv (BootFv);</span><br><span class="line"></span><br><span class="line">    DecompressMemFvs (BootFv);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FindPeiCoreImageBaseInFv (*BootFv, PeiCoreImageBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and if not IsS3Resume and not SMM required, VM will use S3 resume but in our situation vm go throught Normal boot.</p>
<p>Than locates the comparessed main firmware volume <code>/usr/share/edk2/ovmf/OVMF_CODE.cc.fd</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the compressed main firmware volume and decompresses it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in,out]  Fv            On input, the firmware volume to search</span></span><br><span class="line"><span class="comment">                                On output, the decompressed BOOT/PEI FV</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">EFI_STATUS</span><br><span class="line">DecompressMemFvs (</span><br></pre></td></tr></table></figure>

<p>Next step is still find PEI core entry address, EFI_SECTION_PE32 and EFI_SECTION_TE will be used to find entry address</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the PEI Core entry point address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in]  Fv                 The firmware volume to search</span></span><br><span class="line"><span class="comment">  @param[out] PeiCoreEntryPoint  The entry point of the PEI Core image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">EFI_STATUS</span><br><span class="line">FindPeiCoreImageBaseInFv (</span><br><span class="line">  IN  EFI_FIRMWARE_VOLUME_HEADER       *Fv,</span><br><span class="line">  OUT  EFI_PHYSICAL_ADDRESS             *PeiCoreImageBase</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  EFI_STATUS                  Status;</span><br><span class="line">  EFI_COMMON_SECTION_HEADER   *Section;</span><br><span class="line"></span><br><span class="line">  Status = FindFfsFileAndSection (</span><br><span class="line">             Fv,</span><br><span class="line">             EFI_FV_FILETYPE_PEI_CORE,</span><br><span class="line">             EFI_SECTION_PE32,</span><br><span class="line">             &amp;Section</span><br><span class="line">             );</span><br><span class="line">  <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">    Status = FindFfsFileAndSection (</span><br><span class="line">               Fv,</span><br><span class="line">               EFI_FV_FILETYPE_PEI_CORE,</span><br><span class="line">               EFI_SECTION_TE,</span><br><span class="line">               &amp;Section</span><br><span class="line">               );</span><br><span class="line">    <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">      DEBUG ((DEBUG_ERROR, <span class="string">&quot;Unable to find PEI Core image\n&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *PeiCoreImageBase = (EFI_PHYSICAL_ADDRESS)(UINTN)(Section + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> EFI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is the last step of find PEI Core image.</p>
<p>Back to where FindPeiCoreImageBase’s code path, we can find SecCoreStartupWithStack is the start function which is used in <code>OvmfPkg/Sec/X64/SecEntry.nasm </code></p>
<p>SecCoreStartupWithStack -&gt; SecStartupPhase2 -&gt; FindAndReportEntryPoints -&gt; FindPeiCoreImageBase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">;</span><br><span class="line">; Setup parameters and call SecCoreStartupWithStack</span><br><span class="line">;   rcx: BootFirmwareVolumePtr</span><br><span class="line">;   rdx: TopOfCurrentStack</span><br><span class="line">;</span><br><span class="line">mov     rcx, rbp</span><br><span class="line">mov     rdx, rsp</span><br><span class="line">sub     rsp, 0x20</span><br><span class="line">call    ASM_PFX(SecCoreStartupWithStack)</span><br></pre></td></tr></table></figure>

<p>combine with log, before next SecCoreStartupWithStack invoking:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)^M</span><br></pre></td></tr></table></figure>

<p>Select Item is printed. </p>
<p>Because FV is successfully loaded:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The 0th FV start address is 0x00000820000, size is 0x000E0000, handle is 0x820000</span><br></pre></td></tr></table></figure>

<p>And compare to first boot:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A6DF PlatformPei.efi^M</span><br><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">QemuFwCfg interface (DMA) is supported.^M</span><br><span class="line">Platform PEIM Loaded^M</span><br></pre></td></tr></table></figure>

<p>It seems Platform PEIM not loaded correctly.</p>
<p>Check QemuFwCfg related code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">RETURN_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgInitialize (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 Signature;</span><br><span class="line">  UINT32 Revision;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Enable the access routines while probing to see if it is supported.</span></span><br><span class="line">  <span class="comment">// For probing we always use the IO Port (IoReadFifo8()) access method.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  mQemuFwCfgSupported = TRUE;</span><br><span class="line">  mQemuFwCfgDmaSupported = FALSE;</span><br><span class="line"></span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemSignature);</span><br><span class="line">  Signature = QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, <span class="string">&quot;FW CFG Signature: 0x%x\n&quot;</span>, Signature));</span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemInterfaceVersion);</span><br><span class="line">  Revision = QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, <span class="string">&quot;FW CFG Revision: 0x%x\n&quot;</span>, Revision));</span><br><span class="line">  <span class="keyword">if</span> ((Signature != SIGNATURE_32 (<span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;U&#x27;</span>)) ||</span><br><span class="line">      (Revision &lt; <span class="number">1</span>)</span><br><span class="line">     ) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface not supported.\n&quot;</span>));</span><br><span class="line">    mQemuFwCfgSupported = FALSE;</span><br><span class="line">    <span class="keyword">return</span> RETURN_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((Revision &amp; FW_CFG_F_DMA) == <span class="number">0</span>) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface (IO Port) is supported.\n&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mQemuFwCfgDmaSupported = TRUE;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface (DMA) is supported.\n&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mQemuFwCfgDmaSupported &amp;&amp; MemEncryptSevIsEnabled ()) &#123;</span><br><span class="line">    EFI_STATUS   Status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// IoMmuDxe driver must have installed the IOMMU protocol. If we are not</span></span><br><span class="line">    <span class="comment">// able to locate the protocol then something must have gone wrong.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Status = gBS-&gt;LocateProtocol (&amp;gEdkiiIoMmuProtocolGuid, <span class="literal">NULL</span>,</span><br><span class="line">                    (VOID **)&amp;mIoMmuProtocol);</span><br><span class="line">    <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">      DEBUG ((DEBUG_ERROR,</span><br><span class="line">        <span class="string">&quot;QemuFwCfgSevDma %a:%a Failed to locate IOMMU protocol.\n&quot;</span>,</span><br><span class="line">        gEfiCallerBaseName, __FUNCTION__));</span><br><span class="line">      ASSERT (FALSE);</span><br><span class="line">      CpuDeadLoop ();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RETURN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because FW CFG Revision: 0x3 is supported, according to the code, Revision is &gt; 1 so QemuFwCfg interface is supported, but from next part 0x03 &amp; <code>FW_CFG_F_DMA</code> which is BIT1 0x01 is not 0 so actually <code>QemuFwCfg interface (DMA) is supported.</code> is expected.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ((Revision &amp; FW_CFG_F_DMA) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (IO Port) is supported.\n&quot;));</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  mQemuFwCfgDmaSupported &#x3D; TRUE;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (DMA) is supported.\n&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so that means the boot is not correctly performed. But next boot still triggered so we should check how the boot can be triggered before we dig out the truth.</p>
<p>According to code，we can know edk2-ovmf is try to load PlatformPei.efi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4^M</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A751 PlatformPei.efi^M</span><br></pre></td></tr></table></figure>

<p>use the guid <code>222C386D-5ABC-4FB4-B124-FBB82488ACF4</code> we can easily get definitions in <code>PlatformPei.inf</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Defines]</span></span><br><span class="line">  <span class="attr">INF_VERSION</span>                    = <span class="number">0</span>x00010005</span><br><span class="line">  <span class="attr">BASE_NAME</span>                      = PlatformPei</span><br><span class="line">  <span class="attr">FILE_GUID</span>                      = <span class="number">222</span>c386d-<span class="number">5</span>abc-<span class="number">4</span>fb4-b124-fbb82488acf4</span><br><span class="line">  <span class="attr">MODULE_TYPE</span>                    = PEIM</span><br><span class="line">  <span class="attr">VERSION_STRING</span>                 = <span class="number">1.0</span></span><br><span class="line">  <span class="attr">ENTRY_POINT</span>                    = InitializePlatform</span><br></pre></td></tr></table></figure>

<p>which ENTRY_POINT is InitializePlatform, but before entry LibraryClasses should be initialized first:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[LibraryClasses]</span></span><br><span class="line">  BaseLib</span><br><span class="line">  CacheMaintenanceLib</span><br><span class="line">  DebugLib</span><br><span class="line">  HobLib</span><br><span class="line">  IoLib</span><br><span class="line">  PciLib</span><br><span class="line">  ResourcePublicationLib</span><br><span class="line">  PeiServicesLib</span><br><span class="line">  PeiServicesTablePointerLib</span><br><span class="line">  PeimEntryPoint</span><br><span class="line">  QemuFwCfgLib</span><br><span class="line">  QemuFwCfgS3Lib</span><br><span class="line">  QemuFwCfgSimpleParserLib</span><br><span class="line">  MtrrLib</span><br><span class="line">  MemEncryptSevLib</span><br><span class="line">  PcdLib</span><br></pre></td></tr></table></figure>

<p>add logs code execution details.</p>
<p>following log shows the trace when edk2 fall into infinite loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4^M</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A76B PlatformPei.efi^M</span><br><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; debug entry point &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;^M</span><br><span class="line">check signature match QEMU result: 0^M</span><br><span class="line">check revision &lt; 1 result: 0^M</span><br><span class="line">check supported result: 2^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; enter InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ReadSevMsr &#x3D; true &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ^M</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)^M</span><br></pre></td></tr></table></figure>

<p>SecCoreStartupWithStack is first log when guest boot, and we end with ReadSevMsr = true but nothing after that.</p>
<p>Before we could see PlatformPei.efi is loading, so refer to PlatformPei.efi first. But the QemuFwCfgLib seems not successfully initialized, because the log end up during its load procedure not show <code>Platform PEIM Loaded</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EFI_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">InitializePlatform (</span><br><span class="line">  IN       EFI_PEI_FILE_HANDLE  FileHandle,</span><br><span class="line">  IN CONST EFI_PEI_SERVICES     **PeiServices</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;Platform PEIM Loaded\n&quot;));</span><br></pre></td></tr></table></figure>

<p>And refer to OvmfPkgX64.dsc describes c lib every procedure should use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[LibraryClasses.common.PEIM]</span><br><span class="line">  HobLib|MdePkg&#x2F;Library&#x2F;PeiHobLib&#x2F;PeiHobLib.inf</span><br><span class="line">  PeiServicesTablePointerLib|MdePkg&#x2F;Library&#x2F;PeiServicesTablePointerLibIdt&#x2F;PeiServicesTablePointerLibIdt.inf</span><br><span class="line">  PeiServicesLib|MdePkg&#x2F;Library&#x2F;PeiServicesLib&#x2F;PeiServicesLib.inf</span><br><span class="line">  MemoryAllocationLib|MdePkg&#x2F;Library&#x2F;PeiMemoryAllocationLib&#x2F;PeiMemoryAllocationLib.inf</span><br><span class="line">  PeimEntryPoint|MdePkg&#x2F;Library&#x2F;PeimEntryPoint&#x2F;PeimEntryPoint.inf</span><br><span class="line">  ReportStatusCodeLib|MdeModulePkg&#x2F;Library&#x2F;PeiReportStatusCodeLib&#x2F;PeiReportStatusCodeLib.inf</span><br><span class="line">  OemHookStatusCodeLib|MdeModulePkg&#x2F;Library&#x2F;OemHookStatusCodeLibNull&#x2F;OemHookStatusCodeLibNull.inf</span><br><span class="line">  PeCoffGetEntryPointLib|MdePkg&#x2F;Library&#x2F;BasePeCoffGetEntryPointLib&#x2F;BasePeCoffGetEntryPointLib.inf</span><br><span class="line">!ifdef $(DEBUG_ON_SERIAL_PORT)</span><br><span class="line">  DebugLib|MdePkg&#x2F;Library&#x2F;BaseDebugLibSerialPort&#x2F;BaseDebugLibSerialPort.inf</span><br><span class="line">!else</span><br><span class="line">  DebugLib|OvmfPkg&#x2F;Library&#x2F;PlatformDebugLibIoPort&#x2F;PlatformDebugLibIoPort.inf</span><br><span class="line">!endif</span><br><span class="line">  PeCoffLib|MdePkg&#x2F;Library&#x2F;BasePeCoffLib&#x2F;BasePeCoffLib.inf</span><br><span class="line">  ResourcePublicationLib|MdePkg&#x2F;Library&#x2F;PeiResourcePublicationLib&#x2F;PeiResourcePublicationLib.inf</span><br><span class="line">  ExtractGuidedSectionLib|MdePkg&#x2F;Library&#x2F;PeiExtractGuidedSectionLib&#x2F;PeiExtractGuidedSectionLib.inf</span><br><span class="line">!if $(SOURCE_DEBUG_ENABLE) &#x3D;&#x3D; TRUE</span><br><span class="line">  DebugAgentLib|SourceLevelDebugPkg&#x2F;Library&#x2F;DebugAgent&#x2F;SecPeiDebugAgentLib.inf</span><br><span class="line">!endif</span><br><span class="line">  CpuExceptionHandlerLib|UefiCpuPkg&#x2F;Library&#x2F;CpuExceptionHandlerLib&#x2F;PeiCpuExceptionHandlerLib.inf</span><br><span class="line">  MpInitLib|UefiCpuPkg&#x2F;Library&#x2F;MpInitLib&#x2F;PeiMpInitLib.inf</span><br><span class="line">  QemuFwCfgS3Lib|OvmfPkg&#x2F;Library&#x2F;QemuFwCfgS3Lib&#x2F;PeiQemuFwCfgS3LibFwCfg.inf</span><br><span class="line">  PcdLib|MdePkg&#x2F;Library&#x2F;PeiPcdLib&#x2F;PeiPcdLib.inf</span><br><span class="line">  QemuFwCfgLib|OvmfPkg&#x2F;Library&#x2F;QemuFwCfgLib&#x2F;QemuFwCfgPeiLib.inf</span><br></pre></td></tr></table></figure>

<p>take eyes on <code>QemuFwCfgLib|OvmfPkg/Library/QemuFwCfgLib/QemuFwCfgPeiLib.inf</code></p>
<p>so check more from <code>QemuFwCfgPei.c</code> , following shows debug log added version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgIsAvailable (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  return InternalQemuFwCfgIsAvailable ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RETURN_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgInitialize (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 Signature;</span><br><span class="line">  UINT32 Revision;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F;</span><br><span class="line">  &#x2F;&#x2F; Enable the access routines while probing to see if it is supported.</span><br><span class="line">  &#x2F;&#x2F; For probing we always use the IO Port (IoReadFifo8()) access method.</span><br><span class="line">  &#x2F;&#x2F;</span><br><span class="line">  mQemuFwCfgSupported &#x3D; TRUE;</span><br><span class="line">  mQemuFwCfgDmaSupported &#x3D; FALSE;</span><br><span class="line"></span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemSignature);</span><br><span class="line">  Signature &#x3D; QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;FW CFG Signature: 0x%x\n&quot;, Signature));</span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemInterfaceVersion);</span><br><span class="line">  Revision &#x3D; QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;FW CFG Revision: 0x%x\n&quot;, Revision));</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; debug entry point &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n&quot;));</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check signature match QEMU result: %d\n&quot;, Signature !&#x3D; SIGNATURE_32 (&#39;Q&#39;, &#39;E&#39;, &#39;M&#39;, &#39;U&#39;)));</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check revision &lt; 1 result: %d\n&quot;, Revision &lt; 1));</span><br><span class="line">  if ((Signature !&#x3D; SIGNATURE_32 (&#39;Q&#39;, &#39;E&#39;, &#39;M&#39;, &#39;U&#39;)) ||</span><br><span class="line">      (Revision &lt; 1)</span><br><span class="line">     ) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface not supported.\n&quot;));</span><br><span class="line">    mQemuFwCfgSupported &#x3D; FALSE;</span><br><span class="line">    return RETURN_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check supported result: %d\n&quot;, (Revision &amp; FW_CFG_F_DMA)));</span><br><span class="line">  if ((Revision &amp; FW_CFG_F_DMA) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (IO Port) is supported.\n&quot;));</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; If SEV is enabled then we do not support DMA operations in PEI phase.</span><br><span class="line">    &#x2F;&#x2F; This is mainly because DMA in SEV guest requires using bounce buffer</span><br><span class="line">    &#x2F;&#x2F; (which need to allocate dynamic memory and allocating a PAGE size&#39;d</span><br><span class="line">    &#x2F;&#x2F; buffer can be challenge in PEI phase)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    if (MemEncryptSevIsEnabled ()) &#123;</span><br><span class="line">      DEBUG ((DEBUG_INFO, &quot;SEV: QemuFwCfg fallback to IO Port interface.\n&quot;));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      mQemuFwCfgDmaSupported &#x3D; TRUE;</span><br><span class="line">      DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (DMA) is supported.\n&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>the code enter the <code>MemEncryptSevIsEnabled ()</code> and hang on next function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">STATIC</span><br><span class="line">VOID</span><br><span class="line">EFIAPI</span><br><span class="line">InternalMemEncryptSevStatus (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32                            RegEax;</span><br><span class="line">  MSR_SEV_STATUS_REGISTER           Msr;</span><br><span class="line">  CPUID_MEMORY_ENCRYPTION_INFO_EAX  Eax;</span><br><span class="line">  BOOLEAN                           ReadSevMsr;</span><br><span class="line">  SEC_SEV_ES_WORK_AREA              *SevEsWorkArea;</span><br><span class="line"></span><br><span class="line">  ReadSevMsr &#x3D; FALSE;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; enter InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">  SevEsWorkArea &#x3D; (SEC_SEV_ES_WORK_AREA *) FixedPcdGet32 (PcdSevEsWorkAreaBase);</span><br><span class="line">  if (SevEsWorkArea !&#x3D; NULL &amp;&amp; SevEsWorkArea-&gt;EncryptionMask !&#x3D; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; The MSR has been read before, so it is safe to read it again and avoid</span><br><span class="line">    &#x2F;&#x2F; having to validate the CPUID information.</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ReadSevMsr &#x3D; true &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    ReadSevMsr &#x3D; TRUE;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check if memory encryption leaf exist</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; AsmCpuid &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    AsmCpuid (CPUID_EXTENDED_FUNCTION, &amp;RegEax, NULL, NULL, NULL);</span><br><span class="line">    if (RegEax &gt;&#x3D; CPUID_MEMORY_ENCRYPTION_INFO) &#123;</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      &#x2F;&#x2F; CPUID Fn8000_001F[EAX] Bit 1 (Sev supported)</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      AsmCpuid (CPUID_MEMORY_ENCRYPTION_INFO, &amp;Eax.Uint32, NULL, NULL, NULL);</span><br><span class="line"></span><br><span class="line">      if (Eax.Bits.SevBit) &#123;</span><br><span class="line">        ReadSevMsr &#x3D; TRUE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (ReadSevMsr) &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check MSR_0xC0010131 Bit 0 (Sev Enabled)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    Msr.Uint32 &#x3D; AsmReadMsr32 (MSR_SEV_STATUS);</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; AsmReadMsr32 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    if (Msr.Bits.SevBit) &#123;</span><br><span class="line">      mSevStatus &#x3D; TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check MSR_0xC0010131 Bit 1 (Sev-Es Enabled)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    if (Msr.Bits.SevEsBit) &#123;</span><br><span class="line">      mSevEsStatus &#x3D; TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; out InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">  mSevStatusChecked &#x3D; TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally <code>AsmReadMsr32</code> is the victim to blame. </p>
<p>note: SEC_SEV_ES_WORK_AREA is a new AREA added by amd used for their SEV feature. Normally guest without SEV feature should not modify those memory area, but it seems windows write randomly bits which caused this problem.</p>
<h3 id="From-edk2-groups"><a href="#From-edk2-groups" class="headerlink" title="From edk2 groups"></a>From edk2 groups</h3><p>Same issue is found <code>https://edk2.groups.io/g/devel/topic/87301748#84086</code></p>
<p>According to the mail:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tested on Intel Platform, It is like &#39;SEV-ES work area&#39; can be modified by</span><br><span class="line">os(Windows etc), and will not restored on reboot, the</span><br><span class="line">SevEsWorkArea-&gt;EncryptionMask may have a random value after reboot. then it</span><br><span class="line">may casue fail on reboot. The msr bits already cached by mSevStatusChecked,</span><br><span class="line">there is no need to try cache again in PEI phase.</span><br></pre></td></tr></table></figure>

<p>it seems Windows will change SEV-ES work area which will lead QemuFwCfgLib to readMsr when guest reboot, but actually for guests, normally SEV-ES is not used, so initializing failure cause the reboot infinite loop.</p>
<h3 id="Patches-fix-the-reboot-issue"><a href="#Patches-fix-the-reboot-issue" class="headerlink" title="Patches fix the reboot issue"></a>Patches fix the reboot issue</h3><p>check file change log </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log OvmfPkg/Library/BaseMemEncryptSevLib/PeiMemEncryptSevLibInternal.c</span><br></pre></td></tr></table></figure>

<p>we can find related patches:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">commit d9822304ce0075b1075edf93cc6e2514685b5212</span><br><span class="line">Author: Brijesh Singh &lt;brijesh.singh@amd.com&gt;</span><br><span class="line">Date:   Thu Dec 9 11:27:37 2021 +0800</span><br><span class="line"></span><br><span class="line">    OvmfPkg&#x2F;MemEncryptSevLib: add MemEncryptSevSnpEnabled()</span><br><span class="line"></span><br><span class="line">    BZ: https:&#x2F;&#x2F;bugzilla.tianocore.org&#x2F;show_bug.cgi?id&#x3D;3275</span><br><span class="line"></span><br><span class="line">    Create a function that can be used to determine if VM is running as an</span><br><span class="line">    SEV-SNP guest.</span><br><span class="line"></span><br><span class="line">    Cc: Michael Roth &lt;michael.roth@amd.com&gt;</span><br><span class="line">    Cc: James Bottomley &lt;jejb@linux.ibm.com&gt;</span><br><span class="line">    Cc: Min Xu &lt;min.m.xu@intel.com&gt;</span><br><span class="line">    Cc: Jiewen Yao &lt;jiewen.yao@intel.com&gt;</span><br><span class="line">    Cc: Tom Lendacky &lt;thomas.lendacky@amd.com&gt;</span><br><span class="line">    Cc: Jordan Justen &lt;jordan.l.justen@intel.com&gt;</span><br><span class="line">    Cc: Ard Biesheuvel &lt;ardb+tianocore@kernel.org&gt;</span><br><span class="line">    Cc: Erdem Aktas &lt;erdemaktas@google.com&gt;</span><br><span class="line">    Cc: Gerd Hoffmann &lt;kraxel@redhat.com&gt;</span><br><span class="line">    Acked-by: Jiewen Yao &lt;Jiewen.yao@intel.com&gt;</span><br><span class="line">    Acked-by: Gerd Hoffmann &lt;kraxel@redhat.com&gt;</span><br><span class="line">    Signed-off-by: Brijesh Singh &lt;brijesh.singh@amd.com&gt;</span><br><span class="line"></span><br><span class="line">commit ac0a286f4d747a4c6c603a7b225917293cbe1e9f</span><br><span class="line">Author: Michael Kubacki &lt;michael.kubacki@microsoft.com&gt;</span><br><span class="line">Date:   Sun Dec 5 14:54:09 2021 -0800</span><br><span class="line"></span><br><span class="line">    OvmfPkg: Apply uncrustify changes</span><br><span class="line"></span><br><span class="line">    REF: https:&#x2F;&#x2F;bugzilla.tianocore.org&#x2F;show_bug.cgi?id&#x3D;3737</span><br><span class="line"></span><br><span class="line">    Apply uncrustify changes to .c&#x2F;.h files in the OvmfPkg package</span><br><span class="line"></span><br><span class="line">    Cc: Andrew Fish &lt;afish@apple.com&gt;</span><br><span class="line">    Cc: Leif Lindholm &lt;leif@nuviainc.com&gt;</span><br><span class="line">    Cc: Michael D Kinney &lt;michael.d.kinney@intel.com&gt;</span><br><span class="line">    Signed-off-by: Michael Kubacki &lt;michael.kubacki@microsoft.com&gt;</span><br><span class="line">    Reviewed-by: Andrew Fish &lt;afish@apple.com&gt;</span><br></pre></td></tr></table></figure>



<h2 id="More-information-about-my-debug-related-procedure"><a href="#More-information-about-my-debug-related-procedure" class="headerlink" title="More information about my debug related procedure"></a>More information about my debug related procedure</h2><h3 id="UEFI-boot-procedure"><a href="#UEFI-boot-procedure" class="headerlink" title="UEFI boot procedure"></a>UEFI boot procedure</h3><p>Before debugging on edk2 code, check UEFI boot procedure to know more about UEFI boot.</p>
<p>According to <a target="_blank" rel="noopener" href="https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence">https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence</a></p>
<p>PI compliant system firmware must support the six phases: security (SEC), pre-efi initialization (PEI), driver execution environment (DXE), boot device selection (BDS), run time (RT) services and After Life (transition from the OS back to the firmware) of system. Refer to Figure below</p>
<img src="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/boot_sequence.png" class="">

<p>Our issue occours at PEI so check the first two steps:</p>
<h4 id="Security-SEC"><a href="#Security-SEC" class="headerlink" title="Security(SEC)"></a>Security(SEC)</h4><p>The Security (SEC) phase is the first phase in the PI Architecture and is responsible for the following:</p>
<ul>
<li>Handling all platform restart events</li>
<li>Creating a temporary memory store</li>
<li>Serving as the root of trust in the system</li>
<li>Passing handoff information to the PEI Foundation</li>
</ul>
<p>The security section may contain modules with code written in assembly. Therefore, some EDK II module development environment (MDE) modules may contain assembly code. Where this occurs, both Windows and GCC versions of assembly code are provided in different files.</p>
<h4 id="Pre-EFI-Initialization-PEI"><a href="#Pre-EFI-Initialization-PEI" class="headerlink" title="Pre-EFI Initialization (PEI)"></a>Pre-EFI Initialization (PEI)</h4><p>The Pre-EFI Initialization (PEI) phase described in the PI Architecture specifications is invoked quite early in the boot flow. Specifically, after some preliminary processing in the Security (SEC) phase, any machine restart event will invoke the PEI phase.</p>
<p>The PEI phase initially operates with the platform in a nascent state, leveraging only on-processor resources, such as the processor cache as a call stack, to dispatch Pre-EFI Initialization Modules (PEIMs). These PEIMs are responsible for the following:</p>
<ul>
<li>Initializing some permanent memory complement</li>
<li>Describing the memory in Hand-Off Blocks (HOBs)</li>
<li>Describing the firmware volume locations in HOBs</li>
<li>Passing control into the Driver Execution Environment (DXE) phase</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" data-id="cld1mhec9005xyuwbgriparkk" data-title="Dive into edk2-ovmf fisrt debug trip" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Go-through-KVM-code-due-to-a-tdp-page-fault" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" class="article-date">
  <time class="dt-published" datetime="2022-07-15T02:23:14.000Z" itemprop="datePublished">2022-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/">Go through KVM code due to a tdp_page_fault</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="What-happened"><a href="#What-happened" class="headerlink" title="What happened?"></a>What happened?</h2><p>Our CI/CD system ran integration test for every pull request but suddenly it met performance issue. Usually one round of integration test need 1h but this time almost all test do not finished after 1h 20min. </p>
<p>After check the codebase and test on lastest release stable branch, its more likely that the system met performance issue.</p>
<p>Before starting trip of “dig out the root cause”, check big picture of this CI/CD system architecture.</p>
<h2 id="Prepare-from-perf"><a href="#Prepare-from-perf" class="headerlink" title="Prepare from perf"></a>Prepare from perf</h2><p>Because integration test runs on virtual machine memory, check hypervisor’s performance might gave more details. So use perf to collect run time data for analysis.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;brendangregg&#x2F;FlameGraph  # or download it from github</span><br><span class="line">cd FlameGraph</span><br><span class="line">perf record -F 99 -a -g -- sleep 60</span><br><span class="line">perf script | .&#x2F;stackcollapse-perf.pl &gt; out.perf-folded</span><br><span class="line">.&#x2F;flamegraph.pl out.perf-folded &gt; perf.svg</span><br></pre></td></tr></table></figure>

<p>Check the flame graph</p>
<img src="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/2022-07-15-kvm-figure1.png" class=""> 


<h2 id="Start-from-tdp-page-fault"><a href="#Start-from-tdp-page-fault" class="headerlink" title="Start from tdp_page_fault"></a>Start from tdp_page_fault</h2><p>Abviously cpu spend lots of time to handle tdp_page_fault</p>
<p>find definition from <code>linux/arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static void init_kvm_tdp_mmu(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	struct kvm_mmu *context &#x3D; &amp;vcpu-&gt;arch.mmu;</span><br><span class="line"></span><br><span class="line">	context-&gt;base_role.word &#x3D; 0;</span><br><span class="line">	context-&gt;base_role.guest_mode &#x3D; is_guest_mode(vcpu);</span><br><span class="line">	context-&gt;base_role.smm &#x3D; is_smm(vcpu);</span><br><span class="line">	context-&gt;base_role.ad_disabled &#x3D; (shadow_accessed_mask &#x3D;&#x3D; 0);</span><br><span class="line">	context-&gt;page_fault &#x3D; tdp_page_fault;</span><br><span class="line">	context-&gt;sync_page &#x3D; nonpaging_sync_page;</span><br><span class="line">	context-&gt;invlpg &#x3D; nonpaging_invlpg;</span><br><span class="line">	context-&gt;update_pte &#x3D; nonpaging_update_pte;</span><br><span class="line">	context-&gt;shadow_root_level &#x3D; kvm_x86_ops-&gt;get_tdp_level(vcpu);</span><br><span class="line">	context-&gt;root_hpa &#x3D; INVALID_PAGE;</span><br><span class="line">	context-&gt;direct_map &#x3D; true;</span><br><span class="line">	context-&gt;set_cr3 &#x3D; kvm_x86_ops-&gt;set_tdp_cr3;</span><br><span class="line">	context-&gt;get_cr3 &#x3D; get_cr3;</span><br><span class="line">	context-&gt;get_pdptr &#x3D; kvm_pdptr_read;</span><br><span class="line">	context-&gt;inject_page_fault &#x3D; kvm_inject_page_fault;</span><br></pre></td></tr></table></figure>

<p><code>kvm_vcpu</code> <code>page_fault</code> point to <code>tdp_page_fault</code> when mmu field of <code>kvm_vcpu</code> is initializing.</p>
<p>from kvm vcpu setup <code>arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void init_kvm_mmu(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	if (mmu_is_nested(vcpu))</span><br><span class="line">		init_kvm_nested_mmu(vcpu);</span><br><span class="line">	else if (tdp_enabled)</span><br><span class="line">		init_kvm_tdp_mmu(vcpu);</span><br><span class="line">	else</span><br><span class="line">		init_kvm_softmmu(vcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>from kvm vcpu setup <code>arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void kvm_mmu_setup(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	MMU_WARN_ON(VALID_PAGE(vcpu-&gt;arch.mmu.root_hpa));</span><br><span class="line"></span><br><span class="line">	init_kvm_mmu(vcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>from kvm vcpu setup <code>arch/x86/kvm/x86.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int kvm_arch_vcpu_setup(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	kvm_vcpu_mtrr_init(vcpu);</span><br><span class="line">	vcpu_load(vcpu);</span><br><span class="line">	kvm_vcpu_reset(vcpu, false);</span><br><span class="line">	kvm_mmu_setup(vcpu);</span><br><span class="line">	vcpu_put(vcpu);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vcpu is created by </p>
<p><code>kvm_vm_ioctl_create_vcpu(struct kvm *kvm, u32 id)</code></p>
<p>check mmu in vcpu structure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Paging state of the vcpu</span><br><span class="line"> *</span><br><span class="line"> * If the vcpu runs in guest mode with two level paging this still saves</span><br><span class="line"> * the paging mode of the l1 guest. This context is always used to</span><br><span class="line"> * handle faults.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct kvm_mmu mmu;</span><br></pre></td></tr></table></figure>

<h2 id="Find-more-by-pf-interception"><a href="#Find-more-by-pf-interception" class="headerlink" title="Find more by pf_interception"></a>Find more by pf_interception</h2><p>combine to flage graph, pf_interception is before tdp_page_fault,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static int pf_interception(struct vcpu_svm *svm)</span><br><span class="line">&#123;</span><br><span class="line">	u64 fault_address &#x3D; __sme_clr(svm-&gt;vmcb-&gt;control.exit_info_2);</span><br><span class="line">	u64 error_code &#x3D; svm-&gt;vmcb-&gt;control.exit_info_1;</span><br><span class="line"></span><br><span class="line">	return kvm_handle_page_fault(&amp;svm-&gt;vcpu, error_code, fault_address,</span><br><span class="line">			static_cpu_has(X86_FEATURE_DECODEASSISTS) ?</span><br><span class="line">			svm-&gt;vmcb-&gt;control.insn_bytes : NULL,</span><br><span class="line">			svm-&gt;vmcb-&gt;control.insn_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>refer to its usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[SVM_EXIT_EXCP_BASE + PF_VECTOR] &#x3D; pf_interception</span><br></pre></td></tr></table></figure>

<p>SVM_EXIT_EXCP_BASE is related to AMD CPU virtualization, PF_VECTOR means page_frame vector, used by page fault.</p>
<p>more details about the PF_VECTOR in <code>arch/x86/kvm/svm.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (npt_enabled) &#123;</span><br><span class="line">	&#x2F;* Setup VMCB for Nested Paging *&#x2F;</span><br><span class="line">	control-&gt;nested_ctl |&#x3D; SVM_NESTED_CTL_NP_ENABLE;</span><br><span class="line">	clr_intercept(svm, INTERCEPT_INVLPG);</span><br><span class="line">	clr_exception_intercept(svm, PF_VECTOR);</span><br><span class="line">	clr_cr_intercept(svm, INTERCEPT_CR3_READ);</span><br><span class="line">	clr_cr_intercept(svm, INTERCEPT_CR3_WRITE);</span><br><span class="line">	save-&gt;g_pat &#x3D; svm-&gt;vcpu.arch.pat;</span><br><span class="line">	save-&gt;cr3 &#x3D; 0;</span><br><span class="line">	save-&gt;cr4 &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if AMD CPU’s npt not enabled, PF_VECTOR will be used to intercept page fault.</p>
<p>So just quickly go through guest virtual address translation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Fetch a guest pte for a guest virtual address</span><br><span class="line"> *&#x2F;</span><br><span class="line">static int FNAME(walk_addr_generic)(struct guest_walker *walker,</span><br><span class="line">				    struct kvm_vcpu *vcpu, struct kvm_mmu *mmu,</span><br><span class="line">				    gva_t addr, u32 access)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">error:</span><br><span class="line">	errcode |&#x3D; write_fault | user_fault;</span><br><span class="line">	if (fetch_fault &amp;&amp; (mmu-&gt;nx ||</span><br><span class="line">			    kvm_read_cr4_bits(vcpu, X86_CR4_SMEP)))</span><br><span class="line">		errcode |&#x3D; PFERR_FETCH_MASK;</span><br><span class="line"></span><br><span class="line">	walker-&gt;fault.vector &#x3D; PF_VECTOR;</span><br><span class="line">	walker-&gt;fault.error_code_valid &#x3D; true;</span><br><span class="line">	walker-&gt;fault.error_code &#x3D; errcode;</span><br></pre></td></tr></table></figure>

<p>error is defined to raise PF_VECTOR when failed to find any PTE(Page table entry) </p>
<p>Than let’s find the next method <code>handle_exit()</code> from svm.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int handle_exit(struct kvm_vcpu *vcpu)</span><br></pre></td></tr></table></figure>

<p>following shows more details</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct vcpu_svm *svm &#x3D; to_svm(vcpu);</span><br><span class="line">struct kvm_run *kvm_run &#x3D; vcpu-&gt;run;</span><br><span class="line">u32 exit_code &#x3D; svm-&gt;vmcb-&gt;control.exit_code;</span><br></pre></td></tr></table></figure>

<p>the vcpu structure will be changed to vcpu_svm and than get the exit_code from it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">trace_kvm_exit(exit_code, vcpu, KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">if (!is_cr_intercept(svm, INTERCEPT_CR0_WRITE))</span><br><span class="line">	vcpu-&gt;arch.cr0 &#x3D; svm-&gt;vmcb-&gt;save.cr0;</span><br><span class="line">if (npt_enabled)</span><br><span class="line">	vcpu-&gt;arch.cr3 &#x3D; svm-&gt;vmcb-&gt;save.cr3;</span><br><span class="line"></span><br><span class="line">if (unlikely(svm-&gt;nested.exit_required)) &#123;</span><br><span class="line">	nested_svm_vmexit(svm);</span><br><span class="line">	svm-&gt;nested.exit_required &#x3D; false;</span><br><span class="line"></span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>than the exit_code will be traced.</p>
<p>CR0 has various control flags that modify the basic operation of the processor. See more: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Control_register#CR0">https://en.wikipedia.org/wiki/Control_register#CR0</a></p>
<p>if npt_enabled(CPU enable npt) vcpu will use vmcb saved cr3</p>
<p>vmcb: Intel VT-x name it as vmcs(virtual machine control structure), AMD name it as vmcb(virtual machine control block)</p>
<p>vmcb_control_area and vmcb_save_area combined as virtual machine control block. </p>
<p>note: need more research</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if (is_guest_mode(vcpu)) &#123;</span><br><span class="line">	int vmexit;</span><br><span class="line"></span><br><span class="line">	trace_kvm_nested_vmexit(svm-&gt;vmcb-&gt;save.rip, exit_code,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_info_1,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_info_2,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_int_info,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_int_info_err,</span><br><span class="line">				KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">	vmexit &#x3D; nested_svm_exit_special(svm);</span><br><span class="line"></span><br><span class="line">	if (vmexit &#x3D;&#x3D; NESTED_EXIT_CONTINUE)</span><br><span class="line">		vmexit &#x3D; nested_svm_exit_handled(svm);</span><br><span class="line"></span><br><span class="line">	if (vmexit &#x3D;&#x3D; NESTED_EXIT_DONE)</span><br><span class="line">		return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if vm is nested exit, handle nested exit next step, interrupts will be queued and if vm exit due to SVM_EXIT_ERR exit this thread.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">svm_complete_interrupts(svm);</span><br><span class="line"></span><br><span class="line">if (svm-&gt;vmcb-&gt;control.exit_code &#x3D;&#x3D; SVM_EXIT_ERR) &#123;</span><br><span class="line">	kvm_run-&gt;exit_reason &#x3D; KVM_EXIT_FAIL_ENTRY;</span><br><span class="line">	kvm_run-&gt;fail_entry.hardware_entry_failure_reason</span><br><span class="line">		&#x3D; svm-&gt;vmcb-&gt;control.exit_code;</span><br><span class="line">	pr_err(&quot;KVM: FAILED VMRUN WITH VMCB:\n&quot;);</span><br><span class="line">	dump_vmcb(vcpu);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>last, check if the error code is external interrupt and not kernel handable error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if (is_external_interrupt(svm-&gt;vmcb-&gt;control.exit_int_info) &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_EXCP_BASE + PF_VECTOR &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_NPF &amp;&amp; exit_code !&#x3D; SVM_EXIT_TASK_SWITCH &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_INTR &amp;&amp; exit_code !&#x3D; SVM_EXIT_NMI)</span><br><span class="line">	printk(KERN_ERR &quot;%s: unexpected exit_int_info 0x%x &quot;</span><br><span class="line">	       &quot;exit_code 0x%x\n&quot;,</span><br><span class="line">	       __func__, svm-&gt;vmcb-&gt;control.exit_int_info,</span><br><span class="line">	       exit_code);</span><br><span class="line"></span><br><span class="line">if (exit_code &gt;&#x3D; ARRAY_SIZE(svm_exit_handlers)</span><br><span class="line">    || !svm_exit_handlers[exit_code]) &#123;</span><br><span class="line">	WARN_ONCE(1, &quot;svm: unexpected exit reason 0x%x\n&quot;, exit_code);</span><br><span class="line">	kvm_queue_exception(vcpu, UD_VECTOR);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return svm_exit_handlers[exit_code](svm);</span><br></pre></td></tr></table></figure>

<p>finally invoke svm exit handler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return svm_exit_handlers[exit_code](svm);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" data-id="cld1mhe9x0003yuwb8g646w4b" data-title="Go through KVM code due to a tdp_page_fault" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BSOD/" style="font-size: 10px;">BSOD</a> <a href="/tags/DPDK/" style="font-size: 13.33px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/TDP/" style="font-size: 11.67px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 16.67px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 10px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 13.33px;">java</a> <a href="/tags/kernel/" style="font-size: 11.67px;">kernel</a> <a href="/tags/kvm/" style="font-size: 16.67px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 10px;">libvirt</a> <a href="/tags/linux/" style="font-size: 16.67px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 13.33px;">software-arch</a> <a href="/tags/system-design/" style="font-size: 13.33px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 18.33px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 15px;">virt</a> <a href="/tags/virtio/" style="font-size: 11.67px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 18.33px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 18.33px;">virtio-networking</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/">Windows install virtio then reboot met BSOD</a>
          </li>
        
          <li>
            <a href="/2023/01/13/live-migration-failed-due-to-libvirt-keepalive-timeout/">Live migration failed due to libvirt keepalive timeout</a>
          </li>
        
          <li>
            <a href="/2022/12/15/nessus-on-centos-7/">Nessus on centos 7</a>
          </li>
        
          <li>
            <a href="/2022/11/16/uefi-windows-guest-hang-after-live-migration/">UEFI Windows guest hang after live migration</a>
          </li>
        
          <li>
            <a href="/2022/11/09/plugable-system-in-practice-00/">Plugable system in practice 00</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>