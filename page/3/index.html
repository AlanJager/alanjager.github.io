<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="花の様に">
<meta property="og:url" content="http://hanayo.cn/page/3/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:locale">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="ブログ">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-some-thought-about-software-engineer-interview" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/23/some-thought-about-software-engineer-interview/" class="article-date">
  <time class="dt-published" datetime="2022-09-23T07:40:26.000Z" itemprop="datePublished">2022-09-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/management/">management</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/23/some-thought-about-software-engineer-interview/">Some thought about software engineer interview</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>I can’t stop thinking about how to interview a suitable software engineer for my team, because a graduate is fired only after joining my team for three months. There are some points to figure the reasons about the story:</p>
<ul>
<li>Low learning efficiency, can not figure out what is supposed to be known, for example, basic git usage to submit a patch, learn it over month.</li>
<li>Bad code kills, code is not good and can not comprehen the code even after your explaination and testing.</li>
<li>Bad manners, diss the colleague to explain why he didn’t do his work as expected.</li>
</ul>
<p>Notice: I’m not sure if those requests are only requested in my country, but actually his buddy and colleague cost a lot of energy to solve his own problems. </p>
<p>Fortunately, I am very sharp to colleague’s work so that guy didn’t disturb me very much. But after that I start thinking about is there any way to get a more suitable devloper to avoid this situation from happening again. (Maybe for undergraduate, our the interview is too easy)</p>
<h2 id="Details-about-current-interview"><a href="#Details-about-current-interview" class="headerlink" title="Details about current interview"></a>Details about current interview</h2><h3 id="Introduction-for-current-interview"><a href="#Introduction-for-current-interview" class="headerlink" title="Introduction for current interview"></a>Introduction for current interview</h3><p>Typically, every interviewee need to intend two or three around technical interview. </p>
<ol>
<li>interview for basic skills, like code skills or knowledges we required</li>
<li>interview for project engineering, explain technical view of experinenced project and know a big picture  of a project.</li>
<li>interview for code reading/writing and math problem capability (but not always used)</li>
</ol>
<p>But many teams only interview their own candidate, the skills maybe not well interviewed or not executed as expected, because we do not have any objective test to get the result of every interview. Only perspective point is used so when try to scale a team or required more developers the period is more longer than we expected.</p>
<h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><p>From last failure, some basic requirements need to be recorded.</p>
<ul>
<li>Learning skiils. Self-driving is essential for a developer</li>
<li>Code skills. Typlically not read code but comprehend the code</li>
<li>Good manners. May be a optional quality but it is important for teamwork</li>
</ul>
<p>Except those requrements more basic requirements is involved in current list:</p>
<ul>
<li>System knownledge, operation system usage, architecture and so on.</li>
<li>Code skills, code usage (including useful lib, programming language implementation)</li>
<li>Communication skills, throught interview not actually maybe pretended</li>
<li>Teamwork skills, for those who have work experience</li>
</ul>
<p>So more personal skills need to be involved in interview in my expectation. But in my opinion, it’s not a good thing for devloper as a interviewer need to judge interviewee’s those aspects directly.</p>
<p>Well formed questions need to be collected for all those aspects we required for a “suitable developer”.</p>
<h3 id="Research-before-planning"><a href="#Research-before-planning" class="headerlink" title="Research before planning"></a>Research before planning</h3><p>More research need to be done before we get some solutions.</p>
<p>When I search “how to interview software engineers”. I got this page:</p>
<p><a target="_blank" rel="noopener" href="https://arc.dev/employer-blog/software-engineer-interview-questions/">https://arc.dev/employer-blog/software-engineer-interview-questions/</a></p>
<p>There are some interesting questions:</p>
<ol>
<li>Discuss one of your previous projects and explain how you completed it successfully.</li>
<li>When you ran into an obstacle with your project, how did you handle the issue?</li>
<li>What are your thoughts on unit testing?</li>
<li>What is your process for finding a bug in an application?</li>
</ol>
<p>Combine with experience and actual works, the debug skills and project skills can be easily tested.</p>
<p>So those kind of open questions seems a good way for a interview.</p>
<p>Besides those questions, knowledge test should also be used for graduate, but this is quite easy.</p>
<h2 id="Plan"><a href="#Plan" class="headerlink" title="Plan"></a>Plan</h2><p>According to below discuss, we decide to make a plan to help us feel easy with interviews.</p>
<ul>
<li>Change seperated interview for the whole backend team. </li>
<li>Use prepared questions to interview in order to get objective result from different interviewers.</li>
<li>Add more tests for graduate</li>
<li>Logic analysis test should be involved in the interview questions</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/23/some-thought-about-software-engineer-interview/" data-id="cld1mheb5001hyuwbeiku3dbd" data-title="Some thought about software engineer interview" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/23/some-thought-about-software-engineer-interview/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/23/some-thought-about-software-engineer-interview/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/interview/" rel="tag">interview</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-build-internal-maven-repos" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/22/build-internal-maven-repos/" class="article-date">
  <time class="dt-published" datetime="2022-09-22T05:58:26.000Z" itemprop="datePublished">2022-09-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/project-related-works/">project-related-works</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/22/build-internal-maven-repos/">Build internal maven repositories</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Build-internal-maven-repositories"><a href="#Build-internal-maven-repositories" class="headerlink" title="Build internal maven repositories"></a>Build internal maven repositories</h1><h2 id="Installation-of-management-tool"><a href="#Installation-of-management-tool" class="headerlink" title="Installation of management tool"></a>Installation of management tool</h2><p>Choose sonatype nexus repository manager to bulid internal maven repositories.</p>
<p>Download link: <a target="_blank" rel="noopener" href="https://help.sonatype.com/repomanager3/product-information/download">https://help.sonatype.com/repomanager3/product-information/download</a></p>
<p>Select a tar match your system and execute following commands:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.sonatype.com/nexus/3/nexus-3.41.1-01-unix.tar.gz</span><br><span class="line">tar zxvf nexus-3.41.1-01-unix.tar.gz</span><br><span class="line">cd nexus-3.41.1-01/bin/</span><br><span class="line">./nexus start</span><br></pre></td></tr></table></figure>

<p>Because use root to start nexus, check the log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /root/sonatype-work/nexus3/log/nexus.log</span><br></pre></td></tr></table></figure>

<p>application is started</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line">Started Sonatype Nexus OSS 3.41.1-01</span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>But we want this application run as service, so do more configuration for systemd, create a file <code>/etc/systemd/system/nexus.service</code> contains:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nexus service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">ExecStart=/root/nexus-3.41.1-01/bin/nexus start</span><br><span class="line">ExecStop=/root/nexus-3.41.1-01/bin/nexus stop</span><br><span class="line">User=root</span><br><span class="line">Restart=on-abort</span><br><span class="line">TimeoutSec=600</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>then enable and start nexus:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable nexus.service</span><br><span class="line">sudo systemctl start nexus.service</span><br></pre></td></tr></table></figure>

<p>after that management tool installation finished, let’s start to build internal maven repositories.</p>
<h2 id="Create-private-repository"><a href="#Create-private-repository" class="headerlink" title="Create private repository"></a>Create private repository</h2><p>First, access sonatype nexus by 8081 port and finish the wizard.</p>
<h3 id="Repository-types"><a href="#Repository-types" class="headerlink" title="Repository types"></a>Repository types</h3><p>According to nexus docs, there are several proxy types for nexus:</p>
<ul>
<li>Proxy repository: is a type linked to remote repository, which act as cache for the local request</li>
<li>Hosted repository: local stored and follow maven policy </li>
<li>Repository group: combine multi repositories as one</li>
</ul>
<p>So our usage, we choose maven2 hosted repository to publish our own jar. </p>
<p>Following configurations are used for this repository:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">format: maven2</span><br><span class="line">type: hosted</span><br><span class="line">layout policy: strict</span><br><span class="line">content disposition: inline</span><br><span class="line">blob store: default</span><br><span class="line">deployment policy: disable redeploy</span><br></pre></td></tr></table></figure>

<p>And try to upload first jar to our hosted repository</p>
<p>Access<code>http://your_nexus_address/#browse/upload:your_repo </code> this page to uplaod jar with group id and artifact id.</p>
<p>Then, change pom.xml to enable the repository:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://your_nexus_address/repository/your_repo/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>But if use maven3 need to update settings to allow http access. </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>zstack-premium-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://your_nexus_address/repository/your_repo/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>zstack-premium<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Test mvn install the lib is download as expected.</p>
<h2 id="Deploy-project-to-the-repository"><a href="#Deploy-project-to-the-repository" class="headerlink" title="Deploy project to the repository"></a>Deploy project to the repository</h2><p>Add distribution management into your pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>your_repo_id<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>readable name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>your_repo_address<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>to set which repo address your deployment should go, then add server related setttings to your .m2/settting.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>your_repo_id<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">username</span>&gt;</span>your_username<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">password</span>&gt;</span>your_password<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Then use <code>mvn deploy</code> to finish upload.</p>
<p>There are some errors during the configuration phase.</p>
<ul>
<li><p>Error status code 401, means authentication failure,  use <code>mvn -X</code> to check</p>
<p>[DEBUG] Reading global settings from /opt/maven/conf/settings.xml<br>[DEBUG] Reading user settings from /root/.m2/settings.xml<br>two configuration files are used, change the global one with the sever section fix the issue.</p>
</li>
<li><p>Error status code 400, nexus repository should change the deployment policy to allow redeploy</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/22/build-internal-maven-repos/" data-id="cld1mhea20008yuwbd9ts255q" data-title="Build internal maven repositories" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/22/build-internal-maven-repos/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/22/build-internal-maven-repos/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-shared-timeout-impelments-under-multi-thread-context-model" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/" class="article-date">
  <time class="dt-published" datetime="2022-09-20T05:38:16.000Z" itemprop="datePublished">2022-09-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/arch-notes/">arch-notes</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/">Shared timeout implements under multi-thread context model</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>This blog shows timeout impelents under multi-thread Java application. Discuss its advantage and disadvantage, also tell difficulties we meet in practice.</p>
<h2 id="Why-shared-timeout"><a href="#Why-shared-timeout" class="headerlink" title="Why shared timeout"></a>Why shared timeout</h2><p>For a complex micro service system, message is a basic way used for communication between all modules. So timeout is come into used, for every API or message, to avoid unfinished tasks.</p>
<p>Let’s think if you what to do something without timeout, it may never finished with response. So timeout does the matter to help user and system get rid of those situations.</p>
<p>But when we talk about shared timeout, what is it and what it does. </p>
<p>For example, one API may sending several message to execute on different services and finally finished. During the process, if a timeout happen, API should return as timeouted as we expected. So the design of timeout mechanism should share a same period of timeout.</p>
<p>Assume API timeout is T and three messages tend to be used for API’s execution, and message<sub>1</sub> use time T<sub>1</sub>, message<sub>2</sub> use time T<sub>2</sub> and message<sub>3</sub> use time T<sub>3</sub> , in shared timeout situation, message<sub>1</sub>‘s timeout is T , message<sub>2</sub>‘s timeout is T - T<sub>1</sub>,  message<sub>3</sub>‘s timeout is T - T<sub>1</sub> - T<sub>2</sub>. The remaining timeout should be used for next message to confirm all sub messages could be timeouted as expected.</p>
<h2 id="Application-level-implements"><a href="#Application-level-implements" class="headerlink" title="Application level implements"></a>Application level implements</h2><p>For message level timeout, the easiest way to implement timeout management is on message bus. Every timeout the message received, check its timeout header and calculate its remaining timeout seems to make sense. </p>
<p>But if we record its timeout by decrease message used time. The machanism became more complex, because every messages time usage need to be recorded but for most product the message profiling is disable to avoid any performance overhead. </p>
<p>In order to solve this problem, we use message deadline as metadata for message lifecyle. Every new coming message should be set a deadline due to its configuration and every sub message calculate its remaining timeout by using the deadline time substract current time. So with a general service to get current time this timeout mechanism get more efficient.</p>
<h2 id="More-challenges"><a href="#More-challenges" class="headerlink" title="More challenges"></a>More challenges</h2><p>In multi-thread application. Lifecyle maintanence of message’s timeout is really matter. </p>
<p>Espacially, ZStack use in-process micro services architecture, messages pass through memory or http, for API message, the timeout always works well, but for internal messages more problems came out.</p>
<p>For example, a async invoker util functios may send several messages but they shares the same thread before handling, so the thread’s context will be used as message’s initial context where the timeout stored.</p>
<p>When thread context changed we can clear the context by thread pool’s thread lifecyle hook.</p>
<p>But some user case the timeout do not work as expected.</p>
<ul>
<li>GC task (in memory task triggered by a fixed time rate or any system event)</li>
<li>Thread level task (async and sync task queue)</li>
</ul>
<h3 id="GC-task"><a href="#GC-task" class="headerlink" title="GC task"></a>GC task</h3><p>GC task is used to handling some unexpected async operation or retry to delete some resource and so on. </p>
<p>If a thread submit the task executes the task itself, the context will be used directly, and actually the context mess up the GC task’s execution. So always use a new thread to start GC job is a good choice.</p>
<p>For multi-thread application, message dilevery and handling involves different threads, especially some task driver might be used to construct work flow and task execution. So the timeout context need be passed from one thread to another.</p>
<p>Assume Thread1 do task1 and finished with submit a new task2, maybe sometimes after Thread2 start to handle task2 but at this time task2 is required to contain timeout. Or the timeout cannot be passed.</p>
<h3 id="Fixed-thread-task"><a href="#Fixed-thread-task" class="headerlink" title="Fixed thread task"></a>Fixed thread task</h3><p>Same thread handling all tasks, so task should store its context when submitted to task queue.</p>
<p>Execution need to recover task context before execution.</p>
<h3 id="Benefits-of-the-concepts"><a href="#Benefits-of-the-concepts" class="headerlink" title="Benefits of the concepts"></a>Benefits of the concepts</h3><p>For a in-process arch, use a global level timeout during api or inner task lifecycle and the whole timeout can be managed.</p>
<h2 id="Easy-implements"><a href="#Easy-implements" class="headerlink" title="Easy implements"></a>Easy implements</h2><p>In java program, use aop to maintain the timeout get/set seems a good choice.</p>
<p>A typical ZStack task workflow, usually use api at the first step. A new coming api message, ZStack will set timeout to it, but in order to know parent messages timeout, we need to manage the timeout information to the message.</p>
<p>So a design named TaskContext is created to contains the global variables during whole task lifecycle. Use aop, all async tasks will use its parent TaskContext and clear it before start. With TaskContext, the timeout can be managed.</p>
<p>But some user scenarios still need to be discussed, list it before details:</p>
<ul>
<li>Inner message is used as the start of a task, it should support timeout.</li>
<li>API use a inner message configured with timeout which should be supported.</li>
<li>How did new coming mechanism aware of the timeout from task context</li>
<li>How to avoid task context be messed</li>
</ul>
<h3 id="Inner-message"><a href="#Inner-message" class="headerlink" title="Inner message"></a>Inner message</h3><p>Inner message level timeout configuration need to be supported as some tasks is executed by GC task which we mentioned, may send inner message directly, so timeout maybe requested for those tasks</p>
<h3 id="Duplicate-configuration"><a href="#Duplicate-configuration" class="headerlink" title="Duplicate configuration"></a>Duplicate configuration</h3><p>For api messages, it may use a workflow contains several inner messsages when those messages all have timeout configuration, we need to use the origin timeout but do not use new configured one.</p>
<h3 id="Aware-of-timeout"><a href="#Aware-of-timeout" class="headerlink" title="Aware of timeout"></a>Aware of timeout</h3><p>It not practical, becamse task context is a in-memory variable and marked by thread-id, so everytime the thread switched the task context need to be copied to the new thread. If any mechanism do not support task context copy, it will result in timeout loss, if any inner message used, a new timeout will be set from timeout manager. And it seems no good solution to make the new mechanism aware of this. That’s the shortage of using aop.</p>
<h3 id="Do-not-touch-task-context"><a href="#Do-not-touch-task-context" class="headerlink" title="Do not touch task context"></a>Do not touch task context</h3><p>Only timeout manager should use task context for timeout handling and other task context usage including     manually clear it or set value should be avoid.</p>
<p>But for some reason the access of TaskContext supposed to be available to core module for timeout or other context usage (for example, task id), so only keep it cleared after thread context switch and only assign value to framework known fields to avoid any mess up operations from other developer.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Actually task context is more likely a global variable for every thread to use. Keep it from abuse and oom is the first task and aop in involved to resolve this problem. So how to trace task context seems the next valuable target of this version of code.</p>
<h2 id="Check-the-code"><a href="#Check-the-code" class="headerlink" title="Check the code"></a>Check the code</h2><p><a target="_blank" rel="noopener" href="https://github.com/zstackio/zstack">https://github.com/zstackio/zstack</a> check the code if you are interested in this feature.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/" data-id="cld1mheax0017yuwbfudbeuxv" data-title="Shared timeout implements under multi-thread context model" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/20/shared-timeout-impelments-under-multi-thread-context-model/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-guest-free-page-hinting-notes-01" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/04/guest-free-page-hinting-notes-01/" class="article-date">
  <time class="dt-published" datetime="2022-09-04T13:41:09.000Z" itemprop="datePublished">2022-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/04/guest-free-page-hinting-notes-01/">Guest Free Page Hinting notes 01</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>基于virtio1.2的推送，在virtio-balloon设备下有一条新特性：free page hints</p>
<p>因为不太了解这个东西具体做了啥，查了一番资料</p>
<h2 id="KVM-Guest-Free-Page-Hinting"><a href="#KVM-Guest-Free-Page-Hinting" class="headerlink" title="KVM: Guest Free Page Hinting"></a>KVM: Guest Free Page Hinting</h2><p>在2019年2月有这样一封邮件记录 <a target="_blank" rel="noopener" href="https://lwn.net/Articles/778432/">https://lwn.net/Articles/778432/</a></p>
<blockquote>
<p>The following patch-set proposes an efficient mechanism for handing freed memory between the guest and the host. It enables the guests with no page cache to rapidly free and reclaims memory to and from the host respectively.</p>
</blockquote>
<p>看起来主要目的是为了优化guest和host之间的空闲内存管理，避免出现需要快速释放或者回收page cache内存</p>
<p>同时里面提到了</p>
<p> Known code re-work:</p>
<ul>
<li>Plan to re-use Wei’s work, which communicates the poison value to the host.</li>
<li>The nomenclatures used in virtio-balloon needs to be changed so that the code can easily be distinguished from Wei’s Free Page Hint code.</li>
<li>Sorting based on zonenum, to avoid repetitive zone locks for the same zone.</li>
</ul>
<p>需要对virtio-balloon做一些修改来来保证代码能够和这部分Free Page Hint的代码保持区别。</p>
<p>这么说感觉好像是Hint的代码和virtio-balloon是两套</p>
<h2 id="Virtio-balloon-support-free-page-reporting"><a href="#Virtio-balloon-support-free-page-reporting" class="headerlink" title="Virtio-balloon: support free page reporting"></a>Virtio-balloon: support free page reporting</h2><p>基于上面查到的资料，又发现了另外一篇直接提到Virtio-balloon的改动 <a target="_blank" rel="noopener" href="https://lwn.net/Articles/759413/">https://lwn.net/Articles/759413/</a></p>
<p>里面新增的 VIRTIO_BALLOON_F_FREE_PAGE_HINT 是可以和 <a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.pdf">https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.pdf</a> virtio1.2的spec对应上的</p>
<p>摘抄一下里面的描述</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Live migration needs to transfer the VM&#39;s memory from the source machine</span><br><span class="line">to the destination round by round. For the 1st round, all the VM&#39;s memory</span><br><span class="line">is transferred. From the 2nd round, only the pieces of memory that were</span><br><span class="line">written by the guest (after the 1st round) are transferred. One method</span><br><span class="line">that is popularly used by the hypervisor to track which part of memory is</span><br><span class="line">written is to write-protect all the guest memory.</span><br><span class="line"></span><br><span class="line">This feature enables the optimization by skipping the transfer of guest</span><br><span class="line">free pages during VM live migration. It is not concerned that the memory</span><br><span class="line">pages are used after they are given to the hypervisor as a hint of the</span><br><span class="line">free pages, because they will be tracked by the hypervisor and transferred</span><br><span class="line">in the subsequent round if they are used and written.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>针对热迁移场景，会不停的copy memory。第一轮会复制所有内存，后续只需要复制guest写过的内存。</p>
<p>因此hypervisor需要记录guest写过哪些内存，然后全都复制一遍。</p>
<p>而这个功能是用来优化guest free page transfer的。即忽略这些已经被标记为free page的内容，如果后续这些page被使用了或者被写了，下一轮内存拷贝才考虑这些page。</p>
<p>通过这段描述，可以知道这个优化需要提供一个机制，来提供free page hint，并以此为基础来优化live migration。</p>
<h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2><p>在准备看代码之前，发现了一段很有意思的内容</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- mm&#x2F;get_from_free_page_list: The new implementation to get free page</span><br><span class="line">  hints based on the suggestions from Linus:</span><br><span class="line">  https:&#x2F;&#x2F;lkml.org&#x2F;lkml&#x2F;2018&#x2F;6&#x2F;11&#x2F;764</span><br><span class="line">  This avoids the complex call chain, and looks more prudent.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对获取 <code>get_from_free_page_list</code> 操作，linus回了很长的一段建议</p>
<p>里面很有意思的是，是不是要加一个新的 GFP_NONE，来标记分配失败？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Maybe it will help to have GFP_NONE which will make any allocation</span><br><span class="line">fail if attempted. Linus, would this address your comment?</span><br></pre></td></tr></table></figure>

<p>而linus的回复是，如果不用这么复杂的会引起内存分配的调用，用一个简单的机制来避免这个问题发生感觉更好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">So instead of having virtio_balloon_send_free_pages() call a really</span><br><span class="line">generic complex chain of functions that in _some_ cases can do memory</span><br><span class="line">allocation, why isn&#39;t there a short-circuited &quot;vitruque_add_datum()&quot;</span><br><span class="line">that is guaranteed to never do anything like that?</span><br></pre></td></tr></table></figure>

<p>中间还有很长的一些简化代码的建议，里面有这么一句话，评价这部分代码太复杂并且太脆弱了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The whole sequence of events really looks &quot;this is too much</span><br><span class="line">complexity, and way too fragile&quot; to me at so many levels.</span><br></pre></td></tr></table></figure>

<p>让我联想到目前ZStack里面一些功能的实现逻辑存在情况</p>
<ol>
<li>实现了机制B解决机制A的问题</li>
<li>复用了，不熟悉的机制A，忽略了A本身存在的问题</li>
</ol>
<p>结合一个实际功能说一下这个问题，比如vm的kernel panic检测，有两个必要选项</p>
<ol>
<li>给vm增加一个pvpanic的xml配置</li>
<li>虚拟机内部需要启用内核pvpanic模块</li>
</ol>
<p>因此这个功能实现需要guest和host相互配合才能判定是否可用</p>
<p>基于这个前提，guest内部的逻辑需要提供传递guest内部是否支持pvpanic的信息，host上需要从配置中获取是否配置过pvpanic，因此实现这个逻辑的时候需要分别查询这两个信息。而查询host上的配置最终导致了一些控制面的bug。</p>
<p>后来反思这个问题的时候，只从host配置获取的逻辑出发，但是忽略了运行时配置不会变更的前提，其实并没有必要增加一个多余的查询逻辑，反而导致这个问题依赖了已有的配置查询机制，最终引起了更复杂的现象。</p>
<p>kernel的开源世界也会有人碰到这样的问题，所以整理好功能设计的方法论还是很重要的，至少能够指导怎么做能设计的更好，提升committer和coder的水平。</p>
<p>反过来想想：</p>
<ol>
<li>guest tool在运行时返回的云主机所支持的特性，实际上总是和他的版本绑定的，只要获取过一次其实就不需要反复获取了。</li>
<li>如果guest tool版本发生了变化，才需要重新获取这个信息</li>
<li>提供主动更新guest tool特性的功能即可</li>
</ol>
<p>其实这样拆解这个问题，云主机其实本身就应该保存这些特性信息而不需要总是去获取，这样机制的设计可以简化很多。</p>
<p>而之前的设计出发点并不是基于对整个功能的理解，而是类似新增 <code>GFP_NONE</code> 来解决问题的思路。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/04/guest-free-page-hinting-notes-01/" data-id="cld1mhea8000cyuwbca2qgz2p" data-title="Guest Free Page Hinting notes 01" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/04/guest-free-page-hinting-notes-01/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/04/guest-free-page-hinting-notes-01/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-java-class-getname-and-getsimplename-get-me-confuse" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" class="article-date">
  <time class="dt-published" datetime="2022-09-04T13:37:27.000Z" itemprop="datePublished">2022-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/">Java Class getName() vs getSimpleName()</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Work with Java reflection and invoke getSimpleName() met <code>java.lang.NoClassDefFoundError</code></p>
<p>Use getName() instead, the logic seems work well.</p>
<p>Before compare these two methods’ difference go through the code quickly.</p>
<h2 id="Class-getName"><a href="#Class-getName" class="headerlink" title="Class::getName()"></a>Class::getName()</h2><p>for getName()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public String getName() &#123;</span><br><span class="line">    String name &#x3D; this.name;</span><br><span class="line">    if (name &#x3D;&#x3D; null)</span><br><span class="line">        this.name &#x3D; name &#x3D; getName0();</span><br><span class="line">    return name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and the getName0() is native method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native String getName0();</span><br></pre></td></tr></table></figure>



<h2 id="Class-getSimpleName"><a href="#Class-getSimpleName" class="headerlink" title="Class::getSimpleName()"></a>Class::getSimpleName()</h2><p>for getSimpleName()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public String getSimpleName() &#123;</span><br><span class="line">    if (isArray())</span><br><span class="line">        return getComponentType().getSimpleName()+&quot;[]&quot;;</span><br><span class="line"></span><br><span class="line">    String simpleName &#x3D; getSimpleBinaryName();</span><br><span class="line">    if (simpleName &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; top level class</span><br><span class="line">        simpleName &#x3D; getName();</span><br><span class="line">        return simpleName.substring(simpleName.lastIndexOf(&quot;.&quot;)+1); &#x2F;&#x2F; strip the package name</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; According to JLS3 &quot;Binary Compatibility&quot; (13.1) the binary</span><br><span class="line">    &#x2F;&#x2F; name of non-package classes (not top level) is the binary</span><br><span class="line">    &#x2F;&#x2F; name of the immediately enclosing class followed by a &#39;$&#39; followed by:</span><br><span class="line">    &#x2F;&#x2F; (for nested and inner classes): the simple name.</span><br><span class="line">    &#x2F;&#x2F; (for local classes): 1 or more digits followed by the simple name.</span><br><span class="line">    &#x2F;&#x2F; (for anonymous classes): 1 or more digits.</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Since getSimpleBinaryName() will strip the binary name of</span><br><span class="line">    &#x2F;&#x2F; the immediatly enclosing class, we are now looking at a</span><br><span class="line">    &#x2F;&#x2F; string that matches the regular expression &quot;\$[0-9]*&quot;</span><br><span class="line">    &#x2F;&#x2F; followed by a simple name (considering the simple of an</span><br><span class="line">    &#x2F;&#x2F; anonymous class to be the empty string).</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Remove leading &quot;\$[0-9]*&quot; from the name</span><br><span class="line">    int length &#x3D; simpleName.length();</span><br><span class="line">    if (length &lt; 1 || simpleName.charAt(0) !&#x3D; &#39;$&#39;)</span><br><span class="line">        throw new InternalError(&quot;Malformed class name&quot;);</span><br><span class="line">    int index &#x3D; 1;</span><br><span class="line">    while (index &lt; length &amp;&amp; isAsciiDigit(simpleName.charAt(index)))</span><br><span class="line">        index++;</span><br><span class="line">    &#x2F;&#x2F; Eventually, this is the empty string iff this is an anonymous class</span><br><span class="line">    return simpleName.substring(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The main part is </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String simpleName &#x3D; getSimpleBinaryName();</span><br></pre></td></tr></table></figure>

<p>And then get enclosingClass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private String getSimpleBinaryName() &#123;</span><br><span class="line">    Class&lt;?&gt; enclosingClass &#x3D; getEnclosingClass();</span><br><span class="line">    if (enclosingClass &#x3D;&#x3D; null) &#x2F;&#x2F; top level class</span><br><span class="line">        return null;</span><br><span class="line">    &#x2F;&#x2F; Otherwise, strip the enclosing class&#39; name</span><br><span class="line">    try &#123;</span><br><span class="line">        return getName().substring(enclosingClass.getName().length());</span><br><span class="line">    &#125; catch (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">        throw new InternalError(&quot;Malformed class name&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>what is enclosingClass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; There are five kinds of classes (or interfaces):</span><br><span class="line">&#x2F;&#x2F; a) Top level classes</span><br><span class="line">&#x2F;&#x2F; b) Nested classes (static member classes)</span><br><span class="line">&#x2F;&#x2F; c) Inner classes (non-static member classes)</span><br><span class="line">&#x2F;&#x2F; d) Local classes (named classes declared within a method)</span><br><span class="line">&#x2F;&#x2F; e) Anonymous classes</span><br></pre></td></tr></table></figure>

<p>in my case it tend to be a) Top level classes, so next part of code goes to getDeclaringClass()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; JVM Spec 4.8.6: A class must have an EnclosingMethod</span><br><span class="line">&#x2F;&#x2F; attribute if and only if it is a local class or an</span><br><span class="line">&#x2F;&#x2F; anonymous class.</span><br><span class="line">EnclosingMethodInfo enclosingInfo &#x3D; getEnclosingMethodInfo();</span><br><span class="line">Class&lt;?&gt; enclosingCandidate;</span><br><span class="line"></span><br><span class="line">if (enclosingInfo &#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; This is a top level or a nested class or an inner class (a, b, or c)</span><br><span class="line">    enclosingCandidate &#x3D; getDeclaringClass();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Class&lt;?&gt; enclosingClass &#x3D; enclosingInfo.getEnclosingClass();</span><br><span class="line">    &#x2F;&#x2F; This is a local class or an anonymous class (d or e)</span><br><span class="line">    if (enclosingClass &#x3D;&#x3D; this || enclosingClass &#x3D;&#x3D; null)</span><br><span class="line">        throw new InternalError(&quot;Malformed enclosing method information&quot;);</span><br><span class="line">    else</span><br><span class="line">        enclosingCandidate &#x3D; enclosingClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>and then getDeclaringClass0() will be used.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@CallerSensitive</span><br><span class="line">public Class&lt;?&gt; getDeclaringClass() throws SecurityException &#123;</span><br><span class="line">    final Class&lt;?&gt; candidate &#x3D; getDeclaringClass0();</span><br><span class="line"></span><br><span class="line">    if (candidate !&#x3D; null)</span><br><span class="line">        candidate.checkPackageAccess(</span><br><span class="line">                ClassLoader.getClassLoader(Reflection.getCallerClass()), true);</span><br><span class="line">    return candidate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>which is a native method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native Class&lt;?&gt; getDeclaringClass0();</span><br></pre></td></tr></table></figure>



<h2 id="Comparision"><a href="#Comparision" class="headerlink" title="Comparision"></a>Comparision</h2><p>From the code before this section, aboveously the getSimpleName() always call native method but getName() may use Class’s local variable directly. </p>
<p>So see the local variable before we come to conclusion.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; cache the name to reduce the number of calls into the VM</span><br><span class="line">private transient String name;</span><br></pre></td></tr></table></figure>

<p>the name used by getName() use a transient String as cache to reduce the number of calls into VM.</p>
<p>And combine to getName()’s implement, the first time getName0() invoked, this name is set.</p>
<p>And go for Java doc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String getSimpleName()</span><br></pre></td></tr></table></figure>

<p>Returns the simple name of the underlying class as given in the source code. Returns an empty string if the underlying class is anonymous.</p>
<p>The simple name of an array is the simple name of the component type with “[]” appended. In particular the simple name of an array whose component type is anonymous is “[]”.</p>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the simple name of the underlying class</p>
</li>
<li><p><strong>Since:</strong></p>
<p>1.5</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String getName()</span><br></pre></td></tr></table></figure>

<p>Returns the name of the entity (class, interface, array class, primitive type, or void) represented by this <code>Class</code> object, as a <code>String</code>.</p>
<p>If this class object represents a reference type that is not an array type then the binary name of the class is returned, as specified by The Java™ Language Specification.</p>
<p>If this class object represents a primitive type or void, then the name returned is a <code>String</code> equal to the Java language keyword corresponding to the primitive type or void.</p>
<p>If this class object represents a class of arrays, then the internal form of the name consists of the name of the element type preceded by one or more ‘<code>[</code>‘ characters representing the depth of the array nesting. The encoding of element type names is as follows:</p>
<blockquote>
<table>
<thead>
<tr>
<th>Element Type</th>
<th></th>
<th>Encoding</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td></td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td></td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td></td>
<td>C</td>
</tr>
<tr>
<td>class or interface</td>
<td></td>
<td>L<em>classname</em>;</td>
</tr>
<tr>
<td>double</td>
<td></td>
<td>D</td>
</tr>
<tr>
<td>float</td>
<td></td>
<td>F</td>
</tr>
<tr>
<td>int</td>
<td></td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td></td>
<td>J</td>
</tr>
<tr>
<td>short</td>
<td></td>
<td>S</td>
</tr>
</tbody></table>
</blockquote>
<p>The class or interface name <em>classname</em> is the binary name of the class specified above.</p>
<p>Examples:</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String.class.getName()</span><br><span class="line">  returns &quot;java.lang.String&quot;</span><br><span class="line">byte.class.getName()</span><br><span class="line">  returns &quot;byte&quot;</span><br><span class="line">(new Object[3]).getClass().getName()</span><br><span class="line">  returns &quot;[Ljava.lang.Object;&quot;</span><br><span class="line">(new int[3][4][5][6][7][8][9]).getClass().getName()</span><br><span class="line">  returns &quot;[[[[[[[I&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the name of the class or interface represented by this object.</p>
</li>
</ul>
<p>and more details for the error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class NoClassDefFoundError</span><br><span class="line">extends LinkageError</span><br></pre></td></tr></table></figure>

<p>Thrown if the Java Virtual Machine or a <code>ClassLoader</code> instance tries to load in the definition of a class (as part of a normal method call or as part of creating a new instance using the <code>new</code> expression) and no definition of the class could be found.</p>
<p>The searched-for class definition existed when the currently executing class was compiled, but the definition can no longer be found.</p>
<p>So that means class found at compile time but not available at runtime <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17973970/how-to-solve-java-lang-noclassdeffounderror">Refer this link</a></p>
<p>Check for our configuration: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;xxx&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xxx&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.1&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;scope&gt;system&lt;&#x2F;scope&gt;</span><br><span class="line">    &lt;systemPath&gt;$&#123;project.basedir&#125;&#x2F;ext-libs&#x2F;xxx&lt;&#x2F;systemPath&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>use a system scope.</p>
<p>According to maven doc:</p>
<p>There are 6 scopes:</p>
<ul>
<li><strong>compile</strong><br>This is the default scope, used if none is specified. Compile dependencies are available in all classpaths of a project. Furthermore, those dependencies are propagated to dependent projects.</li>
<li><strong>provided</strong><br>This is much like <code>compile</code>, but indicates you expect the JDK or a container to provide the dependency at runtime. For example, when building a web application for the Java Enterprise Edition, you would set the dependency on the Servlet API and related Java EE APIs to scope <code>provided</code> because the web container provides those classes. A dependency with this scope is added to the classpath used for compilation and test, but not the runtime classpath. It is not transitive.</li>
<li><strong>runtime</strong><br>This scope indicates that the dependency is not required for compilation, but is for execution. Maven includes a dependency with this scope in the runtime and test classpaths, but not the compile classpath.</li>
<li><strong>test</strong><br>This scope indicates that the dependency is not required for normal use of the application, and is only available for the test compilation and execution phases. This scope is not transitive. Typically this scope is used for test libraries such as JUnit and Mockito. It is also used for non-test libraries such as Apache Commons IO if those libraries are used in unit tests (src/test/java) but not in the model code (src/main/java).</li>
<li><strong>system</strong><br>This scope is similar to <code>provided</code> except that you have to provide the JAR which contains it explicitly. The artifact is always available and is not looked up in a repository.</li>
<li><strong>import</strong><br>This scope is only supported on a dependency of type <code>pom</code> in the <code>&lt;dependencyManagement&gt;</code> section. It indicates the dependency is to be replaced with the effective list of dependencies in the specified POM’s <code>&lt;dependencyManagement&gt;</code> section. Since they are replaced, dependencies with a scope of <code>import</code> do not actually participate in limiting the transitivity of a dependency.</li>
</ul>
<p>system most like provided but <code>a dependency with this scope is added to the classpath used for compilation and test, but not the runtime classpath</code></p>
<p>so runtime getSimpleName() will met exception.</p>
<h2 id="Class-loader"><a href="#Class-loader" class="headerlink" title="Class loader"></a>Class loader</h2><p>get back to the error call trace again:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.NoClassDefFoundError: xxxxx</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.Class.getDeclaringClass0(Native Method) ~[?:1.8.0_161]</span><br></pre></td></tr></table></figure>

<p>and another class not found exception:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.ClassNotFoundException: xxxxx</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:381) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.Class.getDeclaringClass0(Native Method) ~[?:1.8.0_161]</span><br></pre></td></tr></table></figure>

<p>when try to get simple name of class A extends B</p>
<p>find A and try to define A but need to define B first, but B is not available at runtime so a exception raised.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" data-id="cld1mheac000jyuwb7lxm4rbw" data-title="Java Class getName() vs getSimpleName()" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Dive-into-edk2-ovmf-fisrt-debug-trip" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" class="article-date">
  <time class="dt-published" datetime="2022-07-27T12:02:47.000Z" itemprop="datePublished">2022-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/">Dive into edk2-ovmf fisrt debug trip</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Prepare-environment"><a href="#Prepare-environment" class="headerlink" title="Prepare environment"></a>Prepare environment</h2><p>install compiler related rpm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo=* --enablerepo=ali* install -y make gcc binutils iasl nasm libuuid-devel gcc-c++</span><br></pre></td></tr></table></figure>

<p>if cross-build firmware on x86 machine, install cross compilers:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo=* --enablerepo=ali* install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnu</span><br></pre></td></tr></table></figure>

<p>get source code</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tianocore/edk2.git</span><br><span class="line">cd edk2</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure>

<p>than setup environment variables:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source edksetup.sh</span><br></pre></td></tr></table></figure>

<p>build base tools at first:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C BaseTools</span><br></pre></td></tr></table></figure>

<p>note: only need once</p>
<h2 id="Build-firmware"><a href="#Build-firmware" class="headerlink" title="Build firmware"></a>Build firmware</h2><p>Then build firmware for x64 qemu:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a X64 -p OvmfPkg/OvmfPkgX64.dsc</span><br></pre></td></tr></table></figure>

<p>The firmware volumes built can be found in <code>Build/OvmfX64/DEBUG_GCC5/FV</code>.</p>
<p>Building the aarch64 firmware instead:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a AARCH64 -p ArmVirtPkg/ArmVirtQemu.dsc</span><br></pre></td></tr></table></figure>

<p>The build results land in <code>Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV</code>.</p>
<p>Qemu expects the aarch64 firmware images being 64M im size. The firmware images can’t be used as-is because of that, some padding is needed to create an image which can be used for pflash:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dd of=&quot;QEMU_EFI-pflash.raw&quot; if=&quot;/dev/zero&quot; bs=1M count=64</span><br><span class="line">dd of=&quot;QEMU_EFI-pflash.raw&quot; if=&quot;QEMU_EFI.fd&quot; conv=notrunc</span><br><span class="line">dd of=&quot;QEMU_VARS-pflash.raw&quot; if=&quot;/dev/zero&quot; bs=1M count=64</span><br><span class="line">dd of=&quot;QEMU_VARS-pflash.raw&quot; if=&quot;QEMU_VARS.fd&quot; conv=notrunc</span><br></pre></td></tr></table></figure>

<p>There are a bunch of compile time options, typically enabled using <code>-D NAME</code> or <code>-D NAME=TRUE</code>. Options which are enabled by default can be turned off using <code>-D NAME=FALSE</code>. Available options are defined in the <code>*.dsc</code> files referenced by the <code>build</code> command. So a feature-complete build looks more like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a X64 -p OvmfPkg/OvmfPkgX64.dsc \</span><br><span class="line">    -D FD_SIZE_4MB \</span><br><span class="line">    -D NETWORK_IP6_ENABLE \</span><br><span class="line">    -D NETWORK_HTTP_BOOT_ENABLE \</span><br><span class="line">    -D NETWORK_TLS_ENABLE \</span><br><span class="line">    -D TPM2_ENABLE</span><br></pre></td></tr></table></figure>

<p>From <code>OvmfPkgX64.dsc</code> lots of features is defined.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  #</span><br><span class="line">  # Network definition</span><br><span class="line">  #</span><br><span class="line">  DEFINE NETWORK_TLS_ENABLE             &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_IP6_ENABLE             &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_HTTP_BOOT_ENABLE       &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_ALLOW_HTTP_CONNECTIONS &#x3D; TRUE</span><br><span class="line">  DEFINE NETWORK_ISCSI_ENABLE           &#x3D; TRUE</span><br><span class="line"></span><br><span class="line">!include NetworkPkg&#x2F;NetworkDefines.dsc.inc</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  # Device drivers</span><br><span class="line">  #</span><br><span class="line">  DEFINE PVSCSI_ENABLE           &#x3D; TRUE</span><br><span class="line">  DEFINE MPT_SCSI_ENABLE         &#x3D; TRUE</span><br><span class="line">  DEFINE LSI_SCSI_ENABLE         &#x3D; FALSE</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  # Flash size selection. Setting FD_SIZE_IN_KB on the command line directly to</span><br><span class="line">  # one of the supported values, in place of any of the convenience macros, is</span><br><span class="line">  # permitted.</span><br><span class="line">  #</span><br><span class="line">!ifdef $(FD_SIZE_1MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 1024</span><br><span class="line">!else</span><br><span class="line">!ifdef $(FD_SIZE_2MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 2048</span><br><span class="line">!else</span><br><span class="line">!ifdef $(FD_SIZE_4MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 4096</span><br><span class="line">!else</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 4096</span><br></pre></td></tr></table></figure>

<p>Secure boot support (on x64) requires SMM mode. Well, it builds and works without SMM, but it’s not secure then. Without SMM nothing prevents the guest OS writing directly to flash, bypassing the firmware, so protected UEFI variables are not actually protected.</p>
<p>Also suspend (S3) support works with enabled SMM only in case parts of the firmware (PEI specifically, see below for details) run in 32bit mode. So the secure boot variant must be compiled this way:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a IA32 -a X64 -p OvmfPkg/OvmfPkgIa32X64.dsc \</span><br><span class="line">    -D FD_SIZE_4MB \</span><br><span class="line">    -D SECURE_BOOT_ENABLE \</span><br><span class="line">    -D SMM_REQUIRE \</span><br><span class="line">    [ ... add network + tpm + other options as needed ... ]</span><br></pre></td></tr></table></figure>

<p>The <code>FD_SIZE_4MB</code> option creates a larger firmware image, being 4MB instead of 2MB (default) in size, offering more space for both code and vars. The RHEL/CentOS builds use that. The Fedora builds are 2MB in size, for historical reasons.</p>
<p>If you need 32-bit firmware builds for some reason, here is how to do it:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a ARM -p ArmVirtPkg/ArmVirtQemu.dsc</span><br><span class="line">build -t GCC5 -a IA32 -p OvmfPkg/OvmfPkgIa32.dsc</span><br></pre></td></tr></table></figure>

<p>The build results will be in in <code>Build/ArmVirtQemu-ARM/DEBUG_GCC5/FV</code> and <code>Build/OvmfIa32/DEBUG_GCC5/FV</code></p>
<h3 id="Booting-fresh-firmware-builds"><a href="#Booting-fresh-firmware-builds" class="headerlink" title="Booting fresh firmware builds"></a>Booting fresh firmware builds</h3><p>The x86 firmware builds create three different images:</p>
<ul>
<li><p><code>OVMF_VARS.fd</code></p>
<p>This is the firmware volume for persistent UEFI variables, i.e. where the firmware stores all configuration (boot entries and boot order, secure boot keys, …). Typically this is used as template for an empty variable store and each VM gets its own private copy, libvirt for example stores them in <code>/var/lib/libvirt/qemu/nvram</code>.</p>
</li>
<li><p><code>OVMF_CODE.fd</code></p>
<p>This is the firmware volume with the code. Separating this from VARS does (a) allow for easy firmware updates, and (b) allows to map the code read-only into the guest.</p>
</li>
<li><p><code>OVMF.fd</code></p>
<p>The all-in-one image with both <code>CODE</code> and <code>VARS</code>. This can be loaded as ROM using <code>-bios</code>, with two drawbacks: (a) UEFI variables are not persistent, and (b) it does not work for <code>SMM_REQUIRE=TRUE</code> builds.</p>
</li>
</ul>
<p>qemu handles pflash storage as block devices, so we have to create block devices for the firmware images:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CODE=$&#123;WORKSPACE&#125;/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd</span><br><span class="line">VARS=$&#123;WORKSPACE&#125;/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_VARS.fd</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -blockdev node-name=code,driver=file,filename=$&#123;CODE&#125;,read-only=on \</span><br><span class="line">  -blockdev node-name=vars,driver=file,filename=$&#123;VARS&#125;,snapshot=on \</span><br><span class="line">  -machine q35,pflash0=code,pflash1=vars \</span><br><span class="line">  [ ... ]</span><br></pre></td></tr></table></figure>

<p>Here is the arm version of that (using the padded files created using <code>dd</code>, see above):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CODE=$&#123;WORKSPACE&#125;/Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV/QEMU_EFI-pflash.raw</span><br><span class="line">VARS=$&#123;WORKSPACE&#125;/Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV/QEMU_VARS-pflash.raw</span><br><span class="line">qemu-system-aarch64 \</span><br><span class="line">  -blockdev node-name=code,driver=file,filename=$&#123;CODE&#125;,read-only=on \</span><br><span class="line">  -blockdev node-name=vars,driver=file,filename=$&#123;VARS&#125;,snapshot=on \</span><br><span class="line">  -machine virt,pflash0=code,pflash1=vars \</span><br><span class="line">  [ ... ]</span><br></pre></td></tr></table></figure>

<h3 id="Source-code-structure"><a href="#Source-code-structure" class="headerlink" title="Source code structure"></a>Source code structure</h3><p>The core edk2 repo holds a number of packages, each package has its own toplevel directory. Here are the most interesting ones:</p>
<ul>
<li><p>OvmfPkg</p>
<p>This holds both the x64-specific code (i.e. OVMF itself) and virtualization-specific code shared by all architectures (virtio drivers).</p>
</li>
<li><p>ArmVirtPkg</p>
<p>Arm specific virtual machine support code.</p>
</li>
<li><p>MdePkg, MdeModulePkg</p>
<p>Most core code is here (PCI support, USB support, generic services and drivers, …).</p>
</li>
<li><p>PcAtChipsetPkg</p>
<p>Some Intel architecture drivers and libs.</p>
</li>
<li><p>ArmPkg, ArmPlatformPkg</p>
<p>Common Arm architecture support code.</p>
</li>
<li><p>CryptoPkg, NetworkPkg, FatPkg, CpuPkg, …</p>
<p>As the names of the packages already suggest: Crypto support (using openssl), Network support (including network boot), FAT Filesystem driver, …</p>
</li>
</ul>
<h3 id="Firmware-boot-phases"><a href="#Firmware-boot-phases" class="headerlink" title="Firmware boot phases"></a>Firmware boot phases</h3><p>The firmware modules in the edk2 repo often named after the boot phase they are running in. Most drivers are named <code>SomeThing**Dxe**</code> for example.</p>
<ul>
<li><p>ResetVector</p>
<p>This is where code execution starts after a machine reset. The code will do the bare minimum needed to enter SEC. On x64 the most important step is the transition from 16-bit real mode to 32-bit mode or 64bit long mode.</p>
</li>
<li><p>SEC (Security)</p>
<p>This code typically loads and uncompresses the code for PEI and SEC. On physical hardware SEC often lives in ROM memory and can not be updated. The PEI and DXE firmware volumes are loaded from (updateable) flash.</p>
<p>With OVMF both SEC firmware volume and the compressed volume holding PXE and DXE code are part of the OVMF_CODE image and will simply be mapped into guest memory.</p>
</li>
<li><p>PEI (Pre-EFI Initialization)</p>
<p>Platform Initialization is done here. Initialize the chipset. Not much to do here in virtual machines, other than loading the x64 e820 memory map (via fw_cfg) from qemu, or get the memory map from the device tree (on aarch64). The virtual hardware is ready-to-go without much extra preaparation.</p>
<p>PEIMs (PEI Modules) can implement functionality which must be executed before entering the DXE phase. This includes security-sensitive things like initializing SMM mode and locking down flash memory.</p>
</li>
<li><p>DXE (Driver Execution Environment)</p>
<p>When PEI is done it hands over control to the full EFI environment contained in the DXE firmware volume. Most code is here. All kinds of drivers. the firmware setup efi app, …</p>
<p>Strictly speaking this isn’t only one phase. The code for all phases after PEI is part of the DXE firmware volume though.</p>
</li>
</ul>
<h2 id="Add-debug-to-EDK2"><a href="#Add-debug-to-EDK2" class="headerlink" title="Add debug to EDK2"></a>Add debug to EDK2</h2><p>The default OVMF build writes debug messages to IO port 0x402.  The following qemu command line options save them in the file called debug.log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-debugcon file:debug.log -global isa-debugcon.iobase=0x402</span><br></pre></td></tr></table></figure>

<p>Or with build option</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D DEBUG_ON_SERIAL_PORT</span><br></pre></td></tr></table></figure>

<p>serial output can be captured</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-serial file:serial.log</span><br></pre></td></tr></table></figure>

<p>note:</p>
<p>The RELEASE build target (‘-b RELEASE’ build option, see below) disables all debug messages.  The default build target is DEBUG.</p>
<p>more build scripts:</p>
<p>On systems with the bash shell you can use OvmfPkg/build.sh to simplify<br>building and running OVMF.</p>
<p>So, for example, to build + run OVMF X64:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a X64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a X64 qemu</span></span><br></pre></td></tr></table></figure>

<p>And to run a 64-bit UEFI bootable ISO image:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ OvmfPkg/build.sh -a X64 qemu -cdrom /path/to/disk-image.iso</span><br></pre></td></tr></table></figure>

<p>To build a 32-bit OVMF without debug messages using GCC 4.8:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a IA32 -b RELEASE -t GCC48</span></span><br></pre></td></tr></table></figure>



<h2 id="UEFI-Windows-7-amp-Windows-2008-Server"><a href="#UEFI-Windows-7-amp-Windows-2008-Server" class="headerlink" title="UEFI Windows 7 &amp; Windows 2008 Server"></a>UEFI Windows 7 &amp; Windows 2008 Server</h2><ul>
<li>One of the ‘-vga std’ and ‘-vga qxl’ QEMU options should be used.</li>
<li>Only one video mode, 1024x768x32, is supported at OS runtime.</li>
<li>The ‘-vga qxl’ QEMU option is recommended. After booting the installed guest OS, select the video card in Device Manager, and upgrade its driver to the QXL XDDM one. Download location:  <a target="_blank" rel="noopener" href="http://www.spice-space.org/download.html">http://www.spice-space.org/download.html</a>, Guest | Windows binaries. This enables further resolutions at OS runtime, and provides S3  (suspend/resume) capability.</li>
</ul>
<h2 id="Debug-in-practice"><a href="#Debug-in-practice" class="headerlink" title="Debug in practice"></a>Debug in practice</h2><h3 id="Test-with-qemu-commandline"><a href="#Test-with-qemu-commandline" class="headerlink" title="Test with qemu commandline"></a>Test with qemu commandline</h3><p>add with config in libvirt vm xml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;qemu:commandline&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;-debugcon&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;file:&#x2F;var&#x2F;log&#x2F;libvirt&#x2F;qemu&#x2F;debug.log&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;-global&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;isa-debugcon.iobase&#x3D;0x402&#39;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;qemu:commandline&gt;</span><br></pre></td></tr></table></figure>

<p>debug log will be found in <code>/var/log/libvirt/qemu/debug.log</code></p>
<p>before we met Win2012 internal reboot issue, use debug to check what happen, the log repeat following lines but guest seems hang on vnc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Register PPI Notify: DCD0BE23-9586-40F4-B643-06522CED4EDE</span><br><span class="line">Install PPI: 8C8CE578-8A3D-4F1C-9935-896185C32DD3</span><br><span class="line">Install PPI: 5473C07A-3DCB-4DCA-BD6F-1E9689E7349A</span><br><span class="line">The 0th FV start address is 0x00000820000, size is 0x000E0000, handle is 0x820000</span><br><span class="line">Register PPI Notify: 49EDB1C1-BF21-4761-BB12-EB0031AABB39</span><br><span class="line">Register PPI Notify: EA7CA24B-DED5-4DAD-A389-BF827E8F9B38</span><br><span class="line">Install PPI: B9E0ABFE-5979-4914-977F-6DEE78C278A6</span><br><span class="line">Install PPI: DBE23AA9-A345-4B97-85B6-B226F1617389</span><br><span class="line">DiscoverPeimsAndOrderWithApriori(): Found 0xB PEI FFS files in the 0th FV</span><br><span class="line">Loading PEIM 9B3ADA4F-AE56-4C24-8DEA-F03B7558AE50</span><br><span class="line">Loading PEIM at 0x0000082BE40 EntryPoint&#x3D;0x0000082F201 PcdPeim.efi</span><br><span class="line">Install PPI: 06E81C58-4AD7-44BC-8390-F10265F72480</span><br><span class="line">Install PPI: 01F34D25-4DE2-23AD-3FF3-36353FF323F1</span><br><span class="line">Install PPI: 4D8B155B-C059-4C8F-8926-06FD4331DB8A</span><br><span class="line">Install PPI: A60C6B59-E459-425D-9C69-0BCC9CB27D81</span><br><span class="line">Register PPI Notify: 605EA650-C65C-42E1-BA80-91A52AB618C6</span><br><span class="line">Loading PEIM A3610442-E69F-4DF3-82CA-2360C4031A23</span><br><span class="line">Loading PEIM at 0x00000830B40 EntryPoint&#x3D;0x00000831F5F ReportStatusCodeRouterPei.efi</span><br><span class="line">Install PPI: 0065D394-9951-4144-82A3-0AFC8579C251</span><br><span class="line">Install PPI: 229832D3-7A30-4B36-B827-F40CB7D45436</span><br><span class="line">Loading PEIM 9D225237-FA01-464C-A949-BAABC02D31D0</span><br><span class="line">Loading PEIM at 0x00000832B40 EntryPoint&#x3D;0x00000833D89 StatusCodeHandlerPei.efi</span><br><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A6DF PlatformPei.efi</span><br><span class="line">Select Item: 0x0</span><br><span class="line">FW CFG Signature: 0x554D4551</span><br><span class="line">Select Item: 0x1</span><br><span class="line">FW CFG Revision: 0x3</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)</span><br><span class="line">SEC: Normal boot</span><br><span class="line">DecompressMemFvs: OutputBuffer@A00000+0xCE0090 ScratchBuffer@1700000+0x10000 PcdOvmfDecompressionScratchEnd&#x3D;0x1710000</span><br></pre></td></tr></table></figure>

<p>track the log to edk2 code, the entry seems start at:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the PEI Core entry point address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in,out]  Fv                 The firmware volume to search</span></span><br><span class="line"><span class="comment">  @param[out]     PeiCoreEntryPoint  The entry point of the PEI Core image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">VOID</span><br><span class="line">FindPeiCoreImageBase (</span><br><span class="line">  IN OUT  EFI_FIRMWARE_VOLUME_HEADER       **BootFv,</span><br><span class="line">     OUT  EFI_PHYSICAL_ADDRESS             *PeiCoreImageBase</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  BOOLEAN S3Resume;</span><br><span class="line"></span><br><span class="line">  *PeiCoreImageBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  S3Resume = IsS3Resume ();</span><br><span class="line">  <span class="keyword">if</span> (S3Resume &amp;&amp; !FeaturePcdGet (PcdSmmSmramRequire)) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// A malicious runtime OS may have injected something into our previously</span></span><br><span class="line">    <span class="comment">// decoded PEI FV, but we don&#x27;t care about that unless SMM/SMRAM is required.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((DEBUG_VERBOSE, <span class="string">&quot;SEC: S3 resume\n&quot;</span>));</span><br><span class="line">    GetS3ResumePeiFv (BootFv);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We&#x27;re either not resuming, or resuming &quot;securely&quot; -- we&#x27;ll decompress</span></span><br><span class="line">    <span class="comment">// both PEI FV and DXE FV from pristine flash.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((DEBUG_VERBOSE, <span class="string">&quot;SEC: %a\n&quot;</span>,</span><br><span class="line">      S3Resume ? <span class="string">&quot;S3 resume (with PEI decompression)&quot;</span> : <span class="string">&quot;Normal boot&quot;</span>));</span><br><span class="line">    FindMainFv (BootFv);</span><br><span class="line"></span><br><span class="line">    DecompressMemFvs (BootFv);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FindPeiCoreImageBaseInFv (*BootFv, PeiCoreImageBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and if not IsS3Resume and not SMM required, VM will use S3 resume but in our situation vm go throught Normal boot.</p>
<p>Than locates the comparessed main firmware volume <code>/usr/share/edk2/ovmf/OVMF_CODE.cc.fd</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the compressed main firmware volume and decompresses it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in,out]  Fv            On input, the firmware volume to search</span></span><br><span class="line"><span class="comment">                                On output, the decompressed BOOT/PEI FV</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">EFI_STATUS</span><br><span class="line">DecompressMemFvs (</span><br></pre></td></tr></table></figure>

<p>Next step is still find PEI core entry address, EFI_SECTION_PE32 and EFI_SECTION_TE will be used to find entry address</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the PEI Core entry point address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in]  Fv                 The firmware volume to search</span></span><br><span class="line"><span class="comment">  @param[out] PeiCoreEntryPoint  The entry point of the PEI Core image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">EFI_STATUS</span><br><span class="line">FindPeiCoreImageBaseInFv (</span><br><span class="line">  IN  EFI_FIRMWARE_VOLUME_HEADER       *Fv,</span><br><span class="line">  OUT  EFI_PHYSICAL_ADDRESS             *PeiCoreImageBase</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  EFI_STATUS                  Status;</span><br><span class="line">  EFI_COMMON_SECTION_HEADER   *Section;</span><br><span class="line"></span><br><span class="line">  Status = FindFfsFileAndSection (</span><br><span class="line">             Fv,</span><br><span class="line">             EFI_FV_FILETYPE_PEI_CORE,</span><br><span class="line">             EFI_SECTION_PE32,</span><br><span class="line">             &amp;Section</span><br><span class="line">             );</span><br><span class="line">  <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">    Status = FindFfsFileAndSection (</span><br><span class="line">               Fv,</span><br><span class="line">               EFI_FV_FILETYPE_PEI_CORE,</span><br><span class="line">               EFI_SECTION_TE,</span><br><span class="line">               &amp;Section</span><br><span class="line">               );</span><br><span class="line">    <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">      DEBUG ((DEBUG_ERROR, <span class="string">&quot;Unable to find PEI Core image\n&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *PeiCoreImageBase = (EFI_PHYSICAL_ADDRESS)(UINTN)(Section + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> EFI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is the last step of find PEI Core image.</p>
<p>Back to where FindPeiCoreImageBase’s code path, we can find SecCoreStartupWithStack is the start function which is used in <code>OvmfPkg/Sec/X64/SecEntry.nasm </code></p>
<p>SecCoreStartupWithStack -&gt; SecStartupPhase2 -&gt; FindAndReportEntryPoints -&gt; FindPeiCoreImageBase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">;</span><br><span class="line">; Setup parameters and call SecCoreStartupWithStack</span><br><span class="line">;   rcx: BootFirmwareVolumePtr</span><br><span class="line">;   rdx: TopOfCurrentStack</span><br><span class="line">;</span><br><span class="line">mov     rcx, rbp</span><br><span class="line">mov     rdx, rsp</span><br><span class="line">sub     rsp, 0x20</span><br><span class="line">call    ASM_PFX(SecCoreStartupWithStack)</span><br></pre></td></tr></table></figure>

<p>combine with log, before next SecCoreStartupWithStack invoking:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)^M</span><br></pre></td></tr></table></figure>

<p>Select Item is printed. </p>
<p>Because FV is successfully loaded:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The 0th FV start address is 0x00000820000, size is 0x000E0000, handle is 0x820000</span><br></pre></td></tr></table></figure>

<p>And compare to first boot:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A6DF PlatformPei.efi^M</span><br><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">QemuFwCfg interface (DMA) is supported.^M</span><br><span class="line">Platform PEIM Loaded^M</span><br></pre></td></tr></table></figure>

<p>It seems Platform PEIM not loaded correctly.</p>
<p>Check QemuFwCfg related code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">RETURN_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgInitialize (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 Signature;</span><br><span class="line">  UINT32 Revision;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Enable the access routines while probing to see if it is supported.</span></span><br><span class="line">  <span class="comment">// For probing we always use the IO Port (IoReadFifo8()) access method.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  mQemuFwCfgSupported = TRUE;</span><br><span class="line">  mQemuFwCfgDmaSupported = FALSE;</span><br><span class="line"></span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemSignature);</span><br><span class="line">  Signature = QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, <span class="string">&quot;FW CFG Signature: 0x%x\n&quot;</span>, Signature));</span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemInterfaceVersion);</span><br><span class="line">  Revision = QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, <span class="string">&quot;FW CFG Revision: 0x%x\n&quot;</span>, Revision));</span><br><span class="line">  <span class="keyword">if</span> ((Signature != SIGNATURE_32 (<span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;U&#x27;</span>)) ||</span><br><span class="line">      (Revision &lt; <span class="number">1</span>)</span><br><span class="line">     ) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface not supported.\n&quot;</span>));</span><br><span class="line">    mQemuFwCfgSupported = FALSE;</span><br><span class="line">    <span class="keyword">return</span> RETURN_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((Revision &amp; FW_CFG_F_DMA) == <span class="number">0</span>) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface (IO Port) is supported.\n&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mQemuFwCfgDmaSupported = TRUE;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface (DMA) is supported.\n&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mQemuFwCfgDmaSupported &amp;&amp; MemEncryptSevIsEnabled ()) &#123;</span><br><span class="line">    EFI_STATUS   Status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// IoMmuDxe driver must have installed the IOMMU protocol. If we are not</span></span><br><span class="line">    <span class="comment">// able to locate the protocol then something must have gone wrong.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Status = gBS-&gt;LocateProtocol (&amp;gEdkiiIoMmuProtocolGuid, <span class="literal">NULL</span>,</span><br><span class="line">                    (VOID **)&amp;mIoMmuProtocol);</span><br><span class="line">    <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">      DEBUG ((DEBUG_ERROR,</span><br><span class="line">        <span class="string">&quot;QemuFwCfgSevDma %a:%a Failed to locate IOMMU protocol.\n&quot;</span>,</span><br><span class="line">        gEfiCallerBaseName, __FUNCTION__));</span><br><span class="line">      ASSERT (FALSE);</span><br><span class="line">      CpuDeadLoop ();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RETURN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because FW CFG Revision: 0x3 is supported, according to the code, Revision is &gt; 1 so QemuFwCfg interface is supported, but from next part 0x03 &amp; <code>FW_CFG_F_DMA</code> which is BIT1 0x01 is not 0 so actually <code>QemuFwCfg interface (DMA) is supported.</code> is expected.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ((Revision &amp; FW_CFG_F_DMA) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (IO Port) is supported.\n&quot;));</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  mQemuFwCfgDmaSupported &#x3D; TRUE;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (DMA) is supported.\n&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so that means the boot is not correctly performed. But next boot still triggered so we should check how the boot can be triggered before we dig out the truth.</p>
<p>According to code，we can know edk2-ovmf is try to load PlatformPei.efi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4^M</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A751 PlatformPei.efi^M</span><br></pre></td></tr></table></figure>

<p>use the guid <code>222C386D-5ABC-4FB4-B124-FBB82488ACF4</code> we can easily get definitions in <code>PlatformPei.inf</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Defines]</span></span><br><span class="line">  <span class="attr">INF_VERSION</span>                    = <span class="number">0</span>x00010005</span><br><span class="line">  <span class="attr">BASE_NAME</span>                      = PlatformPei</span><br><span class="line">  <span class="attr">FILE_GUID</span>                      = <span class="number">222</span>c386d-<span class="number">5</span>abc-<span class="number">4</span>fb4-b124-fbb82488acf4</span><br><span class="line">  <span class="attr">MODULE_TYPE</span>                    = PEIM</span><br><span class="line">  <span class="attr">VERSION_STRING</span>                 = <span class="number">1.0</span></span><br><span class="line">  <span class="attr">ENTRY_POINT</span>                    = InitializePlatform</span><br></pre></td></tr></table></figure>

<p>which ENTRY_POINT is InitializePlatform, but before entry LibraryClasses should be initialized first:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[LibraryClasses]</span></span><br><span class="line">  BaseLib</span><br><span class="line">  CacheMaintenanceLib</span><br><span class="line">  DebugLib</span><br><span class="line">  HobLib</span><br><span class="line">  IoLib</span><br><span class="line">  PciLib</span><br><span class="line">  ResourcePublicationLib</span><br><span class="line">  PeiServicesLib</span><br><span class="line">  PeiServicesTablePointerLib</span><br><span class="line">  PeimEntryPoint</span><br><span class="line">  QemuFwCfgLib</span><br><span class="line">  QemuFwCfgS3Lib</span><br><span class="line">  QemuFwCfgSimpleParserLib</span><br><span class="line">  MtrrLib</span><br><span class="line">  MemEncryptSevLib</span><br><span class="line">  PcdLib</span><br></pre></td></tr></table></figure>

<p>add logs code execution details.</p>
<p>following log shows the trace when edk2 fall into infinite loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4^M</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A76B PlatformPei.efi^M</span><br><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; debug entry point &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;^M</span><br><span class="line">check signature match QEMU result: 0^M</span><br><span class="line">check revision &lt; 1 result: 0^M</span><br><span class="line">check supported result: 2^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; enter InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ReadSevMsr &#x3D; true &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ^M</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)^M</span><br></pre></td></tr></table></figure>

<p>SecCoreStartupWithStack is first log when guest boot, and we end with ReadSevMsr = true but nothing after that.</p>
<p>Before we could see PlatformPei.efi is loading, so refer to PlatformPei.efi first. But the QemuFwCfgLib seems not successfully initialized, because the log end up during its load procedure not show <code>Platform PEIM Loaded</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EFI_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">InitializePlatform (</span><br><span class="line">  IN       EFI_PEI_FILE_HANDLE  FileHandle,</span><br><span class="line">  IN CONST EFI_PEI_SERVICES     **PeiServices</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;Platform PEIM Loaded\n&quot;));</span><br></pre></td></tr></table></figure>

<p>And refer to OvmfPkgX64.dsc describes c lib every procedure should use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[LibraryClasses.common.PEIM]</span><br><span class="line">  HobLib|MdePkg&#x2F;Library&#x2F;PeiHobLib&#x2F;PeiHobLib.inf</span><br><span class="line">  PeiServicesTablePointerLib|MdePkg&#x2F;Library&#x2F;PeiServicesTablePointerLibIdt&#x2F;PeiServicesTablePointerLibIdt.inf</span><br><span class="line">  PeiServicesLib|MdePkg&#x2F;Library&#x2F;PeiServicesLib&#x2F;PeiServicesLib.inf</span><br><span class="line">  MemoryAllocationLib|MdePkg&#x2F;Library&#x2F;PeiMemoryAllocationLib&#x2F;PeiMemoryAllocationLib.inf</span><br><span class="line">  PeimEntryPoint|MdePkg&#x2F;Library&#x2F;PeimEntryPoint&#x2F;PeimEntryPoint.inf</span><br><span class="line">  ReportStatusCodeLib|MdeModulePkg&#x2F;Library&#x2F;PeiReportStatusCodeLib&#x2F;PeiReportStatusCodeLib.inf</span><br><span class="line">  OemHookStatusCodeLib|MdeModulePkg&#x2F;Library&#x2F;OemHookStatusCodeLibNull&#x2F;OemHookStatusCodeLibNull.inf</span><br><span class="line">  PeCoffGetEntryPointLib|MdePkg&#x2F;Library&#x2F;BasePeCoffGetEntryPointLib&#x2F;BasePeCoffGetEntryPointLib.inf</span><br><span class="line">!ifdef $(DEBUG_ON_SERIAL_PORT)</span><br><span class="line">  DebugLib|MdePkg&#x2F;Library&#x2F;BaseDebugLibSerialPort&#x2F;BaseDebugLibSerialPort.inf</span><br><span class="line">!else</span><br><span class="line">  DebugLib|OvmfPkg&#x2F;Library&#x2F;PlatformDebugLibIoPort&#x2F;PlatformDebugLibIoPort.inf</span><br><span class="line">!endif</span><br><span class="line">  PeCoffLib|MdePkg&#x2F;Library&#x2F;BasePeCoffLib&#x2F;BasePeCoffLib.inf</span><br><span class="line">  ResourcePublicationLib|MdePkg&#x2F;Library&#x2F;PeiResourcePublicationLib&#x2F;PeiResourcePublicationLib.inf</span><br><span class="line">  ExtractGuidedSectionLib|MdePkg&#x2F;Library&#x2F;PeiExtractGuidedSectionLib&#x2F;PeiExtractGuidedSectionLib.inf</span><br><span class="line">!if $(SOURCE_DEBUG_ENABLE) &#x3D;&#x3D; TRUE</span><br><span class="line">  DebugAgentLib|SourceLevelDebugPkg&#x2F;Library&#x2F;DebugAgent&#x2F;SecPeiDebugAgentLib.inf</span><br><span class="line">!endif</span><br><span class="line">  CpuExceptionHandlerLib|UefiCpuPkg&#x2F;Library&#x2F;CpuExceptionHandlerLib&#x2F;PeiCpuExceptionHandlerLib.inf</span><br><span class="line">  MpInitLib|UefiCpuPkg&#x2F;Library&#x2F;MpInitLib&#x2F;PeiMpInitLib.inf</span><br><span class="line">  QemuFwCfgS3Lib|OvmfPkg&#x2F;Library&#x2F;QemuFwCfgS3Lib&#x2F;PeiQemuFwCfgS3LibFwCfg.inf</span><br><span class="line">  PcdLib|MdePkg&#x2F;Library&#x2F;PeiPcdLib&#x2F;PeiPcdLib.inf</span><br><span class="line">  QemuFwCfgLib|OvmfPkg&#x2F;Library&#x2F;QemuFwCfgLib&#x2F;QemuFwCfgPeiLib.inf</span><br></pre></td></tr></table></figure>

<p>take eyes on <code>QemuFwCfgLib|OvmfPkg/Library/QemuFwCfgLib/QemuFwCfgPeiLib.inf</code></p>
<p>so check more from <code>QemuFwCfgPei.c</code> , following shows debug log added version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgIsAvailable (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  return InternalQemuFwCfgIsAvailable ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RETURN_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgInitialize (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 Signature;</span><br><span class="line">  UINT32 Revision;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F;</span><br><span class="line">  &#x2F;&#x2F; Enable the access routines while probing to see if it is supported.</span><br><span class="line">  &#x2F;&#x2F; For probing we always use the IO Port (IoReadFifo8()) access method.</span><br><span class="line">  &#x2F;&#x2F;</span><br><span class="line">  mQemuFwCfgSupported &#x3D; TRUE;</span><br><span class="line">  mQemuFwCfgDmaSupported &#x3D; FALSE;</span><br><span class="line"></span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemSignature);</span><br><span class="line">  Signature &#x3D; QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;FW CFG Signature: 0x%x\n&quot;, Signature));</span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemInterfaceVersion);</span><br><span class="line">  Revision &#x3D; QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;FW CFG Revision: 0x%x\n&quot;, Revision));</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; debug entry point &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n&quot;));</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check signature match QEMU result: %d\n&quot;, Signature !&#x3D; SIGNATURE_32 (&#39;Q&#39;, &#39;E&#39;, &#39;M&#39;, &#39;U&#39;)));</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check revision &lt; 1 result: %d\n&quot;, Revision &lt; 1));</span><br><span class="line">  if ((Signature !&#x3D; SIGNATURE_32 (&#39;Q&#39;, &#39;E&#39;, &#39;M&#39;, &#39;U&#39;)) ||</span><br><span class="line">      (Revision &lt; 1)</span><br><span class="line">     ) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface not supported.\n&quot;));</span><br><span class="line">    mQemuFwCfgSupported &#x3D; FALSE;</span><br><span class="line">    return RETURN_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check supported result: %d\n&quot;, (Revision &amp; FW_CFG_F_DMA)));</span><br><span class="line">  if ((Revision &amp; FW_CFG_F_DMA) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (IO Port) is supported.\n&quot;));</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; If SEV is enabled then we do not support DMA operations in PEI phase.</span><br><span class="line">    &#x2F;&#x2F; This is mainly because DMA in SEV guest requires using bounce buffer</span><br><span class="line">    &#x2F;&#x2F; (which need to allocate dynamic memory and allocating a PAGE size&#39;d</span><br><span class="line">    &#x2F;&#x2F; buffer can be challenge in PEI phase)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    if (MemEncryptSevIsEnabled ()) &#123;</span><br><span class="line">      DEBUG ((DEBUG_INFO, &quot;SEV: QemuFwCfg fallback to IO Port interface.\n&quot;));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      mQemuFwCfgDmaSupported &#x3D; TRUE;</span><br><span class="line">      DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (DMA) is supported.\n&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>the code enter the <code>MemEncryptSevIsEnabled ()</code> and hang on next function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">STATIC</span><br><span class="line">VOID</span><br><span class="line">EFIAPI</span><br><span class="line">InternalMemEncryptSevStatus (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32                            RegEax;</span><br><span class="line">  MSR_SEV_STATUS_REGISTER           Msr;</span><br><span class="line">  CPUID_MEMORY_ENCRYPTION_INFO_EAX  Eax;</span><br><span class="line">  BOOLEAN                           ReadSevMsr;</span><br><span class="line">  SEC_SEV_ES_WORK_AREA              *SevEsWorkArea;</span><br><span class="line"></span><br><span class="line">  ReadSevMsr &#x3D; FALSE;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; enter InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">  SevEsWorkArea &#x3D; (SEC_SEV_ES_WORK_AREA *) FixedPcdGet32 (PcdSevEsWorkAreaBase);</span><br><span class="line">  if (SevEsWorkArea !&#x3D; NULL &amp;&amp; SevEsWorkArea-&gt;EncryptionMask !&#x3D; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; The MSR has been read before, so it is safe to read it again and avoid</span><br><span class="line">    &#x2F;&#x2F; having to validate the CPUID information.</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ReadSevMsr &#x3D; true &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    ReadSevMsr &#x3D; TRUE;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check if memory encryption leaf exist</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; AsmCpuid &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    AsmCpuid (CPUID_EXTENDED_FUNCTION, &amp;RegEax, NULL, NULL, NULL);</span><br><span class="line">    if (RegEax &gt;&#x3D; CPUID_MEMORY_ENCRYPTION_INFO) &#123;</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      &#x2F;&#x2F; CPUID Fn8000_001F[EAX] Bit 1 (Sev supported)</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      AsmCpuid (CPUID_MEMORY_ENCRYPTION_INFO, &amp;Eax.Uint32, NULL, NULL, NULL);</span><br><span class="line"></span><br><span class="line">      if (Eax.Bits.SevBit) &#123;</span><br><span class="line">        ReadSevMsr &#x3D; TRUE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (ReadSevMsr) &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check MSR_0xC0010131 Bit 0 (Sev Enabled)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    Msr.Uint32 &#x3D; AsmReadMsr32 (MSR_SEV_STATUS);</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; AsmReadMsr32 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    if (Msr.Bits.SevBit) &#123;</span><br><span class="line">      mSevStatus &#x3D; TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check MSR_0xC0010131 Bit 1 (Sev-Es Enabled)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    if (Msr.Bits.SevEsBit) &#123;</span><br><span class="line">      mSevEsStatus &#x3D; TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; out InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">  mSevStatusChecked &#x3D; TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally <code>AsmReadMsr32</code> is the victim to blame. </p>
<p>note: SEC_SEV_ES_WORK_AREA is a new AREA added by amd used for their SEV feature. Normally guest without SEV feature should not modify those memory area, but it seems windows write randomly bits which caused this problem.</p>
<h3 id="From-edk2-groups"><a href="#From-edk2-groups" class="headerlink" title="From edk2 groups"></a>From edk2 groups</h3><p>Same issue is found <code>https://edk2.groups.io/g/devel/topic/87301748#84086</code></p>
<p>According to the mail:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tested on Intel Platform, It is like &#39;SEV-ES work area&#39; can be modified by</span><br><span class="line">os(Windows etc), and will not restored on reboot, the</span><br><span class="line">SevEsWorkArea-&gt;EncryptionMask may have a random value after reboot. then it</span><br><span class="line">may casue fail on reboot. The msr bits already cached by mSevStatusChecked,</span><br><span class="line">there is no need to try cache again in PEI phase.</span><br></pre></td></tr></table></figure>

<p>it seems Windows will change SEV-ES work area which will lead QemuFwCfgLib to readMsr when guest reboot, but actually for guests, normally SEV-ES is not used, so initializing failure cause the reboot infinite loop.</p>
<h3 id="Patches-fix-the-reboot-issue"><a href="#Patches-fix-the-reboot-issue" class="headerlink" title="Patches fix the reboot issue"></a>Patches fix the reboot issue</h3><p>check file change log </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log OvmfPkg/Library/BaseMemEncryptSevLib/PeiMemEncryptSevLibInternal.c</span><br></pre></td></tr></table></figure>

<p>we can find related patches:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">commit d9822304ce0075b1075edf93cc6e2514685b5212</span><br><span class="line">Author: Brijesh Singh &lt;brijesh.singh@amd.com&gt;</span><br><span class="line">Date:   Thu Dec 9 11:27:37 2021 +0800</span><br><span class="line"></span><br><span class="line">    OvmfPkg&#x2F;MemEncryptSevLib: add MemEncryptSevSnpEnabled()</span><br><span class="line"></span><br><span class="line">    BZ: https:&#x2F;&#x2F;bugzilla.tianocore.org&#x2F;show_bug.cgi?id&#x3D;3275</span><br><span class="line"></span><br><span class="line">    Create a function that can be used to determine if VM is running as an</span><br><span class="line">    SEV-SNP guest.</span><br><span class="line"></span><br><span class="line">    Cc: Michael Roth &lt;michael.roth@amd.com&gt;</span><br><span class="line">    Cc: James Bottomley &lt;jejb@linux.ibm.com&gt;</span><br><span class="line">    Cc: Min Xu &lt;min.m.xu@intel.com&gt;</span><br><span class="line">    Cc: Jiewen Yao &lt;jiewen.yao@intel.com&gt;</span><br><span class="line">    Cc: Tom Lendacky &lt;thomas.lendacky@amd.com&gt;</span><br><span class="line">    Cc: Jordan Justen &lt;jordan.l.justen@intel.com&gt;</span><br><span class="line">    Cc: Ard Biesheuvel &lt;ardb+tianocore@kernel.org&gt;</span><br><span class="line">    Cc: Erdem Aktas &lt;erdemaktas@google.com&gt;</span><br><span class="line">    Cc: Gerd Hoffmann &lt;kraxel@redhat.com&gt;</span><br><span class="line">    Acked-by: Jiewen Yao &lt;Jiewen.yao@intel.com&gt;</span><br><span class="line">    Acked-by: Gerd Hoffmann &lt;kraxel@redhat.com&gt;</span><br><span class="line">    Signed-off-by: Brijesh Singh &lt;brijesh.singh@amd.com&gt;</span><br><span class="line"></span><br><span class="line">commit ac0a286f4d747a4c6c603a7b225917293cbe1e9f</span><br><span class="line">Author: Michael Kubacki &lt;michael.kubacki@microsoft.com&gt;</span><br><span class="line">Date:   Sun Dec 5 14:54:09 2021 -0800</span><br><span class="line"></span><br><span class="line">    OvmfPkg: Apply uncrustify changes</span><br><span class="line"></span><br><span class="line">    REF: https:&#x2F;&#x2F;bugzilla.tianocore.org&#x2F;show_bug.cgi?id&#x3D;3737</span><br><span class="line"></span><br><span class="line">    Apply uncrustify changes to .c&#x2F;.h files in the OvmfPkg package</span><br><span class="line"></span><br><span class="line">    Cc: Andrew Fish &lt;afish@apple.com&gt;</span><br><span class="line">    Cc: Leif Lindholm &lt;leif@nuviainc.com&gt;</span><br><span class="line">    Cc: Michael D Kinney &lt;michael.d.kinney@intel.com&gt;</span><br><span class="line">    Signed-off-by: Michael Kubacki &lt;michael.kubacki@microsoft.com&gt;</span><br><span class="line">    Reviewed-by: Andrew Fish &lt;afish@apple.com&gt;</span><br></pre></td></tr></table></figure>



<h2 id="More-information-about-my-debug-related-procedure"><a href="#More-information-about-my-debug-related-procedure" class="headerlink" title="More information about my debug related procedure"></a>More information about my debug related procedure</h2><h3 id="UEFI-boot-procedure"><a href="#UEFI-boot-procedure" class="headerlink" title="UEFI boot procedure"></a>UEFI boot procedure</h3><p>Before debugging on edk2 code, check UEFI boot procedure to know more about UEFI boot.</p>
<p>According to <a target="_blank" rel="noopener" href="https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence">https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence</a></p>
<p>PI compliant system firmware must support the six phases: security (SEC), pre-efi initialization (PEI), driver execution environment (DXE), boot device selection (BDS), run time (RT) services and After Life (transition from the OS back to the firmware) of system. Refer to Figure below</p>
<img src="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/boot_sequence.png" class="">

<p>Our issue occours at PEI so check the first two steps:</p>
<h4 id="Security-SEC"><a href="#Security-SEC" class="headerlink" title="Security(SEC)"></a>Security(SEC)</h4><p>The Security (SEC) phase is the first phase in the PI Architecture and is responsible for the following:</p>
<ul>
<li>Handling all platform restart events</li>
<li>Creating a temporary memory store</li>
<li>Serving as the root of trust in the system</li>
<li>Passing handoff information to the PEI Foundation</li>
</ul>
<p>The security section may contain modules with code written in assembly. Therefore, some EDK II module development environment (MDE) modules may contain assembly code. Where this occurs, both Windows and GCC versions of assembly code are provided in different files.</p>
<h4 id="Pre-EFI-Initialization-PEI"><a href="#Pre-EFI-Initialization-PEI" class="headerlink" title="Pre-EFI Initialization (PEI)"></a>Pre-EFI Initialization (PEI)</h4><p>The Pre-EFI Initialization (PEI) phase described in the PI Architecture specifications is invoked quite early in the boot flow. Specifically, after some preliminary processing in the Security (SEC) phase, any machine restart event will invoke the PEI phase.</p>
<p>The PEI phase initially operates with the platform in a nascent state, leveraging only on-processor resources, such as the processor cache as a call stack, to dispatch Pre-EFI Initialization Modules (PEIMs). These PEIMs are responsible for the following:</p>
<ul>
<li>Initializing some permanent memory complement</li>
<li>Describing the memory in Hand-Off Blocks (HOBs)</li>
<li>Describing the firmware volume locations in HOBs</li>
<li>Passing control into the Driver Execution Environment (DXE) phase</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" data-id="cld1mhec9005xyuwbgriparkk" data-title="Dive into edk2-ovmf fisrt debug trip" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Go-through-KVM-code-due-to-a-tdp-page-fault" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" class="article-date">
  <time class="dt-published" datetime="2022-07-15T02:23:14.000Z" itemprop="datePublished">2022-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/">Go through KVM code due to a tdp_page_fault</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="What-happened"><a href="#What-happened" class="headerlink" title="What happened?"></a>What happened?</h2><p>Our CI/CD system ran integration test for every pull request but suddenly it met performance issue. Usually one round of integration test need 1h but this time almost all test do not finished after 1h 20min. </p>
<p>After check the codebase and test on lastest release stable branch, its more likely that the system met performance issue.</p>
<p>Before starting trip of “dig out the root cause”, check big picture of this CI/CD system architecture.</p>
<h2 id="Prepare-from-perf"><a href="#Prepare-from-perf" class="headerlink" title="Prepare from perf"></a>Prepare from perf</h2><p>Because integration test runs on virtual machine memory, check hypervisor’s performance might gave more details. So use perf to collect run time data for analysis.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;brendangregg&#x2F;FlameGraph  # or download it from github</span><br><span class="line">cd FlameGraph</span><br><span class="line">perf record -F 99 -a -g -- sleep 60</span><br><span class="line">perf script | .&#x2F;stackcollapse-perf.pl &gt; out.perf-folded</span><br><span class="line">.&#x2F;flamegraph.pl out.perf-folded &gt; perf.svg</span><br></pre></td></tr></table></figure>

<p>Check the flame graph</p>
<img src="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/2022-07-15-kvm-figure1.png" class=""> 


<h2 id="Start-from-tdp-page-fault"><a href="#Start-from-tdp-page-fault" class="headerlink" title="Start from tdp_page_fault"></a>Start from tdp_page_fault</h2><p>Abviously cpu spend lots of time to handle tdp_page_fault</p>
<p>find definition from <code>linux/arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static void init_kvm_tdp_mmu(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	struct kvm_mmu *context &#x3D; &amp;vcpu-&gt;arch.mmu;</span><br><span class="line"></span><br><span class="line">	context-&gt;base_role.word &#x3D; 0;</span><br><span class="line">	context-&gt;base_role.guest_mode &#x3D; is_guest_mode(vcpu);</span><br><span class="line">	context-&gt;base_role.smm &#x3D; is_smm(vcpu);</span><br><span class="line">	context-&gt;base_role.ad_disabled &#x3D; (shadow_accessed_mask &#x3D;&#x3D; 0);</span><br><span class="line">	context-&gt;page_fault &#x3D; tdp_page_fault;</span><br><span class="line">	context-&gt;sync_page &#x3D; nonpaging_sync_page;</span><br><span class="line">	context-&gt;invlpg &#x3D; nonpaging_invlpg;</span><br><span class="line">	context-&gt;update_pte &#x3D; nonpaging_update_pte;</span><br><span class="line">	context-&gt;shadow_root_level &#x3D; kvm_x86_ops-&gt;get_tdp_level(vcpu);</span><br><span class="line">	context-&gt;root_hpa &#x3D; INVALID_PAGE;</span><br><span class="line">	context-&gt;direct_map &#x3D; true;</span><br><span class="line">	context-&gt;set_cr3 &#x3D; kvm_x86_ops-&gt;set_tdp_cr3;</span><br><span class="line">	context-&gt;get_cr3 &#x3D; get_cr3;</span><br><span class="line">	context-&gt;get_pdptr &#x3D; kvm_pdptr_read;</span><br><span class="line">	context-&gt;inject_page_fault &#x3D; kvm_inject_page_fault;</span><br></pre></td></tr></table></figure>

<p><code>kvm_vcpu</code> <code>page_fault</code> point to <code>tdp_page_fault</code> when mmu field of <code>kvm_vcpu</code> is initializing.</p>
<p>from kvm vcpu setup <code>arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void init_kvm_mmu(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	if (mmu_is_nested(vcpu))</span><br><span class="line">		init_kvm_nested_mmu(vcpu);</span><br><span class="line">	else if (tdp_enabled)</span><br><span class="line">		init_kvm_tdp_mmu(vcpu);</span><br><span class="line">	else</span><br><span class="line">		init_kvm_softmmu(vcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>from kvm vcpu setup <code>arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void kvm_mmu_setup(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	MMU_WARN_ON(VALID_PAGE(vcpu-&gt;arch.mmu.root_hpa));</span><br><span class="line"></span><br><span class="line">	init_kvm_mmu(vcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>from kvm vcpu setup <code>arch/x86/kvm/x86.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int kvm_arch_vcpu_setup(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	kvm_vcpu_mtrr_init(vcpu);</span><br><span class="line">	vcpu_load(vcpu);</span><br><span class="line">	kvm_vcpu_reset(vcpu, false);</span><br><span class="line">	kvm_mmu_setup(vcpu);</span><br><span class="line">	vcpu_put(vcpu);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vcpu is created by </p>
<p><code>kvm_vm_ioctl_create_vcpu(struct kvm *kvm, u32 id)</code></p>
<p>check mmu in vcpu structure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Paging state of the vcpu</span><br><span class="line"> *</span><br><span class="line"> * If the vcpu runs in guest mode with two level paging this still saves</span><br><span class="line"> * the paging mode of the l1 guest. This context is always used to</span><br><span class="line"> * handle faults.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct kvm_mmu mmu;</span><br></pre></td></tr></table></figure>

<h2 id="Find-more-by-pf-interception"><a href="#Find-more-by-pf-interception" class="headerlink" title="Find more by pf_interception"></a>Find more by pf_interception</h2><p>combine to flage graph, pf_interception is before tdp_page_fault,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static int pf_interception(struct vcpu_svm *svm)</span><br><span class="line">&#123;</span><br><span class="line">	u64 fault_address &#x3D; __sme_clr(svm-&gt;vmcb-&gt;control.exit_info_2);</span><br><span class="line">	u64 error_code &#x3D; svm-&gt;vmcb-&gt;control.exit_info_1;</span><br><span class="line"></span><br><span class="line">	return kvm_handle_page_fault(&amp;svm-&gt;vcpu, error_code, fault_address,</span><br><span class="line">			static_cpu_has(X86_FEATURE_DECODEASSISTS) ?</span><br><span class="line">			svm-&gt;vmcb-&gt;control.insn_bytes : NULL,</span><br><span class="line">			svm-&gt;vmcb-&gt;control.insn_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>refer to its usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[SVM_EXIT_EXCP_BASE + PF_VECTOR] &#x3D; pf_interception</span><br></pre></td></tr></table></figure>

<p>SVM_EXIT_EXCP_BASE is related to AMD CPU virtualization, PF_VECTOR means page_frame vector, used by page fault.</p>
<p>more details about the PF_VECTOR in <code>arch/x86/kvm/svm.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (npt_enabled) &#123;</span><br><span class="line">	&#x2F;* Setup VMCB for Nested Paging *&#x2F;</span><br><span class="line">	control-&gt;nested_ctl |&#x3D; SVM_NESTED_CTL_NP_ENABLE;</span><br><span class="line">	clr_intercept(svm, INTERCEPT_INVLPG);</span><br><span class="line">	clr_exception_intercept(svm, PF_VECTOR);</span><br><span class="line">	clr_cr_intercept(svm, INTERCEPT_CR3_READ);</span><br><span class="line">	clr_cr_intercept(svm, INTERCEPT_CR3_WRITE);</span><br><span class="line">	save-&gt;g_pat &#x3D; svm-&gt;vcpu.arch.pat;</span><br><span class="line">	save-&gt;cr3 &#x3D; 0;</span><br><span class="line">	save-&gt;cr4 &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if AMD CPU’s npt not enabled, PF_VECTOR will be used to intercept page fault.</p>
<p>So just quickly go through guest virtual address translation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Fetch a guest pte for a guest virtual address</span><br><span class="line"> *&#x2F;</span><br><span class="line">static int FNAME(walk_addr_generic)(struct guest_walker *walker,</span><br><span class="line">				    struct kvm_vcpu *vcpu, struct kvm_mmu *mmu,</span><br><span class="line">				    gva_t addr, u32 access)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">error:</span><br><span class="line">	errcode |&#x3D; write_fault | user_fault;</span><br><span class="line">	if (fetch_fault &amp;&amp; (mmu-&gt;nx ||</span><br><span class="line">			    kvm_read_cr4_bits(vcpu, X86_CR4_SMEP)))</span><br><span class="line">		errcode |&#x3D; PFERR_FETCH_MASK;</span><br><span class="line"></span><br><span class="line">	walker-&gt;fault.vector &#x3D; PF_VECTOR;</span><br><span class="line">	walker-&gt;fault.error_code_valid &#x3D; true;</span><br><span class="line">	walker-&gt;fault.error_code &#x3D; errcode;</span><br></pre></td></tr></table></figure>

<p>error is defined to raise PF_VECTOR when failed to find any PTE(Page table entry) </p>
<p>Than let’s find the next method <code>handle_exit()</code> from svm.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int handle_exit(struct kvm_vcpu *vcpu)</span><br></pre></td></tr></table></figure>

<p>following shows more details</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct vcpu_svm *svm &#x3D; to_svm(vcpu);</span><br><span class="line">struct kvm_run *kvm_run &#x3D; vcpu-&gt;run;</span><br><span class="line">u32 exit_code &#x3D; svm-&gt;vmcb-&gt;control.exit_code;</span><br></pre></td></tr></table></figure>

<p>the vcpu structure will be changed to vcpu_svm and than get the exit_code from it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">trace_kvm_exit(exit_code, vcpu, KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">if (!is_cr_intercept(svm, INTERCEPT_CR0_WRITE))</span><br><span class="line">	vcpu-&gt;arch.cr0 &#x3D; svm-&gt;vmcb-&gt;save.cr0;</span><br><span class="line">if (npt_enabled)</span><br><span class="line">	vcpu-&gt;arch.cr3 &#x3D; svm-&gt;vmcb-&gt;save.cr3;</span><br><span class="line"></span><br><span class="line">if (unlikely(svm-&gt;nested.exit_required)) &#123;</span><br><span class="line">	nested_svm_vmexit(svm);</span><br><span class="line">	svm-&gt;nested.exit_required &#x3D; false;</span><br><span class="line"></span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>than the exit_code will be traced.</p>
<p>CR0 has various control flags that modify the basic operation of the processor. See more: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Control_register#CR0">https://en.wikipedia.org/wiki/Control_register#CR0</a></p>
<p>if npt_enabled(CPU enable npt) vcpu will use vmcb saved cr3</p>
<p>vmcb: Intel VT-x name it as vmcs(virtual machine control structure), AMD name it as vmcb(virtual machine control block)</p>
<p>vmcb_control_area and vmcb_save_area combined as virtual machine control block. </p>
<p>note: need more research</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if (is_guest_mode(vcpu)) &#123;</span><br><span class="line">	int vmexit;</span><br><span class="line"></span><br><span class="line">	trace_kvm_nested_vmexit(svm-&gt;vmcb-&gt;save.rip, exit_code,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_info_1,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_info_2,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_int_info,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_int_info_err,</span><br><span class="line">				KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">	vmexit &#x3D; nested_svm_exit_special(svm);</span><br><span class="line"></span><br><span class="line">	if (vmexit &#x3D;&#x3D; NESTED_EXIT_CONTINUE)</span><br><span class="line">		vmexit &#x3D; nested_svm_exit_handled(svm);</span><br><span class="line"></span><br><span class="line">	if (vmexit &#x3D;&#x3D; NESTED_EXIT_DONE)</span><br><span class="line">		return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if vm is nested exit, handle nested exit next step, interrupts will be queued and if vm exit due to SVM_EXIT_ERR exit this thread.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">svm_complete_interrupts(svm);</span><br><span class="line"></span><br><span class="line">if (svm-&gt;vmcb-&gt;control.exit_code &#x3D;&#x3D; SVM_EXIT_ERR) &#123;</span><br><span class="line">	kvm_run-&gt;exit_reason &#x3D; KVM_EXIT_FAIL_ENTRY;</span><br><span class="line">	kvm_run-&gt;fail_entry.hardware_entry_failure_reason</span><br><span class="line">		&#x3D; svm-&gt;vmcb-&gt;control.exit_code;</span><br><span class="line">	pr_err(&quot;KVM: FAILED VMRUN WITH VMCB:\n&quot;);</span><br><span class="line">	dump_vmcb(vcpu);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>last, check if the error code is external interrupt and not kernel handable error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if (is_external_interrupt(svm-&gt;vmcb-&gt;control.exit_int_info) &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_EXCP_BASE + PF_VECTOR &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_NPF &amp;&amp; exit_code !&#x3D; SVM_EXIT_TASK_SWITCH &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_INTR &amp;&amp; exit_code !&#x3D; SVM_EXIT_NMI)</span><br><span class="line">	printk(KERN_ERR &quot;%s: unexpected exit_int_info 0x%x &quot;</span><br><span class="line">	       &quot;exit_code 0x%x\n&quot;,</span><br><span class="line">	       __func__, svm-&gt;vmcb-&gt;control.exit_int_info,</span><br><span class="line">	       exit_code);</span><br><span class="line"></span><br><span class="line">if (exit_code &gt;&#x3D; ARRAY_SIZE(svm_exit_handlers)</span><br><span class="line">    || !svm_exit_handlers[exit_code]) &#123;</span><br><span class="line">	WARN_ONCE(1, &quot;svm: unexpected exit reason 0x%x\n&quot;, exit_code);</span><br><span class="line">	kvm_queue_exception(vcpu, UD_VECTOR);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return svm_exit_handlers[exit_code](svm);</span><br></pre></td></tr></table></figure>

<p>finally invoke svm exit handler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return svm_exit_handlers[exit_code](svm);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" data-id="cld1mhe9x0003yuwb8g646w4b" data-title="Go through KVM code due to a tdp_page_fault" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-python-elementtree-notes" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/01/python-elementtree-notes/" class="article-date">
  <time class="dt-published" datetime="2022-07-01T07:13:28.000Z" itemprop="datePublished">2022-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/python/">python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/01/python-elementtree-notes/">Python ElementTree notes</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Develop with libvrt python API, xml parse and operation is frequently required. ElementTree (stantard python library) is introduced in <a target="_blank" rel="noopener" href="https://realpython.com/python-xml-parser/">python-xml-parse</a> come into used for the sake of simplify xml configuration lifecycle handling.</p>
<p>This blog will go throught <a target="_blank" rel="noopener" href="https://docs.python.org/2/library/xml.etree.elementtree.html#module-xml.etree.ElementTree">xml.etree.ElementTree</a> combine with typical situations which is use as learning notes.</p>
<p>First, start with some basic concepts </p>
<blockquote>
</blockquote>
<p>The Element type is a flexible container object, designed to store hierarchical data structures in memory. The type can be described as a cross between a list and a dictionary.</p>
<blockquote>
</blockquote>
<p>Each element has a number of properties associated with it:</p>
<blockquote>
</blockquote>
<ul>
<li>a tag which is a string identifying what kind of data this element represents (the element type, in other words).<blockquote>
</blockquote>
</li>
<li>a number of attributes, stored in a Python dictionary.<blockquote>
</blockquote>
</li>
<li>a text string.<blockquote>
</blockquote>
</li>
<li>an optional tail string.<blockquote>
</blockquote>
</li>
<li>a number of child elements, stored in a Python sequence</li>
</ul>
<p>use following XML as sample data:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;data&gt;</span><br><span class="line">    &lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;</span><br><span class="line">        &lt;rank&gt;1&lt;&#x2F;rank&gt;</span><br><span class="line">        &lt;year&gt;2008&lt;&#x2F;year&gt;</span><br><span class="line">        &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Austria&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Switzerland&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;country&gt;</span><br><span class="line">    &lt;country name&#x3D;&quot;Singapore&quot;&gt;</span><br><span class="line">        &lt;rank&gt;4&lt;&#x2F;rank&gt;</span><br><span class="line">        &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">        &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Malaysia&quot; direction&#x3D;&quot;N&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;country&gt;</span><br><span class="line">    &lt;country name&#x3D;&quot;Panama&quot;&gt;</span><br><span class="line">        &lt;rank&gt;68&lt;&#x2F;rank&gt;</span><br><span class="line">        &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">        &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Costa Rica&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Colombia&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;country&gt;</span><br><span class="line">&lt;&#x2F;data&gt;</span><br></pre></td></tr></table></figure>

<p>load xml from file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.5 (default, Aug  4 2017, 00:39:18)</span><br><span class="line">[GCC 4.8.5 20150623 (Red Hat 4.8.5-16)] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import xml.etree.ElementTree as ET</span><br><span class="line">&gt;&gt;&gt; tree &#x3D; ET.parse(&#39;test_data.xml&#39;)</span><br><span class="line">&gt;&gt;&gt; root &#x3D; tree.getroot()</span><br><span class="line">&gt;&gt;&gt; root</span><br><span class="line">&lt;Element &#39;data&#39; at 0x7f58bd8232d0&gt;</span><br></pre></td></tr></table></figure>

<p>or load xml from string:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; test_data_str &#x3D; &#39;&#39;&#39;&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">... &lt;data&gt;</span><br><span class="line">...     &lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;1&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2008&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Austria&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Switzerland&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;</span><br><span class="line">...     &lt;country name&#x3D;&quot;Singapore&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;4&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Malaysia&quot; direction&#x3D;&quot;N&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;</span><br><span class="line">...     &lt;country name&#x3D;&quot;Panama&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;68&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Costa Rica&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Colombia&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;</span><br><span class="line">... &lt;&#x2F;data&gt;&#39;&#39;&#39;</span><br><span class="line">&gt;&gt;&gt; ET.fromstring(test_data_str)</span><br><span class="line">&lt;Element &#39;data&#39; at 0x7f58bd823a10&gt;</span><br><span class="line">&gt;&gt;&gt; root &#x3D; ET.fromstring(test_data_str)</span><br><span class="line">&gt;&gt;&gt; root</span><br><span class="line">&lt;Element &#39;data&#39; at 0x7f58bd823f10&gt;</span><br></pre></td></tr></table></figure>

<p>As an element, use dir to check whats inside element we just loaded:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; dir(root)</span><br><span class="line">[&#39;__class__&#39;, &#39;__delattr__&#39;, &#39;__delitem__&#39;, &#39;__dict__&#39;, &#39;__doc__&#39;, &#39;__format__&#39;, &#39;__getattribute__&#39;, &#39;__getitem__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__len__&#39;, &#39;__module__&#39;, &#39;__new__&#39;, &#39;__nonzero__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__setitem__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;__weakref__&#39;, &#39;_children&#39;, &#39;append&#39;, &#39;attrib&#39;, &#39;clear&#39;, &#39;copy&#39;, &#39;extend&#39;, &#39;find&#39;, &#39;findall&#39;, &#39;findtext&#39;, &#39;get&#39;, &#39;getchildren&#39;, &#39;getiterator&#39;, &#39;insert&#39;, &#39;items&#39;, &#39;iter&#39;, &#39;iterfind&#39;, &#39;itertext&#39;, &#39;keys&#39;, &#39;makeelement&#39;, &#39;remove&#39;, &#39;set&#39;, &#39;tag&#39;, &#39;tail&#39;, &#39;text&#39;]</span><br></pre></td></tr></table></figure>

<p>as we see, operations is listed and think about some typical user case.</p>
<h2 id="find-attributes"><a href="#find-attributes" class="headerlink" title="find attributes"></a>find attributes</h2><p>Before finding attributes check what attributes the xml has.</p>
<p>For root node, only <data></data> has a tag but no attribute is set. So use tag and attrib to check this before find attributes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.tag</span><br><span class="line">&#39;data&#39;</span><br><span class="line">&gt;&gt;&gt; root.attrib</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>return value is what we expected. Get deeper, a country tag with name attribute is used. </p>
<p>iterate can be used to get child tag of root.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for child in root:</span><br><span class="line">...     child</span><br><span class="line">...</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd823f50&gt;</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd825110&gt;</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd825250&gt;</span><br></pre></td></tr></table></figure>

<p>or use index to find tag element directly:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root[0]</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd823f50&gt;</span><br></pre></td></tr></table></figure>

<p>for more duplicate case, those method became hard to use, so use iter or findall:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for neighbor in root.iter(&#39;neighbor&#39;):</span><br><span class="line">...     print neighbor.attrib</span><br><span class="line">...</span><br><span class="line">&#123;&#39;direction&#39;: &#39;E&#39;, &#39;name&#39;: &#39;Austria&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;W&#39;, &#39;name&#39;: &#39;Switzerland&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;N&#39;, &#39;name&#39;: &#39;Malaysia&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;W&#39;, &#39;name&#39;: &#39;Costa Rica&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;E&#39;, &#39;name&#39;: &#39;Colombia&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>all tags match neighbor is listed. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for country in root.findall(&#39;country&#39;):</span><br><span class="line">...     rank &#x3D; country.find(&#39;rank&#39;).text</span><br><span class="line">...     name &#x3D; country.get(&#39;name&#39;)</span><br><span class="line">...     print name, rank</span><br><span class="line">...</span><br><span class="line">Liechtenstein 1</span><br><span class="line">Singapore 4</span><br><span class="line">Panama 68</span><br></pre></td></tr></table></figure>

<p>use find all, all tag with name country is found and its rank text and attribute name is listed.</p>
<p>change the parameters for test, change findall target, test if tag not matched what will happend:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for country in root.findall(&#39;test&#39;):</span><br><span class="line">...     print country</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>when use find instead of findall</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for tag in root.find(&#39;country&#39;):</span><br><span class="line">...     print tag</span><br><span class="line">...</span><br><span class="line">&lt;Element &#39;rank&#39; at 0x7f58bd823f90&gt;</span><br><span class="line">&lt;Element &#39;year&#39; at 0x7f58bd823fd0&gt;</span><br><span class="line">&lt;Element &#39;gdppc&#39; at 0x7f58bd825050&gt;</span><br><span class="line">&lt;Element &#39;neighbor&#39; at 0x7f58bd825090&gt;</span><br><span class="line">&lt;Element &#39;neighbor&#39; at 0x7f58bd8250d0&gt;</span><br></pre></td></tr></table></figure>

<p>only first matched result is returned.</p>
<p>if find for a unexists tag None will be returned.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print root.find(&#39;test&#39;)</span><br><span class="line">None</span><br></pre></td></tr></table></figure>

<p>so in most cases, find and findall seems meet all the require for finding a specific tag.</p>
<h2 id="use-tag"><a href="#use-tag" class="headerlink" title="use tag"></a>use tag</h2><p>get attribute of tag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.find(&#39;country&#39;).get(&#39;name&#39;)</span><br><span class="line">&#39;Liechtenstein&#39;</span><br></pre></td></tr></table></figure>

<p>get text inside tag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.find(&#39;country&#39;).text</span><br><span class="line">&#39;\n        &#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.find(&#39;country&#39;).find(&#39;year&#39;).text</span><br><span class="line">&#39;2008&#39;</span><br></pre></td></tr></table></figure>

<p>list all children</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.getchildren()</span><br><span class="line">[&lt;Element &#39;country&#39; at 0x7f58bd825bd0&gt;, &lt;Element &#39;country&#39; at 0x7f58bd823f10&gt;, &lt;Element &#39;country&#39; at 0x7f58bd8239d0&gt;</span><br></pre></td></tr></table></figure>

<h2 id="insert-tag"><a href="#insert-tag" class="headerlink" title="insert tag"></a>insert tag</h2><p>create new element from string:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; new_element_str&#x3D;&#39;&#39;&#39;    &lt;country name&#x3D;&quot;China&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;2&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2022&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Japan&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;&#39;&#39;&#39;</span><br><span class="line">(reverse-i-search)&#96;lo&#39;: &#123;&#39;name&#39;: &#39;Colombia&#39;, &#39;direction&#39;: &#39;E&#39;&#125;</span><br><span class="line">KeyboardInterrupt</span><br><span class="line">&gt;&gt;&gt; &#123;&#39;name&#39;: &#39;Colombia&#39;, &#39;direction&#39;: &#39;E&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;E&#39;, &#39;name&#39;: &#39;Colombia&#39;&#125;</span><br><span class="line">&gt;&gt;&gt; new &#x3D; ET.fromstring(new_element_str)</span><br></pre></td></tr></table></figure>

<p>check origin element tree:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ET.tostring(root)</span><br><span class="line">&#39;&lt;data&gt;\n    &lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;\n        &lt;rank&gt;1&lt;&#x2F;rank&gt;\n        &lt;year&gt;2008&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Austria&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Switzerland&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Singapore&quot;&gt;\n        &lt;rank&gt;4&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;N&quot; name&#x3D;&quot;Malaysia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Panama&quot;&gt;\n        &lt;rank&gt;68&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Costa Rica&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Colombia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n&lt;&#x2F;data&gt;&#39;</span><br></pre></td></tr></table></figure>

<p>insert new element:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ET.tostring(root)</span><br><span class="line">&#39;&lt;data&gt;\n    &lt;country name&#x3D;&quot;China&quot;&gt;\n        &lt;rank&gt;2&lt;&#x2F;rank&gt;\n        &lt;year&gt;2022&lt;&#x2F;year&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Japan&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;&lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;\n        &lt;rank&gt;1&lt;&#x2F;rank&gt;\n        &lt;year&gt;2008&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Austria&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Switzerland&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Singapore&quot;&gt;\n        &lt;rank&gt;4&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;N&quot; name&#x3D;&quot;Malaysia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Panama&quot;&gt;\n        &lt;rank&gt;68&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Costa Rica&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Colombia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n&lt;&#x2F;data&gt;</span><br></pre></td></tr></table></figure>

<p>confirm new element is added:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for country in root.findall(&#39;country&#39;):</span><br><span class="line">...     country.get(&#39;name&#39;)</span><br><span class="line">...</span><br><span class="line">&#39;China&#39;</span><br><span class="line">&#39;Liechtenstein&#39;</span><br><span class="line">&#39;Singapore&#39;</span><br><span class="line">&#39;Panama&#39;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/01/python-elementtree-notes/" data-id="cld1mheb4001dyuwb2id44d0w" data-title="Python ElementTree notes" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/01/python-elementtree-notes/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/01/python-elementtree-notes/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-kvm-introduction-00" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/30/kvm-introduction-00/" class="article-date">
  <time class="dt-published" datetime="2022-06-30T15:47:07.000Z" itemprop="datePublished">2022-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/30/kvm-introduction-00/">KVM introduction 00</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>See notation of <code>virt/kvm/kvm_main.c</code> in linux kernel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Kernel-based Virtual Machine driver for Linux</span><br><span class="line"> *</span><br><span class="line"> * This module enables machines with Intel VT-x extensions to run virtual</span><br><span class="line"> * machines without emulation or binary translation.</span><br><span class="line"> *</span><br><span class="line"> * Copyright (C) 2006 Qumranet, Inc.</span><br><span class="line"> * Copyright 2010 Red Hat, Inc. and&#x2F;or its affiliates.</span><br><span class="line"> *</span><br><span class="line"> * Authors:</span><br><span class="line"> *   Avi Kivity   &lt;avi@qumranet.com&gt;</span><br><span class="line"> *   Yaniv Kamay  &lt;yaniv@qumranet.com&gt;</span><br><span class="line"> *</span><br><span class="line"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span><br><span class="line"> * the COPYING file in the top-level directory.</span><br><span class="line"> *</span><br><span class="line"> *</span><br></pre></td></tr></table></figure>

<p>I got some questions</p>
<ul>
<li>what means kernel-based</li>
<li>what is VT-x</li>
<li>emulation? binary traslation?</li>
<li>who is Avi Kivity</li>
<li>is there any user-mode hypervisor?</li>
</ul>
<h2 id="Kernel-based"><a href="#Kernel-based" class="headerlink" title="Kernel-based"></a>Kernel-based</h2><blockquote>
</blockquote>
<p>Kernel-based Virtual Machine (KVM) is a virtualization module in the Linux kernel that allows the kernel to function as a hypervisor. It was merged into the mainline Linux kernel in version 2.6.20, which was released on February 5, 2007. <sup>[1]</sup></p>
<p>its available under <code>linux/virt</code></p>
<h2 id="VT-x"><a href="#VT-x" class="headerlink" title="VT-x"></a>VT-x</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">This module enables machines with Intel VT-x extensions to run virtual</span><br><span class="line">machines without emulation or binary translation.</span><br></pre></td></tr></table></figure>

<p>According to the code notation, Intel VT-x extensions is metioned.</p>
<blockquote>
</blockquote>
<p>Previously codenamed “Vanderpool”, VT-x represents Intel’s technology for virtualization on the x86 platform. On November 13, 2005, Intel released two models of Pentium 4 (Model 662 and 672) as the first Intel processors to support VT-x. The CPU flag for VT-x capability is “vmx”; in Linux, this can be checked via /proc/cpuinfo, or in macOS via sysctl machdep.cpu.features.<sup>[2]</sup></p>
<p>for example, on centos 7.6</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cat &#x2F;proc&#x2F;cpuinfo | grep vmx | head -1</span><br><span class="line">flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx avx512f avx512dq rdseed adx smap clflushopt clwb avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 arat</span><br></pre></td></tr></table></figure>

<p>or on Intel CPU MacBook Pro (2020)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sysctl machdep.cpu.features | grep -i vmx</span><br><span class="line">machdep.cpu.features: FPU VME DE PSE TSC MSR PAE MCE CX8 APIC SEP MTRR PGE MCA CMOV PAT PSE36 CLFSH DS ACPI MMX FXSR SSE SSE2 SS HTT TM PBE SSE3 PCLMULQDQ DTES64 MON DSCPL VMX EST TM2 SSSE3 FMA CX16 TPR PDCM SSE4.1 SSE4.2 x2APIC MOVBE POPCNT AES PCID XSAVE OSXSAVE SEGLIM64 TSCTMR AVX1.0 RDRAND F16C</span><br></pre></td></tr></table></figure>

<p>vmx is available</p>
<blockquote>
</blockquote>
<p>“VMX” stands for Virtual Machine Extensions, which adds 13 new instructions: VMPTRLD, VMPTRST, VMCLEAR, VMREAD, VMWRITE, VMCALL, VMLAUNCH, VMRESUME, VMXOFF, VMXON, INVEPT, INVVPID, and VMFUNC.[21] These instructions permit entering and exiting a virtual execution mode where the guest OS perceives itself as running with full privilege (ring 0), but the host OS remains protected.<sup>[2]</sup></p>
<p>note: virtual execution mode is a important concept</p>
<p>refer to paper <strong>kvm: the Linux Virtual Machine Monitor</strong> KVM is designed to add a guest mode, joining the existing <em>kernel mode</em> and <em>user mode</em> </p>
<img src="/2022/06/30/kvm-introduction-00/cpu_executino_loop.png" class="">

<p>In <em>guest-mode</em> CPU instruction executed natively but when I/O requests or signal(typically, network packets received or timeout), exit <em>guest-mode</em> is required and kvm than redirect those I/O or signal handling to <em>user-mode</em> process to emulation device and execute actual I/O. After I/O handling finished, KVM will enter guest mode to execute its CPU instructions again.</p>
<p>For <em>kernel-mode</em> handling exit and enter is basic task. And <em>user-mode</em> process calls kernel to enter <em>guest-mode</em> until it interrupt.</p>
<h2 id="Emulation-amp-Binary-translation"><a href="#Emulation-amp-Binary-translation" class="headerlink" title="Emulation &amp; Binary translation"></a>Emulation &amp; Binary translation</h2><blockquote>
</blockquote>
<p>In computing, binary translation is a form of binary recompilation where sequences of instructions are translated from a source instruction set to the target instruction set. In some cases such as instruction set simulation, the target instruction set may be the same as the source instruction set, providing testing and debugging features such as instruction trace, conditional breakpoints and hot spot detection.</p>
<blockquote>
</blockquote>
<p>The two main types are static and dynamic binary translation. Translation can be done in hardware (for example, by circuits in a CPU) or in software (e.g. run-time engines, static recompiler, emulators).<sup>[3]</sup></p>
<p>Emulators mostly used to run softwares or applications on current OS where those softwares or applications are not support. For example, <a target="_blank" rel="noopener" href="https://github.com/OpenEmu/OpenEmu">https://github.com/OpenEmu/OpenEmu</a> a multiple video game system. This is advantage of emulators.</p>
<p>Disadvantage is that binary translation sometimes require instructino scan, if its used for CPU instruction translations, it spends more time than native instruction. More details in <a target="_blank" rel="noopener" href="https://people.redhat.com/pbonzini/qemu-test-doc/_build/html/topics/Translator-Internals.html">Translator-Internals</a> will be talked in next blogs.</p>
<h2 id="Avi-Kivity"><a href="#Avi-Kivity" class="headerlink" title="Avi Kivity"></a>Avi Kivity</h2><p>Mad C++ developer, proud grandfather of KVM. Now working on @ScyllaDB, an open source drop-in replacement for Cassandra that’s 10X faster. Hiring (remotes too).</p>
<p>from <a target="_blank" rel="noopener" href="https://twitter.com/avikivity">https://twitter.com/avikivity</a></p>
<blockquote>
</blockquote>
<p>Avi Kivity began the development of KVM in mid-2006 at Qumranet, a technology startup company that was acquired by Red Hat in 2008. KVM surfaced in October, 2006 and was merged into the Linux kernel mainline in kernel version 2.6.20, which was released on 5 February 2007. </p>
<blockquote>
</blockquote>
<p>KVM is maintained by Paolo Bonzini. <sup>[1]</sup></p>
<h2 id="Virtualization"><a href="#Virtualization" class="headerlink" title="Virtualization"></a>Virtualization</h2><img src="/2022/06/30/kvm-introduction-00/hardware_assisted_virtualization.png" class="">

<p>For hardware assisted virtualiztion, VMM running below ring0 Guest OS, user application can directly execute user requests, and sensitive OS call trap to VMM without binary translation or Paravirtualization so overhead is decreased.</p>
<p>But for older full virtualization design</p>
<img src="/2022/06/30/kvm-introduction-00/full_virtualization.png" class="">

<p>Guest OS runs on Ring1 and VMM runs on Ring0, without hardware assist, OS requests trap to VMM and after binary translation the instruction finally executed.</p>
<h2 id="KVM-Details"><a href="#KVM-Details" class="headerlink" title="KVM Details"></a>KVM Details</h2><h3 id="Memory-map"><a href="#Memory-map" class="headerlink" title="Memory map"></a>Memory map</h3><p>From perspective of Linux guest OS. Physical memory is already prepared and virtual memory is allocated depend on the physical memory. When guest OS require a virtual address(GVA), Guest OS need to translate is to guest physical address(GPA), this obey the prinsiple of Linux, and tlb, page cache will be involved. And no difference with a Linux Guest running on a real server.</p>
<p>From perspective of host, start a Guest need to allocate a memory space as GPA space. So every GPA has a mapped host virtual address(HVA) and also a host physical address(HPA)</p>
<p>So typically, if a guest need to access a virtual memory address</p>
<p>GVA -&gt; GPA -&gt; HVA -&gt; GPA</p>
<p>at least three times of translation is needed.</p>
<p>Nowadays, CPU offer EPT(Intel) or NPT(AMD) to accelerate GPA -&gt; HVA translation. We will refer that in after blogs.</p>
<h3 id="vMMU"><a href="#vMMU" class="headerlink" title="vMMU"></a>vMMU</h3><p>MMU consists of </p>
<ul>
<li>A radix tree ,the page table, encoding the virtual- to-physical translation. This tree is provided by system software on physical memory, but is rooted in a hardware register (the cr3 register)</li>
<li>A mechanism to notify system software of missing translations (page faults)</li>
<li>An on-chip cache(the translation lookaside buffer, or tlb) that accelerates lookups of the page table</li>
<li>Instructions for switching the translation root inorder to provide independent address spaces</li>
<li>Instructions for managing the tlb</li>
</ul>
<p>As referred in <strong>Memory map</strong> GPA -&gt; HVA should be offered by KVM.</p>
<p>If no hardware assist, use shadow table to maintain the map between GPA and HVA, the good point of shadow table is that runtime address translation overhead is decrease but the major problem is how to synchronize guest page table with shadow page table, when guest writes page table, the shadow page table need to be changed together, so virtual MMU need offer hooks to implement this.</p>
<p>Another question is context switch. Shadow page tables based on the fact that guest should sync its tlb with shadow page tables so that tlb management instruction will be trapped. But the most common tlb management instruction in context-switch is invalidates the entire tlb. So the shadow page tables need to be synced again. Causes bad performance when vm runs multi processes.</p>
<p>vMMU is implement in order to improve guest performance which caches all page tables during context switch. This means context swtich could find its cache from vMMU directly, invdalidates tlb has no influence on context-switch.</p>
<ul>
<li>[1] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine</a></li>
<li>[2] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)">https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)</a></li>
<li>[3] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Binary_translation">https://en.wikipedia.org/wiki/Binary_translation</a></li>
<li>[4] <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/ols/2007/ols2007v1-pages-225-230.pdf">https://www.kernel.org/doc/ols/2007/ols2007v1-pages-225-230.pdf</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/06/30/kvm-introduction-00/" data-id="cld1mheai000nyuwb2orxc0lk" data-title="KVM introduction 00" class="article-share-link">Share</a>
      
      
        <a href="/2022/06/30/kvm-introduction-00/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/06/30/kvm-introduction-00/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/" class="article-date">
  <time class="dt-published" datetime="2022-06-09T14:22:56.000Z" itemprop="datePublished">2022-06-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/translation/">translation</a>►<a class="article-category-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/">Achieving network wirespeed in an open standard manner: introducing vDPA</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>之前的文章里，我们讨论了现存的virtio-networking架构，包括基于内核的（vhost-net/virtio-net）以及基于用户态DPDK的（vhost-user/vhost-pmd），现在我们需要转移我们的注意力到一个目标是让virtio-networking架构给VM提供有线连接速度的架构</p>
<p>本文将会涵盖构成这个架构的数据面以及控制面组件。我们将会介绍SR-IOV技术，以及这个技术如何提升网络性能。还会介绍virtio的硬件方案以及vDPA（virtual data path acceleration）带来的巨大好处。最后通过比较这些virtio-networking架构来做一个总结。</p>
<p>本文主要是为了那些有兴趣想了解不同virtio-networking架构的（包括vDPA），但不那么深入细节的人。当然后面也会提供一个技术细节的分享以及一个实践教程。</p>
<h2 id="Data-plane-and-control-plane-for-direct-access-to-NIC"><a href="#Data-plane-and-control-plane-for-direct-access-to-NIC" class="headerlink" title="Data plane and control plane for direct access to NIC"></a>Data plane and control plane for direct access to NIC</h2><p>在之前的vhost-net/virtio-net和vhost-user/vhost-pmd架构里，网卡都是接入在OVS kernel或者OVS-DPDK里的，而virtio的后端接口则是从OVS的另外一个port出去的</p>
<p>为了提升网络性能，直接把网络连到guest里，和之前的virtio架构类似，我们拆分了网卡的控制面和数据面：</p>
<ol>
<li>控制面。提供网卡和guest之前的配置修改和特性协商功能，用来建立和销毁数据面通道</li>
<li>数据面。用来在guest和网卡之间传输数据包。当直接把网卡连接到guest的时候，实际上是要求网卡要支持virtio ring layout的</li>
</ol>
<p>这个架构如下图所示：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure1.jpeg" class="">

<p>笔记：</p>
<ul>
<li>如果需要知道KVM，libvirt以及Qemu进程的额外信息，可以看前面的文章</li>
<li>数据面直接从网卡到guest，实际上是通过guest提供一个网卡可访问的共享内存实现的，并且并不经过host kernel。这个意味着网卡和guest都需要使用完全一致的ring layout否则就需要做地址翻译，地址翻译意味着性能损耗</li>
<li>控制面的实现则可能设计host kernel或者qemu进程，这个取决于具体的实现</li>
</ul>
<h2 id="SR-IOV-for-isolating-VM-traffic"><a href="#SR-IOV-for-isolating-VM-traffic" class="headerlink" title="SR-IOV for isolating VM traffic"></a>SR-IOV for isolating VM traffic</h2><p>在vhost-net/virtio-net和vhost-user/virto-pmd架构里，我们是用了软件交换机（OVS）可以让一个网卡对接到物理端口上，然后分发数据包到不同的虚拟机的端口上。</p>
<p>把网卡挂在虚拟机上最简单的方法就是硬件透传，也就是直接把一个网卡提供给guest kernel的驱动。</p>
<p>问题是我们需要在服务器上有一个单独的通过PIC暴露的物理网卡，接下来的问题就是我们如何在物理网卡上创建“虚拟端口”？</p>
<p>SR-IOV（Single root I/O virtualization)是一种PCI设备规范，允许共享一个物理设备给多个虚拟机。换言之，这个功能允许不同的虚拟环境里的虚拟机共享一个网卡。这意味着我们能够拥有一个类似把一个物理网卡拆分为多个以太网接口的功能，帮我们解决了上面提到的“虚拟端口”的创建问题。</p>
<p>SR-IOV有两个主要功能</p>
<ol>
<li>Physical Functions，即PCI设备的完整功能，包括发现，管理和配置功能。每个网卡都有一个对应的PF能提供整个网卡设备的配置</li>
<li>Virtual Functions，是单个PCI功能，可以控制设备的一部分，并且是PF的子集。同一个网卡上能有多个VF</li>
</ol>
<p>我们需要在网卡上配置VF，PF，VF相当于是虚拟接口，PF相当于是网络接口，举个例子，我们有一个10GB网卡有一个外部接口和8个VF。那么这个外部端口的速度以及双工是取决于PF的配置而频率限制则是VF的设置</p>
<p>hypervisor提供了映射virtual function到虚拟机的功能，每个VF都可以被映射到一个VM（一个VM可以同时有多个VF）</p>
<p>然后来看看SR-IOV是如何映射到guest kernel，用户态DPDK或者是直接到host kernel的吧</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure2.jpeg" class="">

<ol>
<li>OVS和SR-IOV： 我们使用SR-IOV给OVS提供多个物理面端口，比如配置多个单独的mac地址，虽然我们只有一个物理网卡，但可以通过VF实现。并且给每分配一段内核内存到特定到VF（每个VF都有）</li>
<li>OVS DPDK和SR-IOV：跳过物理机内核，通过SR-IOV直接从物理网卡到OVS-DPDK。映射host用户态内存给网卡的VF</li>
<li>SR-IOV + guests：映射guest内存到网卡，跳过所有物理机环节。注意：使用设备透传，ring layout在物理网卡和guest之间是共享的，因此特定网卡才能被使用，因为这个逻辑一定是网卡厂商提供的。</li>
</ol>
<p>注意：当然还有不是很常见的第四个方案，就是透传设备给guest里的用户态DPDK应用。</p>
<h2 id="SR-IOV-for-mapping-NIC-to-guest"><a href="#SR-IOV-for-mapping-NIC-to-guest" class="headerlink" title="SR-IOV for mapping NIC to guest"></a>SR-IOV for mapping NIC to guest</h2><p>重点说一下SR-IOV到guest的情况，这里存在一个问题就是在直接映射内存到网卡的场景下，如何更高效的发包收包。</p>
<p>我们有下面两个方法解决这个问题：</p>
<ol>
<li>使用guest kerel驱动：这个方法就是使用网卡厂商提供的kernel驱动，即直接映射IO内存，这样的话硬件设备就能够直接访问guest kernel的内存了</li>
<li>在guest里使用DPDK-pmd驱动：这个方法，就是使用网卡厂商提供的DPDK pmd驱动，运行在guest的用户态，能够直接映射IO内存，因此硬件设备也能够直接访问用户态的特定进程</li>
</ol>
<p>这一段我们重点看看DPDP pmd驱动的方案，整合起来就是下面这个图：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure3.jpeg" class="">

<p>笔记：</p>
<ul>
<li>数据面是和厂商挂钩的直接访问VF</li>
<li>对SRIOV，网卡厂商的驱动需要在host和guest都装</li>
<li>host内核驱动以及guest的pmd驱动并不直接互相访问，PF/VF的驱动是通过其他接口配置的（比如libvirt等）</li>
<li>厂商提供的VF-pmd需要负责网卡VF的配置而PF驱动则负责在host内核上管理好物理网卡设备</li>
</ul>
<p>总结一下这个方案，我们可以通过SR-IOV + DPDK PMC的方式给Guest提供一个很好的网络性能，不过这个方法还是挺麻烦的。因为这个方法是和厂商绑定的，因此需要在guest和host跑一样的驱动，并且特定网卡。这意味着网卡硬件升级，虚拟机应用驱动也需要升级。如果网卡被替换成了另外一个厂商的网卡，那么guest也需要装一个新的pmd。同时迁移虚拟机则会要求host上配置完全一致。也就是说网卡需要版本一致，物理位置需要一致，并且厂家还要提供迁移支持。</p>
<p>因此我们要处理的问题就是如何使用标准接口实现SR-IOV的性能提升，最好是只需要标准驱动，把这个驱动问题从整个架构中解耦出来。</p>
<p>下面的两个方案就是来解决这个问题的</p>
<h2 id="Virtio-full-HW-offloading"><a href="#Virtio-full-HW-offloading" class="headerlink" title="Virtio full HW offloading"></a>Virtio full HW offloading</h2><p>第一个方案是virtio的硬件替代方案，把virtio的控制面和数据面都转移到硬件上，也就是说网卡（当然还是通过VF来提供虚拟接口），支持virtio控制面的标准，包括发现，特性协商，以及建立/销毁数据面，等等。这个设备也支持virtio rang layout，因此一旦内存在网卡和guest之间被映射了，他们就能够直接通信了。</p>
<p>这个方案里，guest能够直接和网卡使用PCI通讯吗所以没有必要使用额外的驱动。然而需要网卡厂商提供支持virtio标准的网卡，包括控制面的软件实现，一般来说都是操作系统实现的，这个情况就是需要网卡自己实现。</p>
<p>下面是硬件架构的图：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure4.jpeg" class="">

<p>笔记：</p>
<ul>
<li>实际上控制面需要的操作是非常负责的主要是和IOMMU以及vIOMMU，下篇文章里会说</li>
<li>实际上在host kernel，qemu进程还有guest kernel都涉及这个流程，图里面简化了</li>
<li>当然也可以吧virtio数据面控制面放到kernel里而不是用户态（和SRIOV的场景一致），也就是直接使用virtio-net驱动来和网卡通讯（而不是使用virtio-pmd）</li>
</ul>
<h2 id="vDPA-standard-data-plane"><a href="#vDPA-standard-data-plane" class="headerlink" title="vDPA - standard data plane"></a>vDPA - standard data plane</h2><p>Virtual data path acceleration (vDPA) 是一个通过virtio ring layout和放置一个SRIOV在guest，来标准化网卡SRIOV数据面将这个网络性能改善和厂家实现解耦的方案，通过增加一个通用的控制面以及阮家架构来支持vDPA。提供一个抽象层，在SRIOV之上，并且给未来的可拓展IOV打好基础。</p>
<p>和virtio的硬件方案类似，数据面直接建立在网卡和guest之间，都使用virtio ring layout。然而每个网卡厂家可能就会提供各自的驱动了，然后一个通用的vDPA驱动就被添加到了kernel里面来完成常见网卡驱动或控制面之间的virtio控制面翻译工作。</p>
<p>vDPA是一个灵活性更高的方案，相比硬件方案来说，网卡厂家支持virtio ring layout的成本更小了，并且也能够达到性能提升的目的。</p>
<p>示例图如下：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure5.jpeg" class="">

<p>笔记：</p>
<ul>
<li>实际上在host kernel，qemu进程还有guest kernel都涉及这个流程，图里面简化了</li>
<li>类似SRIOV和virtio全硬件方案，数据面控制面都是在guest内核里而不是用户态（优劣和之前提到的一样）</li>
</ul>
<p>vDPA有潜力成为一个权威的给虚拟机提供以太网接口的方案：</p>
<ol>
<li>开源的标准：任何人可用，并且贡献标准，而不被特定的厂商限制</li>
<li>优异的性能：接近SRIOV，中间没有翻译成本</li>
<li>可以支持未来的硬件平台拓展技术</li>
<li>独立于特定厂商的标准驱动，意味着只需要配置一次驱动，而不用太关心网卡和版本</li>
<li>传输保护，guest直接使用单个接口。从host角度容易发现，并可以做好切换</li>
<li>在线迁移，提供不同网卡不同版本的在线迁移</li>
<li>提供一个标准的容器加速接口</li>
<li>裸机，提供标准的网卡驱动mvirtio网卡驱动可以被作为一个裸机驱动，当时用vDPA软件架构的时候，驱动这个驱动来适配不同网卡硬件</li>
</ol>
<h2 id="Comparing-virtio-architectures"><a href="#Comparing-virtio-architectures" class="headerlink" title="Comparing virtio architectures"></a>Comparing virtio architectures</h2><p>总结一下之前的系列里我们学到的内容，包括四种提供给vm以太网络的架构，vhost-net/virito-net, vhost-user/virito-pmd, virtio full HW offloading 和 vDPA。</p>
<p>然后来比较一下他们的优劣：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/virtio-arch-compare.png" class="">

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇文章我们包含了四种提供以太网接口的virtio-networking架构概览，包括速度慢的（virtio-net）到比较快的（vhost-user）还有最快的（virtio硬件方案和vDPA）</p>
<p>我们强调vDPA和SR-IOV相对其他技术来说的优势，也提供了四种技术的对比，接下来会更加深入的使用virtio硬件方案以及vDPA。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/" data-id="cld1mhe9t0001yuwbfbjaec59" data-title="Achieving network wirespeed in an open standard manner: introducing vDPA" class="article-share-link">Share</a>
      
      
        <a href="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/python/">python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio/">virtio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpu/" rel="tag">cpu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/performance/" rel="tag">performance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysstat/" rel="tag">sysstat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt-top/" rel="tag">virt-top</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BSOD/" style="font-size: 10px;">BSOD</a> <a href="/tags/DPDK/" style="font-size: 12.86px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/TDP/" style="font-size: 11.43px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 18.57px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/cpu/" style="font-size: 11.43px;">cpu</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 10px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 12.86px;">java</a> <a href="/tags/kernel/" style="font-size: 14.29px;">kernel</a> <a href="/tags/kvm/" style="font-size: 15.71px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 12.86px;">libvirt</a> <a href="/tags/linux/" style="font-size: 17.14px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/performance/" style="font-size: 10px;">performance</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 12.86px;">software-arch</a> <a href="/tags/sysstat/" style="font-size: 10px;">sysstat</a> <a href="/tags/system-design/" style="font-size: 12.86px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 17.14px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 14.29px;">virt</a> <a href="/tags/virt-top/" style="font-size: 10px;">virt-top</a> <a href="/tags/virtio/" style="font-size: 15.71px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 17.14px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 17.14px;">virtio-networking</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/13/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">KVM虚拟化性能分析</a>
          </li>
        
          <li>
            <a href="/2023/03/09/cpu-features-about-kvm-hidden/">Cpu features about kvm hidden</a>
          </li>
        
          <li>
            <a href="/2023/03/03/virtio-on-linux/">Virtio on Linux</a>
          </li>
        
          <li>
            <a href="/2023/03/01/cpu-feature-configuration-code-diving/">Cpu feature configuration code diving</a>
          </li>
        
          <li>
            <a href="/2023/02/23/packed-virtqueue-how-to-reduce-overhead-with-virtio/">Packed virtqueue: How to reduce overhead with virtio</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>