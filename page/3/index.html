<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>花の様に</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="花の様に">
<meta property="og:url" content="http://hanayo.cn/page/3/index.html">
<meta property="og:site_name" content="花の様に">
<meta property="og:locale">
<meta property="article:author" content="Alan Jager">
<meta property="article:tag" content="ブログ">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="花の様に" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">花の様に</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://hanayo.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-guest-free-page-hinting-notes-01" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/04/guest-free-page-hinting-notes-01/" class="article-date">
  <time class="dt-published" datetime="2022-09-04T13:41:09.000Z" itemprop="datePublished">2022-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/04/guest-free-page-hinting-notes-01/">Guest Free Page Hinting notes 01</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>基于virtio1.2的推送，在virtio-balloon设备下有一条新特性：free page hints</p>
<p>因为不太了解这个东西具体做了啥，查了一番资料</p>
<h2 id="KVM-Guest-Free-Page-Hinting"><a href="#KVM-Guest-Free-Page-Hinting" class="headerlink" title="KVM: Guest Free Page Hinting"></a>KVM: Guest Free Page Hinting</h2><p>在2019年2月有这样一封邮件记录 <a target="_blank" rel="noopener" href="https://lwn.net/Articles/778432/">https://lwn.net/Articles/778432/</a></p>
<blockquote>
<p>The following patch-set proposes an efficient mechanism for handing freed memory between the guest and the host. It enables the guests with no page cache to rapidly free and reclaims memory to and from the host respectively.</p>
</blockquote>
<p>看起来主要目的是为了优化guest和host之间的空闲内存管理，避免出现需要快速释放或者回收page cache内存</p>
<p>同时里面提到了</p>
<p> Known code re-work:</p>
<ul>
<li>Plan to re-use Wei’s work, which communicates the poison value to the host.</li>
<li>The nomenclatures used in virtio-balloon needs to be changed so that the code can easily be distinguished from Wei’s Free Page Hint code.</li>
<li>Sorting based on zonenum, to avoid repetitive zone locks for the same zone.</li>
</ul>
<p>需要对virtio-balloon做一些修改来来保证代码能够和这部分Free Page Hint的代码保持区别。</p>
<p>这么说感觉好像是Hint的代码和virtio-balloon是两套</p>
<h2 id="Virtio-balloon-support-free-page-reporting"><a href="#Virtio-balloon-support-free-page-reporting" class="headerlink" title="Virtio-balloon: support free page reporting"></a>Virtio-balloon: support free page reporting</h2><p>基于上面查到的资料，又发现了另外一篇直接提到Virtio-balloon的改动 <a target="_blank" rel="noopener" href="https://lwn.net/Articles/759413/">https://lwn.net/Articles/759413/</a></p>
<p>里面新增的 VIRTIO_BALLOON_F_FREE_PAGE_HINT 是可以和 <a target="_blank" rel="noopener" href="https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.pdf">https://docs.oasis-open.org/virtio/virtio/v1.2/virtio-v1.2.pdf</a> virtio1.2的spec对应上的</p>
<p>摘抄一下里面的描述</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Live migration needs to transfer the VM&#39;s memory from the source machine</span><br><span class="line">to the destination round by round. For the 1st round, all the VM&#39;s memory</span><br><span class="line">is transferred. From the 2nd round, only the pieces of memory that were</span><br><span class="line">written by the guest (after the 1st round) are transferred. One method</span><br><span class="line">that is popularly used by the hypervisor to track which part of memory is</span><br><span class="line">written is to write-protect all the guest memory.</span><br><span class="line"></span><br><span class="line">This feature enables the optimization by skipping the transfer of guest</span><br><span class="line">free pages during VM live migration. It is not concerned that the memory</span><br><span class="line">pages are used after they are given to the hypervisor as a hint of the</span><br><span class="line">free pages, because they will be tracked by the hypervisor and transferred</span><br><span class="line">in the subsequent round if they are used and written.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>针对热迁移场景，会不停的copy memory。第一轮会复制所有内存，后续只需要复制guest写过的内存。</p>
<p>因此hypervisor需要记录guest写过哪些内存，然后全都复制一遍。</p>
<p>而这个功能是用来优化guest free page transfer的。即忽略这些已经被标记为free page的内容，如果后续这些page被使用了或者被写了，下一轮内存拷贝才考虑这些page。</p>
<p>通过这段描述，可以知道这个优化需要提供一个机制，来提供free page hint，并以此为基础来优化live migration。</p>
<h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2><p>在准备看代码之前，发现了一段很有意思的内容</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- mm&#x2F;get_from_free_page_list: The new implementation to get free page</span><br><span class="line">  hints based on the suggestions from Linus:</span><br><span class="line">  https:&#x2F;&#x2F;lkml.org&#x2F;lkml&#x2F;2018&#x2F;6&#x2F;11&#x2F;764</span><br><span class="line">  This avoids the complex call chain, and looks more prudent.</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对获取 <code>get_from_free_page_list</code> 操作，linus回了很长的一段建议</p>
<p>里面很有意思的是，是不是要加一个新的 GFP_NONE，来标记分配失败？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Maybe it will help to have GFP_NONE which will make any allocation</span><br><span class="line">fail if attempted. Linus, would this address your comment?</span><br></pre></td></tr></table></figure>

<p>而linus的回复是，如果不用这么复杂的会引起内存分配的调用，用一个简单的机制来避免这个问题发生感觉更好</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">So instead of having virtio_balloon_send_free_pages() call a really</span><br><span class="line">generic complex chain of functions that in _some_ cases can do memory</span><br><span class="line">allocation, why isn&#39;t there a short-circuited &quot;vitruque_add_datum()&quot;</span><br><span class="line">that is guaranteed to never do anything like that?</span><br></pre></td></tr></table></figure>

<p>中间还有很长的一些简化代码的建议，里面有这么一句话，评价这部分代码太复杂并且太脆弱了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The whole sequence of events really looks &quot;this is too much</span><br><span class="line">complexity, and way too fragile&quot; to me at so many levels.</span><br></pre></td></tr></table></figure>

<p>让我联想到目前ZStack里面一些功能的实现逻辑存在情况</p>
<ol>
<li>实现了机制B解决机制A的问题</li>
<li>复用了，不熟悉的机制A，忽略了A本身存在的问题</li>
</ol>
<p>结合一个实际功能说一下这个问题，比如vm的kernel panic检测，有两个必要选项</p>
<ol>
<li>给vm增加一个pvpanic的xml配置</li>
<li>虚拟机内部需要启用内核pvpanic模块</li>
</ol>
<p>因此这个功能实现需要guest和host相互配合才能判定是否可用</p>
<p>基于这个前提，guest内部的逻辑需要提供传递guest内部是否支持pvpanic的信息，host上需要从配置中获取是否配置过pvpanic，因此实现这个逻辑的时候需要分别查询这两个信息。而查询host上的配置最终导致了一些控制面的bug。</p>
<p>后来反思这个问题的时候，只从host配置获取的逻辑出发，但是忽略了运行时配置不会变更的前提，其实并没有必要增加一个多余的查询逻辑，反而导致这个问题依赖了已有的配置查询机制，最终引起了更复杂的现象。</p>
<p>kernel的开源世界也会有人碰到这样的问题，所以整理好功能设计的方法论还是很重要的，至少能够指导怎么做能设计的更好，提升committer和coder的水平。</p>
<p>反过来想想：</p>
<ol>
<li>guest tool在运行时返回的云主机所支持的特性，实际上总是和他的版本绑定的，只要获取过一次其实就不需要反复获取了。</li>
<li>如果guest tool版本发生了变化，才需要重新获取这个信息</li>
<li>提供主动更新guest tool特性的功能即可</li>
</ol>
<p>其实这样拆解这个问题，云主机其实本身就应该保存这些特性信息而不需要总是去获取，这样机制的设计可以简化很多。</p>
<p>而之前的设计出发点并不是基于对整个功能的理解，而是类似新增 <code>GFP_NONE</code> 来解决问题的思路。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/04/guest-free-page-hinting-notes-01/" data-id="cld1mhea8000cyuwbca2qgz2p" data-title="Guest Free Page Hinting notes 01" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/04/guest-free-page-hinting-notes-01/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/04/guest-free-page-hinting-notes-01/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-java-class-getname-and-getsimplename-get-me-confuse" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" class="article-date">
  <time class="dt-published" datetime="2022-09-04T13:37:27.000Z" itemprop="datePublished">2022-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/">Java Class getName() vs getSimpleName()</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Work with Java reflection and invoke getSimpleName() met <code>java.lang.NoClassDefFoundError</code></p>
<p>Use getName() instead, the logic seems work well.</p>
<p>Before compare these two methods’ difference go through the code quickly.</p>
<h2 id="Class-getName"><a href="#Class-getName" class="headerlink" title="Class::getName()"></a>Class::getName()</h2><p>for getName()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public String getName() &#123;</span><br><span class="line">    String name &#x3D; this.name;</span><br><span class="line">    if (name &#x3D;&#x3D; null)</span><br><span class="line">        this.name &#x3D; name &#x3D; getName0();</span><br><span class="line">    return name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and the getName0() is native method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native String getName0();</span><br></pre></td></tr></table></figure>



<h2 id="Class-getSimpleName"><a href="#Class-getSimpleName" class="headerlink" title="Class::getSimpleName()"></a>Class::getSimpleName()</h2><p>for getSimpleName()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public String getSimpleName() &#123;</span><br><span class="line">    if (isArray())</span><br><span class="line">        return getComponentType().getSimpleName()+&quot;[]&quot;;</span><br><span class="line"></span><br><span class="line">    String simpleName &#x3D; getSimpleBinaryName();</span><br><span class="line">    if (simpleName &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; top level class</span><br><span class="line">        simpleName &#x3D; getName();</span><br><span class="line">        return simpleName.substring(simpleName.lastIndexOf(&quot;.&quot;)+1); &#x2F;&#x2F; strip the package name</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; According to JLS3 &quot;Binary Compatibility&quot; (13.1) the binary</span><br><span class="line">    &#x2F;&#x2F; name of non-package classes (not top level) is the binary</span><br><span class="line">    &#x2F;&#x2F; name of the immediately enclosing class followed by a &#39;$&#39; followed by:</span><br><span class="line">    &#x2F;&#x2F; (for nested and inner classes): the simple name.</span><br><span class="line">    &#x2F;&#x2F; (for local classes): 1 or more digits followed by the simple name.</span><br><span class="line">    &#x2F;&#x2F; (for anonymous classes): 1 or more digits.</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Since getSimpleBinaryName() will strip the binary name of</span><br><span class="line">    &#x2F;&#x2F; the immediatly enclosing class, we are now looking at a</span><br><span class="line">    &#x2F;&#x2F; string that matches the regular expression &quot;\$[0-9]*&quot;</span><br><span class="line">    &#x2F;&#x2F; followed by a simple name (considering the simple of an</span><br><span class="line">    &#x2F;&#x2F; anonymous class to be the empty string).</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Remove leading &quot;\$[0-9]*&quot; from the name</span><br><span class="line">    int length &#x3D; simpleName.length();</span><br><span class="line">    if (length &lt; 1 || simpleName.charAt(0) !&#x3D; &#39;$&#39;)</span><br><span class="line">        throw new InternalError(&quot;Malformed class name&quot;);</span><br><span class="line">    int index &#x3D; 1;</span><br><span class="line">    while (index &lt; length &amp;&amp; isAsciiDigit(simpleName.charAt(index)))</span><br><span class="line">        index++;</span><br><span class="line">    &#x2F;&#x2F; Eventually, this is the empty string iff this is an anonymous class</span><br><span class="line">    return simpleName.substring(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The main part is </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String simpleName &#x3D; getSimpleBinaryName();</span><br></pre></td></tr></table></figure>

<p>And then get enclosingClass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private String getSimpleBinaryName() &#123;</span><br><span class="line">    Class&lt;?&gt; enclosingClass &#x3D; getEnclosingClass();</span><br><span class="line">    if (enclosingClass &#x3D;&#x3D; null) &#x2F;&#x2F; top level class</span><br><span class="line">        return null;</span><br><span class="line">    &#x2F;&#x2F; Otherwise, strip the enclosing class&#39; name</span><br><span class="line">    try &#123;</span><br><span class="line">        return getName().substring(enclosingClass.getName().length());</span><br><span class="line">    &#125; catch (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">        throw new InternalError(&quot;Malformed class name&quot;, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>what is enclosingClass:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; There are five kinds of classes (or interfaces):</span><br><span class="line">&#x2F;&#x2F; a) Top level classes</span><br><span class="line">&#x2F;&#x2F; b) Nested classes (static member classes)</span><br><span class="line">&#x2F;&#x2F; c) Inner classes (non-static member classes)</span><br><span class="line">&#x2F;&#x2F; d) Local classes (named classes declared within a method)</span><br><span class="line">&#x2F;&#x2F; e) Anonymous classes</span><br></pre></td></tr></table></figure>

<p>in my case it tend to be a) Top level classes, so next part of code goes to getDeclaringClass()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; JVM Spec 4.8.6: A class must have an EnclosingMethod</span><br><span class="line">&#x2F;&#x2F; attribute if and only if it is a local class or an</span><br><span class="line">&#x2F;&#x2F; anonymous class.</span><br><span class="line">EnclosingMethodInfo enclosingInfo &#x3D; getEnclosingMethodInfo();</span><br><span class="line">Class&lt;?&gt; enclosingCandidate;</span><br><span class="line"></span><br><span class="line">if (enclosingInfo &#x3D;&#x3D; null) &#123;</span><br><span class="line">    &#x2F;&#x2F; This is a top level or a nested class or an inner class (a, b, or c)</span><br><span class="line">    enclosingCandidate &#x3D; getDeclaringClass();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Class&lt;?&gt; enclosingClass &#x3D; enclosingInfo.getEnclosingClass();</span><br><span class="line">    &#x2F;&#x2F; This is a local class or an anonymous class (d or e)</span><br><span class="line">    if (enclosingClass &#x3D;&#x3D; this || enclosingClass &#x3D;&#x3D; null)</span><br><span class="line">        throw new InternalError(&quot;Malformed enclosing method information&quot;);</span><br><span class="line">    else</span><br><span class="line">        enclosingCandidate &#x3D; enclosingClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>and then getDeclaringClass0() will be used.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@CallerSensitive</span><br><span class="line">public Class&lt;?&gt; getDeclaringClass() throws SecurityException &#123;</span><br><span class="line">    final Class&lt;?&gt; candidate &#x3D; getDeclaringClass0();</span><br><span class="line"></span><br><span class="line">    if (candidate !&#x3D; null)</span><br><span class="line">        candidate.checkPackageAccess(</span><br><span class="line">                ClassLoader.getClassLoader(Reflection.getCallerClass()), true);</span><br><span class="line">    return candidate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>which is a native method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private native Class&lt;?&gt; getDeclaringClass0();</span><br></pre></td></tr></table></figure>



<h2 id="Comparision"><a href="#Comparision" class="headerlink" title="Comparision"></a>Comparision</h2><p>From the code before this section, aboveously the getSimpleName() always call native method but getName() may use Class’s local variable directly. </p>
<p>So see the local variable before we come to conclusion.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; cache the name to reduce the number of calls into the VM</span><br><span class="line">private transient String name;</span><br></pre></td></tr></table></figure>

<p>the name used by getName() use a transient String as cache to reduce the number of calls into VM.</p>
<p>And combine to getName()’s implement, the first time getName0() invoked, this name is set.</p>
<p>And go for Java doc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String getSimpleName()</span><br></pre></td></tr></table></figure>

<p>Returns the simple name of the underlying class as given in the source code. Returns an empty string if the underlying class is anonymous.</p>
<p>The simple name of an array is the simple name of the component type with “[]” appended. In particular the simple name of an array whose component type is anonymous is “[]”.</p>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the simple name of the underlying class</p>
</li>
<li><p><strong>Since:</strong></p>
<p>1.5</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public String getName()</span><br></pre></td></tr></table></figure>

<p>Returns the name of the entity (class, interface, array class, primitive type, or void) represented by this <code>Class</code> object, as a <code>String</code>.</p>
<p>If this class object represents a reference type that is not an array type then the binary name of the class is returned, as specified by The Java™ Language Specification.</p>
<p>If this class object represents a primitive type or void, then the name returned is a <code>String</code> equal to the Java language keyword corresponding to the primitive type or void.</p>
<p>If this class object represents a class of arrays, then the internal form of the name consists of the name of the element type preceded by one or more ‘<code>[</code>‘ characters representing the depth of the array nesting. The encoding of element type names is as follows:</p>
<blockquote>
<table>
<thead>
<tr>
<th>Element Type</th>
<th></th>
<th>Encoding</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td></td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td></td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td></td>
<td>C</td>
</tr>
<tr>
<td>class or interface</td>
<td></td>
<td>L<em>classname</em>;</td>
</tr>
<tr>
<td>double</td>
<td></td>
<td>D</td>
</tr>
<tr>
<td>float</td>
<td></td>
<td>F</td>
</tr>
<tr>
<td>int</td>
<td></td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td></td>
<td>J</td>
</tr>
<tr>
<td>short</td>
<td></td>
<td>S</td>
</tr>
</tbody></table>
</blockquote>
<p>The class or interface name <em>classname</em> is the binary name of the class specified above.</p>
<p>Examples:</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String.class.getName()</span><br><span class="line">  returns &quot;java.lang.String&quot;</span><br><span class="line">byte.class.getName()</span><br><span class="line">  returns &quot;byte&quot;</span><br><span class="line">(new Object[3]).getClass().getName()</span><br><span class="line">  returns &quot;[Ljava.lang.Object;&quot;</span><br><span class="line">(new int[3][4][5][6][7][8][9]).getClass().getName()</span><br><span class="line">  returns &quot;[[[[[[[I&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the name of the class or interface represented by this object.</p>
</li>
</ul>
<p>and more details for the error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class NoClassDefFoundError</span><br><span class="line">extends LinkageError</span><br></pre></td></tr></table></figure>

<p>Thrown if the Java Virtual Machine or a <code>ClassLoader</code> instance tries to load in the definition of a class (as part of a normal method call or as part of creating a new instance using the <code>new</code> expression) and no definition of the class could be found.</p>
<p>The searched-for class definition existed when the currently executing class was compiled, but the definition can no longer be found.</p>
<p>So that means class found at compile time but not available at runtime <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17973970/how-to-solve-java-lang-noclassdeffounderror">Refer this link</a></p>
<p>Check for our configuration: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;xxx&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xxx&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1.1&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;scope&gt;system&lt;&#x2F;scope&gt;</span><br><span class="line">    &lt;systemPath&gt;$&#123;project.basedir&#125;&#x2F;ext-libs&#x2F;xxx&lt;&#x2F;systemPath&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>use a system scope.</p>
<p>According to maven doc:</p>
<p>There are 6 scopes:</p>
<ul>
<li><strong>compile</strong><br>This is the default scope, used if none is specified. Compile dependencies are available in all classpaths of a project. Furthermore, those dependencies are propagated to dependent projects.</li>
<li><strong>provided</strong><br>This is much like <code>compile</code>, but indicates you expect the JDK or a container to provide the dependency at runtime. For example, when building a web application for the Java Enterprise Edition, you would set the dependency on the Servlet API and related Java EE APIs to scope <code>provided</code> because the web container provides those classes. A dependency with this scope is added to the classpath used for compilation and test, but not the runtime classpath. It is not transitive.</li>
<li><strong>runtime</strong><br>This scope indicates that the dependency is not required for compilation, but is for execution. Maven includes a dependency with this scope in the runtime and test classpaths, but not the compile classpath.</li>
<li><strong>test</strong><br>This scope indicates that the dependency is not required for normal use of the application, and is only available for the test compilation and execution phases. This scope is not transitive. Typically this scope is used for test libraries such as JUnit and Mockito. It is also used for non-test libraries such as Apache Commons IO if those libraries are used in unit tests (src/test/java) but not in the model code (src/main/java).</li>
<li><strong>system</strong><br>This scope is similar to <code>provided</code> except that you have to provide the JAR which contains it explicitly. The artifact is always available and is not looked up in a repository.</li>
<li><strong>import</strong><br>This scope is only supported on a dependency of type <code>pom</code> in the <code>&lt;dependencyManagement&gt;</code> section. It indicates the dependency is to be replaced with the effective list of dependencies in the specified POM’s <code>&lt;dependencyManagement&gt;</code> section. Since they are replaced, dependencies with a scope of <code>import</code> do not actually participate in limiting the transitivity of a dependency.</li>
</ul>
<p>system most like provided but <code>a dependency with this scope is added to the classpath used for compilation and test, but not the runtime classpath</code></p>
<p>so runtime getSimpleName() will met exception.</p>
<h2 id="Class-loader"><a href="#Class-loader" class="headerlink" title="Class loader"></a>Class loader</h2><p>get back to the error call trace again:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.NoClassDefFoundError: xxxxx</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.Class.getDeclaringClass0(Native Method) ~[?:1.8.0_161]</span><br></pre></td></tr></table></figure>

<p>and another class not found exception:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.ClassNotFoundException: xxxxx</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:381) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass1(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.defineClass(ClassLoader.java:763) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.access$100(URLClassLoader.java:73) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:368) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader$1.run(URLClassLoader.java:362) ~[?:1.8.0_161]</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_161]</span><br><span class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:361) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_161]</span><br><span class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:338) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_161]</span><br><span class="line">        at java.lang.Class.getDeclaringClass0(Native Method) ~[?:1.8.0_161]</span><br></pre></td></tr></table></figure>

<p>when try to get simple name of class A extends B</p>
<p>find A and try to define A but need to define B first, but B is not available at runtime so a exception raised.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" data-id="cld1mheac000jyuwb7lxm4rbw" data-title="Java Class getName() vs getSimpleName()" class="article-share-link">Share</a>
      
      
        <a href="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/09/04/java-class-getname-and-getsimplename-get-me-confuse/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Dive-into-edk2-ovmf-fisrt-debug-trip" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" class="article-date">
  <time class="dt-published" datetime="2022-07-27T12:02:47.000Z" itemprop="datePublished">2022-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/">Dive into edk2-ovmf fisrt debug trip</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Prepare-environment"><a href="#Prepare-environment" class="headerlink" title="Prepare environment"></a>Prepare environment</h2><p>install compiler related rpm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo=* --enablerepo=ali* install -y make gcc binutils iasl nasm libuuid-devel gcc-c++</span><br></pre></td></tr></table></figure>

<p>if cross-build firmware on x86 machine, install cross compilers:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --disablerepo=* --enablerepo=ali* install -y gcc-aarch64-linux-gnu gcc-arm-linux-gnu</span><br></pre></td></tr></table></figure>

<p>get source code</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tianocore/edk2.git</span><br><span class="line">cd edk2</span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure>

<p>than setup environment variables:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source edksetup.sh</span><br></pre></td></tr></table></figure>

<p>build base tools at first:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -C BaseTools</span><br></pre></td></tr></table></figure>

<p>note: only need once</p>
<h2 id="Build-firmware"><a href="#Build-firmware" class="headerlink" title="Build firmware"></a>Build firmware</h2><p>Then build firmware for x64 qemu:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a X64 -p OvmfPkg/OvmfPkgX64.dsc</span><br></pre></td></tr></table></figure>

<p>The firmware volumes built can be found in <code>Build/OvmfX64/DEBUG_GCC5/FV</code>.</p>
<p>Building the aarch64 firmware instead:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a AARCH64 -p ArmVirtPkg/ArmVirtQemu.dsc</span><br></pre></td></tr></table></figure>

<p>The build results land in <code>Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV</code>.</p>
<p>Qemu expects the aarch64 firmware images being 64M im size. The firmware images can’t be used as-is because of that, some padding is needed to create an image which can be used for pflash:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dd of=&quot;QEMU_EFI-pflash.raw&quot; if=&quot;/dev/zero&quot; bs=1M count=64</span><br><span class="line">dd of=&quot;QEMU_EFI-pflash.raw&quot; if=&quot;QEMU_EFI.fd&quot; conv=notrunc</span><br><span class="line">dd of=&quot;QEMU_VARS-pflash.raw&quot; if=&quot;/dev/zero&quot; bs=1M count=64</span><br><span class="line">dd of=&quot;QEMU_VARS-pflash.raw&quot; if=&quot;QEMU_VARS.fd&quot; conv=notrunc</span><br></pre></td></tr></table></figure>

<p>There are a bunch of compile time options, typically enabled using <code>-D NAME</code> or <code>-D NAME=TRUE</code>. Options which are enabled by default can be turned off using <code>-D NAME=FALSE</code>. Available options are defined in the <code>*.dsc</code> files referenced by the <code>build</code> command. So a feature-complete build looks more like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a X64 -p OvmfPkg/OvmfPkgX64.dsc \</span><br><span class="line">    -D FD_SIZE_4MB \</span><br><span class="line">    -D NETWORK_IP6_ENABLE \</span><br><span class="line">    -D NETWORK_HTTP_BOOT_ENABLE \</span><br><span class="line">    -D NETWORK_TLS_ENABLE \</span><br><span class="line">    -D TPM2_ENABLE</span><br></pre></td></tr></table></figure>

<p>From <code>OvmfPkgX64.dsc</code> lots of features is defined.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  #</span><br><span class="line">  # Network definition</span><br><span class="line">  #</span><br><span class="line">  DEFINE NETWORK_TLS_ENABLE             &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_IP6_ENABLE             &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_HTTP_BOOT_ENABLE       &#x3D; FALSE</span><br><span class="line">  DEFINE NETWORK_ALLOW_HTTP_CONNECTIONS &#x3D; TRUE</span><br><span class="line">  DEFINE NETWORK_ISCSI_ENABLE           &#x3D; TRUE</span><br><span class="line"></span><br><span class="line">!include NetworkPkg&#x2F;NetworkDefines.dsc.inc</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  # Device drivers</span><br><span class="line">  #</span><br><span class="line">  DEFINE PVSCSI_ENABLE           &#x3D; TRUE</span><br><span class="line">  DEFINE MPT_SCSI_ENABLE         &#x3D; TRUE</span><br><span class="line">  DEFINE LSI_SCSI_ENABLE         &#x3D; FALSE</span><br><span class="line"></span><br><span class="line">  #</span><br><span class="line">  # Flash size selection. Setting FD_SIZE_IN_KB on the command line directly to</span><br><span class="line">  # one of the supported values, in place of any of the convenience macros, is</span><br><span class="line">  # permitted.</span><br><span class="line">  #</span><br><span class="line">!ifdef $(FD_SIZE_1MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 1024</span><br><span class="line">!else</span><br><span class="line">!ifdef $(FD_SIZE_2MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 2048</span><br><span class="line">!else</span><br><span class="line">!ifdef $(FD_SIZE_4MB)</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 4096</span><br><span class="line">!else</span><br><span class="line">  DEFINE FD_SIZE_IN_KB           &#x3D; 4096</span><br></pre></td></tr></table></figure>

<p>Secure boot support (on x64) requires SMM mode. Well, it builds and works without SMM, but it’s not secure then. Without SMM nothing prevents the guest OS writing directly to flash, bypassing the firmware, so protected UEFI variables are not actually protected.</p>
<p>Also suspend (S3) support works with enabled SMM only in case parts of the firmware (PEI specifically, see below for details) run in 32bit mode. So the secure boot variant must be compiled this way:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a IA32 -a X64 -p OvmfPkg/OvmfPkgIa32X64.dsc \</span><br><span class="line">    -D FD_SIZE_4MB \</span><br><span class="line">    -D SECURE_BOOT_ENABLE \</span><br><span class="line">    -D SMM_REQUIRE \</span><br><span class="line">    [ ... add network + tpm + other options as needed ... ]</span><br></pre></td></tr></table></figure>

<p>The <code>FD_SIZE_4MB</code> option creates a larger firmware image, being 4MB instead of 2MB (default) in size, offering more space for both code and vars. The RHEL/CentOS builds use that. The Fedora builds are 2MB in size, for historical reasons.</p>
<p>If you need 32-bit firmware builds for some reason, here is how to do it:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">build -t GCC5 -a ARM -p ArmVirtPkg/ArmVirtQemu.dsc</span><br><span class="line">build -t GCC5 -a IA32 -p OvmfPkg/OvmfPkgIa32.dsc</span><br></pre></td></tr></table></figure>

<p>The build results will be in in <code>Build/ArmVirtQemu-ARM/DEBUG_GCC5/FV</code> and <code>Build/OvmfIa32/DEBUG_GCC5/FV</code></p>
<h3 id="Booting-fresh-firmware-builds"><a href="#Booting-fresh-firmware-builds" class="headerlink" title="Booting fresh firmware builds"></a>Booting fresh firmware builds</h3><p>The x86 firmware builds create three different images:</p>
<ul>
<li><p><code>OVMF_VARS.fd</code></p>
<p>This is the firmware volume for persistent UEFI variables, i.e. where the firmware stores all configuration (boot entries and boot order, secure boot keys, …). Typically this is used as template for an empty variable store and each VM gets its own private copy, libvirt for example stores them in <code>/var/lib/libvirt/qemu/nvram</code>.</p>
</li>
<li><p><code>OVMF_CODE.fd</code></p>
<p>This is the firmware volume with the code. Separating this from VARS does (a) allow for easy firmware updates, and (b) allows to map the code read-only into the guest.</p>
</li>
<li><p><code>OVMF.fd</code></p>
<p>The all-in-one image with both <code>CODE</code> and <code>VARS</code>. This can be loaded as ROM using <code>-bios</code>, with two drawbacks: (a) UEFI variables are not persistent, and (b) it does not work for <code>SMM_REQUIRE=TRUE</code> builds.</p>
</li>
</ul>
<p>qemu handles pflash storage as block devices, so we have to create block devices for the firmware images:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CODE=$&#123;WORKSPACE&#125;/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd</span><br><span class="line">VARS=$&#123;WORKSPACE&#125;/Build/OvmfX64/DEBUG_GCC5/FV/OVMF_VARS.fd</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -blockdev node-name=code,driver=file,filename=$&#123;CODE&#125;,read-only=on \</span><br><span class="line">  -blockdev node-name=vars,driver=file,filename=$&#123;VARS&#125;,snapshot=on \</span><br><span class="line">  -machine q35,pflash0=code,pflash1=vars \</span><br><span class="line">  [ ... ]</span><br></pre></td></tr></table></figure>

<p>Here is the arm version of that (using the padded files created using <code>dd</code>, see above):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CODE=$&#123;WORKSPACE&#125;/Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV/QEMU_EFI-pflash.raw</span><br><span class="line">VARS=$&#123;WORKSPACE&#125;/Build/ArmVirtQemu-AARCH64/DEBUG_GCC5/FV/QEMU_VARS-pflash.raw</span><br><span class="line">qemu-system-aarch64 \</span><br><span class="line">  -blockdev node-name=code,driver=file,filename=$&#123;CODE&#125;,read-only=on \</span><br><span class="line">  -blockdev node-name=vars,driver=file,filename=$&#123;VARS&#125;,snapshot=on \</span><br><span class="line">  -machine virt,pflash0=code,pflash1=vars \</span><br><span class="line">  [ ... ]</span><br></pre></td></tr></table></figure>

<h3 id="Source-code-structure"><a href="#Source-code-structure" class="headerlink" title="Source code structure"></a>Source code structure</h3><p>The core edk2 repo holds a number of packages, each package has its own toplevel directory. Here are the most interesting ones:</p>
<ul>
<li><p>OvmfPkg</p>
<p>This holds both the x64-specific code (i.e. OVMF itself) and virtualization-specific code shared by all architectures (virtio drivers).</p>
</li>
<li><p>ArmVirtPkg</p>
<p>Arm specific virtual machine support code.</p>
</li>
<li><p>MdePkg, MdeModulePkg</p>
<p>Most core code is here (PCI support, USB support, generic services and drivers, …).</p>
</li>
<li><p>PcAtChipsetPkg</p>
<p>Some Intel architecture drivers and libs.</p>
</li>
<li><p>ArmPkg, ArmPlatformPkg</p>
<p>Common Arm architecture support code.</p>
</li>
<li><p>CryptoPkg, NetworkPkg, FatPkg, CpuPkg, …</p>
<p>As the names of the packages already suggest: Crypto support (using openssl), Network support (including network boot), FAT Filesystem driver, …</p>
</li>
</ul>
<h3 id="Firmware-boot-phases"><a href="#Firmware-boot-phases" class="headerlink" title="Firmware boot phases"></a>Firmware boot phases</h3><p>The firmware modules in the edk2 repo often named after the boot phase they are running in. Most drivers are named <code>SomeThing**Dxe**</code> for example.</p>
<ul>
<li><p>ResetVector</p>
<p>This is where code execution starts after a machine reset. The code will do the bare minimum needed to enter SEC. On x64 the most important step is the transition from 16-bit real mode to 32-bit mode or 64bit long mode.</p>
</li>
<li><p>SEC (Security)</p>
<p>This code typically loads and uncompresses the code for PEI and SEC. On physical hardware SEC often lives in ROM memory and can not be updated. The PEI and DXE firmware volumes are loaded from (updateable) flash.</p>
<p>With OVMF both SEC firmware volume and the compressed volume holding PXE and DXE code are part of the OVMF_CODE image and will simply be mapped into guest memory.</p>
</li>
<li><p>PEI (Pre-EFI Initialization)</p>
<p>Platform Initialization is done here. Initialize the chipset. Not much to do here in virtual machines, other than loading the x64 e820 memory map (via fw_cfg) from qemu, or get the memory map from the device tree (on aarch64). The virtual hardware is ready-to-go without much extra preaparation.</p>
<p>PEIMs (PEI Modules) can implement functionality which must be executed before entering the DXE phase. This includes security-sensitive things like initializing SMM mode and locking down flash memory.</p>
</li>
<li><p>DXE (Driver Execution Environment)</p>
<p>When PEI is done it hands over control to the full EFI environment contained in the DXE firmware volume. Most code is here. All kinds of drivers. the firmware setup efi app, …</p>
<p>Strictly speaking this isn’t only one phase. The code for all phases after PEI is part of the DXE firmware volume though.</p>
</li>
</ul>
<h2 id="Add-debug-to-EDK2"><a href="#Add-debug-to-EDK2" class="headerlink" title="Add debug to EDK2"></a>Add debug to EDK2</h2><p>The default OVMF build writes debug messages to IO port 0x402.  The following qemu command line options save them in the file called debug.log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-debugcon file:debug.log -global isa-debugcon.iobase=0x402</span><br></pre></td></tr></table></figure>

<p>Or with build option</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-D DEBUG_ON_SERIAL_PORT</span><br></pre></td></tr></table></figure>

<p>serial output can be captured</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-serial file:serial.log</span><br></pre></td></tr></table></figure>

<p>note:</p>
<p>The RELEASE build target (‘-b RELEASE’ build option, see below) disables all debug messages.  The default build target is DEBUG.</p>
<p>more build scripts:</p>
<p>On systems with the bash shell you can use OvmfPkg/build.sh to simplify<br>building and running OVMF.</p>
<p>So, for example, to build + run OVMF X64:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a X64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a X64 qemu</span></span><br></pre></td></tr></table></figure>

<p>And to run a 64-bit UEFI bootable ISO image:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ OvmfPkg/build.sh -a X64 qemu -cdrom /path/to/disk-image.iso</span><br></pre></td></tr></table></figure>

<p>To build a 32-bit OVMF without debug messages using GCC 4.8:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> OvmfPkg/build.sh -a IA32 -b RELEASE -t GCC48</span></span><br></pre></td></tr></table></figure>



<h2 id="UEFI-Windows-7-amp-Windows-2008-Server"><a href="#UEFI-Windows-7-amp-Windows-2008-Server" class="headerlink" title="UEFI Windows 7 &amp; Windows 2008 Server"></a>UEFI Windows 7 &amp; Windows 2008 Server</h2><ul>
<li>One of the ‘-vga std’ and ‘-vga qxl’ QEMU options should be used.</li>
<li>Only one video mode, 1024x768x32, is supported at OS runtime.</li>
<li>The ‘-vga qxl’ QEMU option is recommended. After booting the installed guest OS, select the video card in Device Manager, and upgrade its driver to the QXL XDDM one. Download location:  <a target="_blank" rel="noopener" href="http://www.spice-space.org/download.html">http://www.spice-space.org/download.html</a>, Guest | Windows binaries. This enables further resolutions at OS runtime, and provides S3  (suspend/resume) capability.</li>
</ul>
<h2 id="Debug-in-practice"><a href="#Debug-in-practice" class="headerlink" title="Debug in practice"></a>Debug in practice</h2><h3 id="Test-with-qemu-commandline"><a href="#Test-with-qemu-commandline" class="headerlink" title="Test with qemu commandline"></a>Test with qemu commandline</h3><p>add with config in libvirt vm xml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;qemu:commandline&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;-debugcon&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;file:&#x2F;var&#x2F;log&#x2F;libvirt&#x2F;qemu&#x2F;debug.log&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;-global&#39;&#x2F;&gt;</span><br><span class="line">  &lt;qemu:arg value&#x3D;&#39;isa-debugcon.iobase&#x3D;0x402&#39;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;qemu:commandline&gt;</span><br></pre></td></tr></table></figure>

<p>debug log will be found in <code>/var/log/libvirt/qemu/debug.log</code></p>
<p>before we met Win2012 internal reboot issue, use debug to check what happen, the log repeat following lines but guest seems hang on vnc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Register PPI Notify: DCD0BE23-9586-40F4-B643-06522CED4EDE</span><br><span class="line">Install PPI: 8C8CE578-8A3D-4F1C-9935-896185C32DD3</span><br><span class="line">Install PPI: 5473C07A-3DCB-4DCA-BD6F-1E9689E7349A</span><br><span class="line">The 0th FV start address is 0x00000820000, size is 0x000E0000, handle is 0x820000</span><br><span class="line">Register PPI Notify: 49EDB1C1-BF21-4761-BB12-EB0031AABB39</span><br><span class="line">Register PPI Notify: EA7CA24B-DED5-4DAD-A389-BF827E8F9B38</span><br><span class="line">Install PPI: B9E0ABFE-5979-4914-977F-6DEE78C278A6</span><br><span class="line">Install PPI: DBE23AA9-A345-4B97-85B6-B226F1617389</span><br><span class="line">DiscoverPeimsAndOrderWithApriori(): Found 0xB PEI FFS files in the 0th FV</span><br><span class="line">Loading PEIM 9B3ADA4F-AE56-4C24-8DEA-F03B7558AE50</span><br><span class="line">Loading PEIM at 0x0000082BE40 EntryPoint&#x3D;0x0000082F201 PcdPeim.efi</span><br><span class="line">Install PPI: 06E81C58-4AD7-44BC-8390-F10265F72480</span><br><span class="line">Install PPI: 01F34D25-4DE2-23AD-3FF3-36353FF323F1</span><br><span class="line">Install PPI: 4D8B155B-C059-4C8F-8926-06FD4331DB8A</span><br><span class="line">Install PPI: A60C6B59-E459-425D-9C69-0BCC9CB27D81</span><br><span class="line">Register PPI Notify: 605EA650-C65C-42E1-BA80-91A52AB618C6</span><br><span class="line">Loading PEIM A3610442-E69F-4DF3-82CA-2360C4031A23</span><br><span class="line">Loading PEIM at 0x00000830B40 EntryPoint&#x3D;0x00000831F5F ReportStatusCodeRouterPei.efi</span><br><span class="line">Install PPI: 0065D394-9951-4144-82A3-0AFC8579C251</span><br><span class="line">Install PPI: 229832D3-7A30-4B36-B827-F40CB7D45436</span><br><span class="line">Loading PEIM 9D225237-FA01-464C-A949-BAABC02D31D0</span><br><span class="line">Loading PEIM at 0x00000832B40 EntryPoint&#x3D;0x00000833D89 StatusCodeHandlerPei.efi</span><br><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A6DF PlatformPei.efi</span><br><span class="line">Select Item: 0x0</span><br><span class="line">FW CFG Signature: 0x554D4551</span><br><span class="line">Select Item: 0x1</span><br><span class="line">FW CFG Revision: 0x3</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)</span><br><span class="line">SEC: Normal boot</span><br><span class="line">DecompressMemFvs: OutputBuffer@A00000+0xCE0090 ScratchBuffer@1700000+0x10000 PcdOvmfDecompressionScratchEnd&#x3D;0x1710000</span><br></pre></td></tr></table></figure>

<p>track the log to edk2 code, the entry seems start at:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the PEI Core entry point address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in,out]  Fv                 The firmware volume to search</span></span><br><span class="line"><span class="comment">  @param[out]     PeiCoreEntryPoint  The entry point of the PEI Core image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">VOID</span><br><span class="line">FindPeiCoreImageBase (</span><br><span class="line">  IN OUT  EFI_FIRMWARE_VOLUME_HEADER       **BootFv,</span><br><span class="line">     OUT  EFI_PHYSICAL_ADDRESS             *PeiCoreImageBase</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  BOOLEAN S3Resume;</span><br><span class="line"></span><br><span class="line">  *PeiCoreImageBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  S3Resume = IsS3Resume ();</span><br><span class="line">  <span class="keyword">if</span> (S3Resume &amp;&amp; !FeaturePcdGet (PcdSmmSmramRequire)) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// A malicious runtime OS may have injected something into our previously</span></span><br><span class="line">    <span class="comment">// decoded PEI FV, but we don&#x27;t care about that unless SMM/SMRAM is required.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((DEBUG_VERBOSE, <span class="string">&quot;SEC: S3 resume\n&quot;</span>));</span><br><span class="line">    GetS3ResumePeiFv (BootFv);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We&#x27;re either not resuming, or resuming &quot;securely&quot; -- we&#x27;ll decompress</span></span><br><span class="line">    <span class="comment">// both PEI FV and DXE FV from pristine flash.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    DEBUG ((DEBUG_VERBOSE, <span class="string">&quot;SEC: %a\n&quot;</span>,</span><br><span class="line">      S3Resume ? <span class="string">&quot;S3 resume (with PEI decompression)&quot;</span> : <span class="string">&quot;Normal boot&quot;</span>));</span><br><span class="line">    FindMainFv (BootFv);</span><br><span class="line"></span><br><span class="line">    DecompressMemFvs (BootFv);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  FindPeiCoreImageBaseInFv (*BootFv, PeiCoreImageBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and if not IsS3Resume and not SMM required, VM will use S3 resume but in our situation vm go throught Normal boot.</p>
<p>Than locates the comparessed main firmware volume <code>/usr/share/edk2/ovmf/OVMF_CODE.cc.fd</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the compressed main firmware volume and decompresses it.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in,out]  Fv            On input, the firmware volume to search</span></span><br><span class="line"><span class="comment">                                On output, the decompressed BOOT/PEI FV</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">EFI_STATUS</span><br><span class="line">DecompressMemFvs (</span><br></pre></td></tr></table></figure>

<p>Next step is still find PEI core entry address, EFI_SECTION_PE32 and EFI_SECTION_TE will be used to find entry address</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  Locates the PEI Core entry point address</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @param[in]  Fv                 The firmware volume to search</span></span><br><span class="line"><span class="comment">  @param[out] PeiCoreEntryPoint  The entry point of the PEI Core image</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @retval EFI_SUCCESS           The file and section was found</span></span><br><span class="line"><span class="comment">  @retval EFI_NOT_FOUND         The file and section was not found</span></span><br><span class="line"><span class="comment">  @retval EFI_VOLUME_CORRUPTED  The firmware volume was corrupted</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">EFI_STATUS</span><br><span class="line">FindPeiCoreImageBaseInFv (</span><br><span class="line">  IN  EFI_FIRMWARE_VOLUME_HEADER       *Fv,</span><br><span class="line">  OUT  EFI_PHYSICAL_ADDRESS             *PeiCoreImageBase</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  EFI_STATUS                  Status;</span><br><span class="line">  EFI_COMMON_SECTION_HEADER   *Section;</span><br><span class="line"></span><br><span class="line">  Status = FindFfsFileAndSection (</span><br><span class="line">             Fv,</span><br><span class="line">             EFI_FV_FILETYPE_PEI_CORE,</span><br><span class="line">             EFI_SECTION_PE32,</span><br><span class="line">             &amp;Section</span><br><span class="line">             );</span><br><span class="line">  <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">    Status = FindFfsFileAndSection (</span><br><span class="line">               Fv,</span><br><span class="line">               EFI_FV_FILETYPE_PEI_CORE,</span><br><span class="line">               EFI_SECTION_TE,</span><br><span class="line">               &amp;Section</span><br><span class="line">               );</span><br><span class="line">    <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">      DEBUG ((DEBUG_ERROR, <span class="string">&quot;Unable to find PEI Core image\n&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *PeiCoreImageBase = (EFI_PHYSICAL_ADDRESS)(UINTN)(Section + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> EFI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is the last step of find PEI Core image.</p>
<p>Back to where FindPeiCoreImageBase’s code path, we can find SecCoreStartupWithStack is the start function which is used in <code>OvmfPkg/Sec/X64/SecEntry.nasm </code></p>
<p>SecCoreStartupWithStack -&gt; SecStartupPhase2 -&gt; FindAndReportEntryPoints -&gt; FindPeiCoreImageBase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">;</span><br><span class="line">; Setup parameters and call SecCoreStartupWithStack</span><br><span class="line">;   rcx: BootFirmwareVolumePtr</span><br><span class="line">;   rdx: TopOfCurrentStack</span><br><span class="line">;</span><br><span class="line">mov     rcx, rbp</span><br><span class="line">mov     rdx, rsp</span><br><span class="line">sub     rsp, 0x20</span><br><span class="line">call    ASM_PFX(SecCoreStartupWithStack)</span><br></pre></td></tr></table></figure>

<p>combine with log, before next SecCoreStartupWithStack invoking:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)^M</span><br></pre></td></tr></table></figure>

<p>Select Item is printed. </p>
<p>Because FV is successfully loaded:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The 0th FV start address is 0x00000820000, size is 0x000E0000, handle is 0x820000</span><br></pre></td></tr></table></figure>

<p>And compare to first boot:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A6DF PlatformPei.efi^M</span><br><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">QemuFwCfg interface (DMA) is supported.^M</span><br><span class="line">Platform PEIM Loaded^M</span><br></pre></td></tr></table></figure>

<p>It seems Platform PEIM not loaded correctly.</p>
<p>Check QemuFwCfg related code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">RETURN_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgInitialize (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 Signature;</span><br><span class="line">  UINT32 Revision;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Enable the access routines while probing to see if it is supported.</span></span><br><span class="line">  <span class="comment">// For probing we always use the IO Port (IoReadFifo8()) access method.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  mQemuFwCfgSupported = TRUE;</span><br><span class="line">  mQemuFwCfgDmaSupported = FALSE;</span><br><span class="line"></span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemSignature);</span><br><span class="line">  Signature = QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, <span class="string">&quot;FW CFG Signature: 0x%x\n&quot;</span>, Signature));</span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemInterfaceVersion);</span><br><span class="line">  Revision = QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, <span class="string">&quot;FW CFG Revision: 0x%x\n&quot;</span>, Revision));</span><br><span class="line">  <span class="keyword">if</span> ((Signature != SIGNATURE_32 (<span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;U&#x27;</span>)) ||</span><br><span class="line">      (Revision &lt; <span class="number">1</span>)</span><br><span class="line">     ) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface not supported.\n&quot;</span>));</span><br><span class="line">    mQemuFwCfgSupported = FALSE;</span><br><span class="line">    <span class="keyword">return</span> RETURN_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((Revision &amp; FW_CFG_F_DMA) == <span class="number">0</span>) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface (IO Port) is supported.\n&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mQemuFwCfgDmaSupported = TRUE;</span><br><span class="line">    DEBUG ((DEBUG_INFO, <span class="string">&quot;QemuFwCfg interface (DMA) is supported.\n&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mQemuFwCfgDmaSupported &amp;&amp; MemEncryptSevIsEnabled ()) &#123;</span><br><span class="line">    EFI_STATUS   Status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// IoMmuDxe driver must have installed the IOMMU protocol. If we are not</span></span><br><span class="line">    <span class="comment">// able to locate the protocol then something must have gone wrong.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Status = gBS-&gt;LocateProtocol (&amp;gEdkiiIoMmuProtocolGuid, <span class="literal">NULL</span>,</span><br><span class="line">                    (VOID **)&amp;mIoMmuProtocol);</span><br><span class="line">    <span class="keyword">if</span> (EFI_ERROR (Status)) &#123;</span><br><span class="line">      DEBUG ((DEBUG_ERROR,</span><br><span class="line">        <span class="string">&quot;QemuFwCfgSevDma %a:%a Failed to locate IOMMU protocol.\n&quot;</span>,</span><br><span class="line">        gEfiCallerBaseName, __FUNCTION__));</span><br><span class="line">      ASSERT (FALSE);</span><br><span class="line">      CpuDeadLoop ();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> RETURN_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>because FW CFG Revision: 0x3 is supported, according to the code, Revision is &gt; 1 so QemuFwCfg interface is supported, but from next part 0x03 &amp; <code>FW_CFG_F_DMA</code> which is BIT1 0x01 is not 0 so actually <code>QemuFwCfg interface (DMA) is supported.</code> is expected.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ((Revision &amp; FW_CFG_F_DMA) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (IO Port) is supported.\n&quot;));</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  mQemuFwCfgDmaSupported &#x3D; TRUE;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (DMA) is supported.\n&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so that means the boot is not correctly performed. But next boot still triggered so we should check how the boot can be triggered before we dig out the truth.</p>
<p>According to code，we can know edk2-ovmf is try to load PlatformPei.efi</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4^M</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A751 PlatformPei.efi^M</span><br></pre></td></tr></table></figure>

<p>use the guid <code>222C386D-5ABC-4FB4-B124-FBB82488ACF4</code> we can easily get definitions in <code>PlatformPei.inf</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Defines]</span></span><br><span class="line">  <span class="attr">INF_VERSION</span>                    = <span class="number">0</span>x00010005</span><br><span class="line">  <span class="attr">BASE_NAME</span>                      = PlatformPei</span><br><span class="line">  <span class="attr">FILE_GUID</span>                      = <span class="number">222</span>c386d-<span class="number">5</span>abc-<span class="number">4</span>fb4-b124-fbb82488acf4</span><br><span class="line">  <span class="attr">MODULE_TYPE</span>                    = PEIM</span><br><span class="line">  <span class="attr">VERSION_STRING</span>                 = <span class="number">1.0</span></span><br><span class="line">  <span class="attr">ENTRY_POINT</span>                    = InitializePlatform</span><br></pre></td></tr></table></figure>

<p>which ENTRY_POINT is InitializePlatform, but before entry LibraryClasses should be initialized first:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[LibraryClasses]</span></span><br><span class="line">  BaseLib</span><br><span class="line">  CacheMaintenanceLib</span><br><span class="line">  DebugLib</span><br><span class="line">  HobLib</span><br><span class="line">  IoLib</span><br><span class="line">  PciLib</span><br><span class="line">  ResourcePublicationLib</span><br><span class="line">  PeiServicesLib</span><br><span class="line">  PeiServicesTablePointerLib</span><br><span class="line">  PeimEntryPoint</span><br><span class="line">  QemuFwCfgLib</span><br><span class="line">  QemuFwCfgS3Lib</span><br><span class="line">  QemuFwCfgSimpleParserLib</span><br><span class="line">  MtrrLib</span><br><span class="line">  MemEncryptSevLib</span><br><span class="line">  PcdLib</span><br></pre></td></tr></table></figure>

<p>add logs code execution details.</p>
<p>following log shows the trace when edk2 fall into infinite loop:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Loading PEIM 222C386D-5ABC-4FB4-B124-FBB82488ACF4^M</span><br><span class="line">Loading PEIM at 0x00000834A40 EntryPoint&#x3D;0x0000083A76B PlatformPei.efi^M</span><br><span class="line">Select Item: 0x0^M</span><br><span class="line">FW CFG Signature: 0x554D4551^M</span><br><span class="line">Select Item: 0x1^M</span><br><span class="line">FW CFG Revision: 0x3^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; debug entry point &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;^M</span><br><span class="line">check signature match QEMU result: 0^M</span><br><span class="line">check revision &lt; 1 result: 0^M</span><br><span class="line">check supported result: 2^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; enter InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ^M</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ReadSevMsr &#x3D; true &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ^M</span><br><span class="line">SecCoreStartupWithStack(0xFFFCC000, 0x820000)^M</span><br></pre></td></tr></table></figure>

<p>SecCoreStartupWithStack is first log when guest boot, and we end with ReadSevMsr = true but nothing after that.</p>
<p>Before we could see PlatformPei.efi is loading, so refer to PlatformPei.efi first. But the QemuFwCfgLib seems not successfully initialized, because the log end up during its load procedure not show <code>Platform PEIM Loaded</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EFI_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">InitializePlatform (</span><br><span class="line">  IN       EFI_PEI_FILE_HANDLE  FileHandle,</span><br><span class="line">  IN CONST EFI_PEI_SERVICES     **PeiServices</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;Platform PEIM Loaded\n&quot;));</span><br></pre></td></tr></table></figure>

<p>And refer to OvmfPkgX64.dsc describes c lib every procedure should use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[LibraryClasses.common.PEIM]</span><br><span class="line">  HobLib|MdePkg&#x2F;Library&#x2F;PeiHobLib&#x2F;PeiHobLib.inf</span><br><span class="line">  PeiServicesTablePointerLib|MdePkg&#x2F;Library&#x2F;PeiServicesTablePointerLibIdt&#x2F;PeiServicesTablePointerLibIdt.inf</span><br><span class="line">  PeiServicesLib|MdePkg&#x2F;Library&#x2F;PeiServicesLib&#x2F;PeiServicesLib.inf</span><br><span class="line">  MemoryAllocationLib|MdePkg&#x2F;Library&#x2F;PeiMemoryAllocationLib&#x2F;PeiMemoryAllocationLib.inf</span><br><span class="line">  PeimEntryPoint|MdePkg&#x2F;Library&#x2F;PeimEntryPoint&#x2F;PeimEntryPoint.inf</span><br><span class="line">  ReportStatusCodeLib|MdeModulePkg&#x2F;Library&#x2F;PeiReportStatusCodeLib&#x2F;PeiReportStatusCodeLib.inf</span><br><span class="line">  OemHookStatusCodeLib|MdeModulePkg&#x2F;Library&#x2F;OemHookStatusCodeLibNull&#x2F;OemHookStatusCodeLibNull.inf</span><br><span class="line">  PeCoffGetEntryPointLib|MdePkg&#x2F;Library&#x2F;BasePeCoffGetEntryPointLib&#x2F;BasePeCoffGetEntryPointLib.inf</span><br><span class="line">!ifdef $(DEBUG_ON_SERIAL_PORT)</span><br><span class="line">  DebugLib|MdePkg&#x2F;Library&#x2F;BaseDebugLibSerialPort&#x2F;BaseDebugLibSerialPort.inf</span><br><span class="line">!else</span><br><span class="line">  DebugLib|OvmfPkg&#x2F;Library&#x2F;PlatformDebugLibIoPort&#x2F;PlatformDebugLibIoPort.inf</span><br><span class="line">!endif</span><br><span class="line">  PeCoffLib|MdePkg&#x2F;Library&#x2F;BasePeCoffLib&#x2F;BasePeCoffLib.inf</span><br><span class="line">  ResourcePublicationLib|MdePkg&#x2F;Library&#x2F;PeiResourcePublicationLib&#x2F;PeiResourcePublicationLib.inf</span><br><span class="line">  ExtractGuidedSectionLib|MdePkg&#x2F;Library&#x2F;PeiExtractGuidedSectionLib&#x2F;PeiExtractGuidedSectionLib.inf</span><br><span class="line">!if $(SOURCE_DEBUG_ENABLE) &#x3D;&#x3D; TRUE</span><br><span class="line">  DebugAgentLib|SourceLevelDebugPkg&#x2F;Library&#x2F;DebugAgent&#x2F;SecPeiDebugAgentLib.inf</span><br><span class="line">!endif</span><br><span class="line">  CpuExceptionHandlerLib|UefiCpuPkg&#x2F;Library&#x2F;CpuExceptionHandlerLib&#x2F;PeiCpuExceptionHandlerLib.inf</span><br><span class="line">  MpInitLib|UefiCpuPkg&#x2F;Library&#x2F;MpInitLib&#x2F;PeiMpInitLib.inf</span><br><span class="line">  QemuFwCfgS3Lib|OvmfPkg&#x2F;Library&#x2F;QemuFwCfgS3Lib&#x2F;PeiQemuFwCfgS3LibFwCfg.inf</span><br><span class="line">  PcdLib|MdePkg&#x2F;Library&#x2F;PeiPcdLib&#x2F;PeiPcdLib.inf</span><br><span class="line">  QemuFwCfgLib|OvmfPkg&#x2F;Library&#x2F;QemuFwCfgLib&#x2F;QemuFwCfgPeiLib.inf</span><br></pre></td></tr></table></figure>

<p>take eyes on <code>QemuFwCfgLib|OvmfPkg/Library/QemuFwCfgLib/QemuFwCfgPeiLib.inf</code></p>
<p>so check more from <code>QemuFwCfgPei.c</code> , following shows debug log added version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">BOOLEAN</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgIsAvailable (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  return InternalQemuFwCfgIsAvailable ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RETURN_STATUS</span><br><span class="line">EFIAPI</span><br><span class="line">QemuFwCfgInitialize (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32 Signature;</span><br><span class="line">  UINT32 Revision;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F;</span><br><span class="line">  &#x2F;&#x2F; Enable the access routines while probing to see if it is supported.</span><br><span class="line">  &#x2F;&#x2F; For probing we always use the IO Port (IoReadFifo8()) access method.</span><br><span class="line">  &#x2F;&#x2F;</span><br><span class="line">  mQemuFwCfgSupported &#x3D; TRUE;</span><br><span class="line">  mQemuFwCfgDmaSupported &#x3D; FALSE;</span><br><span class="line"></span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemSignature);</span><br><span class="line">  Signature &#x3D; QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;FW CFG Signature: 0x%x\n&quot;, Signature));</span><br><span class="line">  QemuFwCfgSelectItem (QemuFwCfgItemInterfaceVersion);</span><br><span class="line">  Revision &#x3D; QemuFwCfgRead32 ();</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;FW CFG Revision: 0x%x\n&quot;, Revision));</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; debug entry point &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n&quot;));</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check signature match QEMU result: %d\n&quot;, Signature !&#x3D; SIGNATURE_32 (&#39;Q&#39;, &#39;E&#39;, &#39;M&#39;, &#39;U&#39;)));</span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check revision &lt; 1 result: %d\n&quot;, Revision &lt; 1));</span><br><span class="line">  if ((Signature !&#x3D; SIGNATURE_32 (&#39;Q&#39;, &#39;E&#39;, &#39;M&#39;, &#39;U&#39;)) ||</span><br><span class="line">      (Revision &lt; 1)</span><br><span class="line">     ) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface not supported.\n&quot;));</span><br><span class="line">    mQemuFwCfgSupported &#x3D; FALSE;</span><br><span class="line">    return RETURN_SUCCESS;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;check supported result: %d\n&quot;, (Revision &amp; FW_CFG_F_DMA)));</span><br><span class="line">  if ((Revision &amp; FW_CFG_F_DMA) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (IO Port) is supported.\n&quot;));</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; If SEV is enabled then we do not support DMA operations in PEI phase.</span><br><span class="line">    &#x2F;&#x2F; This is mainly because DMA in SEV guest requires using bounce buffer</span><br><span class="line">    &#x2F;&#x2F; (which need to allocate dynamic memory and allocating a PAGE size&#39;d</span><br><span class="line">    &#x2F;&#x2F; buffer can be challenge in PEI phase)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    if (MemEncryptSevIsEnabled ()) &#123;</span><br><span class="line">      DEBUG ((DEBUG_INFO, &quot;SEV: QemuFwCfg fallback to IO Port interface.\n&quot;));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      mQemuFwCfgDmaSupported &#x3D; TRUE;</span><br><span class="line">      DEBUG ((DEBUG_INFO, &quot;QemuFwCfg interface (DMA) is supported.\n&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>the code enter the <code>MemEncryptSevIsEnabled ()</code> and hang on next function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">STATIC</span><br><span class="line">VOID</span><br><span class="line">EFIAPI</span><br><span class="line">InternalMemEncryptSevStatus (</span><br><span class="line">  VOID</span><br><span class="line">  )</span><br><span class="line">&#123;</span><br><span class="line">  UINT32                            RegEax;</span><br><span class="line">  MSR_SEV_STATUS_REGISTER           Msr;</span><br><span class="line">  CPUID_MEMORY_ENCRYPTION_INFO_EAX  Eax;</span><br><span class="line">  BOOLEAN                           ReadSevMsr;</span><br><span class="line">  SEC_SEV_ES_WORK_AREA              *SevEsWorkArea;</span><br><span class="line"></span><br><span class="line">  ReadSevMsr &#x3D; FALSE;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; enter InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">  SevEsWorkArea &#x3D; (SEC_SEV_ES_WORK_AREA *) FixedPcdGet32 (PcdSevEsWorkAreaBase);</span><br><span class="line">  if (SevEsWorkArea !&#x3D; NULL &amp;&amp; SevEsWorkArea-&gt;EncryptionMask !&#x3D; 0) &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; The MSR has been read before, so it is safe to read it again and avoid</span><br><span class="line">    &#x2F;&#x2F; having to validate the CPUID information.</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; ReadSevMsr &#x3D; true &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    ReadSevMsr &#x3D; TRUE;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check if memory encryption leaf exist</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; AsmCpuid &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    AsmCpuid (CPUID_EXTENDED_FUNCTION, &amp;RegEax, NULL, NULL, NULL);</span><br><span class="line">    if (RegEax &gt;&#x3D; CPUID_MEMORY_ENCRYPTION_INFO) &#123;</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      &#x2F;&#x2F; CPUID Fn8000_001F[EAX] Bit 1 (Sev supported)</span><br><span class="line">      &#x2F;&#x2F;</span><br><span class="line">      AsmCpuid (CPUID_MEMORY_ENCRYPTION_INFO, &amp;Eax.Uint32, NULL, NULL, NULL);</span><br><span class="line"></span><br><span class="line">      if (Eax.Bits.SevBit) &#123;</span><br><span class="line">        ReadSevMsr &#x3D; TRUE;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (ReadSevMsr) &#123;</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check MSR_0xC0010131 Bit 0 (Sev Enabled)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    Msr.Uint32 &#x3D; AsmReadMsr32 (MSR_SEV_STATUS);</span><br><span class="line">    DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; AsmReadMsr32 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">    if (Msr.Bits.SevBit) &#123;</span><br><span class="line">      mSevStatus &#x3D; TRUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    &#x2F;&#x2F; Check MSR_0xC0010131 Bit 1 (Sev-Es Enabled)</span><br><span class="line">    &#x2F;&#x2F;</span><br><span class="line">    if (Msr.Bits.SevEsBit) &#123;</span><br><span class="line">      mSevEsStatus &#x3D; TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG ((DEBUG_INFO, &quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; out InternalMemEncryptSevStatus &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; \n&quot;));</span><br><span class="line">  mSevStatusChecked &#x3D; TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally <code>AsmReadMsr32</code> is the victim to blame. </p>
<p>note: SEC_SEV_ES_WORK_AREA is a new AREA added by amd used for their SEV feature. Normally guest without SEV feature should not modify those memory area, but it seems windows write randomly bits which caused this problem.</p>
<h3 id="From-edk2-groups"><a href="#From-edk2-groups" class="headerlink" title="From edk2 groups"></a>From edk2 groups</h3><p>Same issue is found <code>https://edk2.groups.io/g/devel/topic/87301748#84086</code></p>
<p>According to the mail:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tested on Intel Platform, It is like &#39;SEV-ES work area&#39; can be modified by</span><br><span class="line">os(Windows etc), and will not restored on reboot, the</span><br><span class="line">SevEsWorkArea-&gt;EncryptionMask may have a random value after reboot. then it</span><br><span class="line">may casue fail on reboot. The msr bits already cached by mSevStatusChecked,</span><br><span class="line">there is no need to try cache again in PEI phase.</span><br></pre></td></tr></table></figure>

<p>it seems Windows will change SEV-ES work area which will lead QemuFwCfgLib to readMsr when guest reboot, but actually for guests, normally SEV-ES is not used, so initializing failure cause the reboot infinite loop.</p>
<h3 id="Patches-fix-the-reboot-issue"><a href="#Patches-fix-the-reboot-issue" class="headerlink" title="Patches fix the reboot issue"></a>Patches fix the reboot issue</h3><p>check file change log </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log OvmfPkg/Library/BaseMemEncryptSevLib/PeiMemEncryptSevLibInternal.c</span><br></pre></td></tr></table></figure>

<p>we can find related patches:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">commit d9822304ce0075b1075edf93cc6e2514685b5212</span><br><span class="line">Author: Brijesh Singh &lt;brijesh.singh@amd.com&gt;</span><br><span class="line">Date:   Thu Dec 9 11:27:37 2021 +0800</span><br><span class="line"></span><br><span class="line">    OvmfPkg&#x2F;MemEncryptSevLib: add MemEncryptSevSnpEnabled()</span><br><span class="line"></span><br><span class="line">    BZ: https:&#x2F;&#x2F;bugzilla.tianocore.org&#x2F;show_bug.cgi?id&#x3D;3275</span><br><span class="line"></span><br><span class="line">    Create a function that can be used to determine if VM is running as an</span><br><span class="line">    SEV-SNP guest.</span><br><span class="line"></span><br><span class="line">    Cc: Michael Roth &lt;michael.roth@amd.com&gt;</span><br><span class="line">    Cc: James Bottomley &lt;jejb@linux.ibm.com&gt;</span><br><span class="line">    Cc: Min Xu &lt;min.m.xu@intel.com&gt;</span><br><span class="line">    Cc: Jiewen Yao &lt;jiewen.yao@intel.com&gt;</span><br><span class="line">    Cc: Tom Lendacky &lt;thomas.lendacky@amd.com&gt;</span><br><span class="line">    Cc: Jordan Justen &lt;jordan.l.justen@intel.com&gt;</span><br><span class="line">    Cc: Ard Biesheuvel &lt;ardb+tianocore@kernel.org&gt;</span><br><span class="line">    Cc: Erdem Aktas &lt;erdemaktas@google.com&gt;</span><br><span class="line">    Cc: Gerd Hoffmann &lt;kraxel@redhat.com&gt;</span><br><span class="line">    Acked-by: Jiewen Yao &lt;Jiewen.yao@intel.com&gt;</span><br><span class="line">    Acked-by: Gerd Hoffmann &lt;kraxel@redhat.com&gt;</span><br><span class="line">    Signed-off-by: Brijesh Singh &lt;brijesh.singh@amd.com&gt;</span><br><span class="line"></span><br><span class="line">commit ac0a286f4d747a4c6c603a7b225917293cbe1e9f</span><br><span class="line">Author: Michael Kubacki &lt;michael.kubacki@microsoft.com&gt;</span><br><span class="line">Date:   Sun Dec 5 14:54:09 2021 -0800</span><br><span class="line"></span><br><span class="line">    OvmfPkg: Apply uncrustify changes</span><br><span class="line"></span><br><span class="line">    REF: https:&#x2F;&#x2F;bugzilla.tianocore.org&#x2F;show_bug.cgi?id&#x3D;3737</span><br><span class="line"></span><br><span class="line">    Apply uncrustify changes to .c&#x2F;.h files in the OvmfPkg package</span><br><span class="line"></span><br><span class="line">    Cc: Andrew Fish &lt;afish@apple.com&gt;</span><br><span class="line">    Cc: Leif Lindholm &lt;leif@nuviainc.com&gt;</span><br><span class="line">    Cc: Michael D Kinney &lt;michael.d.kinney@intel.com&gt;</span><br><span class="line">    Signed-off-by: Michael Kubacki &lt;michael.kubacki@microsoft.com&gt;</span><br><span class="line">    Reviewed-by: Andrew Fish &lt;afish@apple.com&gt;</span><br></pre></td></tr></table></figure>



<h2 id="More-information-about-my-debug-related-procedure"><a href="#More-information-about-my-debug-related-procedure" class="headerlink" title="More information about my debug related procedure"></a>More information about my debug related procedure</h2><h3 id="UEFI-boot-procedure"><a href="#UEFI-boot-procedure" class="headerlink" title="UEFI boot procedure"></a>UEFI boot procedure</h3><p>Before debugging on edk2 code, check UEFI boot procedure to know more about UEFI boot.</p>
<p>According to <a target="_blank" rel="noopener" href="https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence">https://edk2-docs.gitbook.io/edk-ii-build-specification/2_design_discussion/23_boot_sequence</a></p>
<p>PI compliant system firmware must support the six phases: security (SEC), pre-efi initialization (PEI), driver execution environment (DXE), boot device selection (BDS), run time (RT) services and After Life (transition from the OS back to the firmware) of system. Refer to Figure below</p>
<img src="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/boot_sequence.png" class="">

<p>Our issue occours at PEI so check the first two steps:</p>
<h4 id="Security-SEC"><a href="#Security-SEC" class="headerlink" title="Security(SEC)"></a>Security(SEC)</h4><p>The Security (SEC) phase is the first phase in the PI Architecture and is responsible for the following:</p>
<ul>
<li>Handling all platform restart events</li>
<li>Creating a temporary memory store</li>
<li>Serving as the root of trust in the system</li>
<li>Passing handoff information to the PEI Foundation</li>
</ul>
<p>The security section may contain modules with code written in assembly. Therefore, some EDK II module development environment (MDE) modules may contain assembly code. Where this occurs, both Windows and GCC versions of assembly code are provided in different files.</p>
<h4 id="Pre-EFI-Initialization-PEI"><a href="#Pre-EFI-Initialization-PEI" class="headerlink" title="Pre-EFI Initialization (PEI)"></a>Pre-EFI Initialization (PEI)</h4><p>The Pre-EFI Initialization (PEI) phase described in the PI Architecture specifications is invoked quite early in the boot flow. Specifically, after some preliminary processing in the Security (SEC) phase, any machine restart event will invoke the PEI phase.</p>
<p>The PEI phase initially operates with the platform in a nascent state, leveraging only on-processor resources, such as the processor cache as a call stack, to dispatch Pre-EFI Initialization Modules (PEIMs). These PEIMs are responsible for the following:</p>
<ul>
<li>Initializing some permanent memory complement</li>
<li>Describing the memory in Hand-Off Blocks (HOBs)</li>
<li>Describing the firmware volume locations in HOBs</li>
<li>Passing control into the Driver Execution Environment (DXE) phase</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" data-id="cld1mhec9005xyuwbgriparkk" data-title="Dive into edk2-ovmf fisrt debug trip" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/27/Dive-into-edk2-ovmf-fisrt-debug-trip/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Go-through-KVM-code-due-to-a-tdp-page-fault" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" class="article-date">
  <time class="dt-published" datetime="2022-07-15T02:23:14.000Z" itemprop="datePublished">2022-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/kvm/">kvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/">Go through KVM code due to a tdp_page_fault</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="What-happened"><a href="#What-happened" class="headerlink" title="What happened?"></a>What happened?</h2><p>Our CI/CD system ran integration test for every pull request but suddenly it met performance issue. Usually one round of integration test need 1h but this time almost all test do not finished after 1h 20min. </p>
<p>After check the codebase and test on lastest release stable branch, its more likely that the system met performance issue.</p>
<p>Before starting trip of “dig out the root cause”, check big picture of this CI/CD system architecture.</p>
<h2 id="Prepare-from-perf"><a href="#Prepare-from-perf" class="headerlink" title="Prepare from perf"></a>Prepare from perf</h2><p>Because integration test runs on virtual machine memory, check hypervisor’s performance might gave more details. So use perf to collect run time data for analysis.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;brendangregg&#x2F;FlameGraph  # or download it from github</span><br><span class="line">cd FlameGraph</span><br><span class="line">perf record -F 99 -a -g -- sleep 60</span><br><span class="line">perf script | .&#x2F;stackcollapse-perf.pl &gt; out.perf-folded</span><br><span class="line">.&#x2F;flamegraph.pl out.perf-folded &gt; perf.svg</span><br></pre></td></tr></table></figure>

<p>Check the flame graph</p>
<img src="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/2022-07-15-kvm-figure1.png" class=""> 


<h2 id="Start-from-tdp-page-fault"><a href="#Start-from-tdp-page-fault" class="headerlink" title="Start from tdp_page_fault"></a>Start from tdp_page_fault</h2><p>Abviously cpu spend lots of time to handle tdp_page_fault</p>
<p>find definition from <code>linux/arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static void init_kvm_tdp_mmu(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	struct kvm_mmu *context &#x3D; &amp;vcpu-&gt;arch.mmu;</span><br><span class="line"></span><br><span class="line">	context-&gt;base_role.word &#x3D; 0;</span><br><span class="line">	context-&gt;base_role.guest_mode &#x3D; is_guest_mode(vcpu);</span><br><span class="line">	context-&gt;base_role.smm &#x3D; is_smm(vcpu);</span><br><span class="line">	context-&gt;base_role.ad_disabled &#x3D; (shadow_accessed_mask &#x3D;&#x3D; 0);</span><br><span class="line">	context-&gt;page_fault &#x3D; tdp_page_fault;</span><br><span class="line">	context-&gt;sync_page &#x3D; nonpaging_sync_page;</span><br><span class="line">	context-&gt;invlpg &#x3D; nonpaging_invlpg;</span><br><span class="line">	context-&gt;update_pte &#x3D; nonpaging_update_pte;</span><br><span class="line">	context-&gt;shadow_root_level &#x3D; kvm_x86_ops-&gt;get_tdp_level(vcpu);</span><br><span class="line">	context-&gt;root_hpa &#x3D; INVALID_PAGE;</span><br><span class="line">	context-&gt;direct_map &#x3D; true;</span><br><span class="line">	context-&gt;set_cr3 &#x3D; kvm_x86_ops-&gt;set_tdp_cr3;</span><br><span class="line">	context-&gt;get_cr3 &#x3D; get_cr3;</span><br><span class="line">	context-&gt;get_pdptr &#x3D; kvm_pdptr_read;</span><br><span class="line">	context-&gt;inject_page_fault &#x3D; kvm_inject_page_fault;</span><br></pre></td></tr></table></figure>

<p><code>kvm_vcpu</code> <code>page_fault</code> point to <code>tdp_page_fault</code> when mmu field of <code>kvm_vcpu</code> is initializing.</p>
<p>from kvm vcpu setup <code>arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static void init_kvm_mmu(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	if (mmu_is_nested(vcpu))</span><br><span class="line">		init_kvm_nested_mmu(vcpu);</span><br><span class="line">	else if (tdp_enabled)</span><br><span class="line">		init_kvm_tdp_mmu(vcpu);</span><br><span class="line">	else</span><br><span class="line">		init_kvm_softmmu(vcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>from kvm vcpu setup <code>arch/x86/kvm/mmu.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void kvm_mmu_setup(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	MMU_WARN_ON(VALID_PAGE(vcpu-&gt;arch.mmu.root_hpa));</span><br><span class="line"></span><br><span class="line">	init_kvm_mmu(vcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>from kvm vcpu setup <code>arch/x86/kvm/x86.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int kvm_arch_vcpu_setup(struct kvm_vcpu *vcpu)</span><br><span class="line">&#123;</span><br><span class="line">	kvm_vcpu_mtrr_init(vcpu);</span><br><span class="line">	vcpu_load(vcpu);</span><br><span class="line">	kvm_vcpu_reset(vcpu, false);</span><br><span class="line">	kvm_mmu_setup(vcpu);</span><br><span class="line">	vcpu_put(vcpu);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vcpu is created by </p>
<p><code>kvm_vm_ioctl_create_vcpu(struct kvm *kvm, u32 id)</code></p>
<p>check mmu in vcpu structure:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Paging state of the vcpu</span><br><span class="line"> *</span><br><span class="line"> * If the vcpu runs in guest mode with two level paging this still saves</span><br><span class="line"> * the paging mode of the l1 guest. This context is always used to</span><br><span class="line"> * handle faults.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct kvm_mmu mmu;</span><br></pre></td></tr></table></figure>

<h2 id="Find-more-by-pf-interception"><a href="#Find-more-by-pf-interception" class="headerlink" title="Find more by pf_interception"></a>Find more by pf_interception</h2><p>combine to flage graph, pf_interception is before tdp_page_fault,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static int pf_interception(struct vcpu_svm *svm)</span><br><span class="line">&#123;</span><br><span class="line">	u64 fault_address &#x3D; __sme_clr(svm-&gt;vmcb-&gt;control.exit_info_2);</span><br><span class="line">	u64 error_code &#x3D; svm-&gt;vmcb-&gt;control.exit_info_1;</span><br><span class="line"></span><br><span class="line">	return kvm_handle_page_fault(&amp;svm-&gt;vcpu, error_code, fault_address,</span><br><span class="line">			static_cpu_has(X86_FEATURE_DECODEASSISTS) ?</span><br><span class="line">			svm-&gt;vmcb-&gt;control.insn_bytes : NULL,</span><br><span class="line">			svm-&gt;vmcb-&gt;control.insn_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>refer to its usage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[SVM_EXIT_EXCP_BASE + PF_VECTOR] &#x3D; pf_interception</span><br></pre></td></tr></table></figure>

<p>SVM_EXIT_EXCP_BASE is related to AMD CPU virtualization, PF_VECTOR means page_frame vector, used by page fault.</p>
<p>more details about the PF_VECTOR in <code>arch/x86/kvm/svm.c</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (npt_enabled) &#123;</span><br><span class="line">	&#x2F;* Setup VMCB for Nested Paging *&#x2F;</span><br><span class="line">	control-&gt;nested_ctl |&#x3D; SVM_NESTED_CTL_NP_ENABLE;</span><br><span class="line">	clr_intercept(svm, INTERCEPT_INVLPG);</span><br><span class="line">	clr_exception_intercept(svm, PF_VECTOR);</span><br><span class="line">	clr_cr_intercept(svm, INTERCEPT_CR3_READ);</span><br><span class="line">	clr_cr_intercept(svm, INTERCEPT_CR3_WRITE);</span><br><span class="line">	save-&gt;g_pat &#x3D; svm-&gt;vcpu.arch.pat;</span><br><span class="line">	save-&gt;cr3 &#x3D; 0;</span><br><span class="line">	save-&gt;cr4 &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if AMD CPU’s npt not enabled, PF_VECTOR will be used to intercept page fault.</p>
<p>So just quickly go through guest virtual address translation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Fetch a guest pte for a guest virtual address</span><br><span class="line"> *&#x2F;</span><br><span class="line">static int FNAME(walk_addr_generic)(struct guest_walker *walker,</span><br><span class="line">				    struct kvm_vcpu *vcpu, struct kvm_mmu *mmu,</span><br><span class="line">				    gva_t addr, u32 access)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">error:</span><br><span class="line">	errcode |&#x3D; write_fault | user_fault;</span><br><span class="line">	if (fetch_fault &amp;&amp; (mmu-&gt;nx ||</span><br><span class="line">			    kvm_read_cr4_bits(vcpu, X86_CR4_SMEP)))</span><br><span class="line">		errcode |&#x3D; PFERR_FETCH_MASK;</span><br><span class="line"></span><br><span class="line">	walker-&gt;fault.vector &#x3D; PF_VECTOR;</span><br><span class="line">	walker-&gt;fault.error_code_valid &#x3D; true;</span><br><span class="line">	walker-&gt;fault.error_code &#x3D; errcode;</span><br></pre></td></tr></table></figure>

<p>error is defined to raise PF_VECTOR when failed to find any PTE(Page table entry) </p>
<p>Than let’s find the next method <code>handle_exit()</code> from svm.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static int handle_exit(struct kvm_vcpu *vcpu)</span><br></pre></td></tr></table></figure>

<p>following shows more details</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct vcpu_svm *svm &#x3D; to_svm(vcpu);</span><br><span class="line">struct kvm_run *kvm_run &#x3D; vcpu-&gt;run;</span><br><span class="line">u32 exit_code &#x3D; svm-&gt;vmcb-&gt;control.exit_code;</span><br></pre></td></tr></table></figure>

<p>the vcpu structure will be changed to vcpu_svm and than get the exit_code from it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">trace_kvm_exit(exit_code, vcpu, KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">if (!is_cr_intercept(svm, INTERCEPT_CR0_WRITE))</span><br><span class="line">	vcpu-&gt;arch.cr0 &#x3D; svm-&gt;vmcb-&gt;save.cr0;</span><br><span class="line">if (npt_enabled)</span><br><span class="line">	vcpu-&gt;arch.cr3 &#x3D; svm-&gt;vmcb-&gt;save.cr3;</span><br><span class="line"></span><br><span class="line">if (unlikely(svm-&gt;nested.exit_required)) &#123;</span><br><span class="line">	nested_svm_vmexit(svm);</span><br><span class="line">	svm-&gt;nested.exit_required &#x3D; false;</span><br><span class="line"></span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>than the exit_code will be traced.</p>
<p>CR0 has various control flags that modify the basic operation of the processor. See more: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Control_register#CR0">https://en.wikipedia.org/wiki/Control_register#CR0</a></p>
<p>if npt_enabled(CPU enable npt) vcpu will use vmcb saved cr3</p>
<p>vmcb: Intel VT-x name it as vmcs(virtual machine control structure), AMD name it as vmcb(virtual machine control block)</p>
<p>vmcb_control_area and vmcb_save_area combined as virtual machine control block. </p>
<p>note: need more research</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if (is_guest_mode(vcpu)) &#123;</span><br><span class="line">	int vmexit;</span><br><span class="line"></span><br><span class="line">	trace_kvm_nested_vmexit(svm-&gt;vmcb-&gt;save.rip, exit_code,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_info_1,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_info_2,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_int_info,</span><br><span class="line">				svm-&gt;vmcb-&gt;control.exit_int_info_err,</span><br><span class="line">				KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">	vmexit &#x3D; nested_svm_exit_special(svm);</span><br><span class="line"></span><br><span class="line">	if (vmexit &#x3D;&#x3D; NESTED_EXIT_CONTINUE)</span><br><span class="line">		vmexit &#x3D; nested_svm_exit_handled(svm);</span><br><span class="line"></span><br><span class="line">	if (vmexit &#x3D;&#x3D; NESTED_EXIT_DONE)</span><br><span class="line">		return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>if vm is nested exit, handle nested exit next step, interrupts will be queued and if vm exit due to SVM_EXIT_ERR exit this thread.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">svm_complete_interrupts(svm);</span><br><span class="line"></span><br><span class="line">if (svm-&gt;vmcb-&gt;control.exit_code &#x3D;&#x3D; SVM_EXIT_ERR) &#123;</span><br><span class="line">	kvm_run-&gt;exit_reason &#x3D; KVM_EXIT_FAIL_ENTRY;</span><br><span class="line">	kvm_run-&gt;fail_entry.hardware_entry_failure_reason</span><br><span class="line">		&#x3D; svm-&gt;vmcb-&gt;control.exit_code;</span><br><span class="line">	pr_err(&quot;KVM: FAILED VMRUN WITH VMCB:\n&quot;);</span><br><span class="line">	dump_vmcb(vcpu);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>last, check if the error code is external interrupt and not kernel handable error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if (is_external_interrupt(svm-&gt;vmcb-&gt;control.exit_int_info) &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_EXCP_BASE + PF_VECTOR &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_NPF &amp;&amp; exit_code !&#x3D; SVM_EXIT_TASK_SWITCH &amp;&amp;</span><br><span class="line">    exit_code !&#x3D; SVM_EXIT_INTR &amp;&amp; exit_code !&#x3D; SVM_EXIT_NMI)</span><br><span class="line">	printk(KERN_ERR &quot;%s: unexpected exit_int_info 0x%x &quot;</span><br><span class="line">	       &quot;exit_code 0x%x\n&quot;,</span><br><span class="line">	       __func__, svm-&gt;vmcb-&gt;control.exit_int_info,</span><br><span class="line">	       exit_code);</span><br><span class="line"></span><br><span class="line">if (exit_code &gt;&#x3D; ARRAY_SIZE(svm_exit_handlers)</span><br><span class="line">    || !svm_exit_handlers[exit_code]) &#123;</span><br><span class="line">	WARN_ONCE(1, &quot;svm: unexpected exit reason 0x%x\n&quot;, exit_code);</span><br><span class="line">	kvm_queue_exception(vcpu, UD_VECTOR);</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return svm_exit_handlers[exit_code](svm);</span><br></pre></td></tr></table></figure>

<p>finally invoke svm exit handler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return svm_exit_handlers[exit_code](svm);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" data-id="cld1mhe9x0003yuwb8g646w4b" data-title="Go through KVM code due to a tdp_page_fault" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/15/Go-through-KVM-code-due-to-a-tdp-page-fault/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virt/" rel="tag">virt</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-python-elementtree-notes" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/01/python-elementtree-notes/" class="article-date">
  <time class="dt-published" datetime="2022-07-01T07:13:28.000Z" itemprop="datePublished">2022-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/languages/">languages</a>►<a class="article-category-link" href="/categories/languages/python/">python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/01/python-elementtree-notes/">Python ElementTree notes</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Develop with libvrt python API, xml parse and operation is frequently required. ElementTree (stantard python library) is introduced in <a target="_blank" rel="noopener" href="https://realpython.com/python-xml-parser/">python-xml-parse</a> come into used for the sake of simplify xml configuration lifecycle handling.</p>
<p>This blog will go throught <a target="_blank" rel="noopener" href="https://docs.python.org/2/library/xml.etree.elementtree.html#module-xml.etree.ElementTree">xml.etree.ElementTree</a> combine with typical situations which is use as learning notes.</p>
<p>First, start with some basic concepts </p>
<blockquote>
</blockquote>
<p>The Element type is a flexible container object, designed to store hierarchical data structures in memory. The type can be described as a cross between a list and a dictionary.</p>
<blockquote>
</blockquote>
<p>Each element has a number of properties associated with it:</p>
<blockquote>
</blockquote>
<ul>
<li>a tag which is a string identifying what kind of data this element represents (the element type, in other words).<blockquote>
</blockquote>
</li>
<li>a number of attributes, stored in a Python dictionary.<blockquote>
</blockquote>
</li>
<li>a text string.<blockquote>
</blockquote>
</li>
<li>an optional tail string.<blockquote>
</blockquote>
</li>
<li>a number of child elements, stored in a Python sequence</li>
</ul>
<p>use following XML as sample data:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;data&gt;</span><br><span class="line">    &lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;</span><br><span class="line">        &lt;rank&gt;1&lt;&#x2F;rank&gt;</span><br><span class="line">        &lt;year&gt;2008&lt;&#x2F;year&gt;</span><br><span class="line">        &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Austria&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Switzerland&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;country&gt;</span><br><span class="line">    &lt;country name&#x3D;&quot;Singapore&quot;&gt;</span><br><span class="line">        &lt;rank&gt;4&lt;&#x2F;rank&gt;</span><br><span class="line">        &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">        &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Malaysia&quot; direction&#x3D;&quot;N&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;country&gt;</span><br><span class="line">    &lt;country name&#x3D;&quot;Panama&quot;&gt;</span><br><span class="line">        &lt;rank&gt;68&lt;&#x2F;rank&gt;</span><br><span class="line">        &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">        &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Costa Rica&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">        &lt;neighbor name&#x3D;&quot;Colombia&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;country&gt;</span><br><span class="line">&lt;&#x2F;data&gt;</span><br></pre></td></tr></table></figure>

<p>load xml from file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.5 (default, Aug  4 2017, 00:39:18)</span><br><span class="line">[GCC 4.8.5 20150623 (Red Hat 4.8.5-16)] on linux2</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import xml.etree.ElementTree as ET</span><br><span class="line">&gt;&gt;&gt; tree &#x3D; ET.parse(&#39;test_data.xml&#39;)</span><br><span class="line">&gt;&gt;&gt; root &#x3D; tree.getroot()</span><br><span class="line">&gt;&gt;&gt; root</span><br><span class="line">&lt;Element &#39;data&#39; at 0x7f58bd8232d0&gt;</span><br></pre></td></tr></table></figure>

<p>or load xml from string:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; test_data_str &#x3D; &#39;&#39;&#39;&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">... &lt;data&gt;</span><br><span class="line">...     &lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;1&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2008&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Austria&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Switzerland&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;</span><br><span class="line">...     &lt;country name&#x3D;&quot;Singapore&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;4&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Malaysia&quot; direction&#x3D;&quot;N&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;</span><br><span class="line">...     &lt;country name&#x3D;&quot;Panama&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;68&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2011&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Costa Rica&quot; direction&#x3D;&quot;W&quot;&#x2F;&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Colombia&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;</span><br><span class="line">... &lt;&#x2F;data&gt;&#39;&#39;&#39;</span><br><span class="line">&gt;&gt;&gt; ET.fromstring(test_data_str)</span><br><span class="line">&lt;Element &#39;data&#39; at 0x7f58bd823a10&gt;</span><br><span class="line">&gt;&gt;&gt; root &#x3D; ET.fromstring(test_data_str)</span><br><span class="line">&gt;&gt;&gt; root</span><br><span class="line">&lt;Element &#39;data&#39; at 0x7f58bd823f10&gt;</span><br></pre></td></tr></table></figure>

<p>As an element, use dir to check whats inside element we just loaded:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; dir(root)</span><br><span class="line">[&#39;__class__&#39;, &#39;__delattr__&#39;, &#39;__delitem__&#39;, &#39;__dict__&#39;, &#39;__doc__&#39;, &#39;__format__&#39;, &#39;__getattribute__&#39;, &#39;__getitem__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__len__&#39;, &#39;__module__&#39;, &#39;__new__&#39;, &#39;__nonzero__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__setitem__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;__weakref__&#39;, &#39;_children&#39;, &#39;append&#39;, &#39;attrib&#39;, &#39;clear&#39;, &#39;copy&#39;, &#39;extend&#39;, &#39;find&#39;, &#39;findall&#39;, &#39;findtext&#39;, &#39;get&#39;, &#39;getchildren&#39;, &#39;getiterator&#39;, &#39;insert&#39;, &#39;items&#39;, &#39;iter&#39;, &#39;iterfind&#39;, &#39;itertext&#39;, &#39;keys&#39;, &#39;makeelement&#39;, &#39;remove&#39;, &#39;set&#39;, &#39;tag&#39;, &#39;tail&#39;, &#39;text&#39;]</span><br></pre></td></tr></table></figure>

<p>as we see, operations is listed and think about some typical user case.</p>
<h2 id="find-attributes"><a href="#find-attributes" class="headerlink" title="find attributes"></a>find attributes</h2><p>Before finding attributes check what attributes the xml has.</p>
<p>For root node, only <data></data> has a tag but no attribute is set. So use tag and attrib to check this before find attributes.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.tag</span><br><span class="line">&#39;data&#39;</span><br><span class="line">&gt;&gt;&gt; root.attrib</span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>return value is what we expected. Get deeper, a country tag with name attribute is used. </p>
<p>iterate can be used to get child tag of root.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for child in root:</span><br><span class="line">...     child</span><br><span class="line">...</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd823f50&gt;</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd825110&gt;</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd825250&gt;</span><br></pre></td></tr></table></figure>

<p>or use index to find tag element directly:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root[0]</span><br><span class="line">&lt;Element &#39;country&#39; at 0x7f58bd823f50&gt;</span><br></pre></td></tr></table></figure>

<p>for more duplicate case, those method became hard to use, so use iter or findall:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for neighbor in root.iter(&#39;neighbor&#39;):</span><br><span class="line">...     print neighbor.attrib</span><br><span class="line">...</span><br><span class="line">&#123;&#39;direction&#39;: &#39;E&#39;, &#39;name&#39;: &#39;Austria&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;W&#39;, &#39;name&#39;: &#39;Switzerland&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;N&#39;, &#39;name&#39;: &#39;Malaysia&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;W&#39;, &#39;name&#39;: &#39;Costa Rica&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;E&#39;, &#39;name&#39;: &#39;Colombia&#39;&#125;</span><br></pre></td></tr></table></figure>

<p>all tags match neighbor is listed. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for country in root.findall(&#39;country&#39;):</span><br><span class="line">...     rank &#x3D; country.find(&#39;rank&#39;).text</span><br><span class="line">...     name &#x3D; country.get(&#39;name&#39;)</span><br><span class="line">...     print name, rank</span><br><span class="line">...</span><br><span class="line">Liechtenstein 1</span><br><span class="line">Singapore 4</span><br><span class="line">Panama 68</span><br></pre></td></tr></table></figure>

<p>use find all, all tag with name country is found and its rank text and attribute name is listed.</p>
<p>change the parameters for test, change findall target, test if tag not matched what will happend:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for country in root.findall(&#39;test&#39;):</span><br><span class="line">...     print country</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>when use find instead of findall</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for tag in root.find(&#39;country&#39;):</span><br><span class="line">...     print tag</span><br><span class="line">...</span><br><span class="line">&lt;Element &#39;rank&#39; at 0x7f58bd823f90&gt;</span><br><span class="line">&lt;Element &#39;year&#39; at 0x7f58bd823fd0&gt;</span><br><span class="line">&lt;Element &#39;gdppc&#39; at 0x7f58bd825050&gt;</span><br><span class="line">&lt;Element &#39;neighbor&#39; at 0x7f58bd825090&gt;</span><br><span class="line">&lt;Element &#39;neighbor&#39; at 0x7f58bd8250d0&gt;</span><br></pre></td></tr></table></figure>

<p>only first matched result is returned.</p>
<p>if find for a unexists tag None will be returned.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print root.find(&#39;test&#39;)</span><br><span class="line">None</span><br></pre></td></tr></table></figure>

<p>so in most cases, find and findall seems meet all the require for finding a specific tag.</p>
<h2 id="use-tag"><a href="#use-tag" class="headerlink" title="use tag"></a>use tag</h2><p>get attribute of tag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.find(&#39;country&#39;).get(&#39;name&#39;)</span><br><span class="line">&#39;Liechtenstein&#39;</span><br></pre></td></tr></table></figure>

<p>get text inside tag:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.find(&#39;country&#39;).text</span><br><span class="line">&#39;\n        &#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.find(&#39;country&#39;).find(&#39;year&#39;).text</span><br><span class="line">&#39;2008&#39;</span><br></pre></td></tr></table></figure>

<p>list all children</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; root.getchildren()</span><br><span class="line">[&lt;Element &#39;country&#39; at 0x7f58bd825bd0&gt;, &lt;Element &#39;country&#39; at 0x7f58bd823f10&gt;, &lt;Element &#39;country&#39; at 0x7f58bd8239d0&gt;</span><br></pre></td></tr></table></figure>

<h2 id="insert-tag"><a href="#insert-tag" class="headerlink" title="insert tag"></a>insert tag</h2><p>create new element from string:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; new_element_str&#x3D;&#39;&#39;&#39;    &lt;country name&#x3D;&quot;China&quot;&gt;</span><br><span class="line">...         &lt;rank&gt;2&lt;&#x2F;rank&gt;</span><br><span class="line">...         &lt;year&gt;2022&lt;&#x2F;year&gt;</span><br><span class="line">...         &lt;neighbor name&#x3D;&quot;Japan&quot; direction&#x3D;&quot;E&quot;&#x2F;&gt;</span><br><span class="line">...     &lt;&#x2F;country&gt;&#39;&#39;&#39;</span><br><span class="line">(reverse-i-search)&#96;lo&#39;: &#123;&#39;name&#39;: &#39;Colombia&#39;, &#39;direction&#39;: &#39;E&#39;&#125;</span><br><span class="line">KeyboardInterrupt</span><br><span class="line">&gt;&gt;&gt; &#123;&#39;name&#39;: &#39;Colombia&#39;, &#39;direction&#39;: &#39;E&#39;&#125;</span><br><span class="line">&#123;&#39;direction&#39;: &#39;E&#39;, &#39;name&#39;: &#39;Colombia&#39;&#125;</span><br><span class="line">&gt;&gt;&gt; new &#x3D; ET.fromstring(new_element_str)</span><br></pre></td></tr></table></figure>

<p>check origin element tree:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ET.tostring(root)</span><br><span class="line">&#39;&lt;data&gt;\n    &lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;\n        &lt;rank&gt;1&lt;&#x2F;rank&gt;\n        &lt;year&gt;2008&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Austria&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Switzerland&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Singapore&quot;&gt;\n        &lt;rank&gt;4&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;N&quot; name&#x3D;&quot;Malaysia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Panama&quot;&gt;\n        &lt;rank&gt;68&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Costa Rica&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Colombia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n&lt;&#x2F;data&gt;&#39;</span><br></pre></td></tr></table></figure>

<p>insert new element:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ET.tostring(root)</span><br><span class="line">&#39;&lt;data&gt;\n    &lt;country name&#x3D;&quot;China&quot;&gt;\n        &lt;rank&gt;2&lt;&#x2F;rank&gt;\n        &lt;year&gt;2022&lt;&#x2F;year&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Japan&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;&lt;country name&#x3D;&quot;Liechtenstein&quot;&gt;\n        &lt;rank&gt;1&lt;&#x2F;rank&gt;\n        &lt;year&gt;2008&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;141100&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Austria&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Switzerland&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Singapore&quot;&gt;\n        &lt;rank&gt;4&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;59900&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;N&quot; name&#x3D;&quot;Malaysia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n    &lt;country name&#x3D;&quot;Panama&quot;&gt;\n        &lt;rank&gt;68&lt;&#x2F;rank&gt;\n        &lt;year&gt;2011&lt;&#x2F;year&gt;\n        &lt;gdppc&gt;13600&lt;&#x2F;gdppc&gt;\n        &lt;neighbor direction&#x3D;&quot;W&quot; name&#x3D;&quot;Costa Rica&quot; &#x2F;&gt;\n        &lt;neighbor direction&#x3D;&quot;E&quot; name&#x3D;&quot;Colombia&quot; &#x2F;&gt;\n    &lt;&#x2F;country&gt;\n&lt;&#x2F;data&gt;</span><br></pre></td></tr></table></figure>

<p>confirm new element is added:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for country in root.findall(&#39;country&#39;):</span><br><span class="line">...     country.get(&#39;name&#39;)</span><br><span class="line">...</span><br><span class="line">&#39;China&#39;</span><br><span class="line">&#39;Liechtenstein&#39;</span><br><span class="line">&#39;Singapore&#39;</span><br><span class="line">&#39;Panama&#39;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/07/01/python-elementtree-notes/" data-id="cld1mheb4001dyuwb2id44d0w" data-title="Python ElementTree notes" class="article-share-link">Share</a>
      
      
        <a href="/2022/07/01/python-elementtree-notes/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/07/01/python-elementtree-notes/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-kvm-introduction-00" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/30/kvm-introduction-00/" class="article-date">
  <time class="dt-published" datetime="2022-06-30T15:47:07.000Z" itemprop="datePublished">2022-06-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/30/kvm-introduction-00/">KVM introduction 00</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>See notation of <code>virt/kvm/kvm_main.c</code> in linux kernel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Kernel-based Virtual Machine driver for Linux</span><br><span class="line"> *</span><br><span class="line"> * This module enables machines with Intel VT-x extensions to run virtual</span><br><span class="line"> * machines without emulation or binary translation.</span><br><span class="line"> *</span><br><span class="line"> * Copyright (C) 2006 Qumranet, Inc.</span><br><span class="line"> * Copyright 2010 Red Hat, Inc. and&#x2F;or its affiliates.</span><br><span class="line"> *</span><br><span class="line"> * Authors:</span><br><span class="line"> *   Avi Kivity   &lt;avi@qumranet.com&gt;</span><br><span class="line"> *   Yaniv Kamay  &lt;yaniv@qumranet.com&gt;</span><br><span class="line"> *</span><br><span class="line"> * This work is licensed under the terms of the GNU GPL, version 2.  See</span><br><span class="line"> * the COPYING file in the top-level directory.</span><br><span class="line"> *</span><br><span class="line"> *</span><br></pre></td></tr></table></figure>

<p>I got some questions</p>
<ul>
<li>what means kernel-based</li>
<li>what is VT-x</li>
<li>emulation? binary traslation?</li>
<li>who is Avi Kivity</li>
<li>is there any user-mode hypervisor?</li>
</ul>
<h2 id="Kernel-based"><a href="#Kernel-based" class="headerlink" title="Kernel-based"></a>Kernel-based</h2><blockquote>
</blockquote>
<p>Kernel-based Virtual Machine (KVM) is a virtualization module in the Linux kernel that allows the kernel to function as a hypervisor. It was merged into the mainline Linux kernel in version 2.6.20, which was released on February 5, 2007. <sup>[1]</sup></p>
<p>its available under <code>linux/virt</code></p>
<h2 id="VT-x"><a href="#VT-x" class="headerlink" title="VT-x"></a>VT-x</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">This module enables machines with Intel VT-x extensions to run virtual</span><br><span class="line">machines without emulation or binary translation.</span><br></pre></td></tr></table></figure>

<p>According to the code notation, Intel VT-x extensions is metioned.</p>
<blockquote>
</blockquote>
<p>Previously codenamed “Vanderpool”, VT-x represents Intel’s technology for virtualization on the x86 platform. On November 13, 2005, Intel released two models of Pentium 4 (Model 662 and 672) as the first Intel processors to support VT-x. The CPU flag for VT-x capability is “vmx”; in Linux, this can be checked via /proc/cpuinfo, or in macOS via sysctl machdep.cpu.features.<sup>[2]</sup></p>
<p>for example, on centos 7.6</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cat &#x2F;proc&#x2F;cpuinfo | grep vmx | head -1</span><br><span class="line">flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx avx512f avx512dq rdseed adx smap clflushopt clwb avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 arat</span><br></pre></td></tr></table></figure>

<p>or on Intel CPU MacBook Pro (2020)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sysctl machdep.cpu.features | grep -i vmx</span><br><span class="line">machdep.cpu.features: FPU VME DE PSE TSC MSR PAE MCE CX8 APIC SEP MTRR PGE MCA CMOV PAT PSE36 CLFSH DS ACPI MMX FXSR SSE SSE2 SS HTT TM PBE SSE3 PCLMULQDQ DTES64 MON DSCPL VMX EST TM2 SSSE3 FMA CX16 TPR PDCM SSE4.1 SSE4.2 x2APIC MOVBE POPCNT AES PCID XSAVE OSXSAVE SEGLIM64 TSCTMR AVX1.0 RDRAND F16C</span><br></pre></td></tr></table></figure>

<p>vmx is available</p>
<blockquote>
</blockquote>
<p>“VMX” stands for Virtual Machine Extensions, which adds 13 new instructions: VMPTRLD, VMPTRST, VMCLEAR, VMREAD, VMWRITE, VMCALL, VMLAUNCH, VMRESUME, VMXOFF, VMXON, INVEPT, INVVPID, and VMFUNC.[21] These instructions permit entering and exiting a virtual execution mode where the guest OS perceives itself as running with full privilege (ring 0), but the host OS remains protected.<sup>[2]</sup></p>
<p>note: virtual execution mode is a important concept</p>
<p>refer to paper <strong>kvm: the Linux Virtual Machine Monitor</strong> KVM is designed to add a guest mode, joining the existing <em>kernel mode</em> and <em>user mode</em> </p>
<img src="/2022/06/30/kvm-introduction-00/cpu_executino_loop.png" class="">

<p>In <em>guest-mode</em> CPU instruction executed natively but when I/O requests or signal(typically, network packets received or timeout), exit <em>guest-mode</em> is required and kvm than redirect those I/O or signal handling to <em>user-mode</em> process to emulation device and execute actual I/O. After I/O handling finished, KVM will enter guest mode to execute its CPU instructions again.</p>
<p>For <em>kernel-mode</em> handling exit and enter is basic task. And <em>user-mode</em> process calls kernel to enter <em>guest-mode</em> until it interrupt.</p>
<h2 id="Emulation-amp-Binary-translation"><a href="#Emulation-amp-Binary-translation" class="headerlink" title="Emulation &amp; Binary translation"></a>Emulation &amp; Binary translation</h2><blockquote>
</blockquote>
<p>In computing, binary translation is a form of binary recompilation where sequences of instructions are translated from a source instruction set to the target instruction set. In some cases such as instruction set simulation, the target instruction set may be the same as the source instruction set, providing testing and debugging features such as instruction trace, conditional breakpoints and hot spot detection.</p>
<blockquote>
</blockquote>
<p>The two main types are static and dynamic binary translation. Translation can be done in hardware (for example, by circuits in a CPU) or in software (e.g. run-time engines, static recompiler, emulators).<sup>[3]</sup></p>
<p>Emulators mostly used to run softwares or applications on current OS where those softwares or applications are not support. For example, <a target="_blank" rel="noopener" href="https://github.com/OpenEmu/OpenEmu">https://github.com/OpenEmu/OpenEmu</a> a multiple video game system. This is advantage of emulators.</p>
<p>Disadvantage is that binary translation sometimes require instructino scan, if its used for CPU instruction translations, it spends more time than native instruction. More details in <a target="_blank" rel="noopener" href="https://people.redhat.com/pbonzini/qemu-test-doc/_build/html/topics/Translator-Internals.html">Translator-Internals</a> will be talked in next blogs.</p>
<h2 id="Avi-Kivity"><a href="#Avi-Kivity" class="headerlink" title="Avi Kivity"></a>Avi Kivity</h2><p>Mad C++ developer, proud grandfather of KVM. Now working on @ScyllaDB, an open source drop-in replacement for Cassandra that’s 10X faster. Hiring (remotes too).</p>
<p>from <a target="_blank" rel="noopener" href="https://twitter.com/avikivity">https://twitter.com/avikivity</a></p>
<blockquote>
</blockquote>
<p>Avi Kivity began the development of KVM in mid-2006 at Qumranet, a technology startup company that was acquired by Red Hat in 2008. KVM surfaced in October, 2006 and was merged into the Linux kernel mainline in kernel version 2.6.20, which was released on 5 February 2007. </p>
<blockquote>
</blockquote>
<p>KVM is maintained by Paolo Bonzini. <sup>[1]</sup></p>
<h2 id="Virtualization"><a href="#Virtualization" class="headerlink" title="Virtualization"></a>Virtualization</h2><img src="/2022/06/30/kvm-introduction-00/hardware_assisted_virtualization.png" class="">

<p>For hardware assisted virtualiztion, VMM running below ring0 Guest OS, user application can directly execute user requests, and sensitive OS call trap to VMM without binary translation or Paravirtualization so overhead is decreased.</p>
<p>But for older full virtualization design</p>
<img src="/2022/06/30/kvm-introduction-00/full_virtualization.png" class="">

<p>Guest OS runs on Ring1 and VMM runs on Ring0, without hardware assist, OS requests trap to VMM and after binary translation the instruction finally executed.</p>
<h2 id="KVM-Details"><a href="#KVM-Details" class="headerlink" title="KVM Details"></a>KVM Details</h2><h3 id="Memory-map"><a href="#Memory-map" class="headerlink" title="Memory map"></a>Memory map</h3><p>From perspective of Linux guest OS. Physical memory is already prepared and virtual memory is allocated depend on the physical memory. When guest OS require a virtual address(GVA), Guest OS need to translate is to guest physical address(GPA), this obey the prinsiple of Linux, and tlb, page cache will be involved. And no difference with a Linux Guest running on a real server.</p>
<p>From perspective of host, start a Guest need to allocate a memory space as GPA space. So every GPA has a mapped host virtual address(HVA) and also a host physical address(HPA)</p>
<p>So typically, if a guest need to access a virtual memory address</p>
<p>GVA -&gt; GPA -&gt; HVA -&gt; GPA</p>
<p>at least three times of translation is needed.</p>
<p>Nowadays, CPU offer EPT(Intel) or NPT(AMD) to accelerate GPA -&gt; HVA translation. We will refer that in after blogs.</p>
<h3 id="vMMU"><a href="#vMMU" class="headerlink" title="vMMU"></a>vMMU</h3><p>MMU consists of </p>
<ul>
<li>A radix tree ,the page table, encoding the virtual- to-physical translation. This tree is provided by system software on physical memory, but is rooted in a hardware register (the cr3 register)</li>
<li>A mechanism to notify system software of missing translations (page faults)</li>
<li>An on-chip cache(the translation lookaside buffer, or tlb) that accelerates lookups of the page table</li>
<li>Instructions for switching the translation root inorder to provide independent address spaces</li>
<li>Instructions for managing the tlb</li>
</ul>
<p>As referred in <strong>Memory map</strong> GPA -&gt; HVA should be offered by KVM.</p>
<p>If no hardware assist, use shadow table to maintain the map between GPA and HVA, the good point of shadow table is that runtime address translation overhead is decrease but the major problem is how to synchronize guest page table with shadow page table, when guest writes page table, the shadow page table need to be changed together, so virtual MMU need offer hooks to implement this.</p>
<p>Another question is context switch. Shadow page tables based on the fact that guest should sync its tlb with shadow page tables so that tlb management instruction will be trapped. But the most common tlb management instruction in context-switch is invalidates the entire tlb. So the shadow page tables need to be synced again. Causes bad performance when vm runs multi processes.</p>
<p>vMMU is implement in order to improve guest performance which caches all page tables during context switch. This means context swtich could find its cache from vMMU directly, invdalidates tlb has no influence on context-switch.</p>
<ul>
<li>[1] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine</a></li>
<li>[2] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)">https://en.wikipedia.org/wiki/X86_virtualization#Intel_virtualization_(VT-x)</a></li>
<li>[3] <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Binary_translation">https://en.wikipedia.org/wiki/Binary_translation</a></li>
<li>[4] <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/ols/2007/ols2007v1-pages-225-230.pdf">https://www.kernel.org/doc/ols/2007/ols2007v1-pages-225-230.pdf</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/06/30/kvm-introduction-00/" data-id="cld1mheai000nyuwb2orxc0lk" data-title="KVM introduction 00" class="article-share-link">Share</a>
      
      
        <a href="/2022/06/30/kvm-introduction-00/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/06/30/kvm-introduction-00/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/" class="article-date">
  <time class="dt-published" datetime="2022-06-09T14:22:56.000Z" itemprop="datePublished">2022-06-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/translation/">translation</a>►<a class="article-category-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/">Achieving network wirespeed in an open standard manner: introducing vDPA</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>之前的文章里，我们讨论了现存的virtio-networking架构，包括基于内核的（vhost-net/virtio-net）以及基于用户态DPDK的（vhost-user/vhost-pmd），现在我们需要转移我们的注意力到一个目标是让virtio-networking架构给VM提供有线连接速度的架构</p>
<p>本文将会涵盖构成这个架构的数据面以及控制面组件。我们将会介绍SR-IOV技术，以及这个技术如何提升网络性能。还会介绍virtio的硬件方案以及vDPA（virtual data path acceleration）带来的巨大好处。最后通过比较这些virtio-networking架构来做一个总结。</p>
<p>本文主要是为了那些有兴趣想了解不同virtio-networking架构的（包括vDPA），但不那么深入细节的人。当然后面也会提供一个技术细节的分享以及一个实践教程。</p>
<h2 id="Data-plane-and-control-plane-for-direct-access-to-NIC"><a href="#Data-plane-and-control-plane-for-direct-access-to-NIC" class="headerlink" title="Data plane and control plane for direct access to NIC"></a>Data plane and control plane for direct access to NIC</h2><p>在之前的vhost-net/virtio-net和vhost-user/vhost-pmd架构里，网卡都是接入在OVS kernel或者OVS-DPDK里的，而virtio的后端接口则是从OVS的另外一个port出去的</p>
<p>为了提升网络性能，直接把网络连到guest里，和之前的virtio架构类似，我们拆分了网卡的控制面和数据面：</p>
<ol>
<li>控制面。提供网卡和guest之前的配置修改和特性协商功能，用来建立和销毁数据面通道</li>
<li>数据面。用来在guest和网卡之间传输数据包。当直接把网卡连接到guest的时候，实际上是要求网卡要支持virtio ring layout的</li>
</ol>
<p>这个架构如下图所示：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure1.jpeg" class="">

<p>笔记：</p>
<ul>
<li>如果需要知道KVM，libvirt以及Qemu进程的额外信息，可以看前面的文章</li>
<li>数据面直接从网卡到guest，实际上是通过guest提供一个网卡可访问的共享内存实现的，并且并不经过host kernel。这个意味着网卡和guest都需要使用完全一致的ring layout否则就需要做地址翻译，地址翻译意味着性能损耗</li>
<li>控制面的实现则可能设计host kernel或者qemu进程，这个取决于具体的实现</li>
</ul>
<h2 id="SR-IOV-for-isolating-VM-traffic"><a href="#SR-IOV-for-isolating-VM-traffic" class="headerlink" title="SR-IOV for isolating VM traffic"></a>SR-IOV for isolating VM traffic</h2><p>在vhost-net/virtio-net和vhost-user/virto-pmd架构里，我们是用了软件交换机（OVS）可以让一个网卡对接到物理端口上，然后分发数据包到不同的虚拟机的端口上。</p>
<p>把网卡挂在虚拟机上最简单的方法就是硬件透传，也就是直接把一个网卡提供给guest kernel的驱动。</p>
<p>问题是我们需要在服务器上有一个单独的通过PIC暴露的物理网卡，接下来的问题就是我们如何在物理网卡上创建“虚拟端口”？</p>
<p>SR-IOV（Single root I/O virtualization)是一种PCI设备规范，允许共享一个物理设备给多个虚拟机。换言之，这个功能允许不同的虚拟环境里的虚拟机共享一个网卡。这意味着我们能够拥有一个类似把一个物理网卡拆分为多个以太网接口的功能，帮我们解决了上面提到的“虚拟端口”的创建问题。</p>
<p>SR-IOV有两个主要功能</p>
<ol>
<li>Physical Functions，即PCI设备的完整功能，包括发现，管理和配置功能。每个网卡都有一个对应的PF能提供整个网卡设备的配置</li>
<li>Virtual Functions，是单个PCI功能，可以控制设备的一部分，并且是PF的子集。同一个网卡上能有多个VF</li>
</ol>
<p>我们需要在网卡上配置VF，PF，VF相当于是虚拟接口，PF相当于是网络接口，举个例子，我们有一个10GB网卡有一个外部接口和8个VF。那么这个外部端口的速度以及双工是取决于PF的配置而频率限制则是VF的设置</p>
<p>hypervisor提供了映射virtual function到虚拟机的功能，每个VF都可以被映射到一个VM（一个VM可以同时有多个VF）</p>
<p>然后来看看SR-IOV是如何映射到guest kernel，用户态DPDK或者是直接到host kernel的吧</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure2.jpeg" class="">

<ol>
<li>OVS和SR-IOV： 我们使用SR-IOV给OVS提供多个物理面端口，比如配置多个单独的mac地址，虽然我们只有一个物理网卡，但可以通过VF实现。并且给每分配一段内核内存到特定到VF（每个VF都有）</li>
<li>OVS DPDK和SR-IOV：跳过物理机内核，通过SR-IOV直接从物理网卡到OVS-DPDK。映射host用户态内存给网卡的VF</li>
<li>SR-IOV + guests：映射guest内存到网卡，跳过所有物理机环节。注意：使用设备透传，ring layout在物理网卡和guest之间是共享的，因此特定网卡才能被使用，因为这个逻辑一定是网卡厂商提供的。</li>
</ol>
<p>注意：当然还有不是很常见的第四个方案，就是透传设备给guest里的用户态DPDK应用。</p>
<h2 id="SR-IOV-for-mapping-NIC-to-guest"><a href="#SR-IOV-for-mapping-NIC-to-guest" class="headerlink" title="SR-IOV for mapping NIC to guest"></a>SR-IOV for mapping NIC to guest</h2><p>重点说一下SR-IOV到guest的情况，这里存在一个问题就是在直接映射内存到网卡的场景下，如何更高效的发包收包。</p>
<p>我们有下面两个方法解决这个问题：</p>
<ol>
<li>使用guest kerel驱动：这个方法就是使用网卡厂商提供的kernel驱动，即直接映射IO内存，这样的话硬件设备就能够直接访问guest kernel的内存了</li>
<li>在guest里使用DPDK-pmd驱动：这个方法，就是使用网卡厂商提供的DPDK pmd驱动，运行在guest的用户态，能够直接映射IO内存，因此硬件设备也能够直接访问用户态的特定进程</li>
</ol>
<p>这一段我们重点看看DPDP pmd驱动的方案，整合起来就是下面这个图：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure3.jpeg" class="">

<p>笔记：</p>
<ul>
<li>数据面是和厂商挂钩的直接访问VF</li>
<li>对SRIOV，网卡厂商的驱动需要在host和guest都装</li>
<li>host内核驱动以及guest的pmd驱动并不直接互相访问，PF/VF的驱动是通过其他接口配置的（比如libvirt等）</li>
<li>厂商提供的VF-pmd需要负责网卡VF的配置而PF驱动则负责在host内核上管理好物理网卡设备</li>
</ul>
<p>总结一下这个方案，我们可以通过SR-IOV + DPDK PMC的方式给Guest提供一个很好的网络性能，不过这个方法还是挺麻烦的。因为这个方法是和厂商绑定的，因此需要在guest和host跑一样的驱动，并且特定网卡。这意味着网卡硬件升级，虚拟机应用驱动也需要升级。如果网卡被替换成了另外一个厂商的网卡，那么guest也需要装一个新的pmd。同时迁移虚拟机则会要求host上配置完全一致。也就是说网卡需要版本一致，物理位置需要一致，并且厂家还要提供迁移支持。</p>
<p>因此我们要处理的问题就是如何使用标准接口实现SR-IOV的性能提升，最好是只需要标准驱动，把这个驱动问题从整个架构中解耦出来。</p>
<p>下面的两个方案就是来解决这个问题的</p>
<h2 id="Virtio-full-HW-offloading"><a href="#Virtio-full-HW-offloading" class="headerlink" title="Virtio full HW offloading"></a>Virtio full HW offloading</h2><p>第一个方案是virtio的硬件替代方案，把virtio的控制面和数据面都转移到硬件上，也就是说网卡（当然还是通过VF来提供虚拟接口），支持virtio控制面的标准，包括发现，特性协商，以及建立/销毁数据面，等等。这个设备也支持virtio rang layout，因此一旦内存在网卡和guest之间被映射了，他们就能够直接通信了。</p>
<p>这个方案里，guest能够直接和网卡使用PCI通讯吗所以没有必要使用额外的驱动。然而需要网卡厂商提供支持virtio标准的网卡，包括控制面的软件实现，一般来说都是操作系统实现的，这个情况就是需要网卡自己实现。</p>
<p>下面是硬件架构的图：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure4.jpeg" class="">

<p>笔记：</p>
<ul>
<li>实际上控制面需要的操作是非常负责的主要是和IOMMU以及vIOMMU，下篇文章里会说</li>
<li>实际上在host kernel，qemu进程还有guest kernel都涉及这个流程，图里面简化了</li>
<li>当然也可以吧virtio数据面控制面放到kernel里而不是用户态（和SRIOV的场景一致），也就是直接使用virtio-net驱动来和网卡通讯（而不是使用virtio-pmd）</li>
</ul>
<h2 id="vDPA-standard-data-plane"><a href="#vDPA-standard-data-plane" class="headerlink" title="vDPA - standard data plane"></a>vDPA - standard data plane</h2><p>Virtual data path acceleration (vDPA) 是一个通过virtio ring layout和放置一个SRIOV在guest，来标准化网卡SRIOV数据面将这个网络性能改善和厂家实现解耦的方案，通过增加一个通用的控制面以及阮家架构来支持vDPA。提供一个抽象层，在SRIOV之上，并且给未来的可拓展IOV打好基础。</p>
<p>和virtio的硬件方案类似，数据面直接建立在网卡和guest之间，都使用virtio ring layout。然而每个网卡厂家可能就会提供各自的驱动了，然后一个通用的vDPA驱动就被添加到了kernel里面来完成常见网卡驱动或控制面之间的virtio控制面翻译工作。</p>
<p>vDPA是一个灵活性更高的方案，相比硬件方案来说，网卡厂家支持virtio ring layout的成本更小了，并且也能够达到性能提升的目的。</p>
<p>示例图如下：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/2019-10-02-vdpa-figure5.jpeg" class="">

<p>笔记：</p>
<ul>
<li>实际上在host kernel，qemu进程还有guest kernel都涉及这个流程，图里面简化了</li>
<li>类似SRIOV和virtio全硬件方案，数据面控制面都是在guest内核里而不是用户态（优劣和之前提到的一样）</li>
</ul>
<p>vDPA有潜力成为一个权威的给虚拟机提供以太网接口的方案：</p>
<ol>
<li>开源的标准：任何人可用，并且贡献标准，而不被特定的厂商限制</li>
<li>优异的性能：接近SRIOV，中间没有翻译成本</li>
<li>可以支持未来的硬件平台拓展技术</li>
<li>独立于特定厂商的标准驱动，意味着只需要配置一次驱动，而不用太关心网卡和版本</li>
<li>传输保护，guest直接使用单个接口。从host角度容易发现，并可以做好切换</li>
<li>在线迁移，提供不同网卡不同版本的在线迁移</li>
<li>提供一个标准的容器加速接口</li>
<li>裸机，提供标准的网卡驱动mvirtio网卡驱动可以被作为一个裸机驱动，当时用vDPA软件架构的时候，驱动这个驱动来适配不同网卡硬件</li>
</ol>
<h2 id="Comparing-virtio-architectures"><a href="#Comparing-virtio-architectures" class="headerlink" title="Comparing virtio architectures"></a>Comparing virtio architectures</h2><p>总结一下之前的系列里我们学到的内容，包括四种提供给vm以太网络的架构，vhost-net/virito-net, vhost-user/virito-pmd, virtio full HW offloading 和 vDPA。</p>
<p>然后来比较一下他们的优劣：</p>
<img src="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/virtio-arch-compare.png" class="">

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇文章我们包含了四种提供以太网接口的virtio-networking架构概览，包括速度慢的（virtio-net）到比较快的（vhost-user）还有最快的（virtio硬件方案和vDPA）</p>
<p>我们强调vDPA和SR-IOV相对其他技术来说的优势，也提供了四种技术的对比，接下来会更加深入的使用virtio硬件方案以及vDPA。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/" data-id="cld1mhe9t0001yuwbfbjaec59" data-title="Achieving network wirespeed in an open standard manner: introducing vDPA" class="article-share-link">Share</a>
      
      
        <a href="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/06/09/Achieving-network-wirespeed-in-an-open-standard-manner-introducing-vDPA/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-linux-memory-management-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/04/linux-memory-management-1/" class="article-date">
  <time class="dt-published" datetime="2022-06-04T15:22:23.000Z" itemprop="datePublished">2022-06-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>►<a class="article-category-link" href="/categories/linux/memory-management/">memory management</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/04/linux-memory-management-1/">Linux memory management(1)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="CPU-aceess-memory"><a href="#CPU-aceess-memory" class="headerlink" title="CPU aceess memory"></a>CPU aceess memory</h2><p>CPU core -&gt; MMU(TLBs, Table Walk Unit) -&gt; Caches -&gt; Memory(Translation tables)</p>
<p>CPU VA -&gt; MMU find PTE(Pysical table entry) -&gt; TLB -&gt; L1 cache -&gt; L2 cache -&gt; L3 cache</p>
<p>note: pretend a architecture with TLB between CPU and L1 cache.</p>
<p>TLB is a some cache form VA-to-PA translaction and formed by PTE blocks.</p>
<p>if TLB miss, CPU find PA from L1 and so on until PA is find and then put the PTE into TLB.</p>
<h3 id="what-is-TLB"><a href="#what-is-TLB" class="headerlink" title="what is TLB?"></a>what is TLB?</h3><p>TLB definition from wiki: A translation lookaside buffer (TLB) is a memory cache that is used to reduce the time taken to access a user memory location. It is a part of the chip’s memory-management unit (MMU). The TLB stores the recent translations of virtual memory to physical memory and can be called an address-translation cache. A TLB may reside between the CPU and the CPU cache, between CPU cache and the main memory or between the different levels of the multi-level cache. The majority of desktop, laptop, and server processors include one or more TLBs in the memory-management hardware, and it is nearly always present in any processor that utilizes paged or segmented virtual memory.</p>
<p>note: </p>
<ol>
<li><p>TLB stores recent translations that means not all address translation entry is stored in TLB, take care about cache miss.</p>
</li>
<li><p>TLB may reside between the CPU and the CPU cache, between the CPU cache and primary storage memory, or between levels of a multi-level cache. </p>
</li>
<li><p>virtual addressing met cache miss or physical addressing, CPU always uses TLB to find and store it into cache.</p>
</li>
<li><p>cache strategy LRU or FIFO</p>
</li>
<li><p>The CPU has to access main memory for an instruction-cache miss, data-cache miss, or TLB miss, but compare to others the third case TLB miss is too expensive.</p>
</li>
<li><p>freqently TLB misses occur degrading performance, because each newly cached page displacing one that will soon be used again. Where the TLB acting as a cache for the memory management unit (MMU) which translates virtual addresses to physical addresses is too small for the working set of pages. TLB thrashing can occur even if instruction cache or data cache thrashing are not occurring, because these are cached in different sizes. Instructions and data are cached in small blocks (cache lines), not entire pages, but address lookup is done at the page level. Thus even if the code and data working sets fit into cache, if the working sets are fragmented across many pages, the virtual address working set may not fit into TLB, causing TLB thrashing.</p>
</li>
</ol>
<h3 id="TLB-miss-handling"><a href="#TLB-miss-handling" class="headerlink" title="TLB-miss handling"></a>TLB-miss handling</h3><p>Two schemes for handling TLB misses are commonly found in modern architectures:</p>
<ul>
<li>With hardware TLB management, the CPU automatically walks the page tables . On x86 for example, use CR3 register to walks page tables if entry exists, bring back to TLB and TLB tries and access will hit. Or raise a page fault exception which need to be handled by operation system and load correct physical address to TLB(page swap in/out). CPU change do not cause loss of compatibility for the programs.</li>
<li>With software-managed TLBs, a TLB miss generates a TLB miss exception, and operating system code is responsible for walking the page tables and performing the translation in software. The operating system then loads the translation into the TLB and restarts the program from the instruction that caused the TLB miss. As with hardware TLB management, if the OS finds no valid translation in the page tables, a page fault has occurred, and the OS must handle it accordingly. Instruction sets of CPUs that have software-managed TLBs have instructions that allow loading entries into any slot in the TLB. The format of the TLB entry is defined as a part of the instruction set architecture (ISA).</li>
</ul>
<p>note:</p>
<ol>
<li>hardware TLB management TLB handling the lifecycle of TLB entries. </li>
<li>hardware TLB management throws page fault that OS must handling and OS should bring the missing table entry of physical address into TLB cache. And than the program resume.</li>
<li>hardware TLB management maintain TLB enties is invisible to software. </li>
<li>hardware TLB management can change from CPU to CPU, but without causing compatibility for the programs. In other words, CPU should obey the rules of TLB management so there is always any page fault exception require OS to handle</li>
<li>software TLB management throws TLB miss exception and OS owns the responsibility to walk page tables and translation in software. Then OS loads TLB table and restart programs (attention! not resume but restart).</li>
<li>compare hardware and software TLB management, according to 2 CPU finds TLB and throw page fault exception when hardware, but in sofware situation, the CPU’s instruction sets should have instruction to load TLB to anywhere and TLB entry can be used directly by CPU instruction</li>
</ol>
<p>In most cases, hardware TLB management is used. But according to wiki, some of the architectures using software TLB management.</p>
<h2 id="Typical-TLB"><a href="#Typical-TLB" class="headerlink" title="Typical TLB"></a>Typical TLB</h2><p>These are typical performance levels of a TLB:</p>
<ul>
<li>Size: 12 bits – 4,096 entries</li>
<li>Hit time: 0.5 – 1 clock cycle</li>
<li>Miss penalty: 10 – 100 clock cycles</li>
<li>Miss rate: 0.01 – 1% (20–40% for sparse/graph applications)</li>
</ul>
<p>The average effective memory cycle rate is defined as <code>m + (1-p)h + pm</code> cycles, where <code>m</code> is the number of cycles required for a memory read, <code>p</code> is the miss rate, and <code>h</code> is the hit time in cycles. If a TLB hit takes 1 clock cycle, a miss takes 30 clock cycles, a memory read takes 30 clock cycles, and the miss rate is 1%, the effective memory cycle rate is an average of 30 + 0.99 * 1 + 0.01 * 30 (31.29 clock cycles per memory access)</p>
<p>note: research more of TLB performance</p>
<p>use perf test TLB miss</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perf stat -e dTLB-loads,dTLB-load-misses,iTLB-loads,iTLB-load-misses -p $PID</span><br></pre></td></tr></table></figure>

<p>if a high TLB missing rate exists in your OS, try to use huge page to decrease the table entries in TLB which will cut down the miss rate. But some application is not siutable for huge page and more details need to be change before use this solution.</p>
<h2 id="Address-space-switch"><a href="#Address-space-switch" class="headerlink" title="Address-space switch"></a>Address-space switch</h2><p>After process context switches, some TLB entries’ virtual address to physical address mapping is invalid. In order to clean thoes invalid entires, some strategies is required. </p>
<ol>
<li>flush all entries after process context change</li>
<li>mark the entries with its process so the process context change do not matter</li>
<li>some architecture use a sinlge address space operating system, all process use the same virtual-to-pysical mapping</li>
<li>some CPU have a process register and hardware uses TLB entries only the current process ID matches</li>
</ol>
<p>note:<br>flushing TLB is an important security mechanism for memory isolation. Memory isolation is especially critical during switches between the privileged operating system kernel process and the user processes – as was highlighted by the Meltdown security vulnerability[2]. Mitigation strategies such as kernel page-table isolation (KPTI) rely heavily on performance-impacting TLB flushes and benefit greatly from hardware-enabled selective TLB entry management such as PCID.</p>
<h2 id="Virtualization-and-x86-TLB"><a href="#Virtualization-and-x86-TLB" class="headerlink" title="Virtualization and x86 TLB"></a>Virtualization and x86 TLB</h2><p>With the advent of virtualization for server consolidation, a lot of effort has gone into making the x86 architecture easier to virtualize and to ensure better performance of virtual machines on x86 hardware</p>
<p>EPT required.</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ol>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Translation_lookaside_buffer">https://en.wikipedia.org/wiki/Translation_lookaside_buffer</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Meltdown_(security_vulnerability)">https://en.wikipedia.org/wiki/Meltdown_(security_vulnerability)</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/06/04/linux-memory-management-1/" data-id="cld1mheam000syuwb5pb3co5q" data-title="Linux memory management(1)" class="article-share-link">Share</a>
      
      
        <a href="/2022/06/04/linux-memory-management-1/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/06/04/linux-memory-management-1/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Hands-on-vhost-user-A-warm-welcome-to-DPDK" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/04/14/Hands-on-vhost-user-A-warm-welcome-to-DPDK/" class="article-date">
  <time class="dt-published" datetime="2022-04-14T07:33:37.000Z" itemprop="datePublished">2022-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/translation/">translation</a>►<a class="article-category-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/04/14/Hands-on-vhost-user-A-warm-welcome-to-DPDK/">Hands on vhost-user: A warm welcome to DPDK</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这片文章里我们将会配置一个环境，然后在虚拟机里运行一个基于DPDK应用。我们将介绍所有用来在host系统上配置一个虚拟交换机需要的步骤，并通过这个虚拟交换机连接到虚拟机的应用。正文包括描述如何创建，安装和运行虚拟机，以及安装里面的应用。你将会学习到如何创建并设置一个简单的通过guest内的应用发送并接收网络数据包到host的虚拟交换机。基于这些设置，你将会学习到如何如何调整设置来获得最优的吞吐性能。</p>
<h1 id="Setting-up"><a href="#Setting-up" class="headerlink" title="Setting up"></a>Setting up</h1><p>对于乐意使用DPDK但不希望配置和安装相关软件的，我们提供了一个ansible playbooks在github的repo里，自动化了所有步骤，我们就基于这个配置开始吧。</p>
<h1 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements:"></a>Requirements:</h1><ul>
<li>一台运行了Linux发行版的电脑。本文使用Centos 7，不过不同的Linux发行版之间命令的差别也不会特别大，特别是Red Hat Enterprise Linux 7</li>
<li>一个有sudo权限的用户</li>
<li>home目录下有大于25GB的空闲空间</li>
<li>至少8GB的RAM</li>
</ul>
<p>首先我们先安装我们需要的包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install qemu-kvm libvirt-daemon-qemu libvirt-daemon-kvm libvirt virt-install libguestfs-tools-c kernel-tools dpdk dpdk-tools</span><br></pre></td></tr></table></figure>

<h1 id="Creating-a-VM"><a href="#Creating-a-VM" class="headerlink" title="Creating a VM"></a>Creating a VM</h1><p>首先从下面的网站下载一个最新的Centos-Cloud-Base镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -O &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;CentOS-7-x86_64-GenericCloud.qcow2 http:&#x2F;&#x2F;cloud.centos.org&#x2F;centos&#x2F;7&#x2F;images&#x2F;CentOS-7-x86_64-GenericCloud.qcow2</span><br></pre></td></tr></table></figure>

<p>这个下载的是一个预安装的Centos7，用来在OpenStack环境运行的。因为我们不使用OpenStack，所以我们需要清理一下这个虚拟机。不过首先我们需要做一个镜像的copy。以此保证我们之后能重复使用这个镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-img create -f qcow2 -b  &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;CentOS-7-x86_64-GenericCloud.qcow2  &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;vhuser-test1.qcow2 20G</span><br></pre></td></tr></table></figure>

<p>通过下面的配置我们可以允许非特权用户使用libvirt命令（推荐）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LIBVIRT_DEFAULT_URI&#x3D;&quot;qemu:&#x2F;&#x2F;&#x2F;system&quot;</span><br></pre></td></tr></table></figure>

<p>然后使用清理命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo virt-sysprep --root-password password:changeme --uninstall cloud-init --selinux-relabel -a &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;vhuser-test1.qcow2 --network --install &quot;dpdk,dpdk-tools,pciutils&quot;</span><br></pre></td></tr></table></figure>

<p>这个命令回挂载文件系统并自动应用一些基础配置，然后这个镜像就可以用来启动虚拟机了</p>
<p>我们需要一个网络来连接我们的虚拟机，Libvirt处理网络的方式类似管理虚拟机，你可以通过XML文件定义网络并且通过命令行控制它的启动和停止。</p>
<p>举个例子，我们将使用一个叫做’default’的网络libvirt自带的方便网络。用下面的命令定义’default’网络，启动并检查网络运行状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@10-0-117-158 ~]# virsh net-define &#x2F;usr&#x2F;share&#x2F;libvirt&#x2F;networks&#x2F;default.xml</span><br><span class="line">Network default defined from &#x2F;usr&#x2F;share&#x2F;libvirt&#x2F;networks&#x2F;default.xml</span><br><span class="line"></span><br><span class="line">[root@10-0-117-158 ~]# virsh net-start default</span><br><span class="line">Network default started</span><br><span class="line"></span><br><span class="line">[root@10-0-117-158 ~]# virsh net-list</span><br><span class="line"> Name      State    Autostart   Persistent</span><br><span class="line">--------------------------------------------</span><br><span class="line"> default   active   no          yes</span><br></pre></td></tr></table></figure>

<p>最后我们使用virt-install来创建虚拟机。这个命令行工具包含了一系列常用的操作系统配置定义。然后我们可以基于这个基本定义做一些改动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">virt-install --import  --name vhuser-test1 --ram&#x3D;4096 --vcpus&#x3D;3 \</span><br><span class="line">--nographics --accelerate \</span><br><span class="line">       --network network:default,model&#x3D;virtio --mac 02:ca:fe:fa:ce:aa \</span><br><span class="line">      --debug --wait 0 --console pty \</span><br><span class="line">      --disk &#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;images&#x2F;vhuser-test1.qcow2,bus&#x3D;virtio --os-variant centos7.0</span><br></pre></td></tr></table></figure>

<p>这些参数分别制定了。vCPUs的数量，RAM的大小，磁盘的路径，以及虚拟机要连接的网络。</p>
<p>出了通过我们指定的这些参数定义VM之外，virt-install会把虚拟机同时创建出来，所以我们应该可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@10-0-117-158 ~]# virsh list</span><br><span class="line"> Id   Name           State</span><br><span class="line">------------------------------</span><br><span class="line"> 7    vhuser-test1   running</span><br></pre></td></tr></table></figure>

<p>很好，虚拟机已经运行了。接下来我们先把虚拟机停下来然后做一些额外的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh shutdown vhuser-test1</span><br></pre></td></tr></table></figure>

<h1 id="Preparing-the-host"><a href="#Preparing-the-host" class="headerlink" title="Preparing the host"></a>Preparing the host</h1><p>DPDK对内存缓存的分配和管理做了优化。在Linux上这个需要使用hugepage的支持，所以必须要在kernel上打开。使用的page大小通常需要大于4K，以此通过使用更少的page数量，以及更少的TLB来提升性能。在翻译虚拟地址到物理地址的时候会产生这些查询。为了在启动时分配hugepage，我们需要在bootloader配置里加上kernel参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grubby --args&#x3D;&quot;default_hugepagesz&#x3D;1G hugepagesz&#x3D;1G hugepages&#x3D;6 iommu&#x3D;pt intel_iommu&#x3D;on&quot; --update-kernel &#x2F;boot&#x2F;vmlinuz-3.10.0-957.27.2.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>当然我们来解释一下这些参数做了什么：</p>
<p><code>default_hugepagesz=1G</code> 默认创建出来的hugepages默认是1GB</p>
<p><code>hugepagesz=1G</code> 启动过程中创建出来的hugepage大小也是1GB</p>
<p><code>hugepages=6</code> 最开始启动的时候创建6个大小为1GB的hugepage，这个在重启之后可以在/proc/meminfo里看到</p>
<p>注意，补充说明hugepages的设置增加了两个IOMMU相关的参数 <code>iommu=pt intel_iommu=on</code> 这个会初始化Intel VT-d以及IOMMU Pass-Through模式，在Linux用户态处理IO的时候需要用到他们。因此我们修改了kernel参数，现在刚好可以做一下重启。</p>
<p>等到重启完成之后，我们可以通过命令行查看对应的参数已经生效了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@10-0-117-158 ~]# cat &#x2F;proc&#x2F;cmdline</span><br><span class="line">BOOT_IMAGE&#x3D;&#x2F;vmlinuz-3.10.0-957.27.2.el7.x86_64 root&#x3D;&#x2F;dev&#x2F;mapper&#x2F;zstack-root ro noibrs noibpb nopti nospectre_v2 nospectre_v1 l1tf&#x3D;off nospec_store_bypass_disable no_stf_barrier mds&#x3D;off mitigations&#x3D;off crashkernel&#x3D;auto rd.lvm.lv&#x3D;zstack&#x2F;root rd.lvm.lv&#x3D;zstack&#x2F;swap rhgb quiet LANG&#x3D;en_US.UTF-8 default_hugepagesz&#x3D;1G hugepagesz&#x3D;1G hugepages&#x3D;6 iommu&#x3D;pt intel_iommu&#x3D;on</span><br></pre></td></tr></table></figure>

<h1 id="Prepare-the-guest"><a href="#Prepare-the-guest" class="headerlink" title="Prepare the guest"></a>Prepare the guest</h1><p>virt-install命令通过libvirt创建并启动了一个虚拟机。为了将基于DPDK的vswitch TestPMD连接到QEMU，我们需要增加如下的定义到XML的device部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh edit vhuser-test1</span><br></pre></td></tr></table></figure>

<p>在<code>&lt;device&gt;</code>部分增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;interface type&#x3D;&#39;vhostuser&#39;&gt;</span><br><span class="line">  &lt;mac address&#x3D;&#39;56:48:4f:53:54:01&#39;&#x2F;&gt;</span><br><span class="line">  &lt;source type&#x3D;&#39;unix&#39; path&#x3D;&#39;&#x2F;tmp&#x2F;vhost-user1&#39; mode&#x3D;&#39;client&#39;&#x2F;&gt;</span><br><span class="line">  &lt;model type&#x3D;&#39;virtio&#39;&#x2F;&gt;</span><br><span class="line">  &lt;driver name&#x3D;&#39;vhost&#39; rx_queue_size&#x3D;&#39;256&#39; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;interface&gt;</span><br><span class="line">&lt;interface type&#x3D;&#39;vhostuser&#39;&gt;</span><br><span class="line">  &lt;mac address&#x3D;&#39;56:48:4f:53:54:02&#39;&#x2F;&gt;</span><br><span class="line">  &lt;source type&#x3D;&#39;unix&#39; path&#x3D;&#39;&#x2F;tmp&#x2F;vhost-user2&#39; mode&#x3D;&#39;client&#39;&#x2F;&gt;</span><br><span class="line">  &lt;model type&#x3D;&#39;virtio&#39;&#x2F;&gt;</span><br><span class="line">  &lt;driver name&#x3D;&#39;vhost&#39; rx_queue_size&#x3D;&#39;256&#39; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;interface&gt;</span><br></pre></td></tr></table></figure>

<p>另一个和vhost-net不同的guest配置就是hugepages。因此我们需要给guest增加如下定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;memoryBacking&gt;</span><br><span class="line">  &lt;hugepages&gt;</span><br><span class="line">    &lt;page size&#x3D;&#39;1048576&#39; unit&#x3D;&#39;KiB&#39; nodeset&#x3D;&#39;0&#39;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;hugepages&gt;</span><br><span class="line">  &lt;locked&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;memoryBacking&gt;</span><br><span class="line"> &lt;numatune&gt;</span><br><span class="line">  &lt;memory mode&#x3D;&#39;strict&#39; nodeset&#x3D;&#39;0&#39;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;numatune&gt;</span><br></pre></td></tr></table></figure>

<p>这样就有内存了，然后再修改guest里的配置，这是非常重要的配置，没有的话就没办法收发数据包了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &lt;cpu mode&#x3D;&#39;host-passthrough&#39; check&#x3D;&#39;none&#39;&gt;</span><br><span class="line">  &lt;topology sockets&#x3D;&#39;1&#39; cores&#x3D;&#39;3&#39; threads&#x3D;&#39;1&#39;&#x2F;&gt;</span><br><span class="line">  &lt;numa&gt;</span><br><span class="line">    &lt;cell id&#x3D;&#39;0&#39; cpus&#x3D;&#39;0-2&#39; memory&#x3D;&#39;3145728&#39; unit&#x3D;&#39;KiB&#39; memAccess&#x3D;&#39;shared&#39;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;numa&gt;</span><br><span class="line">&lt;&#x2F;cpu&gt;</span><br></pre></td></tr></table></figure>

<p>然后我们需要启动我们的guest。因为我们配置了让虚拟机连接到vhost-user的UNIX sockets，因此我们需要确保guest启动的时候这些sockets时可用的。这是通过启动testpmd实现的，这个操作会创建我们需要的sockets。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo testpmd -l 0,2,3,4,5 --socket-mem&#x3D;1024 -n 4 \</span><br><span class="line">    --vdev &#39;net_vhost0,iface&#x3D;&#x2F;tmp&#x2F;vhost-user1&#39; \</span><br><span class="line">    --vdev &#39;net_vhost1,iface&#x3D;&#x2F;tmp&#x2F;vhost-user2&#39; -- \</span><br><span class="line">    --portmask&#x3D;f -i --rxq&#x3D;1 --txq&#x3D;1 \</span><br><span class="line">    --nb-cores&#x3D;4 --forward-mode&#x3D;io</span><br></pre></td></tr></table></figure>

<p>最后，这个实验需要连接到vhost-user unix sockets，因此启动QEMU的时候需要用root。所以在<code>/etc/libvirt/qemu.conf</code> 中设置 <code>user=root</code>。 这是因为我们呢的特殊验证场景需要这样配置，生产环境通常不建议这样配置。实际上读者需要在本文演示结束之后把 <code>user=root</code> 这个配置去掉。</p>
<p>现在我们可以通过命令启动虚拟机了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh start vhuser-test1.</span><br></pre></td></tr></table></figure>

<p>通过root登陆之后，我们要做的第一件事就是绑定virtio设备到vfio-pci驱动。为了能够完成这个操作，我们需要加载一些内核模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# modprobe  vfio enable_unsafe_noiommu_mode&#x3D;1</span><br><span class="line">[   90.462919] VFIO - User Level meta-driver version: 0.3</span><br><span class="line">[root@localhost ~]# cat &#x2F;sys&#x2F;module&#x2F;vfio&#x2F;parameters&#x2F;enable_unsafe_noiommu_mode</span><br><span class="line">Y</span><br><span class="line">[root@localhost ~]# modprobe vfio-pci</span><br></pre></td></tr></table></figure>

<p>然后找出virtio-net设备的PCI地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# dpdk-devbind --status net</span><br><span class="line"></span><br><span class="line">Network devices using kernel driver</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">0000:00:02.0 &#39;Virtio network device 1000&#39; if&#x3D;eth0 drv&#x3D;virtio-pci unused&#x3D;virtio_pci,vfio-pci *Active*</span><br><span class="line">0000:00:08.0 &#39;Virtio network device 1000&#39; if&#x3D;eth1 drv&#x3D;virtio-pci unused&#x3D;virtio_pci,vfio-pci</span><br><span class="line">0000:00:09.0 &#39;Virtio network device 1000&#39; if&#x3D;eth2 drv&#x3D;virtio-pci unused&#x3D;virtio_pci,vfio-pci</span><br><span class="line"></span><br><span class="line">No &#39;Crypto&#39; devices detected</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">No &#39;Eventdev&#39; devices detected</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">No &#39;Mempool&#39; devices detected</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">No &#39;Compress&#39; devices detected</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>在dpdk-devbind的输出中找到virtio-devices的部分，并且没有被标记Active状态的。我们可以用这些设备来进行实验。注意：地址可能是不一样的。当我们首次启动这些设备的时候将会自动绑定到virtio-pci驱动，因为我们需要和非kernel的驱动一起使用，首先就是要将这些设备和virtio-pci设备解绑，然后再绑定到vfio-pci驱动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# dpdk-devbind -b vfio-pci 0000:00:08.0 0000:00:09.0</span><br><span class="line">[  360.862724] iommu: Adding device 0000:00:08.0 to group 0</span><br><span class="line">[  360.871147] vfio-pci 0000:00:08.0: Adding kernel taint for vfio-noiommu group on device</span><br><span class="line">[  360.951240] iommu: Adding device 0000:00:09.0 to group 1</span><br><span class="line">[  360.960126] vfio-pci 0000:00:09.0: Adding kernel taint for vfio-noiommu group on device</span><br></pre></td></tr></table></figure>

<h1 id="Generating-traffic"><a href="#Generating-traffic" class="headerlink" title="Generating traffic"></a>Generating traffic</h1><p>我们已经安装并配置好所有东西了，接下来就是运行网络负载了。首先在host上我们需要启动testpmd实例作为虚拟交换机。然后设置它转发所有在net_vhost0收到的数据包到net_vhost1。testpmd需要在虚拟机启动之前启动，因为它会尝试连接到由QEMU创建的属于vhost-user设备初始化出来的unix sockets。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">testpmd -l 0,2,3,4,5 --socket-mem&#x3D;1024 -n 4 \</span><br><span class="line">    --vdev &#39;net_vhost0,iface&#x3D;&#x2F;tmp&#x2F;vhost-user1&#39; \</span><br><span class="line">    --vdev &#39;net_vhost1,iface&#x3D;&#x2F;tmp&#x2F;vhost-user2&#39; -- \</span><br><span class="line">    --portmask&#x3D;f -i --rxq&#x3D;1 --txq&#x3D;1 \</span><br><span class="line">    --nb-cores&#x3D;4 --forward-mode&#x3D;io</span><br></pre></td></tr></table></figure>

<p>然后我们来启动之前准备好的虚拟机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh start vhuser-test1</span><br></pre></td></tr></table></figure>

<p>注意这时候我们能够在testpmd看到vhost-user收到的数据包了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Port 1: link state change event</span><br><span class="line">VHOST_CONFIG: vring base idx:0 file:0</span><br><span class="line">VHOST_CONFIG: read message VHOST_USER_GET_VRING_BASE</span><br><span class="line">VHOST_CONFIG: vring base idx:1 file:0</span><br><span class="line">VHOST_CONFIG: read message VHOST_USER_GET_VRING_BASE</span><br><span class="line"></span><br><span class="line">Port 0: link state change event</span><br><span class="line">VHOST_CONFIG: vring base idx:0 file:0</span><br><span class="line">VHOST_CONFIG: read message VHOST_USER_GET_VRING_BASE</span><br><span class="line">VHOST_CONFIG: vring base idx:1 file:0</span><br></pre></td></tr></table></figure>

<p>当guest启动之后我们就能够启动testpmd了。testpmd会初始化端口以及DPDK实现的virtio-net驱动。另外还有virtio特性的协商以及其他一些通用功能的协商也都在这一步发生了。</p>
<p>在我们启动testpmd之前，需要确认vfio内核模块已经加载并绑定了virtio-net设备到vfio-pci驱动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpdk-devbind -b vfio-pci 0000:00:08.0 0000:00:09.0</span><br></pre></td></tr></table></figure>

<p>然后可以启动testpmd：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">testpmd -l 0,1,2 --socket-mem 1024 -n 4 \</span><br><span class="line">    --proc-type auto --file-prefix pg -- \</span><br><span class="line">    --portmask&#x3D;3 --forward-mode&#x3D;macswap --port-topology&#x3D;chained \</span><br><span class="line">    --disable-rss -i --rxq&#x3D;1 --txq&#x3D;1 \</span><br><span class="line">    --rxd&#x3D;256 --txd&#x3D;256 --nb-cores&#x3D;2 --auto-start</span><br></pre></td></tr></table></figure>

<p>现在我们可以检查testpmd处理了多少数据包了，我们可以通过输入命令 <code>show port stats all</code> 来看对应（RX/TX）方向的信息，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">testpmd&gt; show port stats all</span><br><span class="line"></span><br><span class="line">  ######################## NIC statistics for port 0  ########################</span><br><span class="line">  RX-packets: 75525952   RX-missed: 0          RX-bytes:  4833660928</span><br><span class="line">  RX-errors: 0</span><br><span class="line">  RX-nombuf:  0         </span><br><span class="line">  TX-packets: 75525984   TX-errors: 0          TX-bytes:  4833662976</span><br><span class="line"></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:      4684120</span><br><span class="line">  Tx-pps:      4684120</span><br><span class="line">  #########################################################################</span><br><span class="line"></span><br><span class="line">  ######################## NIC statistics for port 1  ########################</span><br><span class="line">  RX-packets: 75525984   RX-missed: 0          RX-bytes:  4833662976</span><br><span class="line">  RX-errors: 0</span><br><span class="line">  RX-nombuf:  0         </span><br><span class="line">  TX-packets: 75526016   TX-errors: 0          TX-bytes:  4833665024</span><br><span class="line"></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:      4681229</span><br><span class="line">  Tx-pps:      4681229</span><br><span class="line"></span><br><span class="line">  #########################################################################</span><br></pre></td></tr></table></figure>

<p>testpmd有不同的转发模式，这个例子里面我们用的是macswap，此模式会交换目标和源头的mac地址。另外的转发模式，比如’io’则不会处理包，所以会给出更高深职很不现实的数据。另外一个转发模式就是’noisy’，可以模拟调整包的缓存/内存的查找。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/04/14/Hands-on-vhost-user-A-warm-welcome-to-DPDK/" data-id="cld1mhea00006yuwb46p57oqf" data-title="Hands on vhost-user: A warm welcome to DPDK" class="article-share-link">Share</a>
      
      
        <a href="/2022/04/14/Hands-on-vhost-user-A-warm-welcome-to-DPDK/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/04/14/Hands-on-vhost-user-A-warm-welcome-to-DPDK/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-A-journey-to-the-vhost-users-realm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/09/A-journey-to-the-vhost-users-realm/" class="article-date">
  <time class="dt-published" datetime="2022-02-09T07:30:26.000Z" itemprop="datePublished">2022-02-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/virtualization/">virtualization</a>►<a class="article-category-link" href="/categories/virtualization/translation/">translation</a>►<a class="article-category-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/09/A-journey-to-the-vhost-users-realm/">A journey to the vhost-users realm</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这篇文章是基于上一篇 <a href="/2022/02/09/How-vhost-user-came-into-being-Virtio-networking-and-DPDK/" title="HOWTO">HOWTO</a> 的一篇深入介绍以使用DPDK达成高性能用户态网络功能的vhost-user/virtio-pmd架构。本文主要是供对这个架构的更多实质性实现有兴趣的研发/架构师，并将会提供一个便于理解的时间博客来探索这些概念。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>之前的deep dive文章里，我们展示了将网络处理逻辑从qemu移动到kernel driver并通过vhost-net协议后带来的好处。这篇文章里，我们将会更深一步展示一下如何通过使用DPDK把host和guest的数据面从kernel移动到用户态之后获取更好的网络性能。为了实现这个我们需要看一下这个新的vhost-user库的实现。</p>
<p>在这篇文章的结尾，你应该对vhost-user/virtio-pmd架构有一个更深的理解，同时能够了解它系统重大性能提升背后的原因。</p>
<h2 id="DPDK-and-its-benefits"><a href="#DPDK-and-its-benefits" class="headerlink" title="DPDK and its benefits"></a>DPDK and its benefits</h2><p>你可能已经听过DPDK了。这个用户态快速法宝处理库是很多网络功能虚拟化应用的核心（NFV，Network Function Virtualization），通过这个库他们可以实现一个完整的用户态应用，而跳过内核的网络协议栈.</p>
<p>DPDK是一组用户态的库，能够使一个用户创建一个优化过的高性能包处理应用。它带来了很多优势，让他在开发人员之中特别受欢迎。下面是列举一部分优势：</p>
<ul>
<li>Processor affinity  DPDK可以把每一个不同的线程pin到一个特定的逻辑核心上来满足并行最大化</li>
<li>Huge pages DPDK有数层内存管理（比如Mempool library或者是Mbuf libraty）。然而实际上所有的内存都mmap在hugetlbfs里面分配的。使用2MB或者是甚至1GB的页，DPDK减少了cache missi以及TLB的查询</li>
<li>Lockless ring buffers DPDK包处理是基于Ring library的，它提供了一个高效无锁的ring queueu支持爆发式的入队出队操作。</li>
<li>Poll Mode Driver 为了避免中断开销，DPDK提供了一个Poll Mode Driver（PMD）抽象</li>
<li>VFIO支持 VFIO（Virtual Function I/O）提供了一个用户态驱动开发框架，允许用户态应用直接通过I/O空间映射到应用内存的方式直接访问硬件设备。</li>
</ul>
<p>附带在这些特性之后的还有另外两个DPDK支持的技术，提供给我们一套极大提升网络应用性能的工具：</p>
<ul>
<li>Vhost-user库 用户态库，实现了vhost协议</li>
<li>Virtio-PMD 基于DPDK的PMD抽象构建，virtio-pmd驱动实现了virtio标准，同时允许通过一个标准和有效的方式使用虚拟硬件。</li>
</ul>
<h2 id="DPDK-and-OVS-A-perfect-combination"><a href="#DPDK-and-OVS-A-perfect-combination" class="headerlink" title="DPDK and OVS: A perfect combination"></a>DPDK and OVS: A perfect combination</h2><p>一个关于DPDK提升性能的好例子就是Open VSwitch。这是一个功能丰富，多层的，分布式虚拟路由器，被广泛作为虚拟化环境以及SDN应用的主要网络层应用。</p>
<p>经典的OVS被划分为一个高效的基于内核的数据路径（fastpath）组合上一个flow table和一个比较慢的用户态数据路径（slowpath）处理不匹配任何flow（fastpath中已有的）的包。通过集成OVS和DPDK，fastpath也移动到了用户态，减少了kernel切换到用户态的交互，提升了最大性能。结果上对比原生的OVS，OVS+DPDK会有～10x的性能提升。</p>
<p>所以我们如何结合OVS-DPDK的这些特性和性能到一个virtio架构中去呢？接下来将一个一个介绍相关的组件。</p>
<h2 id="Vhost-user-library-in-DPDK"><a href="#Vhost-user-library-in-DPDK" class="headerlink" title="Vhost-user library in DPDK"></a>Vhost-user library in DPDK</h2><p>vhost协议是一组消息和机制，被设计用于将virtio数据处理路径从qemu卸载出来（the primary，主要是要卸载包处理）到一个外部元素（the handler，配置virtio rings以及实际的包处理）。最相关的机制是：</p>
<ul>
<li>一组消息允许primary发送virtqueue内存的布局，并且配置到handler</li>
<li>一堆eventft类的文件描述符，允许guest不通过primary直接发送和接受handler的消息：Available Buffer Notification (从guest发送到handler同志有buffers可以被处理了）和 the Used Buffer Notification (从handler发送到guest说明buffers的处理解释了）</li>
</ul>
<p>之前的virtio-networking文章我们描述了一个具体的vhost协议的实现（vhost-net内核模块）以及如何允许qemu把网络处理卸载到host-kernel上。然后我们介绍的vhost-user库，这个库是基于DPDK构建的，是一个vhost协议的用户态实现，允许qemu把virtio设备的包处理卸载到任意DPDK应用（比如Open vSwitch）。</p>
<p>vhost-user库和vhost-net kernel模块主要的不同是通信channel。vhost-net kernel驱动实现了是通过ioctls，而vhost-user库则是通过定义消息结构然后通过unix socket发送的。</p>
<p>DPDK应用可以被配置到提供unix socket（server模式）并且qemu可以连接上去（client模式）。然而，反过来也是可以的，这样就可以允许在不重启vm的情况下重启DPDK了。</p>
<p>在这个socket上，所有请求都被primary（这里是QEMU）初始化，其中一些请求要求返回的，比如GET_FEATURES请求或者其他设置了REPLY_ACK的请求。</p>
<p>在这个场景下，vhost-net kernel模块和vhost-user的库允许primary通过以下重要步骤配置数据面卸载</p>
<ol>
<li>Feature negotiation（特性协商）：virtio特性和vhost-user-specific特性通过类似的方式协商，首先primary会获取handler的特性bitmask然后设置一个它支持的子集</li>
<li>Memory region configuration（内存域配置）：master设置内存域的分布，然后handler就可以mmap()这些内存了</li>
<li>Vring configuration：primary会设置virtqueue的数量，并且设置他们在memory region内的地址。注意：vhost-user支持multiqueue所以设置更多的queue能用来改善性能。</li>
<li>Kick and Call file descriptors sending：通常irqfd和ioeventfd机制生效。详细内容可以回顾【】。更多关于virtio queue的机制可以看virtio数据面的文章</li>
</ol>
<p>总结一下这些机制，DPDK应用能够通过和guest共享内存处理包并且直接发送和接受guest的通知而不经过qemu。</p>
<p>最后一个把所有东西整合到一起的就是QEMU的virtio device模型，它有两个主要任务：</p>
<ul>
<li>模拟virtio设备，在guest里面展示的i一个特定的PCI端口，并且可以被guest查询和完整配置。同时他会把ioeventfd映射到模拟设备的内存映射I/O空间，同时把irqfd映射到Global System Interrupt（GSI）。结果就是，guest对这些东西时没有感知的，通知和中断都会被转发到vhost-user库而没有qemu参与。</li>
<li>替换实际的virtio数据路径实现，这个设备作为vhost-user协议的master来卸载处理逻辑到vhost-user库的DPDK进程里</li>
<li>处理来自virtqueue的请求，并翻译成vhost-user的请求转发到slave。</li>
</ul>
<p>下面的图展示了vhost-user-library作为DPDK应用的一部分的和QEMU交互以及guest使用virtio-device-model和virtio-pci设备：</p>
<img src="/2022/02/09/A-journey-to-the-vhost-users-realm/2019-09-24-virtio-networking-fig1.png" class="">

<p>对这个图有一些需要提的点</p>
<ul>
<li>virtio memory region是guest初始化的</li>
<li>能正确相应的virtio驱动通过定义在virtio规范的标准配置PCI BARs和virtio device接口交互是正常的</li>
<li>virtio-device-model（qemu内）使用vhost-user协议配置vhost-user库，同时配置irqfd和ioeventfd的文件描述符</li>
<li>virtio memory region是guest分配并映射到vhost-user库的（可以是DPDK应用）</li>
<li>结果是DPDK应用能够直接读写包到guest内存，并通过ioeventfd和irqfd机制直接通知guest</li>
</ul>
<h2 id="Userland-Networking-in-the-guest"><a href="#Userland-Networking-in-the-guest" class="headerlink" title="Userland Networking in the guest"></a>Userland Networking in the guest</h2><p>我们已经介绍了DPDK vhost-user实现，允许我们从host内核（vhost-net）卸载数据路径处理逻辑到专门的DPDK用户态应用（比如open vSwitch）因此动态改进了网络的性能。现在，我们将继续了解如何对guest做一样的改动来运行一个高性能网络应用（比如NFV服务）到guest的用户态来替换virtio-net内核模块。</p>
<p>为了能够直接在设备上运行用户态网络应用，我们需要三个组件：</p>
<ol>
<li>VFIO：VFIO是一个用户态驱动开发框架，允许用户态应用直接和设备交互（跳过kernel）</li>
<li>Virtio-pmd驱动：是一个DPDK驱动，基于Poll Mode Driver抽象构建，实现了virtio协议</li>
<li>IOMMU驱动：IOMMU驱动管理了虚拟IOMMU（I/O Memory Management Unit），一个可以对DMA-capable设备执行地址映射的模拟设备</li>
</ol>
<p>接下来我们一个一个的描述他们的细节吧。</p>
<h2 id="VFIO"><a href="#VFIO" class="headerlink" title="VFIO"></a>VFIO</h2><p>VFIO是Virtual Function I/O的缩写。然而，Alex Williamson，vfio-pci kernel驱动的maintainer建议叫它 “Versatile Framework for userspace I/O”，这是一个更加准确的名字。VFIO是一个构建用户态驱动的基础框架，它提供了：</p>
<ul>
<li>映射设备配置和I/O memory regions到用户内存</li>
<li>DMA和驱动的重新映射以及基于IOMMU groups的隔离。后面我们会深入介绍IOMMU以及它是如何工作的，目前假设它允许创建映射到物理内存的虚拟I/O内存空间（类似普通MMU映射到non-IO虚拟内存），所以当一个设备想要DMA到虚拟I/O地址，IOMMU将重新映射该地址并可能应用隔离和其他安全策略</li>
<li>Eventfd和irqfd 基础信号机制支持用户态的信号和中断</li>
</ul>
<p>引用内核文档：“如果你想在VFIO之前写一个驱动，你要么必须经历完整的开发周期才能成为合适的上游驱动，要么在代码树之外维护，要么使用没有IOMMU保护概念的UIO框架，限制中断支持并需要root权限才能访问诸如PCI配置空间之类的东西。”</p>
<p>VFIO暴露了用户友好的API，用于创建character设备（在 /dev/vfio/）支持ioctl通过device descriptor来描述设备、I/O regions 和 他们的读/写/mmap offsets，同时提供机制来描述和注册中断通知。</p>
<h2 id="Virtio-pmd"><a href="#Virtio-pmd" class="headerlink" title="Virtio-pmd"></a>Virtio-pmd</h2><p>DPDK提供了一个叫做Poll Mode Driver (PMD)的驱动抽象。这个东西作用在设备驱动和用户应用之间。提供了一系列高灵活性的东西给用户应用，同时保证了拓展性。比如给新设备实现驱动的能力。</p>
<p>它提供的一些更有用的特性如下：</p>
<ul>
<li>一组API允许特定的驱动实现驱动标准包括接收和发送方法。</li>
<li>每个端口和每个队列硬件的卸载支持静态和动态配置</li>
<li>一个用于数据的可拓展API可用，允许驱动定义自己的驱动标准的数据，同时应用可以调查回溯这些数据</li>
</ul>
<p>virtio Poll Mode Driver（virtio-pmd）是众多使用PMD API的一个驱动之一，为使用DPDK编写的应用程序提供对virtio设备的快速无锁访问，使用virtio的virtqueues提供数据包接收和传输的基本功能。</p>
<p>除了这些PMD的特性之外，virtio-pmd驱动的实现还支持：</p>
<ul>
<li>接收时每个数据包可灵活合并缓冲区和发送时每个数据包的分散缓冲区</li>
<li>组播和混杂模式</li>
<li>MAC/vlan过滤</li>
</ul>
<p>结果就是一个高性能的用户态virtio驱动允许DPDK应用完整的使用virtio标准接口。</p>
<h2 id="Introducing-the-IOMMU"><a href="#Introducing-the-IOMMU" class="headerlink" title="Introducing the IOMMU"></a>Introducing the IOMMU</h2><p>IOMMU可以说基本上等于I/O空间（设备通过DMA直接访问内存）的MMU。它位于主存和设备之间，创建一个virtual I/O空间给每个设备，提供一个机制，动态映射虚拟内存到无力设备。因此当一个驱动配置了设备的DMA（比如一个网卡），并且配置了虚拟地址，当设备尝试访问虚拟地址的时候，这些虚拟地址就被IOMMU重新映射了。</p>
<p>它提供了很多优势比如：</p>
<ul>
<li>可以分配大段相邻虚拟内存，而不需要相邻物理内存</li>
<li>一些设备不支持足够长的访问物理内存的地址，IOMMU解决了这个问题</li>
<li>保护内存，避免DMA攻击通过恶意构造错误的设备并执行访问了并不是分配给设备的内存空间。设备只能看到虚拟地址并且运行操作系统独占的IOMMU映射。</li>
<li>一些架构里支持中断重映射，允许中断隔离和迁移</li>
</ul>
<img src="/2022/02/09/A-journey-to-the-vhost-users-realm/2019-09-24-virtio-networking-fig2.png" class="">

<p>通常情况下，所有东西都是有代价的，IOMMU的缺点是：</p>
<ul>
<li>因为要做page translation，所以性能下降</li>
<li>如果增加page translation表会消耗物理内存</li>
</ul>
<p>vIOMMU - IOMMU for the guest</p>
<p>当然，如果有一个物理IOMMU（比如intel VT-d和AMD-VI）qemu里也是会存在虚拟IOMMU的。QEMU的vIOMMU有以下特征：</p>
<ul>
<li>它翻译guest I/O虚拟地址（IOVA）到guest物理地址（GPA），并且能够通过QEMU的内存管理系统翻译成QEMU的host虚拟地址（HVA）</li>
<li>设备隔离执行</li>
<li>实现了I/O TLB API，因此映射可以在qemu外部查询</li>
</ul>
<p>因此为了获取一个虚拟设备和虚拟IOMMU协作：</p>
<ol>
<li>使用一个可用API在vIOMMU创建一个必要的IOVA映射，目前API是：<br> a. 内核驱动的内核DMA API<br> b. 用户态驱动的VFIO </li>
<li>用虚拟I/O地址配置设备的DMA</li>
</ol>
<h2 id="vIOMMU-and-DPDK-integration"><a href="#vIOMMU-and-DPDK-integration" class="headerlink" title="vIOMMU and DPDK integration"></a>vIOMMU and DPDK integration</h2><p>当一个QEMU模拟的设备尝试DMA到guest的virtio I/O空间，会使用到vIOMMU TLB来查询对应的页的映射并且执行一个安全的DMA访问。问题是如果实际的DMA被卸载到外部进程比如一个使用vhost-user库的DPDK应用？</p>
<p>当vhost-user库尝试直接访问这些共享内存，它需要把所有地址（I/O虚拟地址）到它自己的地址。因此这个需要让QEMU的vIOMMU来提供Device TLB API。Vhost-user库（或者说是vhost-kernel驱动）使用PCIe’s Address Translation Services标准消息集合来向QEMU请求一个页地址的翻译，通过一个次级的通信channel（另一个unix socket）这个channel会在配置IOMMU的时候创建。</p>
<p>总的来说，这里一共有三次地址翻译需要被处理：</p>
<ol>
<li>Qemu的vIOMMU翻译I/O虚拟地址到Guest物理地址</li>
<li>Qemu的内存管理翻译Guest物理地址到Host虚拟地址（在qemu进程的地址空间内的Host虚拟地址）</li>
<li>Vhost-user库翻译Qemu的Host虚拟地址到Vhost-user的Host虚拟地址。通常情况下，当vhost-user库映射qemu内存地址的时候，很简单就是把QEMU的Host虚拟地址翻译到mmap返回的地址即可</li>
</ol>
<p>显然，这些地址翻译存在潜在的性能影响，特别是使用的是动态映射。然而，静态的大页分配（也是DPDK实际上做的）可以最小化这些性能损失。</p>
<p>下面的图优化了之前的vhost-user架构，来包含IOMMU的组件：</p>
<img src="/2022/02/09/A-journey-to-the-vhost-users-realm/2019-09-24-virtio-networking-fig3.png" class="">

<p>关于这个相当复杂的图表要提几点：</p>
<ul>
<li>Guest物理内存空间是从Guest视角当作物理内存空间的，但显然这是QEMU进程的虚拟地址。当virtqueue memory region被分配的时候，实际上是在Guest的物理内存空间里</li>
<li>当I/O虚拟地址分配给包含virtqueue的内存范围，和Guest物理地址相关联的一个条目就会被增加到vIOMMU的TLB table里</li>
<li>另一方面，qemu的内存管理系统是能够知道guest的物理内存空间的和它自己的内存空间是在一起的。因此qemu的内存管理系统是可以翻译guest物理地址到QEMU（host）虚拟地址的</li>
<li>当vhost-user库尝试去访问未被翻译过的IOVA的时候，它会通过secondary unix socket发送一个IOTLB miss的消息</li>
<li>IOTLB API收到这个请求后就会开始查找这个地址，首先是把IOVA翻译成GPA然后GPA翻译成HVA。然后发送这个翻译好的结果到master的unix socket也就是vhost-user库。</li>
<li>最后，vhost-user库需要做最后一次翻译，因为qemu的内存被映射到了自己的内存空间里，所以需要把QEMU的HVA翻译到自己的HVA来访问共享内存</li>
</ul>
<h2 id="Putting-everything-together"><a href="#Putting-everything-together" class="headerlink" title="Putting everything together"></a>Putting everything together</h2><p>这个文章涵盖了大量的组件，包括DPDK，virtio-pmd，VFIO，IOMMU等等</p>
<p>下面的图展示了把这些组件整合之后实现的vhost-user/virtio-pmd架构：</p>


<p>对这个图标要提一点：</p>
<ul>
<li>把这个图和上一个图相比，增加了通过硬件IOMMU，VFIO以及特定vendor的PMD驱动，连接OVS-DPDK应用到物理网卡的组件。现在就不会有疑惑了，因为访问硬件的方式和guest是一样的。</li>
</ul>
<h2 id="An-example-flow"><a href="#An-example-flow" class="headerlink" title="An example flow"></a>An example flow</h2>

<h2 id="Control-Plane"><a href="#Control-Plane" class="headerlink" title="Control Plane"></a>Control Plane</h2><p>这是设置控制面必要的步骤</p>
<ol>
<li>当host上的DPDK应用（OVS）启动，会创建一个socket（server模式）和qemu处理virtio相关的协商逻辑</li>
<li>当qemu启动，它会连接到main socket，然后如果检测到VHOST_USER_PROTOCOL_F_SLAVE_REQ如果vhost-user提供了这个特性，qemu就会创建一个second socket并且把这个socket发送到vhost-user来连接并发送IOTLB同步消息</li>
<li>当QEMU &lt;-&gt; vhost-library的协商结束，两个sockets在他们之间是共享的。一个是virtio配置，另外一个是iotlb消息交换用的</li>
<li>guest启动然后vfio驱动就和PCI设备绑定了。这个驱动能够提供访问iommu groups（iommu group主要取决于硬件拓扑）</li>
<li>当DPDK在guest里启动的时候有以下步骤<br> a. 初始化PCI-vfio设备，同时映射PCI配置空间到用户内存<br> b. 分配virtqueue<br> c. 使用vfio，DMA映射virtqueue内存空间，这样通过IOMMU内核驱动dma映射到vIOMMU设备<br> d. 然后，virto特性协商就开始了。本场景里，使用的virtqueue的地址是IOVA（在I/O虚拟内存空间）。映射eventfd和irqfd也完成了，因此中断和通知就被直接路由在guest和vhost-user库之间，而没有QEMU参与<br> e. 最后，DPDK应用分配一个大片的连续内存作为网络buffer。这部分映射也通过VFIO和IOMMU驱动添加到vIOMMU</li>
</ol>
<p>到此，配置完成并且数据面（virtqueues和notification机制）已经可以使用了。</p>
<h2 id="Data-Plane"><a href="#Data-Plane" class="headerlink" title="Data Plane"></a>Data Plane</h2><p>为了发送数据包，会有以下步骤：</p>
<ol>
<li>guest里的DPDK应用命令virtio-pmd发包。首先会写buffers然后把一致性描述符增加到可用描述符ring里</li>
<li>vhost-user PMD在host端会polling这个virtioqueue，所以他立刻会检测到新的描述符可用并开始处理</li>
<li>对每一个描述符，vhost-user PMD都会map他们的buffer（这一步就是地址翻译，翻译IOVA到HVA）。很少情况下会有buffer内存在一个没被映射到vhost-user IOTLB的页，如果出现miss的情况，会发送一个请求给QEMU，而实际上DPDK应用在guest里会分配静态大页，保证IOTLB请求会被最小限度的发送到QEMU。</li>
<li>这个vhost-user PMD会把这个buffers拷贝到mbufs（也就是DPDK应用使用的message buffers）</li>
<li>这些描述符会被添加到使用过的描述符ring。这些会立刻被guest里的DPDK应用发现，因为guest里的DPDK应用会不断polling virtqueue</li>
<li>然后这些mbufs就被host的DPDK应用消费了</li>
</ol>
<h2 id="Summary-and-conclusions"><a href="#Summary-and-conclusions" class="headerlink" title="Summary and conclusions"></a>Summary and conclusions</h2><p>DPDK是一个很有前途的技术，因为他提供工了极大提升用户态性能的能力。不仅这个技术本身，和OVS结合，能够满足灵活高效的现代虚拟环境的要求，也在NFV部署中扮演着一个重要的角色。</p>
<p>为了充分利用这个技术，数据中心交换数据路径以及在guest中启用NFV应用，有必要在host和guest之间安全的创建一个有效的数据路径。这也就是virtio-net技术起到的作用。</p>
<p>vhost-user提供了一个可靠并且安全的机制来卸载网络处理逻辑到基于DPDK的应用里。它和vIOMMU集成，并提供隔离和内存保护，同时将libvirt从处理数据包的繁重工作下解放出来。</p>
<p>在guest里，符合virtio标准DPDK（virtio-pmd）利用有效的内存管理和高性能的DPDK Poll Mode driver使得在guest里创建也能创建快速数据路径。</p>
<p>如果你想要学习更多关于virtio技术，vhost-user以及DPDK请不要错过下一篇文章。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://hanayo.cn/2022/02/09/A-journey-to-the-vhost-users-realm/" data-id="cld1mhec8005wyuwbfprq2cun" data-title="A journey to the vhost-users realm" class="article-share-link">Share</a>
      
      
        <a href="/2022/02/09/A-journey-to-the-vhost-users-realm/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2022/02/09/A-journey-to-the-vhost-users-realm/" itemprop="commentCount"></span>
          Comments
        </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arch-notes/">arch-notes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/">languages</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/languages/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/languages/python/">python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/memory-management/">memory management</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/management/">management</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project-related-works/">project-related-works</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/">virtualization</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/edk2-ovmf/">edk2-ovmf</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/kvm/">kvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/">translation</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio/">virtio</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/translation/virtio-networking/">virtio-networking</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/v2v/">v2v</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/virtualization/virtio-balloon/">virtio-balloon</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BSOD/" rel="tag">BSOD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DPDK/" rel="tag">DPDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementTree/" rel="tag">ElementTree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDP/" rel="tag">TDP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TLB/" rel="tag">TLB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/architecture/" rel="tag">architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code-reading/" rel="tag">code-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cpu/" rel="tag">cpu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edk2-ovmf/" rel="tag">edk2-ovmf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ft/" rel="tag">ft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/" rel="tag">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/" rel="tag">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/live-migration/" rel="tag">live-migration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nessus/" rel="tag">nessus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nexus/" rel="tag">nexus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper-reading/" rel="tag">paper-reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">perf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/" rel="tag">qemu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading-notes/" rel="tag">reading notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/" rel="tag">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software-arch/" rel="tag">software-arch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/" rel="tag">system-design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2v/" rel="tag">v2v</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vDPA/" rel="tag">vDPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vhost-net/" rel="tag">vhost-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virt/" rel="tag">virt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio/" rel="tag">virtio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-balloon/" rel="tag">virtio-balloon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-net/" rel="tag">virtio-net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtio-networking/" rel="tag">virtio-networking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BSOD/" style="font-size: 10px;">BSOD</a> <a href="/tags/DPDK/" style="font-size: 12.86px;">DPDK</a> <a href="/tags/ElementTree/" style="font-size: 10px;">ElementTree</a> <a href="/tags/TDP/" style="font-size: 11.43px;">TDP</a> <a href="/tags/TLB/" style="font-size: 10px;">TLB</a> <a href="/tags/architecture/" style="font-size: 18.57px;">architecture</a> <a href="/tags/code-reading/" style="font-size: 10px;">code-reading</a> <a href="/tags/cpu/" style="font-size: 10px;">cpu</a> <a href="/tags/edk2-ovmf/" style="font-size: 10px;">edk2-ovmf</a> <a href="/tags/ft/" style="font-size: 10px;">ft</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/java/" style="font-size: 12.86px;">java</a> <a href="/tags/kernel/" style="font-size: 12.86px;">kernel</a> <a href="/tags/kvm/" style="font-size: 15.71px;">kvm</a> <a href="/tags/libvirt/" style="font-size: 11.43px;">libvirt</a> <a href="/tags/linux/" style="font-size: 15.71px;">linux</a> <a href="/tags/live-migration/" style="font-size: 10px;">live-migration</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/nessus/" style="font-size: 10px;">nessus</a> <a href="/tags/nexus/" style="font-size: 10px;">nexus</a> <a href="/tags/others/" style="font-size: 10px;">others</a> <a href="/tags/paper-reading/" style="font-size: 10px;">paper-reading</a> <a href="/tags/perf/" style="font-size: 10px;">perf</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/qemu/" style="font-size: 20px;">qemu</a> <a href="/tags/reading-notes/" style="font-size: 10px;">reading notes</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/software-arch/" style="font-size: 12.86px;">software-arch</a> <a href="/tags/system-design/" style="font-size: 12.86px;">system-design</a> <a href="/tags/v2v/" style="font-size: 10px;">v2v</a> <a href="/tags/vDPA/" style="font-size: 10px;">vDPA</a> <a href="/tags/vhost-net/" style="font-size: 17.14px;">vhost-net</a> <a href="/tags/virt/" style="font-size: 14.29px;">virt</a> <a href="/tags/virtio/" style="font-size: 15.71px;">virtio</a> <a href="/tags/virtio-balloon/" style="font-size: 10px;">virtio-balloon</a> <a href="/tags/virtio-net/" style="font-size: 17.14px;">virtio-net</a> <a href="/tags/virtio-networking/" style="font-size: 17.14px;">virtio-networking</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/01/cpu-feature-configuration-code-diving/">Cpu feature configuration code diving</a>
          </li>
        
          <li>
            <a href="/2023/02/23/packed-virtqueue-how-to-reduce-overhead-with-virtio/">Packed virtqueue: How to reduce overhead with virtio</a>
          </li>
        
          <li>
            <a href="/2023/02/22/virtqueues-and-virtio-ring-how-the-data-travels/">Virtqueues and virtio ring: How the data travels</a>
          </li>
        
          <li>
            <a href="/2023/02/22/virtio-devices-and-drivers-overview-the-headjack-and-the-phone/">Virtio devices and drivers overview: The headjack and the phone</a>
          </li>
        
          <li>
            <a href="/2023/02/03/windows-install-virtio-then-reboot-met-BSOD/">Windows install virtio then reboot met BSOD</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a></br>
      
      &copy; 2023 Alan Jager<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>

<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = '' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "r30r51B3r5JFqlxR88Jua6So-gzGzoHsz",
        appKey: "wnL9j38siXbLqBHGnWpzmVxv",
        placeholder: "Just go go",
        pageSize:'10',
        avatar:'mm',
        lang:'zh-cn'
    });
</script>

  </div>
</body>
</html>